<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=generator content="Hugo 0.140.0"><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/site.webmanifest><link rel=mask-icon href=/favicon/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Ysoserial-Hibernate1 - zrquan</title>
<meta name=author content="[4shen0ne]"><meta name=description content="A minimal Hugo theme with nice theme color."><meta name=keywords content="java,deserialize"><meta property="og:title" content="Ysoserial-Hibernate1"><meta name=twitter:title content="Ysoserial-Hibernate1"><meta property="og:type" content="article"><meta property="og:url" content="https://zrquan.github.io/posts/ysoserial-hibernate1/"><meta property="og:description" content="Hibernate æ˜¯ Java çš„ä¸€ä¸ªå¯¹è±¡å…³ç³»æ˜ å°„(ORM)æ¡†æ¶ï¼Œä½¿ç”¨ GNU å¼€æºåè®®ã€‚è¯¥åˆ©ç”¨é“¾ä»¥ HashMap ä¸ºå…¥å£ç‚¹ï¼Œé€šè¿‡ hibernate-core åŒ…ä¸­çš„å¤šä¸ªç±»åŠå…¶æ–¹æ³•æ„æˆè°ƒç”¨è·¯å¾„ï¼Œæœ€ç»ˆæ‰§è¡Œäº‹å…ˆå†™å…¥åˆ° TemplatesImpl ç±»ä¸­çš„å‘½ä»¤ã€‚"><meta name=twitter:description content="Hibernate æ˜¯ Java çš„ä¸€ä¸ªå¯¹è±¡å…³ç³»æ˜ å°„(ORM)æ¡†æ¶ï¼Œä½¿ç”¨ GNU å¼€æºåè®®ã€‚è¯¥åˆ©ç”¨é“¾ä»¥ HashMap ä¸ºå…¥å£ç‚¹ï¼Œé€šè¿‡ hibernate-core åŒ…ä¸­çš„å¤šä¸ªç±»åŠå…¶æ–¹æ³•æ„æˆè°ƒç”¨è·¯å¾„ï¼Œæœ€ç»ˆæ‰§è¡Œäº‹å…ˆå†™å…¥åˆ° TemplatesImpl ç±»ä¸­çš„å‘½ä»¤ã€‚"><meta property="og:image" content="https://zrquan.github.io/img/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zrquan.github.io/img/og.png"><meta property="article:published_time" content="2021-01-26T00:00:00+08:00"><meta property="article:modified_time" content="2021-01-26T00:00:00+08:00"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://zrquan.github.io/assets/css/fuji.min.4c44b7b7f176c7ea2e7d3a85a954d45c0d3e801e81eacbad84c7f9575b51e65dc11b59ff1a372389e8b4e0821d6bbb5a668fe9c3e77af9418acb79126a035a1f.css integrity="sha512-TES3t/F2x+oufTqFqVTUXA0+gB6B6suthMf5V1tR5l3BG1n/Gjcjiei04IIda7taZo/pw+d6+UGKy3kSagNaHw=="></head><body data-theme=auto data-theme-auto=false><script data-cfasync=false>var fujiThemeData=localStorage.getItem("fuji_data-theme");fujiThemeData?fujiThemeData!=="auto"&&document.body.setAttribute("data-theme",fujiThemeData==="dark"?"dark":"light"):localStorage.setItem("fuji_data-theme","auto")</script><header></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h1 class="post-item post-title"><a href=https://zrquan.github.io/posts/ysoserial-hibernate1/>Ysoserial-Hibernate1</a></h1><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2021-01-26</span>
<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;2310 words</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=/tags/java>java</a>&nbsp;<a href=/tags/deserialize>deserialize</a>&nbsp;</span></div><div class="post-content markdown-body"><p>Hibernate æ˜¯ Java çš„ä¸€ä¸ªå¯¹è±¡å…³ç³»æ˜ å°„(ORM)æ¡†æ¶ï¼Œä½¿ç”¨ GNU å¼€æºåè®®ã€‚è¯¥åˆ©ç”¨é“¾ä»¥ HashMap ä¸ºå…¥å£ç‚¹ï¼Œé€šè¿‡ hibernate-core åŒ…ä¸­çš„å¤šä¸ªç±»åŠå…¶æ–¹æ³•æ„æˆè°ƒç”¨è·¯å¾„ï¼Œæœ€ç»ˆæ‰§è¡Œäº‹å…ˆå†™å…¥åˆ° TemplatesImpl ç±»ä¸­çš„å‘½ä»¤ã€‚</p><h2 id=åŠ¨æ€å­—èŠ‚ç >åŠ¨æ€å­—èŠ‚ç </h2><p>ysoserial åœ¨æ„é€  payload æ—¶ï¼Œåˆ©ç”¨äº† Java çš„åŠ¨æ€å­—èŠ‚ç ç”Ÿæˆçš„æŠ€æœ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆç¨å¾®äº†è§£ä¸€ä¸‹ã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒJava æ˜¯ä¸€é—¨éœ€è¦ç¼–è¯‘çš„è¯­è¨€ï¼ŒJVM è¯»å–å¹¶è¿è¡Œçš„æ˜¯ç¼–è¯‘åçš„ <code>.class</code> å­—èŠ‚ç æ–‡ä»¶ã€‚ä½†æœ‰æ—¶å€™æˆ‘ä»¬æƒ³è¦åœ¨ç¨‹åºè¿è¡Œä¸­åŠ¨æ€ä¿®æ”¹ä¸€äº›ä»£ç ï¼Œæ¯”å¦‚çƒ­è¡¥ä¸ã€æ¥å£å‡çº§ã€IDE åœ¨è°ƒè¯•æ—¶è¯»å–æˆ–ä¿®æ”¹å˜é‡ç­‰ç­‰éœ€æ±‚ã€‚å¦‚æœæ¯æ¬¡éƒ½è¦æŠŠç¨‹åºåœæ‰å†é‡æ–°ç¼–è¯‘ï¼Œæ˜¾ç„¶ä¸å¤ªç°å®ï¼Œè€Œé€šè¿‡ Java åŠ¨æ€å­—èŠ‚ç æŠ€æœ¯ï¼Œå°±å¯ä»¥ç›´æ¥ä¿®æ”¹å­—èŠ‚ç æ–‡ä»¶ï¼Œå†é€šè¿‡ç›¸å…³æ¥å£åŠ è½½åˆ° JVM ä¸­ï¼Œå®ç°è¿è¡Œæ—¶çš„ä»£ç ä¿®æ”¹ã€‚</p><p>å¸¸è§çš„åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>ASMï¼Œå¯ä»¥ç›´æ¥æ“ä½œå­—èŠ‚ç ï¼Œæ‰§è¡Œæ•ˆç‡é«˜ï¼Œç›¸å¯¹çš„é—¨æ§›ä¹Ÿæ¯”è¾ƒé«˜ï¼Œéœ€è¦å¯¹ Java çš„å­—èŠ‚ç æ–‡ä»¶æœ‰æ‰€äº†è§£ï¼Œç†Ÿæ‚‰ JVM çš„ç¼–è¯‘æŒ‡ä»¤ã€‚</li><li>Javassitï¼Œç”±ä¸œäº¬æŠ€æœ¯å­¦é™¢çš„ Shigeru Chiba åˆ›ä½œçš„å¼€æºç±»åº“ï¼Œæä¾›äº†æ›´æŠ½è±¡çš„ API æ¥å¯¹å­—èŠ‚ç è¿›è¡Œæ“ä½œã€‚Hibernate1 åˆ©ç”¨é“¾ä¸­ä¹Ÿæ­£æ˜¯ä½¿ç”¨è¿™ä¸ªç±»åº“æ¥æ„é€  payloadã€‚</li></ol><h3 id=javassit-demo>Javassit demo</h3><p>ä¸‹é¢çš„ç¤ºä¾‹ä»£ç é€šè¿‡ Javassit æ„é€ äº†ä¸€ä¸ª Someone ç±»ï¼Œå¹¶æ·»åŠ äº†æ–¹æ³•å’Œå±æ€§ã€‚ç„¶åå°†è¯¥ç±»å®ä¾‹åŒ–ï¼Œå¹¶è°ƒç”¨å…¶ toString æ–¹æ³•ã€‚</p><details><summary>ç¤ºä¾‹ä»£ç </summary><div class=details><pre><code class=language-java>import javassist.*;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

public class demo {
    public static void main(String[] args) {
        ClassPool classPool = ClassPool.getDefault();

        //å®šä¹‰Someoneç±»
        CtClass ccSomeone = classPool.makeClass(&quot;Someone&quot;);

        try {
            //å®šä¹‰æˆå‘˜å˜é‡name
            CtClass fieldType = classPool.get(&quot;java.lang.String&quot;);
            CtField cfName = new CtField(fieldType, &quot;name&quot;, ccSomeone);
            cfName.setModifiers(Modifier.PRIVATE);  //ç”¨privateä¿®é¥°name
            ccSomeone.addField(cfName, CtField.Initializer.constant(&quot;init&quot;));  //æ·»åŠ nameåˆ°Someoneä¸­ï¼Œåˆå§‹å€¼ä¸ºinit

            //å®šä¹‰æ„é€ æ–¹æ³•
            CtClass[] parameters = new CtClass[]{classPool.get(&quot;java.lang.String&quot;)};  //å‚æ•°ä¸ºStringç±»å‹
            CtConstructor constructor = new CtConstructor(parameters, ccSomeone);
            String body = &quot;{this.name=$1;}&quot;;  //æ–¹æ³•ä½“ï¼Œ$1è¡¨ç¤ºçš„ç¬¬ä¸€ä¸ªå‚æ•°
            constructor.setBody(body);
            ccSomeone.addConstructor(constructor);  //è®¾ç½®ä¸ºSomeoneçš„æ„é€ æ–¹æ³•

            //setNameå’ŒgetNameæ–¹æ³•
            ccSomeone.addMethod(CtNewMethod.setter(&quot;setName&quot;,cfName));
            ccSomeone.addMethod(CtNewMethod.getter(&quot;getName&quot;,cfName));

            //toString æ–¹æ³•
            CtClass returnType = classPool.get(&quot;java.lang.String&quot;);  //è¿”å›ç±»å‹ä¸º String
            String methodName = &quot;toString&quot;;
            CtMethod cmToString = new CtMethod(returnType, methodName, null, ccSomeone);
            cmToString.setModifiers(Modifier.PUBLIC);  //ç”¨ public ä¿®é¥°
            String methodBody = &quot;{return \&quot;My name is \&quot;+$0.name;}&quot;;  //æ–¹æ³•ä½“ï¼Œ$0 è¡¨ç¤º this
            cmToString.setBody(methodBody);
            ccSomeone.addMethod(cmToString);

            //è·å– Someone ç±»çš„å®ä¾‹ï¼Œè®¾ç½® name å±æ€§ï¼Œè°ƒç”¨ toString æ–¹æ³•
            Class clazz = ccSomeone.toClass();
            Constructor cons = clazz.getConstructor(String.class);
            Object someone = cons.newInstance(&quot;zrquan&quot;);  //é€šè¿‡æ„é€ æ–¹æ³•è®¾ç½® name
            Method toString = clazz.getMethod(&quot;toString&quot;);
            System.out.println(toString.invoke(someone));
        } catch (NotFoundException | CannotCompileException | NoSuchMethodException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (InvocationTargetException e) {
            e.printStackTrace();
        }
    }
}
</code></pre></div></details><figure><img src=/ox-hugo/2021-01-26_19-11-04_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_19-11-04_screenshot.png></figure><h2 id=æ„é€ -payload>æ„é€  payload</h2><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æœ€ä¸»è¦çš„ getObject æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®Œæˆäº†å¯¹è¦æ‰§è¡Œçš„å‘½ä»¤çš„â€œåŒ…è£…â€ï¼Œå¹¶è¿”å›åŒ…å«è¯¥å‘½ä»¤çš„å¯¹è±¡ã€‚</p><pre><code class=language-java>public Object getObject ( String command ) throws Exception {
    Object tpl = Gadgets.createTemplatesImpl(command);
    Object getters = makeGetter(tpl.getClass(), &quot;getOutputProperties&quot;);
    return makeCaller(tpl, getters);
}
</code></pre><p>å…¶ä¸­ makeGetter å’Œ makeCaller éƒ½æ˜¯å†…éƒ¨å‡½æ•°ï¼Œè€Œ makeGetter å…¶å®åªèµ·åˆ°è·¯ç”±ä½œç”¨ï¼ŒçœŸæ­£çš„é€»è¾‘ä»£ç åœ¨å†…éƒ¨å‡½æ•° makeHibernate4Getter å’Œ makeHibernate5Getter ä¸­ã€‚</p><figure><img src=/ox-hugo/2021-01-22_16-29-20_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-22_16-29-20_screenshot.png></figure><p>é¦–å…ˆè·Ÿè¿›ä¸€ä¸‹ createTemplatesImpl æ–¹æ³•ï¼š</p><figure><img src=/ox-hugo/2021-01-22_16-53-53_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-22_16-53-53_screenshot.png></figure><p>è¯¥æ–¹æ³•å…ˆå¯¹ç³»ç»Ÿå±æ€§ properXalan è¿›è¡Œäº†åˆ¤æ–­â€”â€”å¦‚æœè¿”å› falseï¼Œåˆ™é€šè¿‡åå°„æœºåˆ¶è·å–
TemplatesImplã€AbstractTransletã€TransformerFactoryImpl ä¸‰ä¸ªç±»çš„å…¨å±€é™å®šç±»åï¼Œå°†å…¶ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨é‡è½½çš„ createTemplatesImpl æ–¹æ³•ï¼›å¦‚æœè¿”å› trueï¼Œå°±ä½¿ç”¨ä¸Šè¿°ä¸‰ä¸ªç±»çš„éå…¨å±€é™å®šç±»åä½œä¸ºå‚æ•°è°ƒç”¨é‡è½½æ–¹æ³•ã€‚</p><p>åœ¨é‡è½½çš„ createTemplatesImpl æ–¹æ³•ä¸­ï¼Œé€šè¿‡ Javassit åº“åˆ›å»ºä¸€ä¸ª StubTransletPayload ç±»ï¼Œå¹¶å°†æˆ‘ä»¬è¦æ‰§è¡Œçš„å‘½ä»¤æ·»åŠ åˆ°è¿™ä¸ªç±»çš„é™æ€ä»£ç å—ï¼Œå½“è¿™ä¸ªç±»è¢«åŠ è½½æ—¶ï¼Œæˆ‘ä»¬å†™å…¥çš„å‘½ä»¤å°±ä¼šæ‰§è¡Œã€‚</p><figure><img src=/ox-hugo/2021-01-22_17-44-52_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-22_17-44-52_screenshot.png></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ 116 è¡Œï¼Œè°ƒç”¨ <code>CtClass.makeClassInitializer()</code> åˆ›å»ºä¸€ä¸ªç©ºçš„é™æ€ä»£ç å—ï¼Œå†é€šè¿‡ <code>insertAfter()</code> å°†å‘½ä»¤æ’å…¥åˆ°é™æ€ä»£ç å—æœ«å°¾ã€‚</p><p>ä»£ç çš„ 119 å’Œ 120 è¡Œç»™ StubTransletPayload è®¾ç½®äº†çˆ¶ç±» AbstractTransletï¼Œä½†å…¶å®æ²¡æœ‰å¿…è¦ï¼Œå› ä¸º StubTransletPayload æœ¬èº«å°±ç»§æ‰¿äº† AbstractTransletã€‚</p><figure><img src=/ox-hugo/2021-01-22_17-55-15_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-22_17-55-15_screenshot.png></figure><p>æ–¹æ³•çš„æœ€åå°† StubTransletPayload å®ä¾‹è½¬æ¢æˆ byte æ•°ç»„ï¼Œèµ‹ç»™ templates å˜é‡çš„ <code>_bytecodes</code> å±æ€§ï¼Œå¹¶è®¾ç½®äº† <code>_name</code> å’Œ <code>_tfactory</code> å±æ€§ã€‚</p><p>è¿”å›çš„ templates å˜é‡æ˜¯ TemplatesImpl ç±»çš„å®ä¾‹ï¼Œæ‰§è¡Œå®Œ createTemplatesImpl åï¼Œå®ƒçš„ç»“æ„å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src=/ox-hugo/templates.svg class="img-zoomable medium-zoom-image" alt=/ox-hugo/templates.svg></figure><p>æ¥ä¸‹æ¥æ‰§è¡Œçš„ä»£ç æ˜¯ makeGetter æ–¹æ³•ï¼š</p><pre><code class=language-java>Object getters = makeGetter(tpl.getClass(), &quot;getOutputProperties&quot;);
</code></pre><p>é¦–å…ˆé€šè¿‡ç³»ç»Ÿå±æ€§åˆ¤æ–­å½“å‰çš„ hibernate ç‰ˆæœ¬ï¼Œysoserial ä½¿ç”¨çš„æ˜¯ 4.3 ç‰ˆæœ¬ï¼Œæ‰€ä»¥ç›´æ¥è·³åˆ° makeHibernate4Getter å‡½æ•°ã€‚</p><figure><img src=/ox-hugo/2021-01-24_22-06-00_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-24_22-06-00_screenshot.png></figure><p>è¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡åå°„æœºåˆ¶åˆ›å»ºäº†ä¸€ä¸ª <code>BasicPropertyAccessor$BasicGetter</code> å®ä¾‹ï¼Œå¹¶èµ‹å€¼äº† clazzã€methodã€propertyName å±æ€§ï¼Œç„¶åæ”¾åˆ° Getter æ•°ç»„ä¸­ã€‚ç±»å›¾å¤§è‡´å¦‚ä¸‹ï¼š</p><figure><img src=/ox-hugo/getter.svg class="img-zoomable medium-zoom-image" alt=/ox-hugo/getter.svg></figure><p>æœ€åæ‰§è¡Œçš„æ˜¯ <code>makeCaller(tpl, getters)</code> ï¼Œé€šè¿‡åå°„æœºåˆ¶è¿›è¡Œä¸€ç³»åˆ—ç”Ÿæˆå®ä¾‹ã€èµ‹å€¼å±æ€§çš„æ“ä½œï¼Œç„¶åè¿”å›ä¸€ä¸ª HashMap å¯¹è±¡ã€‚</p><figure><img src=/ox-hugo/2021-01-25_13-50-41_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-25_13-50-41_screenshot.png></figure><p>Reflections ç±»å°è£…äº†ä¸€äº›åå°„æœºåˆ¶çš„æ“ä½œï¼Œæ³¨æ„åˆ°ç”Ÿæˆ PojoComponentTuplizer å®ä¾‹æ—¶è°ƒç”¨çš„æ˜¯ createWithoutConstructor æ–¹æ³•ï¼Œå®é™…ä¸Šä¼šä½¿ç”¨ Object ç±»çš„æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥å®ä¾‹ä¸­çš„å±æ€§åŸºæœ¬éƒ½æ˜¯ nullã€‚æ¥ç€å°†ä¹‹å‰æ„é€ çš„ <code>BasicPropertyAccessor$BasicGetter</code> èµ‹å€¼ç»™ getters å±æ€§ã€‚</p><figure><img src=/ox-hugo/2021-01-25_13-57-05_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-25_13-57-05_screenshot.png></figure><p>ç”Ÿæˆ ComponentType å®ä¾‹æ—¶ï¼Œä½¿ç”¨çš„æ˜¯å…¶çˆ¶ç±» AbstractType çš„é»˜è®¤æ„é€ æ–¹æ³•ï¼Œç„¶åèµ‹å€¼äº† componentTuplizerã€propertySpanã€propertyTypes ä¸‰ä¸ªå±æ€§ã€‚</p><figure><img src=/ox-hugo/2021-01-25_14-03-05_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-25_14-03-05_screenshot.png></figure><p><code>Gadgets.makeMap(v1, v2)</code> å°†ä¸¤ä¸ªç›¸åŒçš„ TypedValue å®ä¾‹å†™å…¥åˆ° HashMap ä¸­ï¼Œpayload çš„æ„é€ åˆ°æ­¤å°±å®Œæˆäº†ï¼Œå½“ç›®æ ‡åº”ç”¨ååºåˆ—åŒ–è¿™ä¸ª HashMap å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬å†™å…¥çš„å‘½ä»¤å°±ä¼šæ‰§è¡Œã€‚</p><p>HashMap çš„ç±»å›¾å¤§è‡´å¦‚ä¸‹ï¼š</p><figure><img src=/ox-hugo/hashmap.svg class="img-zoomable medium-zoom-image" alt=/ox-hugo/hashmap.svg></figure><h2 id=ååºåˆ—åŒ–è¿‡ç¨‹>ååºåˆ—åŒ–è¿‡ç¨‹</h2><p>ä½¿ç”¨ jdk ååºåˆ—åŒ– HashMap å¯¹è±¡ï¼Œè‡ªç„¶ä¼šè°ƒç”¨å…¶ readObject æ–¹æ³•ï¼Œæ‰€ä»¥ä»¥è¯¥æ–¹æ³•ä½œä¸ºå…¥å£ç‚¹ï¼Œè°ƒè¯•åˆ†æ HashMap å¯¹è±¡ååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚</p><p>å¦‚ä¸‹å›¾ï¼Œåœ¨ readObject æ–¹æ³•ä¸­ï¼Œå±€éƒ¨å˜é‡ mappings çš„å€¼ä¸º size å±æ€§çš„å€¼ 2ï¼š</p><figure><img src=/ox-hugo/2021-01-26_15-46-03_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_15-46-03_screenshot.png></figure><p>ä¸€ç›´æ‰§è¡Œåˆ°æ–¹æ³•æœ€åçš„ for å¾ªç¯ï¼Œä»æ³¨é‡Šå¯ä»¥çŸ¥é“åœ¨è¿™ä¸ªå¾ªç¯ä¸­å–å‡ºæ‰€æœ‰ key å’Œ valueï¼Œå¹¶ä¿å­˜åˆ° HashMap å¯¹è±¡ä¸­ã€‚è¿™é‡Œç”¨åˆ°äº†ä¸Šé¢çš„ mappings å˜é‡ï¼Œå¦‚æœ mappings å˜é‡æ˜¯ 0ï¼Œå°±æ— æ³•è¿›å…¥å¾ªç¯äº†ã€‚</p><figure><img src=/ox-hugo/2021-01-26_15-49-33_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_15-49-33_screenshot.png></figure><p>è·Ÿè¿›æœ€åä¸€è¡Œçš„ <code>hash(key)</code> ï¼Œè¿™é‡Œçš„ key æ˜¯ TypedValue ç±»çš„å¯¹è±¡ã€‚</p><figure><img src=/ox-hugo/2021-01-26_16-08-16_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_16-08-16_screenshot.png></figure><p>è°ƒç”¨ <code>TypedValue.hashCode</code> æ–¹æ³•ï¼š</p><pre><code class=language-java>public int hashCode() {
    return (Integer)this.hashcode.getValue();
}
</code></pre><p>å…¶ä¸­ <code>this.hashcode</code> å±æ€§æ˜¯ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ï¼š</p><pre><code class=language-java>private void initTransients() {
    this.hashcode = new ValueHolder(new DeferredInitializer&lt;Integer&gt;() {
        public Integer initialize() {
            return TypedValue.this.value == null ? 0 : TypedValue.this.type.getHashCode(TypedValue.this.value);
        }
    });
}
</code></pre><p>å¯ä»¥çœ‹åˆ°åŒ¿åå†…éƒ¨ç±»ä¸­æœ‰ä¸€ä¸ª initialize æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨ getValue æ–¹æ³•ä¸­è¢«è°ƒç”¨ã€‚ä»ä¸Šé¢çš„ç±»å›¾å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°ï¼ŒTypedValue çš„ value å±æ€§å’Œ type å±æ€§åˆ†åˆ«æ˜¯ TemplatesImpl å¯¹è±¡å’Œ ComponentType å¯¹è±¡ã€‚</p><p>ç»§ç»­è·Ÿè¿›ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p><figure><img src=/ox-hugo/2021-01-26_16-47-43_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_16-47-43_screenshot.png></figure><figure><img src=/ox-hugo/2021-01-26_16-49-14_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_16-49-14_screenshot.png></figure><p>æ‰§è¡Œåˆ° PojoComponentTuplizer çš„ getPropertyValue æ–¹æ³•ï¼Œå¹¶è·å–æˆ‘ä»¬ä¹‹å‰æ„é€ çš„ <code>BasicPropertyAccessor$BasicGetter</code> å¯¹è±¡ï¼Œæ‰§è¡Œå…¶ get æ–¹æ³•ï¼Œå‚æ•°æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ TemplatesImpl å¯¹è±¡ã€‚</p><figure><img src=/ox-hugo/2021-01-26_16-52-20_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_16-52-20_screenshot.png></figure><figure><img src=/ox-hugo/2021-01-26_16-56-32_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_16-56-32_screenshot.png></figure><p>é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨ <code>TemplatesImpl.getOutputProperties</code> æ–¹æ³•ï¼š</p><figure><img src=/ox-hugo/2021-01-26_17-00-48_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_17-00-48_screenshot.png></figure><figure><img src=/ox-hugo/2021-01-26_17-01-13_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_17-01-13_screenshot.png></figure><p>è·Ÿè¿› newTransformer æ–¹æ³•ï¼š</p><figure><img src=/ox-hugo/2021-01-26_17-03-17_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_17-03-17_screenshot.png></figure><p>ç„¶åè¿›å…¥æˆ‘ä»¬çš„æœ€ç»ˆçš„ç›®æ ‡æ–¹æ³• getTransletInstanceï¼š</p><figure><img src=/ox-hugo/2021-01-26_17-09-42_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_17-09-42_screenshot.png></figure><p>ä¹‹æ‰€ä»¥åœ¨å¼€å§‹è®¾ç½® TemplatesImpl çš„ <code>_name</code> å±æ€§ï¼Œå°±æ˜¯ä¸ºäº†é€šè¿‡è¿™é‡Œçš„ if åˆ¤æ–­ã€‚</p><p>æ­¤æ—¶ <code>_class</code> çš„å€¼æ˜¯ nullï¼Œè°ƒç”¨ defineTransletClasses æ–¹æ³•å°† <code>_bytecodes</code> ä¸­çš„æ¯ä¸ª <code>byte[]</code> æ•°ç»„è¿˜åŸæˆä¸€ä¸ª Class å¯¹è±¡ï¼Œå†™åˆ° <code>_class</code> ä¸­ã€‚</p><figure><img src=/ox-hugo/2021-01-26_17-17-14_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_17-17-14_screenshot.png></figure><p>å¯è§æ­¤æ—¶çš„ <code>_class[0]</code> æ˜¯æˆ‘ä»¬é€šè¿‡ Javassit åº“æ„é€ çš„ StubTransletPayload ç±»ï¼Œå®ƒçš„é™æ€ä»£ç å—ä¿å­˜ç€æˆ‘ä»¬è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚</p><p>ç´§æ¥ç€å®ä¾‹åŒ–äº†è¿™ä¸ªç±»ï¼ŒæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚</p><figure><img src=/ox-hugo/2021-01-26_17-22-19_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_17-22-19_screenshot.png></figure><p>è¿™é‡Œè¿˜ç•™æ„åˆ° <code>_class[1]</code> ä¹Ÿæ˜¯æˆ‘ä»¬æ„é€ çš„ Foo ç±»ï¼Œç„¶è€Œè¿™ä¸ªç±»ä¼¼ä¹å¯¹è¿‡ç¨‹æ²¡ä»€ä¹ˆå½±å“ï¼Œä¸å¤ªæ˜ç™½æ„é€ è¿™ä¸ªç±»çš„ç”¨æ„ğŸ¤”</p><figure><img src=/ox-hugo/2021-01-26_17-25-06_screenshot.png class="img-zoomable medium-zoom-image" alt=/ox-hugo/2021-01-26_17-25-06_screenshot.png></figure></div></article><div class="license markdown-body"><blockquote><p>Unless otherwise noted, the content of this site is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a>.</p></blockquote></div><div class=post-comment data-comment=disqus><span class=post-comment-notloaded><i class="iconfont icon-chatbox-ellipses-sharp"></i>&nbsp;Load comments</span><div id=disqus_thread style=display:none></div><script>function loadComment(){var t=document.querySelector(".post-comment"),n=function(){this.page.url="https://zrquan.github.io/posts/ysoserial-hibernate1/",this.page.identifier="ysoserial-hibernate1"},e=document.createElement("script");e.src="https://4shen0ne.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),document.querySelector("#disqus_thread").removeAttribute("style"),(document.body||document.head).appendChild(e),document.querySelector("span.post-comment-notloaded").setAttribute("style","display: none;")}</script></div></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=/>Home</a></li><li><a href=/archives/>Archives</a></li><li><a href=/search/>Search</a></li><li><a href=/index.xml>Feed</a></li></ul></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#åŠ¨æ€å­—èŠ‚ç >åŠ¨æ€å­—èŠ‚ç </a><ul><li><a href=#javassit-demo>Javassit demo</a></li></ul></li><li><a href=#æ„é€ -payload>æ„é€  payload</a></li><li><a href=#ååºåˆ—åŒ–è¿‡ç¨‹>ååºåˆ—åŒ–è¿‡ç¨‹</a></li></ul></nav></div></aside></div><div class=btn><div class=btn-menu id=btn-menu><i class="iconfont icon-grid-sharp"></i></div><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div><aside class=sidebar-mobile style=display:none><div class=sidebar-wrapper><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=/>Home</a></li><li><a href=/archives/>Archives</a></li><li><a href=/search/>Search</a></li><li><a href=/index.xml>Feed</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://github.com/zrquan target=_blank><span>GitHub</span></a></li><li><a href=https://notes-bice-five.vercel.app/ target=_blank><span>Notes</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=/tags/ctf/>Ctf</a>
</span><span><a href=/tags/cve/>Cve</a>
</span><span><a href=/tags/deserialize/>Deserialize</a>
</span><span><a href=/tags/emacs/>Emacs</a>
</span><span><a href=/tags/fastjson/>Fastjson</a>
</span><span><a href=/tags/hessian/>Hessian</a>
</span><span><a href=/tags/java/>Java</a>
</span><span><a href=/tags/kotlin/>Kotlin</a>
</span><span><a href=/tags/org-mode/>Org-Mode</a>
</span><span><a href=/tags/web/>Web</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#åŠ¨æ€å­—èŠ‚ç >åŠ¨æ€å­—èŠ‚ç </a><ul><li><a href=#javassit-demo>Javassit demo</a></li></ul></li><li><a href=#æ„é€ -payload>æ„é€  payload</a></li><li><a href=#ååºåˆ—åŒ–è¿‡ç¨‹>ååºåˆ—åŒ–è¿‡ç¨‹</a></li></ul></nav></div></div></aside></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2021-2024
<a href=https://zrquan.github.io/>zrquan</a>
| <a href=https://github.com/zrquan/zrquan.github.io>Source code</a>
| Powered by <a href=https://github.com/andrew-aiken/hugo-theme-fuji/ target=_blank>Fuji</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.0/lazysizes.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js></script><script defer src=/assets/js/fuji.min.js></script><script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script></body></html>