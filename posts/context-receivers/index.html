<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=generator content="Hugo 0.101.0"><link rel=apple-touch-icon sizes=180x180 href=https://zrquan.github.io/blog/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://zrquan.github.io/blog/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://zrquan.github.io/blog/favicon/favicon-16x16.png><link rel=manifest href=https://zrquan.github.io/blog/favicon/site.webmanifest><link rel=mask-icon href=https://zrquan.github.io/blog/favicon/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Context receivers - zrquan</title><meta name=author content="[4shen0ne]"><meta name=description content="A minimal Hugo theme with nice theme color."><meta name=keywords content="kotlin"><meta property="og:title" content="Context receivers"><meta name=twitter:title content="Context receivers"><meta property="og:type" content="article"><meta property="og:url" content="https://zrquan.github.io/blog/posts/context-receivers/"><meta property="og:description" content="
Status: Experimental in 1.6.20-M1
Discussion: KEEP-259
"><meta name=twitter:description content="
Status: Experimental in 1.6.20-M1
Discussion: KEEP-259
"><meta property="og:image" content="https://zrquan.github.io/img/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zrquan.github.io/img/og.png"><meta property="article:published_time" content="2022-06-06T00:00:00+08:00"><meta property="article:modified_time" content="2022-06-06T00:00:00+08:00"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://zrquan.github.io/blog/assets/css/fuji.min.css></head><body data-theme=auto data-theme-auto=false><script data-cfasync=false>var fujiThemeData=localStorage.getItem("fuji_data-theme");fujiThemeData?fujiThemeData!=="auto"&&document.body.setAttribute("data-theme",fujiThemeData==="dark"?"dark":"light"):localStorage.setItem("fuji_data-theme","auto")</script><header><div class="container-lg clearfix"><div class="col-12 header"><a class=title-main href=https://zrquan.github.io/blog>zrquan</a>
<span class=title-sub>每一个平凡的日常，也许就是连续发生的奇迹</span></div></div></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h2 class="post-item post-title"><a href=https://zrquan.github.io/blog/posts/context-receivers/>Context receivers</a></h2><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2022-06-06</span>
<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;969 words</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=https://zrquan.github.io/blog/tags/kotlin>kotlin</a>&nbsp;</span></div><div class="post-content markdown-body"><ul><li>Status: Experimental in 1.6.20-M1</li><li>Discussion: <a href=https://github.com/Kotlin/KEEP/issues/259 target=_blank>KEEP-259</a></li></ul><h2 id=介绍>介绍</h2><p>Kotlin 在 1.6.20-M1 版本中添加了一个实验性的新特性 context receivers，以支持上下文相关的声明（context-dependent declarations）</p><p>这个特性是为了方便在 Kotlin 中面向上下文编程，而在此之前主要通过扩展函数和作用域函数实现。关于面向上下文编程可以看看<a href=https://proandroiddev.com/an-introduction-context-oriented-programming-in-kotlin-2e79d316b0a2 target=_blank>这篇文章</a></p><p>引入 context receivers 的目的<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>：</p><blockquote><ul><li>Remove all limitations of member extensions for writing contextual abstractions<ul><li>Support top-level (non-member) contextual functions and properties</li><li>Support adding contextual function and properties to 3rd party context classes</li><li>Support multiple contexts</li></ul></li><li>Make blocks of code with multiple receivers representable in Kotlin&rsquo;s type system</li><li>Separate the concepts of extension and dispatch receivers from the concept of context receivers<ul><li>Context receivers should not change the meaning of unqualified this expression</li><li>Multiple contexts should not be ordered during resolution, resolution ambiguities shall be reported</li></ul></li><li>Design a scalable resolution algorithm with respect to the number of receivers<ul><li>Call resolution should not be exponential in the number of context receivers</li></ul></li></ul></blockquote><p>另外需要注意，context receivers 在 1.6.20 版本中还是实验性的，需要显式开启
<code>-Xcontext-receivers</code> 才能使用。比如在 Gradle 中使用：</p><pre><code class=language-kotlin>tasks.withType&lt;KotlinCompile&gt; {
    kotlinOptions.jvmTarget = &quot;17&quot;
    kotlinOptions.freeCompilerArgs += &quot;-Xcontext-receivers&quot;
}
</code></pre><h2 id=使用场景>使用场景</h2><p>举个例子，我们来实现一个简单的银行交易逻辑，其中存款和取款必须是事务性的，在失败时进行回滚</p><figure><img src=https://zrquan.github.io/blog/ox-hugo/account-service.svg class="img-zoomable medium-zoom-image" alt=/ox-hugo/account-service.svg width=600></figure><p>我们在 AccountService#transfer 中处理交易逻辑，通过 Transaction 进行事务性操作，所以 transfer 需要传入一个事务实例。常规实现：</p><pre><code class=language-kotlin>class AccountService {
    fun transfer(tx: Transaction, vararg operations: () -&gt; Unit) {
        tx.start()
        try {
            operations.forEach { it.invoke() }
            tx.commit()
        } catch (e: Exception) {
            tx.rollback()
        }
    }
}
</code></pre><p>然后在调用时将 Transaction 实例和 lambda 作为参数传入：</p><pre><code class=language-kotlin>val service = AccountService()
val transaction = Transaction()
val repo = AccountRepo()
service.transfer(
    transaction,
    { repo.credit(account1, 10.5) },
    { repo.debit(account2, 10.5) }
)
</code></pre><p>上面的实现在 Java 中很常见，但是在 Kotlin 我们可以用扩展函数来优化一下：</p><pre><code class=language-kotlin>class AccountService {
    fun Transaction.transfer(vararg operations: () -&gt; Unit) {
        start()
        try {
            operations.forEach { it.invoke() }
            commit()
        } catch (e: Exception) {
            rollback()
        }
    }
}
</code></pre><p>现在 transfer 中的 this 指向了 Transaction 实例，那么就不再需要通过参数传入了，不过需要在 AccountService 实例的上下文中使用 transfer，比如使用 with：</p><pre><code class=language-kotlin>with(service) {
    transaction.transfer(
        { repo.credit(account1, 10.5) },
        { repo.debit(account2, 10.5) }
    )
}
</code></pre><p>使用扩展函数虽然减少了一些代码，但是存在其他问题：在语义上和原来的版本是不同的——transfer 是 Transaction 类的方法，这一点也不符合实际的逻辑，Transaction 应该只包含事务性的操作</p><p>那么有没有办法将 Transaction 上下文引入 transfer 的同时，不改变 transfer 的所属类呢？Context receivers 特性就可以实现这一点</p><p>我们在 transfer 的声明上通过 <code>context()</code> 指定上下文，那么在函数内就会引入一个指向 Transaction 的隐式的 this</p><pre><code class=language-kotlin>class AccountService {
    context(Transaction)
    fun transfer(vararg operations: () -&gt; Unit) {
        start()
        try {
            operations.forEach { it.invoke() }
            commit()
        } catch (e: Exception) {
            rollback()
        }
    }
}
</code></pre><p>然后在 Transaction 实例的上下文中调用 transfer 服务，在语义上也符合逻辑</p><pre><code class=language-kotlin>with(transaction) {
    service.transfer(
        { repo.credit(account1, 10.5) },
        { repo.debit(account2, 10.5) }
    )
}
</code></pre><h2 id=思考>思考</h2><p>由于 context receivers 还处于实验阶段，使用体验和实际案例都还比较欠缺，要感受到它带来的好处恐怕还需要一段时间。不过在实现 DSL 上它肯定比继承更加适合，唯一需要担心的是滥用 context 导致代码晦涩难懂</p><p>关于 context receivers 的详细说明建议看 KEEP 上的相关提案：<a href=https://github.com/Kotlin/KEEP/blob/master/proposals/context-receivers.md target=_blank>context-receivers</a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://github.com/Kotlin/KEEP/blob/master/proposals/context-receivers.md#goals target=_blank>https://github.com/Kotlin/KEEP/blob/master/proposals/context-receivers.md#goals</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><div class="license markdown-body"><blockquote><p>Unless otherwise noted, the content of this site is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a>.</p></blockquote></div><div class=post-comment data-comment=disqus><span class=post-comment-notloaded><i class="iconfont icon-chatbox-ellipses-sharp"></i>&nbsp;Load comments</span><div id=disqus_thread style=display:none></div><script>function loadComment(){var t=document.querySelector(".post-comment"),n=function(){this.page.url="https://zrquan.github.io/blog/posts/context-receivers/",this.page.identifier="context-receivers"},e=document.createElement("script");e.src="https://4shen0ne.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),document.querySelector("#disqus_thread").removeAttribute("style"),(document.body||document.head).appendChild(e),document.querySelector("span.post-comment-notloaded").setAttribute("style","display: none;")}</script></div></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=https://zrquan.github.io/blog/>Home</a></li><li><a href=https://zrquan.github.io/blog/archives/>Archives</a></li><li><a href=https://zrquan.github.io/blog/search/>Search</a></li><li><a href=https://zrquan.github.io/blog/index.xml>Feed</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://github.com/zrquan target=_blank><span>GitHub</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=https://zrquan.github.io/blog/tags/cve/>cve</a></span>
<span><a href=https://zrquan.github.io/blog/tags/deserialize/>deserialize</a></span>
<span><a href=https://zrquan.github.io/blog/tags/emacs/>emacs</a></span>
<span><a href=https://zrquan.github.io/blog/tags/fastjson/>fastjson</a></span>
<span><a href=https://zrquan.github.io/blog/tags/java/>java</a></span>
<span><a href=https://zrquan.github.io/blog/tags/kotlin/>kotlin</a></span>
<span><a href=https://zrquan.github.io/blog/tags/org-mode/>org-mode</a></span>
<span><a href=https://zrquan.github.io/blog/tags/web/>web</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#介绍>介绍</a></li><li><a href=#使用场景>使用场景</a></li><li><a href=#思考>思考</a></li></ul></nav></div></aside></div><div class=btn><div class=btn-menu id=btn-menu><i class="iconfont icon-grid-sharp"></i></div><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div><aside class=sidebar-mobile style=display:none><div class=sidebar-wrapper><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=https://zrquan.github.io/blog/>Home</a></li><li><a href=https://zrquan.github.io/blog/archives/>Archives</a></li><li><a href=https://zrquan.github.io/blog/search/>Search</a></li><li><a href=https://zrquan.github.io/blog/index.xml>Feed</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://github.com/zrquan target=_blank><span>GitHub</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=https://zrquan.github.io/blog/tags/cve/>cve</a></span>
<span><a href=https://zrquan.github.io/blog/tags/deserialize/>deserialize</a></span>
<span><a href=https://zrquan.github.io/blog/tags/emacs/>emacs</a></span>
<span><a href=https://zrquan.github.io/blog/tags/fastjson/>fastjson</a></span>
<span><a href=https://zrquan.github.io/blog/tags/java/>java</a></span>
<span><a href=https://zrquan.github.io/blog/tags/kotlin/>kotlin</a></span>
<span><a href=https://zrquan.github.io/blog/tags/org-mode/>org-mode</a></span>
<span><a href=https://zrquan.github.io/blog/tags/web/>web</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#介绍>介绍</a></li><li><a href=#使用场景>使用场景</a></li><li><a href=#思考>思考</a></li></ul></nav></div></div></aside></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2021-2022
<a href=https://zrquan.github.io/blog>zrquan</a>
| <a href=https://github.com/zrquan/blog>Source code</a>
| Powered by <a href=https://github.com/dsrkafuu/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.0/lazysizes.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js></script>
<script defer src=https://zrquan.github.io/blog/assets/js/fuji.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script></body></html>